<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!-- Desktop-first viewport: optimized for desktop (1024px min) but mobile-adaptive -->
<meta name="viewport" content="width=1024, initial-scale=1.0, user-scalable=yes">
<title>DSH De-escalation Mastery Lab™</title>

<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2563eb">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DSH Training">
<link rel="apple-touch-icon" href="/dsh.png">
<link rel="icon" type="image/png" href="/dsh.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="tenant.config.js"></script>

<!-- Service Worker registration -->
<script>
(function() {
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js', { scope: '/' })
        .then(reg => {
          // Check for updates in the background
          reg.addEventListener('updatefound', () => {
            const newSW = reg.installing;
            newSW && newSW.addEventListener('statechange', () => {
              if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                // New version available — notify user softly
                console.info('[SW] New version available — reload to update.');
              }
            });
          });
        })
        .catch(err => console.warn('[SW] Registration failed:', err));
    });
  }

  // Handle PWA shortcut URL params
  const sp = new URLSearchParams(location.search);
  const shortcut = sp.get('shortcut');
  if (shortcut) {
    window._pwaShortcut = shortcut; // picked up after login
    history.replaceState(null, '', location.pathname);
  }
})();
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, reauthenticateWithCredential, EmailAuthProvider, updatePassword, setPersistence, browserSessionPersistence, GoogleAuthProvider, signInWithPopup, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, get, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
const firebaseConfig = (window.TENANT?.firebase) || {
  apiKey: "AIzaSyDVdGXUgxqsSZZiVoEjPL4DkDEMU29meMY",
  authDomain: "dsh-training-lab.firebaseapp.com",
  databaseURL: "https://dsh-training-lab-default-rtdb.firebaseio.com",
  projectId: "dsh-training-lab",
  storageBucket: "dsh-training-lab.firebasestorage.app",
  messagingSenderId: "564158481536",
  appId: "1:564158481536:web:7dc5dde8b0dff9c9e71265",
  measurementId: "G-S5VEEYP6SW"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
await setPersistence(auth, browserSessionPersistence); // sign out when tab/browser is closed
const googleProvider = new GoogleAuthProvider();
googleProvider.setCustomParameters({ prompt: 'select_account' });
const db = getDatabase(app);
// Multi-tenant path helper — all Firebase data scoped under orgs/{orgId}/ for client isolation
const _ref = path => ref(db, `orgs/${window.TENANT?.orgId || 'destiny-springs'}/${path}`);
window._auth = auth; window._db = db; window._ref = ref;
window._set = set; window._get = get; window._update = update;
window._onValue = onValue; window._remove = remove;
window._updateProfile = updateProfile;
const isReloadNav = (() => {
  const nav = (performance && performance.getEntriesByType) ? performance.getEntriesByType('navigation')[0] : null;
  if (nav && nav.type) return nav.type === 'reload';
  if (performance && performance.navigation) return performance.navigation.type === 1; // legacy API
  return false;
})();
let firstAuthEvent = true;
window._reauthAndChangePassword = async function(currentPass, newPass) {
  const user = auth.currentUser;
  const cred = EmailAuthProvider.credential(user.email, currentPass);
  await reauthenticateWithCredential(user, cred);
  await updatePassword(user, newPass);
};
onAuthStateChanged(auth, user => {
  window._currentUser = user;
  if (firstAuthEvent && user && isReloadNav) {
    // Only sign out persisted sessions that survive a hard reload
    signOut(auth);
    firstAuthEvent = false;
    return;
  }
  firstAuthEvent = false;
  if (user) {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    loadUserData(user);
  } else {
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('app').style.display = 'none';
    const hub = document.getElementById('home-gateway');
    if(hub) hub.style.display = 'none';
  }
});
async function loadUserData(user) {
  const fallbackEmail = user.email || `${user.uid}@guest.local`; // supports anonymous users
  const snap = await get(_ref('users/' + user.uid));
  if (snap.exists()) {
    window._userData = snap.val();
    // Update last login and training year each session
    await update(_ref('users/' + user.uid), { lastLogin: Date.now(), trainingYear: new Date().getFullYear() });
    window._writeAudit('login', { slide: window._userData?.currentSlide || 0 });
    window._checkAchievements && window._checkAchievements({ _justLoggedIn: true }).catch(()=>{});
  } else {
    // Legacy / admin-created account fallback
    const parts = (user.displayName || '').split(' ');
    window._userData = {
      name: user.displayName || fallbackEmail.split('@')[0],
      firstName: parts[0] || fallbackEmail.split('@')[0],
      lastName: parts.slice(1).join(' ') || '',
      email: fallbackEmail, phone: '', jobTitle: '', department: '', employeeId: '',
      xp: 0, level: 1, scenariosDone: 0, scoreTotal: 0,
      labCredits: 0, lastLabRun: {}, weekXP: 0,
      startDate: Date.now(), lastLogin: Date.now(), trainingYear: new Date().getFullYear(),
      hasOnboarded: false, currentSlide: 0, sessionMode: 'training'
    };
    await set(_ref('users/' + user.uid), window._userData);
  }
  initApp();
}
window._signUp = async function(fname, lname, email, pass, phone, title, dept, empid) {
  const cred = await createUserWithEmailAndPassword(auth, email, pass);
  const displayName = fname + ' ' + lname;
  await updateProfile(cred.user, { displayName });
  // Store extended profile in DB immediately
  await set(_ref('users/' + cred.user.uid), {
    name: displayName, firstName: fname, lastName: lname,
    email, phone: phone||'', jobTitle: title||'', department: dept||'', employeeId: empid||'',
    xp: 0, level: 1, scenariosDone: 0, scoreTotal: 0,
    labCredits: 0, lastLabRun: {}, weekXP: 0,
    startDate: Date.now(), lastLogin: Date.now(), trainingYear: new Date().getFullYear()
  });
};
window._signIn = async function(email, pass) {
  await signInWithEmailAndPassword(auth, email, pass);
};
window._signOut = () => signOut(auth);
window._saveUserData = async function(data) {
  if (!window._currentUser) return;
  await update(_ref('users/' + window._currentUser.uid), data);
  window._userData = Object.assign(window._userData || {}, data);
};
window._loadAllUsers = async function() {
  const snap = await get(_ref('users'));
  return snap.exists() ? snap.val() : {};
};
window._deleteUser = async function(uid) {
  await remove(_ref('users/' + uid));
};
window._updateUserData = async function(uid, data) {
  await update(_ref('users/' + uid), data);
};
// ─── Admin role system ───────────────────────────────────
window._getAdminRole = async function(uid) {
  const snap = await get(_ref('admins/' + uid));
  return snap.exists() ? snap.val().role : null; // 'owner' | 'admin' | null
};
window._setAdminRole = async function(uid, role) {
  if(role) await set(_ref('admins/' + uid), { role, grantedAt: Date.now() });
  else await remove(_ref('admins/' + uid));
};
window._loadAllAdmins = async function() {
  const snap = await get(_ref('admins'));
  return snap.exists() ? snap.val() : {};
};
window._getSettings = async function() {
  const snap = await get(_ref('settings'));
  return snap.exists() ? snap.val() : {};
};
window._saveSettings = async function(data) {
  await update(_ref('settings'), data);
};
// ─── Audit log ───────────────────────────────────────────
window._writeAudit = async function(action, meta) {
  try {
    const user = window._currentUser;
    const key = Date.now() + '_' + (user?.uid || 'anon').slice(0, 8);
    await set(_ref('audit/' + key), {
      action,
      uid:         user?.uid         || null,
      email:       user?.email       || (window._userData?.email) || null,
      displayName: user?.displayName || (window._userData?.name) || null,
      ts:          Date.now(),
      iso:         new Date().toISOString(),
      ua:          navigator.userAgent.slice(0, 120),
      ...(meta || {})
    });
  } catch(_e) { /* never block UI for audit failures */ }
};
// ─── UI Polish Helpers ────────────────────────────────────────
window._typewrite = function(el, text, speed=20) {
  // Cancel any in-flight typewrite on this element
  const token = (el._twToken = (el._twToken || 0) + 1);
  el.textContent = '';
  let i = 0;
  const tick = () => {
    if(el._twToken !== token) return; // superseded
    if(i < text.length) {
      el.textContent += text[i++];
      setTimeout(tick, speed);
    }
  };
  tick();
};
window._animCounter = function(el, from, to, ms=800) {
  if(!el) return;
  const start = performance.now();
  const step = t => {
    const p = Math.min(1, (t - start) / ms);
    const ease = 1 - Math.pow(1 - p, 3);
    el.textContent = Math.round(from + (to - from) * ease).toLocaleString();
    if(p < 1) requestAnimationFrame(step);
  };
  requestAnimationFrame(step);
};
// ─── Achievement Badges ───────────────────────────────────────
const ACHIEVEMENTS = [
  { id:'first_login',   icon:'🌟', name:'Welcome Aboard',   desc:'Logged in for the first time',            check: ()=> true },
  { id:'first_lab',     icon:'🧪', name:'Lab Initiate',      desc:'Completed your first lab scenario',       check: u=> (u.scenariosCompleted||0) >= 1 },
  { id:'perfect_lab',   icon:'💎', name:'Perfect Technique', desc:'Scored an A in a lab scenario',           check: u=> u._lastLabGrade === 'A' },
  { id:'all_patients',  icon:'👥', name:'Full Spectrum',     desc:'Worked with all 3 patients in the lab',   check: u=> (u._labPatientSet||[]).length >= 3 },
  { id:'streak_3',      icon:'🔥', name:'On Fire',           desc:'Built a 3-day daily drill streak',         check: u=> (u.drillStreak||0) >= 3 },
  { id:'streak_7',      icon:'⚡', name:'Week Warrior',      desc:'Built a 7-day daily drill streak',         check: u=> (u.drillStreak||0) >= 7 },
  { id:'level_3',       icon:'🎖️', name:'Rising Clinician', desc:'Reached Level 3',                          check: u=> (u.level||1) >= 3 },
  { id:'level_5',       icon:'🏆', name:'Expert Clinician',  desc:'Reached Level 5',                          check: u=> (u.level||1) >= 5 },
  { id:'cert_earned',   icon:'🎓', name:'Certified!',        desc:'Downloaded your completion certificate',   check: u=> !!u.completedAt },
  { id:'drill_10',      icon:'🧠', name:'Drill Devotee',     desc:'Completed 10 or more daily drills',        check: u=> (u.totalDrillsCompleted||0) >= 10 },
];
window._showAchievementToast = function(a) {
  const old = document.getElementById('achievement-toast');
  if(old) old.remove();
  const t = document.createElement('div');
  t.id = 'achievement-toast';
  t.style.cssText = 'position:fixed;bottom:8rem;left:50%;transform:translateX(-50%) scale(.5);z-index:4000;background:linear-gradient(135deg,#1e3a8a,#7c3aed);color:#fff;border-radius:1.5rem;padding:.9rem 1.5rem;box-shadow:0 8px 36px rgba(124,58,237,.5);display:flex;align-items:center;gap:.85rem;pointer-events:none;white-space:nowrap;animation:badge-pop .4s cubic-bezier(.34,1.56,.64,1) forwards';
  t.innerHTML = `<span style="font-size:2rem">${a.icon}</span><div><div style="font-size:.68rem;font-weight:800;letter-spacing:.1em;text-transform:uppercase;opacity:.8;margin-bottom:.15rem">Achievement Unlocked</div><div style="font-size:.97rem;font-weight:900">${a.name}</div><div style="font-size:.72rem;opacity:.7;margin-top:.1rem">${a.desc}</div></div>`;
  document.body.appendChild(t);
  setTimeout(() => {
    t.style.transition = 'opacity .5s ease';
    t.style.opacity = '0';
    setTimeout(() => t.remove(), 520);
  }, 4200);
};
window._checkAchievements = async function(patch) {
  try {
    if(!window._currentUser) return;
    const merged = { ...(window._userData||{}), ...(patch||{}) };
    const earned = merged.achievements || {};
    const toUnlock = ACHIEVEMENTS.filter(a => !earned[a.id] && a.check(merged));
    if(!toUnlock.length) return;
    const updates = {};
    toUnlock.forEach(a => { updates['achievements/' + a.id] = { ts: Date.now(), name: a.name }; });
    await update(_ref('users/' + window._currentUser.uid), updates);
    if(window._userData) {
      window._userData.achievements = { ...(window._userData.achievements||{}), ...Object.fromEntries(toUnlock.map(a=>[a.id,{ts:Date.now()}])) };
    }
    toUnlock.forEach((a, i) => setTimeout(() => window._showAchievementToast(a), i * 4600));
  } catch(_e) {}
};
window._resetAllProgress = async function() {
  const snap = await get(_ref('users'));
  if(!snap.exists()) return;
  const kids = snap.val();
  await Promise.all(Object.keys(kids).map(uid =>
    update(_ref('users/' + uid), { currentSlide:0, xp:0, level:1, scenariosCompleted:0 })
  ));
};

// ─── HR Integration Helpers ──────────────────────────────
// Fires an outbound webhook (proxied server-side for HMAC signing + CORS bypass)
window._fireWebhook = async function(event, payload) {
  try {
    const cfg = window._settingsCache || {};
    const url = cfg.webhookUrl;
    if (!url || !url.startsWith('http')) return;
    const enabledEvents = cfg.webhookEvents || ['training_completed','cert_downloaded','lab_completed'];
    if (!enabledEvents.includes(event)) return;
    const body = JSON.stringify({
      event,
      timestamp: new Date().toISOString(),
      orgId: (typeof TENANT_ID !== 'undefined' ? TENANT_ID : null) || window.TENANT?.orgId || 'unknown',
      orgName: window.TENANT?.orgName || 'Unknown Org',
      ...payload
    });
    await fetch('/api/webhook-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url, event, secret: cfg.webhookSecret || '', body })
    });
  } catch(_e) { /* silent — never block UI for webhook failure */ }
};

// Emits an xAPI / Tin Can statement to a configured LRS
window._emitXAPI = async function(verb, resultData) {
  try {
    const cfg = window._settingsCache || {};
    const endpoint = cfg.xapiEndpoint;
    if (!endpoint) return;
    const user = window._currentUser;
    const activityId = cfg.xapiActivityId || 'https://www.destinysprings.com/training/de-escalation';
    const verbMap = {
      completed:   { id:'http://adlnet.gov/expapi/verbs/completed',   display:{'en-US':'completed'} },
      passed:      { id:'http://adlnet.gov/expapi/verbs/passed',      display:{'en-US':'passed'} },
      attempted:   { id:'http://adlnet.gov/expapi/verbs/attempted',   display:{'en-US':'attempted'} },
      experienced: { id:'http://adlnet.gov/expapi/verbs/experienced', display:{'en-US':'experienced'} }
    };
    const statement = {
      actor: { objectType:'Agent', name: user?.displayName || user?.email || 'Unknown', mbox:`mailto:${user?.email||'unknown@unknown.com'}` },
      verb: verbMap[verb] || { id:`https://www.destinysprings.com/verbs/${verb}`, display:{'en-US':verb} },
      object: {
        objectType:'Activity', id: activityId,
        definition: { name:{'en-US':'De-escalation Mastery Training'}, description:{'en-US':'27-module psychiatric crisis intervention training for BHTs'}, type:'http://adlnet.gov/expapi/activities/course' }
      },
      result: resultData || {},
      timestamp: new Date().toISOString(),
      context: { platform:'De-escalation Mastery Lab', language:'en-US', extensions: { 'https://www.destinysprings.com/extensions/orgId': window.TENANT?.orgId || 'unknown' } }
    };
    const headers = { 'Content-Type':'application/json', 'X-Experience-API-Version':'1.0.3' };
    if (cfg.xapiUsername) headers['Authorization'] = 'Basic ' + btoa((cfg.xapiUsername||'') + ':' + (cfg.xapiPassword||''));
    const lrsUrl = endpoint.replace(/\/$/, '') + '/statements';
    await fetch(lrsUrl, { method:'POST', headers, body: JSON.stringify(statement) });
  } catch(_e) { /* silent */ }
};
</script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box}
html,body{height:100%}
body{font-family:'Inter',sans-serif;background:#0f172a;overflow:hidden;margin:0}
.slide{display:none;width:100vw;height:100vh;overflow-y:auto;flex-direction:column;padding-bottom:5rem}
.slide.active{display:block}
.slide>div{max-width:900px;margin-left:auto;margin-right:auto;width:100%;box-sizing:border-box}
h1,h2,.font-display{font-family:'Montserrat',sans-serif}
.progress-bar{transition:width .4s cubic-bezier(.4,0,.2,1)}
.card{background:#fff;border-radius:1.5rem;box-shadow:0 10px 40px rgba(0,0,0,.08)}
.badge{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .75rem;border-radius:999px;font-size:.7rem;font-weight:800;letter-spacing:.08em;text-transform:uppercase}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem 1.5rem;border-radius:.875rem;font-weight:800;font-size:.875rem;cursor:pointer;transition:all .2s;border:none;letter-spacing:.02em}
.btn-primary{background:#2563eb;color:#fff} .btn-primary:hover{background:#1d4ed8;transform:translateY(-1px);box-shadow:0 8px 20px rgba(37,99,235,.3)}
.btn-success{background:#059669;color:#fff} .btn-success:hover{background:#047857}
.btn-danger{background:#dc2626;color:#fff} .btn-danger:hover{background:#b91c1c}
.btn-purple{background:#7c3aed;color:#fff} .btn-purple:hover{background:#6d28d9}
.btn-amber{background:#d97706;color:#fff} .btn-amber:hover{background:#b45309}
.input-field{width:100%;padding:.875rem 1rem;background:#f8fafc;border:2px solid #e2e8f0;border-radius:.875rem;font-family:inherit;font-size:.9rem;font-weight:600;outline:none;transition:border-color .2s}
.input-field:focus{border-color:#2563eb;background:#fff}
.diagnosis-pill{padding:.5rem 1.25rem;border-radius:999px;font-weight:800;font-size:.75rem;cursor:pointer;transition:all .2s;border:2px solid transparent}
.diagnosis-pill.active{color:#fff}
@keyframes slideUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
@keyframes wiggle{0%,100%{transform:rotate(0)}25%{transform:rotate(-8deg)}75%{transform:rotate(8deg)}}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 0 0 rgba(59,130,246,.4)}50%{box-shadow:0 0 0 16px rgba(59,130,246,0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes talking{0%,100%{transform:scaleY(1)}50%{transform:scaleY(0.3)}}
@keyframes orbFloat{0%,100%{transform:translate(0,0) scale(1)}33%{transform:translate(18px,-22px) scale(1.04)}66%{transform:translate(-12px,14px) scale(.97)}}
/* ═══════════════════════════════════════════════════════════════
   RESPONSIVE MOBILE ADAPTIVE STYLES
   ═══════════════════════════════════════════════════════════════ */

/* Mobile: < 640px */
@media(max-width:640px){
  /* Auth screen mobile layout */
  #auth-screen{flex-direction:column!important}
  #auth-screen>div:first-child{flex:none!important;min-height:180px;padding:1.5rem 1.25rem 1rem!important}
  #auth-screen>div:first-child h1{font-size:1.35rem!important;line-height:1.15!important}
  #auth-screen>div:last-child{width:100%!important;padding:1.5rem 1.25rem!important}
  #mobile-logo-block{display:block!important}
  
  /* Hide decorative orbs on mobile to improve performance */
  #auth-screen>div:first-child>div:nth-child(2),
  #auth-screen>div:first-child>div:nth-child(3),
  #auth-screen>div:first-child>div:nth-child(4){display:none!important}
  
  /* Slides: prevent horizontal overflow */
  .slide{width:100%!important;padding:1rem 1rem 4rem!important}
  
  /* Reduce font sizes for mobile */
  body{font-size:14px}
  h1{font-size:1.5rem!important}
  h2{font-size:1.25rem!important}
  h3{font-size:1.1rem!important}
  
  /* Buttons and controls */
  .btn{padding:.65rem 1.25rem;font-size:.8rem}
  .btn-primary,.btn-success,.btn-danger,.btn-purple,.btn-amber{padding:.75rem 1.25rem}
  
  /* Input fields */
  .input-field{padding:.75rem .875rem;font-size:.85rem}
  
  /* Navigation buttons positioning */
  .slide-header{padding:.5rem .75rem;font-size:.85rem}
  
  /* Stats bar - stack on mobile */
  #auth-screen div[style*="display:flex;gap:2rem"]{gap:1rem!important}
  
  /* Footer on auth screen */
  #auth-screen div[style*="border-top:1px solid"]{flex-direction:column;text-align:center;gap:.5rem!important}
  
  /* Certificate and print preview */
  #certificate-preview{padding:1rem!important;font-size:.85rem!important}
  
  /* Admin modal - full screen on mobile */
  #admin-modal>div{max-width:100%;width:100%;margin:0;border-radius:0;max-height:100vh}
  
  /* Grid layouts - stack on mobile */
  .grid-cols-2{grid-template-columns:1fr!important}
  [style*="grid-template-columns:1fr 1fr"]{grid-template-columns:1fr!important}
  
  /* Diagnosis pills - wrap properly */
  .diagnosis-pill{font-size:.7rem;padding:.4rem 1rem}
  
  /* XP bar and level display */
  .xp-bar{height:6px}
  
  /* Trainer chat bubble - adjust position */
  #trainer-bubble{bottom:4rem;right:1rem;left:1rem;max-width:none!important}
  
  /* Score badge */
  .score-badge{font-size:1.8rem;padding:.75rem;min-width:60px}
  
  /* Navigation bar - more compact on mobile */
  nav[style*="position:fixed;bottom:0"]{padding:.5rem .75rem!important;gap:.35rem!important}
  nav[style*="position:fixed;bottom:0"] button{padding:.4rem .5rem!important;font-size:.7rem!important}
  nav[style*="position:fixed;bottom:0"] button[style*="width:48px"]{width:38px!important;height:38px!important}
  /* hide side-edge arrows on small screens to avoid obscuring content */
  button[style*="border-radius:0 .75rem"]{display:none!important}
  button[style*="border-radius:.75rem 0"]{display:none!important}
  
  /* Hide "Sign Out" text on mobile, keep button - using visibility for accessibility */
  nav button[onclick="doSignOut()"]{
    padding:.45rem!important;
    overflow:hidden;
    text-indent:-9999px;
  }
  nav button[onclick="doSignOut()"]::before{
    content:"×";
    font-size:1.2rem;
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    text-indent:0;
  }
  
  /* Prof. Vance portrait glow while speaking */
  @keyframes vance-pulse {
    0%,100% { box-shadow: 0 0 0 3px rgba(37,99,235,.7), 0 0 16px 4px rgba(37,99,235,.15); }
    50%      { box-shadow: 0 0 0 6px rgba(37,99,235,.4), 0 0 28px 10px rgba(37,99,235,.3); }
  }
  #vance-portrait.speaking {
    animation: vance-pulse 1.1s ease-in-out infinite;
    border-color: #60a5fa !important;
  }

  /* Hide Prof. Pax text on mobile - keep for screen readers */
  nav button[onclick="showGuide()"] span{
    position:absolute;
    width:1px;
    height:1px;
    padding:0;
    margin:-1px;
    overflow:hidden;
    clip:rect(0,0,0,0);
    white-space:nowrap;
    border:0;
  }
  
  /* My Account - hide name on mobile but keep for screen readers */
  #nav-name{
    position:absolute;
    width:1px;
    height:1px;
    padding:0;
    margin:-1px;
    overflow:hidden;
    clip:rect(0,0,0,0);
    white-space:nowrap;
    border:0;
  }
  
  /* Avatar container - hide on mobile */
  #avatar-container{display:none!important}
  
  /* Welcome card on first slide */
  #welcome-card{padding:1.5rem!important;max-width:100%!important}
  
  /* Slide content padding */
  .slide>div[style*="padding:2.5rem"]{padding:1.5rem 1rem!important}
  .slide>div[style*="padding:3rem"]{padding:1.75rem 1rem!important}
  
  /* Card max widths */
  .card[style*="max-w"]{max-width:100%!important;margin:0 auto}
  
  /* Modal cards on mobile - full width */
  #admin-modal .card,#account-modal .card,#admin-pin-modal .card{border-radius:1rem!important}
}

/* Tablet: 641px - 1024px */
@media(min-width:641px) and (max-width:1024px){
  /* Auth screen - adjust proportions */
  #auth-screen>div:first-child{padding:2rem 2.25rem!important}
  #auth-screen>div:last-child{width:420px!important;padding:2rem 2.25rem!important}
  
  /* Slides */
  .slide{padding:1.5rem 1.5rem 4rem!important}
  
  /* Reduce spacing slightly */
  body{font-size:15px}
  .btn{padding:.7rem 1.35rem}
  
  /* Grid layouts - 2 columns on tablet */
  .grid-cols-2{grid-template-columns:repeat(2,1fr)!important}
  
  /* Admin modal */
  #admin-modal>div{max-width:90%;margin:1rem}
}

/* Desktop: > 1024px uses original inline styles */
.anim-slideup{animation:slideUp .5s ease both}
.anim-bounce{animation:bounce 1s ease infinite}
.anim-wiggle{animation:wiggle .5s ease}
.anim-pulse-glow{animation:pulse-glow 2s infinite}
.spinner{width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-top:3px solid #fff;border-radius:50%;animation:spin 1s linear infinite}
.red-box{background:linear-gradient(135deg,#fef2f2,#fee2e2);border-left:5px solid #ef4444}
.green-box{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-left:5px solid #22c55e}
.blue-box{background:linear-gradient(135deg,#eff6ff,#dbeafe);border-left:5px solid #3b82f6}
.amber-box{background:linear-gradient(135deg,#fffbeb,#fef3c7);border-left:5px solid #f59e0b}
.purple-box{background:linear-gradient(135deg,#faf5ff,#ede9fe);border-left:5px solid #8b5cf6}
.slide-header{padding:.5rem 1rem .25rem;background:rgba(255,255,255,.03);border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.copyright{font-size:.6rem;color:rgba(255,255,255,.3);letter-spacing:.05em}
/* Avatar mouth animation */
#avatar-mouth{animation:none}
#avatar-mouth.talking{animation:talking .15s ease infinite}
#home-gateway{display:none;position:fixed;inset:0;z-index:70;background:radial-gradient(circle at 20% 20%,rgba(59,130,246,.12),transparent 35%),radial-gradient(circle at 80% 10%,rgba(14,165,233,.12),transparent 32%),radial-gradient(circle at 30% 80%,rgba(124,58,237,.12),transparent 38%),#0b1224;backdrop-filter:blur(10px);align-items:center;justify-content:center;padding:2rem}
@keyframes shimmer{0%{background-position:-400px 0}100%{background-position:400px 0}}
.skel{background:linear-gradient(90deg,#e2e8f0 25%,#f1f5f9 50%,#e2e8f0 75%);background-size:400px 100%;animation:shimmer 1.4s infinite linear;border-radius:.55rem;height:1rem}
@keyframes badge-pop{0%{transform:translateX(-50%) scale(.5);opacity:0}70%{transform:translateX(-50%) scale(1.07)}100%{transform:translateX(-50%) scale(1);opacity:1}}
@keyframes xp-bounce{0%,100%{transform:translateX(-50%) scale(1)}40%{transform:translateX(-50%) scale(1.22)}}
.xp-toast-pop{animation:xp-bounce .35s cubic-bezier(.34,1.56,.64,1)}
</style>
</head>
<body>

<!-- ═══════════════════════════════════════════════ AUTH SCREEN ══ -->
<div id="auth-screen" style="display:flex;position:fixed;inset:0;z-index:200;overflow:hidden">

  <!-- ── LEFT HERO PANEL ── -->
  <div style="flex:1.1;display:flex;flex-direction:column;position:relative;overflow:hidden;min-width:0">

    <!-- Animated gradient background -->
    <div style="position:absolute;inset:0;background:linear-gradient(160deg,#130c2f 0%,#20114a 32%,#4c1d95 68%,#0f1028 100%);z-index:0"></div>

    <!-- Animated orbs (purple glow) -->
    <div style="position:absolute;width:520px;height:520px;border-radius:50%;background:radial-gradient(circle,rgba(124,58,237,.28) 0%,transparent 70%);top:-120px;left:-80px;animation:orbFloat 9s ease-in-out infinite;z-index:1"></div>
    <div style="position:absolute;width:380px;height:380px;border-radius:50%;background:radial-gradient(circle,rgba(168,85,247,.22) 0%,transparent 70%);bottom:-60px;right:-40px;animation:orbFloat 12s ease-in-out infinite reverse;z-index:1"></div>
    <div style="position:absolute;width:220px;height:220px;border-radius:50%;background:radial-gradient(circle,rgba(217,70,239,.18) 0%,transparent 70%);top:45%;left:55%;animation:orbFloat 7s ease-in-out infinite 2s;z-index:1"></div>

    <!-- Subtle grid overlay -->
    <div style="position:absolute;inset:0;background-image:linear-gradient(rgba(255,255,255,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.03) 1px,transparent 1px);background-size:48px 48px;z-index:1"></div>

    <!-- Content -->
    <div style="position:relative;z-index:2;display:flex;flex-direction:column;height:100%;padding:3rem 3.5rem">

      <!-- Logo -->
      <div style="margin-bottom:auto">
        <div style="background:white;border-radius:.875rem;padding:.6rem 1rem;display:inline-flex;align-items:center">
          <img src="logo.png" alt="Destiny Springs Healthcare" style="height:48px;width:auto;display:block">
        </div>
      </div>

      <!-- Hero headline -->
      <div style="flex:1;display:flex;flex-direction:column;justify-content:center;padding:2rem 0">
        <div style="font-size:.72rem;font-weight:800;color:#38bdf8;letter-spacing:.2em;text-transform:uppercase;margin-bottom:1.25rem;display:flex;align-items:center;gap:.6rem">
          <span style="display:inline-block;width:28px;height:2px;background:#38bdf8;border-radius:2px"></span>
          Staff Training Portal
        </div>
        <h1 style="font-family:Montserrat,sans-serif;font-weight:900;font-size:clamp(2rem,3.5vw,3.2rem);color:white;line-height:1.08;letter-spacing:-.03em;margin-bottom:1.5rem">
          Healing Minds<br>
          <span style="background:linear-gradient(90deg,#38bdf8,#818cf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">and Restoring</span><br>
          Lives.
        </h1>
        <div id="auth-tagline" style="margin-bottom:2.5rem;max-width:420px;color:#94a3b8;font-size:.95rem;line-height:1.75;font-weight:600">
          Master psychiatric de-escalation techniques through immersive training built for Destiny Springs Healthcare staff.
        </div>
        <div style="width:100%;margin-top:1.5rem;border-radius:1rem;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.4)">
          <img src="dsh.png" alt="Destiny Springs Healthcare" style="width:100%;display:block;object-fit:cover">
        </div>
      </div>

      <!-- Footer strip -->
      <div style="border-top:1px solid rgba(255,255,255,.15);padding-top:1.5rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem">
        <div style="display:flex;align-items:center;gap:.6rem">
          <span id="auth-copyright" style="font-size:.82rem;color:#cbd5e1;font-weight:600">© 2026 De-escalation Mastery Lab™</span>
          <span style="color:#475569;font-size:.9rem">·</span>
          <a href="https://www.destinyspringshealthcare.com/" target="_blank" style="font-size:.82rem;color:#7dd3fc;text-decoration:none;font-weight:700">destinyspringshealthcare.com</a>
        </div>
        <span style="font-size:.8rem;color:#94a3b8;font-weight:500">17300 N Dysart Rd, Surprise AZ 85378</span>
      </div>
    </div>
  </div>

  <!-- ── RIGHT FORM PANEL ── -->
  <div style="width:460px;flex-shrink:0;background:#f8fafc;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:3rem 2.75rem 2.75rem;overflow-y:auto;position:relative;row-gap:1rem">

    <!-- Top decoration bar -->
    <div style="position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#0369a1,#2563eb,#7c3aed)"></div>

    <!-- Mobile logo (shows only when left panel hidden) -->
    <div style="display:none;text-align:center;margin-bottom:2rem" id="mobile-logo-block">
      <div class="logo-inline" style="max-width:260px;margin:0 auto"></div>
    </div>

    <!-- Tab switcher -->
    <div style="width:100%;margin-bottom:2rem">
      <div style="font-family:Montserrat,sans-serif;font-weight:900;font-size:1.45rem;color:#0f172a;margin-bottom:.3rem" id="auth-panel-title">Welcome back</div>
      <p style="font-size:.82rem;color:#64748b;margin-bottom:1.5rem" id="auth-panel-sub">Sign in to continue your training.</p>
      <div style="display:flex;background:#e2e8f0;border-radius:12px;padding:4px;gap:4px">
        <button onclick="showAuthTab('login')" id="tab-login"
          style="flex:1;padding:.65rem;border-radius:9px;border:none;font-size:.82rem;font-weight:800;cursor:pointer;transition:all .2s;background:white;color:#0f172a;box-shadow:0 1px 4px rgba(0,0,0,.1)">
          Sign In
        </button>
        <button onclick="showAuthTab('signup')" id="tab-signup"
          style="flex:1;padding:.65rem;border-radius:9px;border:none;font-size:.82rem;font-weight:800;cursor:pointer;transition:all .2s;background:transparent;color:#64748b">
          Create Account
        </button>
      </div>
    </div>

    <!-- Sign In Form -->
    <div id="login-form" style="width:100%">
      <div style="display:flex;flex-direction:column;gap:.875rem">
        <div>
          <label style="font-size:.72rem;font-weight:800;color:#475569;text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:.4rem">Work Email</label>
          <input id="li-email" class="input-field" type="email" placeholder="your.email@destinysprings.com" style="width:100%">
        </div>
        <div>
          <label style="font-size:.72rem;font-weight:800;color:#475569;text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:.4rem">Password</label>
          <input id="li-pass" class="input-field" type="password" placeholder="••••••••" style="width:100%" onkeydown="if(event.key==='Enter')doSignIn()">
        </div>
        <button class="btn btn-primary w-full" style="padding:1rem;font-size:.9rem;margin-top:.25rem;border-radius:12px;background:linear-gradient(135deg,#1d4ed8,#2563eb);box-shadow:0 4px 16px rgba(37,99,235,.35)" onclick="doSignIn()">
          Sign In →
        </button>
        <div style="display:flex;align-items:center;gap:.5rem;margin:1rem 0 .75rem">
          <div style="flex:1;height:1px;background:#e2e8f0"></div>
          <span style="font-size:.75rem;color:#94a3b8;font-weight:700">or</span>
          <div style="flex:1;height:1px;background:#e2e8f0"></div>
        </div>
        <button class="btn w-full" style="padding:.9rem;font-size:.9rem;border-radius:12px;background:white;color:#0f172a;font-weight:800;border:1px solid #e2e8f0;gap:.6rem" onclick="doGoogleSignIn()">
          <span style="font-size:1.05rem">🟢</span> Continue with Google
        </button>
        <button class="btn w-full" style="padding:.85rem;font-size:.85rem;border-radius:12px;background:#f8fafc;color:#0f172a;font-weight:800;border:1px dashed #cbd5e1;gap:.6rem;margin-top:.6rem" onclick="doAnonSignIn()">
          <span style="font-size:1.05rem">👤</span> Continue as guest (anonymous)
        </button>
      </div>
      <p style="text-align:center;font-size:.75rem;color:#94a3b8;margin-top:1.5rem">
        Don't have an account?
        <button onclick="showAuthTab('signup')" style="background:none;border:none;color:#2563eb;font-weight:800;cursor:pointer;font-size:.75rem">Create one</button>
      </p>
    </div>

    <!-- Create Account Form -->
    <div id="signup-form" style="display:none;width:100%">
      <div style="display:flex;flex-direction:column;gap:.75rem">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
          <div>
            <label style="font-size:.68rem;font-weight:800;color:#475569;text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:.35rem">First Name *</label>
            <input id="su-fname" class="input-field" type="text" placeholder="Jane">
          </div>
          <div>
            <label style="font-size:.68rem;font-weight:800;color:#475569;text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:.35rem">Last Name *</label>
            <input id="su-lname" class="input-field" type="text" placeholder="Doe">
          </div>
        </div>
        <div>
          <label style="font-size:.68rem;font-weight:800;color:#475569;text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:.35rem">Work Email *</label>
          <input id="su-email" class="input-field" type="email" placeholder="jane.doe@destinysprings.com">
        </div>
        <div>
          <label style="font-size:.68rem;font-weight:800;color:#475569;text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:.35rem">Mobile Phone *</label>
          <input id="su-phone" class="input-field" type="tel" placeholder="(623) 555-0100">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
          <div>
            <label style="font-size:.68rem;font-weight:800;color:#475569;text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:.35rem">Job Title *</label>
            <input id="su-title" class="input-field" type="text" placeholder="RN, MHT, etc.">
          </div>
          <div>
            <label style="font-size:.68rem;font-weight:800;color:#475569;text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:.35rem">Department *</label>
            <input id="su-dept" class="input-field" type="text" placeholder="Inpatient, Admin…">
          </div>
        </div>
        <div>
          <label style="font-size:.68rem;font-weight:800;color:#475569;text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:.35rem">Employee ID <span style="font-weight:500;text-transform:none">(optional)</span></label>
          <input id="su-empid" class="input-field" type="text" placeholder="DSH-00000">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
          <div>
            <label style="font-size:.68rem;font-weight:800;color:#475569;text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:.35rem">Password *</label>
            <input id="su-pass" class="input-field" type="password" placeholder="min 6 chars">
          </div>
          <div>
            <label style="font-size:.68rem;font-weight:800;color:#475569;text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:.35rem">Confirm *</label>
            <input id="su-conf" class="input-field" type="password" placeholder="repeat password">
          </div>
        </div>
        <button id="signup-btn" class="btn w-full" style="padding:.95rem;font-size:.9rem;margin-top:.25rem;border-radius:12px;background:linear-gradient(135deg,#059669,#10b981);color:white;font-weight:800;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(16,185,129,.3)" onclick="doSignUp()">
          Create Account →
        </button>
        <p style="font-size:.68rem;color:#94a3b8;text-align:center;line-height:1.5">
          <span id="auth-privacy">Your information is stored securely and used only for Destiny Springs Healthcare training purposes.</span>
        </p>
        <div style="display:flex;align-items:center;gap:.5rem;margin:1rem 0 .75rem">
          <div style="flex:1;height:1px;background:#e2e8f0"></div>
          <span style="font-size:.75rem;color:#94a3b8;font-weight:700">or</span>
          <div style="flex:1;height:1px;background:#e2e8f0"></div>
        </div>
        <button class="btn w-full" style="padding:.9rem;font-size:.9rem;border-radius:12px;background:white;color:#0f172a;font-weight:800;border:1px solid #e2e8f0;gap:.6rem" onclick="doGoogleSignIn()">
          <span style="font-size:1.05rem">🟢</span> Continue with Google
        </button>
        <button class="btn w-full" style="padding:.85rem;font-size:.85rem;border-radius:12px;background:#f8fafc;color:#0f172a;font-weight:800;border:1px dashed #cbd5e1;gap:.6rem;margin-top:.6rem" onclick="doAnonSignIn()">
          <span style="font-size:1.05rem">👤</span> Continue as guest (anonymous)
        </button>
      </div>
      <p style="text-align:center;font-size:.75rem;color:#94a3b8;margin-top:1rem">
        Already have an account?
        <button onclick="showAuthTab('login')" style="background:none;border:none;color:#2563eb;font-weight:800;cursor:pointer;font-size:.75rem">Sign in</button>
      </p>
    </div>

    <div id="auth-error" class="mt-3 text-red-600 text-sm font-semibold text-center" style="display:none;width:100%"></div>

    <!-- Trust badges -->
    <div style="width:100%;margin-top:2rem;padding-top:1.5rem;border-top:1px solid #e2e8f0;display:flex;align-items:center;justify-content:center;gap:1.5rem;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:.4rem">
        <span style="font-size:.9rem">🔒</span>
        <span style="font-size:.68rem;color:#94a3b8;font-weight:700">Secure Login</span>
      </div>
      <div style="display:flex;align-items:center;gap:.4rem">
        <span style="font-size:.9rem">📍</span>
        <span style="font-size:.68rem;color:#94a3b8;font-weight:700">Surprise, AZ</span>
      </div>
    </div>
  </div>

</div>

<!-- ═══════════════ 3-STEP ONBOARDING TUTORIAL ═══════════════ -->
<div id="tutorial-overlay" style="display:none;position:fixed;inset:0;z-index:200;background:rgba(5,10,24,.95);backdrop-filter:blur(12px);align-items:center;justify-content:center;padding:1rem">
  <div style="width:100%;max-width:520px;background:white;border-radius:1.4rem;overflow:hidden;box-shadow:0 28px 70px rgba(0,0,0,.6);position:relative">
    <!-- Skip button -->
    <button onclick="closeTutorial()" style="position:absolute;top:.8rem;right:.8rem;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.25);padding:.3rem .7rem;border-radius:.6rem;color:rgba(255,255,255,.85);font-weight:800;font-size:.78rem;cursor:pointer;z-index:2">Skip</button>
    <!-- Portrait header -->
    <div style="background:linear-gradient(135deg,#0f1f5c,#1d4ed8,#6d28d9);padding:1.5rem 1.5rem .9rem;display:flex;align-items:center;gap:1rem">
      <img src="prof.png" id="tut-portrait" style="width:76px;height:76px;border-radius:50%;object-fit:cover;object-position:top center;border:3px solid rgba(255,255,255,.55);flex-shrink:0;box-shadow:0 4px 16px rgba(0,0,0,.35)" alt="Professor Vance">
      <div style="color:white;flex:1;min-width:0">
        <div style="font-size:.6rem;font-weight:900;text-transform:uppercase;letter-spacing:.14em;opacity:.75">Professor Vance &middot; Clinical Mentor</div>
        <div id="tut-title" style="font-size:1.12rem;font-weight:900;line-height:1.25;margin-top:.25rem">Welcome to the Lab</div>
        <div id="tut-subtitle" style="font-size:.8rem;font-weight:600;opacity:.75;margin-top:.1rem">De-escalation Training Unit</div>
      </div>
    </div>
    <!-- Step dots -->
    <div style="display:flex;justify-content:center;gap:.55rem;padding:.65rem 1.5rem .1rem;background:#f8fafc">
      <div id="tut-dot-0" style="width:9px;height:9px;border-radius:50%;background:#2563eb;transition:background .3s"></div>
      <div id="tut-dot-1" style="width:9px;height:9px;border-radius:50%;background:#cbd5e1;transition:background .3s"></div>
      <div id="tut-dot-2" style="width:9px;height:9px;border-radius:50%;background:#cbd5e1;transition:background .3s"></div>
      <div id="tut-dot-3" style="width:9px;height:9px;border-radius:50%;background:#cbd5e1;transition:background .3s"></div>
    </div>
    <!-- Body -->
    <div style="padding:1.2rem 1.5rem 0">
      <div id="tut-icon" style="font-size:2rem;margin-bottom:.4rem">&#127891;</div>
      <p id="tut-body" style="color:#374151;font-weight:600;font-size:.96rem;line-height:1.72;margin:0 0 .9rem"></p>
      <div style="background:#eff6ff;border-left:4px solid #2563eb;border-radius:0 .6rem .6rem 0;padding:.7rem 1rem;margin-bottom:1.1rem">
        <div style="font-size:.6rem;font-weight:900;text-transform:uppercase;letter-spacing:.1em;color:#1d4ed8;margin-bottom:.25rem">&#127891; Prof. Vance says</div>
        <p id="tut-tip" style="color:#1e3a8a;font-weight:700;font-size:.87rem;line-height:1.65;margin:0;font-style:italic"></p>
      </div>
    </div>
    <!-- Nav -->
    <div style="display:flex;align-items:center;gap:.75rem;padding:.7rem 1.5rem 1.2rem">
      <button id="tut-back-btn" onclick="tutStep(-1)" style="border:1px solid #e2e8f0;background:#f8fafc;color:#475569;padding:.6rem 1rem;border-radius:.85rem;font-weight:800;font-size:.88rem;cursor:pointer;display:none">&larr; Back</button>
      <div style="flex:1"></div>
      <button id="tut-next-btn" style="border:none;background:#2563eb;color:white;padding:.7rem 1.5rem;border-radius:.9rem;font-weight:900;font-size:.95rem;cursor:pointer;box-shadow:0 4px 14px rgba(37,99,235,.4)">Next &rarr;</button>
    </div>
  </div>
</div>

<!-- Home gateway overlay -->
<div id="home-gateway">
  <!-- Due-date notification banner (populated by JS) -->
  <div id="due-date-banner" style="display:none;width:100%;max-width:1100px;margin-bottom:1rem"></div>
  <div style="width:100%;max-width:1100px;display:grid;grid-template-columns:1.1fr 1fr;gap:1.75rem;align-items:center;color:#e2e8f0">
    <div style="display:flex;flex-direction:column;gap:1.1rem">
      <div class="logo-inline" aria-label="Destiny Springs Healthcare logo" style="max-width:360px;width:100%"></div>
      <div id="hub-heading" style="font-family:Montserrat,sans-serif;font-weight:900;font-size:clamp(2rem,4vw,2.7rem);line-height:1.05;color:white">Welcome back to the Destiny Springs De-escalation Mastery Lab™</div>
      <p style="color:#cbd5e1;font-size:1rem;line-height:1.7;max-width:640px;font-weight:600">Pick where you want to go. Restart the full training from slide one, or jump straight into the live Lab to practice scenarios. Your XP, level, and lab credits stay with you.</p>
      <div style="display:flex;flex-wrap:wrap;gap:1rem;color:#94a3b8;font-weight:700;font-size:.9rem">
        <div id="hub-org-pill" style="display:flex;align-items:center;gap:.5rem;padding:.65rem 1rem;border-radius:.9rem;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)">Destiny Springs Healthcare</div>
        <div style="display:flex;align-items:center;gap:.5rem;padding:.65rem 1rem;border-radius:.9rem;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)">Interactive Module Training</div>
        <div style="display:flex;align-items:center;gap:.5rem;padding:.65rem 1rem;border-radius:.9rem;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)">Lab simulations</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr;gap:1rem">
      <button onclick="resumeTrainingFromHub()" style="border:none;cursor:pointer;padding:0;border-radius:1.1rem;text-align:left;overflow:hidden;position:relative;box-shadow:0 20px 50px rgba(34,197,94,.28);transition:transform .2s,box-shadow .2s;min-height:110px">
        <img src="lab.png" class="tenant-lab-bg" alt="" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.45)">
        <div style="position:absolute;inset:0;background:linear-gradient(135deg,rgba(22,163,74,.7),rgba(34,197,94,.5))"></div>
        <div style="position:relative;z-index:1;padding:1.4rem 1.2rem;color:white">
          <div style="display:flex;flex-direction:column;gap:.45rem">
            <div style="font-size:1.2rem;font-weight:900;font-family:Montserrat,sans-serif">Resume where I left off</div>
            <div style="font-size:.95rem;font-weight:600;opacity:.9">Jump back to your last slide and keep your progress.</div>
            <div style="font-size:.8rem;font-weight:800;letter-spacing:.08em;text-transform:uppercase;opacity:.8">Progress auto-saved</div>
          </div>
        </div>
      </button>
      <button onclick="startTrainingFromHub()" style="border:none;cursor:pointer;padding:0;border-radius:1.1rem;text-align:left;overflow:hidden;position:relative;box-shadow:0 20px 50px rgba(79,70,229,.35);transition:transform .2s,box-shadow .2s;min-height:110px">
        <img src="lab.png" class="tenant-lab-bg" alt="" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.35)">
        <div style="position:absolute;inset:0;background:linear-gradient(135deg,rgba(37,99,235,.72),rgba(124,58,237,.6))"></div>
        <div style="position:relative;z-index:1;padding:1.4rem 1.2rem;color:white">
          <div style="display:flex;flex-direction:column;gap:.45rem">
            <div style="font-size:1.2rem;font-weight:900;font-family:Montserrat,sans-serif">Redo Training from Slide 1</div>
            <div style="font-size:.95rem;font-weight:600;opacity:.9">Reset to the welcome slide and walk the full program again.</div>
            <div style="font-size:.8rem;font-weight:800;letter-spacing:.08em;text-transform:uppercase;opacity:.8">Includes quizzes, XP, and certificate</div>
          </div>
        </div>
      </button>
      <button onclick="enterLabFromHub()" style="border:none;cursor:pointer;padding:0;border-radius:1.1rem;text-align:left;overflow:hidden;position:relative;box-shadow:0 20px 50px rgba(16,185,129,.28);transition:transform .2s,box-shadow .2s;min-height:110px">
        <img src="lab.png" class="tenant-lab-bg" alt="" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.55)">
        <div style="position:absolute;inset:0;background:linear-gradient(135deg,rgba(14,165,233,.55),rgba(34,197,94,.45))"></div>
        <div style="position:relative;z-index:1;padding:1.4rem 1.2rem;color:white">
          <div style="display:flex;flex-direction:column;gap:.45rem">
            <div style="font-size:1.2rem;font-weight:900;font-family:Montserrat,sans-serif">Enter the Lab</div>
            <div style="font-size:.95rem;font-weight:600;opacity:.9">Skip straight to live scenarios and earn Lab Credits.</div>
            <div style="font-size:.8rem;font-weight:800;letter-spacing:.08em;text-transform:uppercase;opacity:.8">Practice mode · Immediate feedback</div>
          </div>
        </div>
      </button>
      <!-- Daily Drill Button -->
      <button onclick="openDrillModal()" style="border:none;cursor:pointer;padding:0;border-radius:1.1rem;text-align:left;overflow:hidden;position:relative;box-shadow:0 16px 40px rgba(245,158,11,.3);transition:transform .2s,box-shadow .2s;min-height:90px" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
        <div style="position:absolute;inset:0;background:linear-gradient(135deg,#f59e0b,#d97706)"></div>
        <div style="position:relative;z-index:1;padding:1.1rem 1.2rem;color:white;display:flex;align-items:center;gap:1rem">
          <div style="font-size:1.7rem;flex-shrink:0">⚡</div>
          <div style="flex:1">
            <div style="font-size:1.05rem;font-weight:900;font-family:Montserrat,sans-serif">5-Min Daily Drill</div>
            <div style="font-size:.82rem;font-weight:600;opacity:.9">One skill card · one live scenario · build your streak.</div>
          </div>
          <div id="hub-streak-badge" style="display:none;background:rgba(0,0,0,.25);border:2px solid rgba(255,255,255,.3);border-radius:1rem;padding:.35rem .75rem;font-size:.82rem;font-weight:900;white-space:nowrap;flex-shrink:0">🔥 0</div>
        </div>
      </button>
      <button onclick="openTutorial()" style="border:none;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);cursor:pointer;padding:.7rem 1.2rem;border-radius:.9rem;text-align:center;color:#94a3b8;font-weight:800;font-size:.82rem;letter-spacing:.04em" onmouseover="this.style.color='white'" onmouseout="this.style.color='#94a3b8'">
        Replay Tutorial
      </button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════ ADMIN MODAL ══ -->
<div id="admin-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:150;align-items:center;justify-content:center;padding:1rem">
  <div class="card w-full max-w-5xl" style="max-height:90vh;overflow:hidden;display:flex;flex-direction:column">
    <div class="p-6 border-b border-slate-200 flex items-center justify-between flex-shrink-0">
      <div><h2 class="text-xl font-black text-slate-900">🏥 Command Center</h2><p id="admin-role-badge" class="text-xs text-slate-400 font-semibold">Destiny Springs Healthcare — Training Management</p></div>
      <button onclick="closeAdmin()" class="w-9 h-9 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center font-black text-slate-600">✕</button>
    </div>
    <div class="flex gap-0 border-b border-slate-200 px-6 flex-shrink-0" style="overflow-x:auto">
      <button class="admin-tab-btn py-3 px-4 text-xs font-black uppercase tracking-widest border-b-2 border-blue-600 text-blue-600 whitespace-nowrap" onclick="adminTab('leaderboard',this)">🏆 Leaderboard</button>
      <button class="admin-tab-btn py-3 px-4 text-xs font-black uppercase tracking-widest border-b-2 border-transparent text-slate-400 whitespace-nowrap" onclick="adminTab('users',this)">👥 Users</button>
      <button class="admin-tab-btn py-3 px-4 text-xs font-black uppercase tracking-widest border-b-2 border-transparent text-slate-400 whitespace-nowrap" onclick="adminTab('analytics',this)">📈 Analytics</button>
      <button class="admin-tab-btn py-3 px-4 text-xs font-black uppercase tracking-widest border-b-2 border-transparent text-slate-400 whitespace-nowrap" onclick="adminTab('reports',this)">📋 Reports</button>
      <button class="admin-tab-btn py-3 px-4 text-xs font-black uppercase tracking-widest border-b-2 border-transparent text-slate-400 whitespace-nowrap" onclick="adminTab('completion',this)">✅ Completion</button>
      <button id="settings-tab-btn" class="admin-tab-btn py-3 px-4 text-xs font-black uppercase tracking-widest border-b-2 border-transparent text-slate-400 whitespace-nowrap" onclick="adminTab('settings',this)" style="display:none">⚙️ Settings</button>
      <button id="audit-tab-btn" class="admin-tab-btn py-3 px-4 text-xs font-black uppercase tracking-widest border-b-2 border-transparent text-slate-400 whitespace-nowrap" onclick="adminTab('audit',this)" style="display:none">🔍 Audit Log</button>
    </div>
    <div class="flex-1 overflow-y-auto p-6">
      <div id="at-leaderboard"></div>
      <div id="at-users" style="display:none"></div>
      <div id="at-analytics" style="display:none"></div>
      <div id="at-reports" style="display:none"></div>
      <div id="at-completion" style="display:none"></div>
      <div id="at-settings" style="display:none"></div>
      <div id="at-audit" style="display:none"></div>
    </div>
  </div>
</div>

<!-- ═════════════════════════════════════ LAB ROOM MODAL ══ -->
<div id="lab-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:145;align-items:center;justify-content:center;padding:1rem">
  <div class="card" style="width:100%;max-width:980px;max-height:92vh;overflow:hidden;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;border-bottom:1px solid #e2e8f0">
      <div>
        <h3 style="margin:0;font-size:1.2rem;font-weight:900;color:#0f172a">🧪 Laboratory Room</h3>
        <p style="margin:0;color:#64748b;font-weight:600;font-size:.85rem">Earn Lab Credits by running live de-escalation scenarios.</p>
      </div>
      <div style="display:flex;align-items:center;gap:.75rem">
        <div style="background:#ecfdf3;border:1px solid #bbf7d0;padding:.4rem .75rem;border-radius:.75rem;font-weight:800;color:#15803d;font-size:.85rem">Credits: <span id="lab-modal-credits">0</span></div>
        <button onclick="closeLabRoom()" style="width:36px;height:36px;border-radius:50%;background:#f1f5f9;border:none;font-weight:900;color:#475569;cursor:pointer">✕</button>
      </div>
    </div>
    <!-- Tab bar -->
    <div style="display:flex;gap:0;border-bottom:2px solid #e2e8f0;padding:0 1.25rem;background:#f8fafc">
      <button id="lab-tab-btn-scenarios" onclick="switchLabTab('scenarios')" style="padding:.65rem 1.1rem;font-size:.85rem;font-weight:800;border:none;cursor:pointer;border-bottom:3px solid #2563eb;color:#2563eb;background:transparent;margin-bottom:-2px">🎲 Scenarios</button>
      <button id="lab-tab-btn-debrief" onclick="switchLabTab('debrief')" style="padding:.65rem 1.1rem;font-size:.85rem;font-weight:800;border:none;cursor:pointer;border-bottom:3px solid transparent;color:#64748b;background:transparent;margin-bottom:-2px">🎓 Debrief</button>
      <button id="lab-tab-btn-script" onclick="switchLabTab('script')" style="padding:.65rem 1.1rem;font-size:.85rem;font-weight:800;border:none;cursor:pointer;border-bottom:3px solid transparent;color:#64748b;background:transparent;margin-bottom:-2px">📝 Script Builder</button>
      <button id="lab-tab-btn-microexp" onclick="switchLabTab('microexp')" style="padding:.65rem 1.1rem;font-size:.85rem;font-weight:800;border:none;cursor:pointer;border-bottom:3px solid transparent;color:#64748b;background:transparent;margin-bottom:-2px">👁 Micro-Exp</button>
    </div>
    <div style="padding:1.25rem;overflow-y:auto;flex:1">

      <!-- TAB: Scenarios -->
      <div id="lab-tab-scenarios">
        <!-- Patient Selector -->
        <div id="patient-selector" style="display:flex;gap:.5rem;margin-bottom:.65rem;flex-wrap:wrap"></div>
        <!-- Patient Status Bar -->
        <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:.85rem;background:#0f172a;border-radius:.875rem;padding:.6rem 1rem">
          <div id="lab-patient-avatar-wrap" style="width:36px;height:36px;border-radius:50%;border:2px solid #2563eb;flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:.75rem;color:white;background:#2563eb">
            <img id="lab-patient-avatar-img" src="prof.png" style="width:100%;height:100%;object-fit:cover;object-position:top;display:block" alt="">
          </div>
          <div style="flex:1">
            <div style="font-size:.68rem;font-weight:900;text-transform:uppercase;letter-spacing:.1em;color:#475569">Patient Status</div>
            <div id="lab-patient-name" style="font-weight:800;color:white;font-size:.9rem">Marcus <span style="font-size:.75rem;font-weight:600;color:#94a3b8">— Combat PTSD, evaluation pending</span></div>
          </div>
          <div id="marcus-state-badge" style="padding:.3rem .85rem;border-radius:1rem;font-weight:900;font-size:.8rem;background:#dcfce7;color:#166534;border:1px solid #bbf7d0">&#x26AB; Neutral</div>
        </div>
        <div style="display:grid;grid-template-columns:1.1fr 0.9fr;gap:1rem;align-items:start">
        <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:1rem;padding:1rem">
          <div style="display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:1rem">
            <select id="lab-dx" class="input-field" style="flex:1;min-width:180px">
              <option value="autism">Autism</option>
              <option value="adhd">ADHD</option>
              <option value="schizophrenia">Schizophrenia</option>
              <option value="bipolar">Bipolar</option>
              <option value="ptsd">PTSD</option>
              <option value="bpd">BPD</option>
            </select>
            <select id="lab-diff" class="input-field" style="width:180px">
              <option value="standard">Standard</option>
              <option value="advanced">Advanced (+10% LC)</option>
              <option value="intensive">Intensive (+20% LC)</option>
            </select>
            <button class="btn btn-primary" onclick="generateLabScenario()" style="padding:.65rem 1.1rem;font-size:.85rem;font-weight:800">🎲 New Scenario</button>
          </div>
          <div id="lab-scenario-box" style="background:white;border:1px solid #e2e8f0;border-radius:.875rem;padding:1rem;min-height:140px;color:#0f172a;font-weight:600;line-height:1.6">Pick a diagnosis and click New Scenario.</div>
        </div>
        <div style="background:#fffaf5;border:1px solid #fed7aa;border-radius:1rem;padding:1rem">
          <h4 style="margin:0 0 .5rem;font-size:.95rem;font-weight:900;color:#92400e">Earning Rules</h4>
          <ul style="margin:0;padding-left:1.1rem;color:#92400e;font-weight:700;font-size:.86rem;line-height:1.6">
            <li>Base: 50 Lab Credits per completed scenario.</li>
            <li>Score bonus: A +50, B +30, C +15, D +5.</li>
            <li>Run each scenario once per day for credits (replays allowed, no credits).</li>
            <li>Difficulty advanced/intensive adds +10%/+20% to total credits.</li>
          </ul>
          <div style="margin-top:.65rem;font-size:.82rem;color:#b45309;font-weight:700">Redemption tiers: 300 · 600 · 1000 · 1800 LC (set in settings).</div>
        </div>
      </div>
      <div style="margin-top:1rem;display:grid;grid-template-columns:1fr 1fr;gap:1rem">
        <textarea id="lab-response" class="input-field" placeholder="Type your de-escalation response..." style="height:180px;resize:vertical"></textarea>
        <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:1rem;padding:1rem;display:flex;flex-direction:column;gap:.75rem">
          <button id="lab-submit-btn" class="btn btn-success" onclick="submitLabScenario()" style="width:100%">Submit Response</button>
          <div id="lab-score-panel" style="display:none;background:white;border:1px solid #e2e8f0;border-radius:.875rem;padding:.75rem">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:900;color:#0f172a;font-size:1rem">Score: <span id="lab-score-letter">—</span></div>
              <div style="font-weight:900;color:#16a34a;font-size:.95rem">+<span id="lab-lc-earned">0</span> LC</div>
            </div>
            <div id="lab-feedback" style="margin-top:.5rem;color:#475569;white-space:pre-wrap;font-size:.85rem;line-height:1.5"></div>
            <div id="lab-cooldown" style="margin-top:.4rem;color:#dc2626;font-weight:800;display:none;font-size:.82rem"></div>
            <!-- Marcus in-character reply -->
            <div id="marcus-reply-wrap" style="display:none;margin-top:.85rem;background:#0f172a;border-radius:.875rem;overflow:hidden">
              <div style="padding:.4rem .85rem;background:#1e293b;display:flex;align-items:center;gap:.6rem">
                <div id="reply-patient-avatar-wrap" style="width:24px;height:24px;border-radius:50%;border:2px solid #475569;flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:.6rem;color:white;background:#475569">
                  <img id="reply-patient-avatar-img" src="prof.png" style="width:100%;height:100%;object-fit:cover;object-position:top;display:block" alt="">
                </div>
                <span id="reply-patient-label" style="font-size:.68rem;font-weight:900;text-transform:uppercase;letter-spacing:.1em;color:#94a3b8">Marcus responds</span>
                <span id="marcus-reply-state-dot" style="margin-left:auto;font-size:.72rem;font-weight:800;padding:.15rem .55rem;border-radius:1rem"></span>
              </div>
              <div style="padding:.75rem 1rem">
                <p id="marcus-reply-text" style="margin:0;color:#e2e8f0;font-size:.9rem;font-weight:600;line-height:1.65;font-style:italic">…</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      </div><!-- end tab scenarios -->

      <!-- TAB: Debrief -->
      <div id="lab-tab-debrief" style="display:none">
        <p style="margin:0 0 1rem;color:#64748b;font-size:.88rem;font-weight:700">Describe a real or practice incident. Dr. Rivera will review it and provide structured clinical feedback.</p>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <div style="display:flex;flex-direction:column;gap:.5rem">
            <label style="font-size:.75rem;font-weight:800;color:#475569;text-transform:uppercase;letter-spacing:.06em">📝 What happened?</label>
            <textarea id="debrief-input" class="input-field" placeholder="Describe the incident, what you tried, and how it went. Be specific..." style="height:280px;resize:vertical"></textarea>
            <button id="debrief-btn" class="btn btn-primary" onclick="runDebrief()" style="width:100%">Get Clinical Feedback ✨</button>
          </div>
          <div style="display:flex;flex-direction:column;gap:.5rem">
            <label style="font-size:.75rem;font-weight:800;color:#475569;text-transform:uppercase;letter-spacing:.06em">🎓 Clinical Mentor Analysis</label>
            <div id="debrief-output" style="flex:1;min-height:280px;background:#1e1b4b;border:1px solid #4338ca;border-radius:.875rem;padding:1rem;color:#c7d2fe;font-size:.875rem;line-height:1.6;font-weight:600;overflow-y:auto;white-space:pre-wrap"><span style="opacity:.5">Your mentor's feedback will appear here...</span></div>
          </div>
        </div>
      </div><!-- end tab debrief -->

      <!-- TAB: Script Builder -->
      <div id="lab-tab-script" style="display:none">
        <p style="margin:0 0 1rem;color:#64748b;font-size:.88rem;font-weight:700">Generate a realistic roleplay script for a team huddle or training drill from any scenario topic.</p>
        <div style="display:flex;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap">
          <input id="script-topic" class="input-field" placeholder="e.g. Medication refusal, PTSD flashback, manic episode..." style="flex:1;min-width:220px">
          <button id="script-btn" class="btn btn-primary" onclick="buildLabScriptAI()">Build Script ✨</button>
        </div>
        <div id="script-output" style="background:#0f172a;border:1px solid rgba(255,255,255,.1);border-radius:.875rem;padding:1.25rem;color:#4ade80;font-family:monospace;font-size:.85rem;line-height:1.7;min-height:300px;overflow-y:auto;white-space:pre-wrap"><span style="opacity:.5">Roleplay script appears here...</span></div>
      </div><!-- end tab script -->

      <!-- TAB: Micro-Expression Drill -->
      <div id="lab-tab-microexp" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.85rem;flex-wrap:wrap;gap:.75rem">
          <div>
            <h4 style="margin:0;font-size:1rem;font-weight:900;color:#0f172a">Micro-Expression Speed Drill</h4>
            <p style="margin:.2rem 0 0;color:#64748b;font-size:.83rem;font-weight:600">You have 3 seconds to identify Marcus's emotion. React faster than he escalates.</p>
          </div>
          <div style="display:flex;align-items:center;gap:.75rem">
            <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:.75rem;padding:.35rem .75rem;font-size:.82rem;font-weight:800;color:#15803d">Score: <span id="microexp-score">0</span>/<span id="microexp-total">0</span></div>
            <button onclick="startMicroExpDrill()" style="border:none;background:#2563eb;color:white;padding:.55rem 1.1rem;border-radius:.85rem;font-weight:900;font-size:.85rem;cursor:pointer">▶ Start Drill</button>
          </div>
        </div>
        <div style="background:#1e293b;border-radius:1rem;overflow:hidden;margin-bottom:.85rem">
          <!-- Header bar with timer -->
          <div style="padding:.45rem .9rem;background:#0f172a;display:flex;align-items:center;justify-content:space-between">
            <span style="color:#94a3b8;font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.1em">Marcus · Read the expression</span>
            <div id="microexp-timer-bar-wrap" style="width:120px;height:5px;background:rgba(255,255,255,.15);border-radius:3px;overflow:hidden;display:none">
              <div id="microexp-timer-bar" style="height:5px;background:#22c55e;width:100%;border-radius:3px"></div>
            </div>
          </div>
          <!-- Expression image — full visibility, NO text overlay -->
          <div style="background:#111827;display:flex;align-items:center;justify-content:center;min-height:200px">
            <img id="microexp-image" src="microexpressions.png" alt="Marcus expression" style="width:100%;max-height:320px;object-fit:contain;display:block">
          </div>
          <!-- Scenario prompt text — below the image, never on top of it -->
          <div style="padding:.9rem 1rem 1.1rem;background:#0f172a">
            <div id="microexp-prompt" style="color:#e2e8f0;font-size:.95rem;font-weight:700;line-height:1.65;text-align:center">Click Start Drill to begin</div>
            <div style="text-align:center;margin-top:.6rem">
              <span id="microexp-result-badge" style="display:none;padding:.35rem .9rem;border-radius:1rem;font-weight:900;font-size:.88rem"></span>
            </div>
            <div style="text-align:center;margin-top:.75rem">
              <button id="microexp-next-btn" onclick="nextMicroExpRound()" style="display:none;border:none;background:#2563eb;color:white;font-weight:900;padding:.65rem 1.8rem;border-radius:.875rem;font-size:.92rem;cursor:pointer;letter-spacing:.01em">Next Round →</button>
            </div>
          </div>
        </div>
        <div id="microexp-buttons" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:.6rem;margin-bottom:.85rem">
          <button onclick="answerMicroExp('Anger')" style="border:2px solid #fca5a5;background:#fff5f5;color:#b91c1c;font-weight:900;padding:.7rem .4rem;border-radius:.875rem;cursor:pointer;font-size:.88rem">😠 Anger</button>
          <button onclick="answerMicroExp('Fear')" style="border:2px solid #bfdbfe;background:#eff6ff;color:#1d4ed8;font-weight:900;padding:.7rem .4rem;border-radius:.875rem;cursor:pointer;font-size:.88rem">😨 Fear</button>
          <button onclick="answerMicroExp('Sadness')" style="border:2px solid #e9d5ff;background:#faf5ff;color:#7c3aed;font-weight:900;padding:.7rem .4rem;border-radius:.875rem;cursor:pointer;font-size:.88rem">😔 Sadness</button>
          <button onclick="answerMicroExp('Neutral')" style="border:2px solid #d1fae5;background:#f0fdf4;color:#065f46;font-weight:900;padding:.7rem .4rem;border-radius:.875rem;cursor:pointer;font-size:.88rem">😐 Neutral</button>
        </div>
        <div id="microexp-vance-tip" style="background:#eff6ff;border-left:4px solid #2563eb;border-radius:0 .6rem .6rem 0;padding:.7rem 1rem;display:none">
          <div style="font-size:.6rem;font-weight:900;text-transform:uppercase;letter-spacing:.1em;color:#1d4ed8;margin-bottom:.2rem">Prof. Vance</div>
          <p id="microexp-vance-text" style="color:#1e3a8a;font-size:.87rem;font-weight:700;margin:0;font-style:italic"></p>
        </div>
      </div><!-- end tab microexp -->

    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════ DAILY DRILL MODAL ══ -->
<div id="drill-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:148;align-items:center;justify-content:center;padding:1rem">
  <div class="card" style="width:100%;max-width:720px;max-height:92vh;overflow:hidden;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;border-bottom:1px solid #e2e8f0;background:linear-gradient(135deg,#fffbeb,#fff7ed)">
      <div style="display:flex;align-items:center;gap:.85rem">
        <div style="font-size:1.6rem">⚡</div>
        <div>
          <h3 style="margin:0;font-size:1.1rem;font-weight:900;color:#92400e">5-Minute Daily Drill</h3>
          <p style="margin:0;color:#a16207;font-weight:700;font-size:.78rem">One skill card · one scenario · keep your streak alive</p>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:.75rem">
        <div id="drill-streak-display" style="background:#fef3c7;border:2px solid #fcd34d;border-radius:1rem;padding:.4rem .9rem;font-weight:900;color:#92400e;font-size:.88rem">🔥 Start your streak!</div>
        <button onclick="closeDrillModal()" style="width:36px;height:36px;border-radius:50%;background:#f1f5f9;border:none;font-weight:900;color:#475569;cursor:pointer">✕</button>
      </div>
    </div>
    <div style="flex:1;overflow-y:auto;padding:1.25rem">

      <!-- Already-done banner -->
      <div id="drill-done-today" style="display:none;background:linear-gradient(135deg,#ecfdf5,#f0fdf4);border:2px solid #86efac;border-radius:1.25rem;padding:1.75rem;text-align:center">
        <div style="font-size:2.5rem;margin-bottom:.5rem">✅</div>
        <h3 style="font-weight:900;color:#15803d;margin:0 0 .4rem">Drill complete for today!</h3>
        <p style="color:#166534;font-weight:700;font-size:.88rem;margin:0 0 1rem">Your streak is safe. Come back tomorrow to keep it going.</p>
        <div id="drill-done-streak" style="font-size:1.5rem;font-weight:900;color:#15803d"></div>
      </div>

      <!-- Steps wrapper -->
      <div id="drill-steps-wrap">

        <!-- STEP 1: Skill Card flip -->
        <div id="drill-step-1">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.85rem">
            <div style="font-size:.68rem;font-weight:900;text-transform:uppercase;letter-spacing:.1em;color:#a16207;background:#fef3c7;border:1px solid #fcd34d;border-radius:999px;padding:.2rem .65rem">Step 1 of 2 — Skill Card</div>
            <div style="font-size:.75rem;color:#94a3b8;font-weight:700">Tap the card to reveal the answer 🔒</div>
          </div>
          <!-- Flip card wrapper -->
          <div id="drill-flip-card" onclick="flipDrillCard()" style="perspective:1000px;cursor:pointer;margin-bottom:1rem">
            <div id="drill-flip-inner" style="position:relative;width:100%;min-height:210px;transition:transform .55s;transform-style:preserve-3d">
              <!-- Front face -->
              <div style="backface-visibility:hidden;-webkit-backface-visibility:hidden;position:absolute;inset:0;background:linear-gradient(135deg,#1e3a8a,#1d4ed8);border-radius:1.25rem;padding:1.5rem;display:flex;flex-direction:column;justify-content:space-between">
                <div>
                  <div style="font-size:.65rem;font-weight:900;text-transform:uppercase;letter-spacing:.12em;color:#93c5fd;margin-bottom:.55rem" id="drill-card-category">Category</div>
                  <h3 id="drill-card-title" style="font-size:1.15rem;font-weight:900;color:white;margin:0 0 .65rem;font-family:Montserrat,sans-serif">Skill Card</h3>
                  <p id="drill-card-front" style="color:#bfdbfe;font-weight:700;font-size:.9rem;line-height:1.65;margin:0">Loading…</p>
                </div>
                <div style="text-align:right;font-size:.7rem;font-weight:800;color:rgba(255,255,255,.35);margin-top:1rem;letter-spacing:.05em">TAP TO FLIP ↻</div>
              </div>
              <!-- Back face -->
              <div style="backface-visibility:hidden;-webkit-backface-visibility:hidden;position:absolute;inset:0;background:linear-gradient(135deg,#0f172a,#1e293b);border-radius:1.25rem;padding:1.5rem;transform:rotateY(180deg);display:flex;flex-direction:column;justify-content:space-between">
                <div>
                  <div style="font-size:.65rem;font-weight:900;text-transform:uppercase;letter-spacing:.12em;color:#4ade80;margin-bottom:.55rem">Clinical Rationale</div>
                  <p id="drill-card-back" style="color:#e2e8f0;font-weight:700;font-size:.88rem;line-height:1.7;margin:0">Back…</p>
                </div>
                <div style="margin-top:1rem;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.13);border-radius:.75rem;padding:.65rem .9rem">
                  <div style="font-size:.65rem;font-weight:800;color:#94a3b8;margin-bottom:.25rem;text-transform:uppercase;letter-spacing:.08em">Reflect</div>
                  <p id="drill-card-prompt" style="color:#cbd5e1;font-size:.82rem;font-weight:700;margin:0;line-height:1.55"></p>
                </div>
              </div>
            </div>
          </div>
          <div style="text-align:center">
            <button onclick="advanceDrillToStep2()" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border:none;border-radius:.875rem;padding:.75rem 2rem;font-weight:900;font-size:.9rem;cursor:pointer;box-shadow:0 8px 20px rgba(245,158,11,.3)">Next: Practice Scenario →</button>
          </div>
        </div>

        <!-- STEP 2: Scenario + Response -->
        <div id="drill-step-2" style="display:none">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.85rem">
            <div style="font-size:.68rem;font-weight:900;text-transform:uppercase;letter-spacing:.1em;color:#a16207;background:#fef3c7;border:1px solid #fcd34d;border-radius:999px;padding:.2rem .65rem">Step 2 of 2 — Live Scenario</div>
            <button onclick="rerollDrillScenario()" style="border:1px solid #e2e8f0;background:white;border-radius:.65rem;padding:.3rem .75rem;font-size:.75rem;font-weight:800;color:#475569;cursor:pointer">🎲 Different scenario</button>
          </div>
          <div id="drill-scenario-box" style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:1rem;padding:1rem;margin-bottom:.85rem;font-weight:600;color:#0f172a;line-height:1.65;font-size:.88rem;min-height:90px">Loading…</div>
          <div style="margin-bottom:.75rem">
            <div style="font-size:.72rem;font-weight:900;text-transform:uppercase;letter-spacing:.08em;color:#475569;margin-bottom:.4rem">Your de-escalation response</div>
            <textarea id="drill-response" class="input-field" placeholder="How do you respond to this patient right now? Mention space, tone, validation, or choices offered…" style="height:130px;resize:vertical;font-size:.875rem"></textarea>
          </div>

          <!-- Score panel -->
          <div id="drill-score-panel" style="display:none;background:white;border:1px solid #e2e8f0;border-radius:1rem;padding:1rem;margin-bottom:.85rem">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem">
              <div style="font-weight:900;color:#0f172a;font-size:1rem">Score: <span id="drill-grade">—</span></div>
              <div id="drill-xp-badge" style="font-weight:900;font-size:.88rem;color:#16a34a"></div>
            </div>
            <div id="drill-feedback" style="color:#475569;font-size:.85rem;line-height:1.55;white-space:pre-wrap"></div>
            <div id="drill-streak-bonus" style="margin-top:.5rem;font-size:.82rem;font-weight:800;color:#a16207;display:none"></div>
          </div>

          <div style="display:flex;gap:.75rem;justify-content:flex-end">
            <button id="drill-submit-btn" onclick="submitDrill()" class="btn btn-primary">Submit Response</button>
            <button id="drill-finish-btn" onclick="closeDrillModal()" style="display:none;background:#f0fdf4;color:#15803d;border:1px solid #bbf7d0;padding:.65rem 1.5rem;border-radius:.875rem;font-weight:800;cursor:pointer;font-size:.875rem">Done ✓</button>
          </div>
        </div>

      </div><!-- end drill-steps-wrap -->
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════ ADMIN ACCESS MODAL ══ -->
<div id="admin-pin-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:160;align-items:center;justify-content:center;padding:1rem">
  <div class="card" style="width:100%;max-width:420px;padding:2rem;text-align:center">
    <div style="width:56px;height:56px;background:linear-gradient(135deg,#7c3aed,#2563eb);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 1.25rem;font-size:1.5rem">⚙️</div>
    <h2 style="font-size:1.15rem;font-weight:900;color:#0f172a;margin-bottom:.35rem">Admin Access</h2>
    <p id="admin-access-msg" style="font-size:.82rem;color:#64748b;margin-bottom:1.25rem">Checking your access level…</p>
    <!-- Checking state -->
    <div id="admin-access-checking" style="display:block">
      <div style="display:flex;align-items:center;justify-content:center;gap:.625rem;color:#7c3aed;font-weight:700;font-size:.875rem">
        <div style="width:18px;height:18px;border:2px solid #7c3aed;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite"></div>
        Verifying…
      </div>
    </div>
    <!-- Denied state -->
    <div id="admin-access-denied" style="display:none">
      <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:.875rem;padding:1rem;margin-bottom:1rem">
        <p style="color:#dc2626;font-weight:800;font-size:.875rem">🚫 Access Denied</p>
        <p style="color:#ef4444;font-size:.78rem;margin-top:.35rem">Your account does not have admin privileges. Contact your Owner administrator.</p>
      </div>
      <button onclick="closePinModal()" style="width:100%;padding:.75rem;background:#f1f5f9;color:#475569;border:none;border-radius:.875rem;font-weight:800;cursor:pointer;font-size:.875rem">Close</button>
    </div>
    <!-- First-time setup -->
    <div id="admin-first-setup" style="display:none">
      <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:.875rem;padding:1rem;margin-bottom:1rem">
        <p style="color:#1d4ed8;font-weight:800;font-size:.875rem">🔑 First-Time Setup</p>
        <p style="color:#3b82f6;font-size:.78rem;margin-top:.35rem">No admin accounts exist yet. Claim the Owner role for your account now.</p>
      </div>
      <input id="owner-code-new" type="password" placeholder="Create access code" class="input-field" style="width:100%;margin-bottom:.5rem;text-align:center;font-weight:800" autocomplete="off">
      <input id="owner-code-conf" type="password" placeholder="Confirm access code" class="input-field" style="width:100%;margin-bottom:.85rem;text-align:center;font-weight:800" autocomplete="off">
      <div id="owner-code-error" style="display:none;color:#dc2626;font-size:.8rem;font-weight:800;margin-bottom:.6rem"></div>
      <button onclick="claimOwnerAccount()" style="width:100%;padding:.75rem;background:linear-gradient(135deg,#2563eb,#7c3aed);color:white;border:none;border-radius:.875rem;font-weight:900;cursor:pointer;font-size:.875rem;margin-bottom:.625rem">🔑 Claim Owner + Set Code</button>
      <button onclick="closePinModal()" style="width:100%;padding:.75rem;background:#f1f5f9;color:#475569;border:none;border-radius:.875rem;font-weight:800;cursor:pointer;font-size:.82rem">Cancel</button>
    </div>
    <!-- Code entry -->
    <div id="admin-code-entry" style="display:none">
      <input id="admin-access-code" type="password" placeholder="Enter access code" class="input-field" style="width:100%;margin-bottom:.65rem;text-align:center;font-weight:800" autocomplete="off">
      <div id="admin-code-error" style="display:none;color:#dc2626;font-size:.8rem;font-weight:800;margin-bottom:.6rem"></div>
      <button onclick="verifyAdminCode()" style="width:100%;padding:.75rem;background:linear-gradient(135deg,#2563eb,#7c3aed);color:white;border:none;border-radius:.875rem;font-weight:900;cursor:pointer;font-size:.875rem;margin-bottom:.625rem">Unlock Command Center</button>
      <button onclick="closePinModal()" style="width:100%;padding:.7rem;background:#f1f5f9;color:#475569;border:none;border-radius:.875rem;font-weight:800;cursor:pointer;font-size:.82rem">Cancel</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════ MY ACCOUNT MODAL ══ -->
<div id="account-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:155;align-items:center;justify-content:center;padding:1rem">
  <div class="card w-full max-w-lg" style="max-height:92vh;overflow-y:auto">
    <div style="padding:1.5rem 1.5rem 0;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #f1f5f9;padding-bottom:1rem">
      <div style="display:flex;align-items:center;gap:.875rem">
        <div id="acct-avatar-circle" style="width:52px;height:52px;background:linear-gradient(135deg,#2563eb,#7c3aed);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;color:white;font-size:1.1rem"></div>
        <div>
          <h2 style="font-size:1.1rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif" id="acct-header-name">My Account</h2>
          <p style="font-size:.7rem;color:#94a3b8;font-weight:600" id="acct-header-sub">Destiny Springs Healthcare</p>
        </div>
      </div>
      <button onclick="closeAccountModal()" style="width:36px;height:36px;border-radius:50%;background:#f1f5f9;border:none;cursor:pointer;font-size:1rem;font-weight:900;color:#64748b">✕</button>
    </div>

    <!-- View Mode -->
    <div id="acct-view" style="padding:1.5rem">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:1rem">
        <div style="background:#f8fafc;border-radius:.875rem;padding:.875rem">
          <p style="font-size:.65rem;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.25rem">First Name</p>
          <p style="font-size:.95rem;font-weight:700;color:#0f172a" id="acct-fname">—</p>
        </div>
        <div style="background:#f8fafc;border-radius:.875rem;padding:.875rem">
          <p style="font-size:.65rem;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.25rem">Last Name</p>
          <p style="font-size:.95rem;font-weight:700;color:#0f172a" id="acct-lname">—</p>
        </div>
        <div style="background:#f8fafc;border-radius:.875rem;padding:.875rem">
          <p style="font-size:.65rem;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.25rem">Work Email</p>
          <p style="font-size:.85rem;font-weight:700;color:#0f172a;word-break:break-all" id="acct-email">—</p>
        </div>
        <div style="background:#f8fafc;border-radius:.875rem;padding:.875rem">
          <p style="font-size:.65rem;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.25rem">Mobile Phone</p>
          <p style="font-size:.95rem;font-weight:700;color:#0f172a" id="acct-phone">—</p>
        </div>
        <div style="background:#f8fafc;border-radius:.875rem;padding:.875rem">
          <p style="font-size:.65rem;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.25rem">Job Title</p>
          <p style="font-size:.95rem;font-weight:700;color:#0f172a" id="acct-title">—</p>
        </div>
        <div style="background:#f8fafc;border-radius:.875rem;padding:.875rem">
          <p style="font-size:.65rem;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.25rem">Department</p>
          <p style="font-size:.95rem;font-weight:700;color:#0f172a" id="acct-dept">—</p>
        </div>
        <div style="background:#f8fafc;border-radius:.875rem;padding:.875rem">
          <p style="font-size:.65rem;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.25rem">Employee ID</p>
          <p style="font-size:.95rem;font-weight:700;color:#0f172a" id="acct-empid">—</p>
        </div>
        <div style="background:#f8fafc;border-radius:.875rem;padding:.875rem">
          <p style="font-size:.65rem;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.25rem">Training Year</p>
          <p style="font-size:.95rem;font-weight:700;color:#0f172a" id="acct-year">—</p>
        </div>
      </div>
      <!-- Training Stats -->
      <div style="background:linear-gradient(135deg,#0f172a,#1e3a5f);border-radius:1rem;padding:1rem;margin-bottom:1rem;display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;text-align:center">
        <div><p style="font-size:1.4rem;font-weight:900;color:#60a5fa" id="acct-xp-stat">0</p><p style="font-size:.65rem;color:#64748b;font-weight:700;text-transform:uppercase">XP Earned</p></div>
        <div><p style="font-size:1.4rem;font-weight:900;color:#a78bfa" id="acct-level-stat">1</p><p style="font-size:.65rem;color:#64748b;font-weight:700;text-transform:uppercase">Level</p></div>
        <div><p style="font-size:1.4rem;font-weight:900;color:#34d399" id="acct-scenarios-stat">0</p><p style="font-size:.65rem;color:#64748b;font-weight:700;text-transform:uppercase">Scenarios</p></div>
        <div><p style="font-size:1.4rem;font-weight:900;color:#22c55e" id="acct-lc-stat">0</p><p style="font-size:.65rem;color:#64748b;font-weight:700;text-transform:uppercase">Lab Credits</p></div>
        <div><p style="font-size:1.4rem;font-weight:900;color:#fbbf24" id="acct-tier-stat">—</p><p style="font-size:.65rem;color:#64748b;font-weight:700;text-transform:uppercase">Redeem Tier</p></div>
      </div>
      <div style="display:flex;gap:.75rem">
        <button class="btn btn-primary" style="flex:1" onclick="openAccountEdit()">✏️ Edit Profile</button>
        <button class="btn" style="background:#fef2f2;color:#dc2626;border:1px solid #fee2e2;flex:1" onclick="openChangePassword()">🔑 Change Password</button>
      </div>
    </div>

    <!-- Edit Mode -->
    <div id="acct-edit" style="display:none;padding:1.5rem">
      <h3 style="font-size:.9rem;font-weight:900;color:#0f172a;margin-bottom:1rem">Edit Profile Information</h3>
      <div class="space-y-3">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
          <input id="edit-fname" class="input-field" type="text" placeholder="First Name">
          <input id="edit-lname" class="input-field" type="text" placeholder="Last Name">
        </div>
        <input id="edit-phone" class="input-field" type="tel" placeholder="Mobile Phone">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
          <input id="edit-title" class="input-field" type="text" placeholder="Job Title">
          <input id="edit-dept" class="input-field" type="text" placeholder="Department">
        </div>
        <input id="edit-empid" class="input-field" type="text" placeholder="Employee ID (optional)">
        <div id="acct-edit-error" style="display:none;color:#dc2626;font-size:.8rem;font-weight:700;padding:.5rem;background:#fef2f2;border-radius:.5rem"></div>
        <div style="display:flex;gap:.75rem">
          <button class="btn btn-success" style="flex:1" onclick="saveAccountEdit()">Save Changes</button>
          <button class="btn" style="background:#f1f5f9;color:#475569;flex:1" onclick="cancelAccountEdit()">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Change Password Mode -->
    <div id="acct-pw" style="display:none;padding:1.5rem">
      <h3 style="font-size:.9rem;font-weight:900;color:#0f172a;margin-bottom:1rem">Change Password</h3>
      <div class="space-y-3">
        <input id="pw-current" class="input-field" type="password" placeholder="Current Password">
        <input id="pw-new" class="input-field" type="password" placeholder="New Password (min 6 chars)">
        <input id="pw-conf" class="input-field" type="password" placeholder="Confirm New Password">
        <div id="acct-pw-error" style="display:none;color:#dc2626;font-size:.8rem;font-weight:700;padding:.5rem;background:#fef2f2;border-radius:.5rem"></div>
        <div id="acct-pw-success" style="display:none;color:#059669;font-size:.8rem;font-weight:700;padding:.5rem;background:#f0fdf4;border-radius:.5rem">Password updated successfully!</div>
        <div style="display:flex;gap:.75rem">
          <button class="btn btn-primary" style="flex:1" onclick="doChangePassword()">Update Password</button>
          <button class="btn" style="background:#f1f5f9;color:#475569;flex:1" onclick="cancelChangePassword()">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════ AVATAR ══ -->
<!-- Avatar is inside #app so it only shows after login -->

<!-- ═══════════════════════════════════════════════ NAV BAR ══ -->
<div id="app" style="display:none">

<!-- Professor Pax guide (draggable, top-right by default) -->
<div id="avatar-container" style="position:fixed;top:clamp(4.25rem,8vw,6rem);right:clamp(.85rem,calc((100vw - 1100px)/2 + 1rem),2.2rem);z-index:90;display:none;flex-direction:column;align-items:flex-end;max-width:min(340px,92vw);cursor:grab">
  <!-- Speech bubble -->
  <div id="avatar-speech" style="position:relative;background:#fff;border-radius:1.1rem;border-bottom-right-radius:.3rem;padding:1rem 1.1rem;width:min(320px,90vw);box-shadow:0 8px 32px rgba(0,0,0,.2);font-size:.9rem;font-weight:600;color:#0f172a;display:none;line-height:1.65;margin-bottom:.6rem;cursor:pointer;max-width:100%" title="Click to open chat">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:.5rem;margin-bottom:.35rem">
      <div style="display:flex;flex-direction:column;gap:.08rem">
        <div style="font-size:.65rem;font-weight:900;color:#2563eb;text-transform:uppercase;letter-spacing:.08em">Prof. Vance</div>
        <div style="font-size:.62rem;font-weight:600;color:#94a3b8;font-style:italic">(Click &amp; drag if I'm in your way)</div>
      </div>
      <div style="display:flex;gap:.35rem">
        <button id="pax-mute-btn" onclick="togglePaxMute(event)" style="border:none;background:#f1f5f9;color:#475569;border-radius:.6rem;padding:.25rem .5rem;font-weight:800;font-size:.75rem;cursor:pointer" title="Mute / Unmute">🔈</button>
        <button id="pax-minimize-btn" onclick="minimizePax(event)" style="border:none;background:#f1f5f9;color:#475569;border-radius:.6rem;padding:.25rem .55rem;font-weight:800;font-size:.75rem;cursor:pointer" title="Minimize">–</button>
      </div>
    </div>
    <span id="avatar-speech-text"></span>
    <div style="margin-top:.6rem;text-align:right">
      <button onclick="openChatFromPax(event)" style="border:none;background:#2563eb;color:white;font-weight:800;font-size:.75rem;padding:.35rem .65rem;border-radius:.6rem;cursor:pointer">Open chat</button>
    </div>
    <div style="position:absolute;bottom:-8px;right:16px;width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:8px solid #fff"></div>
  </div>
  <!-- Avatar face (Professor Vance photo portrait) -->
  <div id="avatar-drag-handle" style="position:relative;width:90px;height:90px;cursor:grab">
    <img id="vance-portrait" src="prof.png" onclick="toggleAvatar()" style="width:90px;height:90px;border-radius:50%;object-fit:cover;object-position:top center;border:3px solid #2563eb;box-shadow:0 4px 14px rgba(37,99,235,.45);cursor:pointer;display:block;transition:border-color .3s" alt="Professor Vance">
    <button onclick="toggleAvatar()" style="position:absolute;top:-6px;right:-6px;width:20px;height:20px;background:#ef4444;color:white;border-radius:50%;border:none;font-size:10px;cursor:pointer;font-weight:900;line-height:1" title="Dismiss Professor Vance">✕</button>
  </div>
  <!-- Name label -->
  <div style="font-size:.72rem;font-weight:900;color:#0f172a;background:rgba(255,255,255,.9);padding:.2rem .55rem;border-radius:.75rem;text-align:center;width:auto;margin-top:.35rem;letter-spacing:.05em;box-shadow:0 6px 16px rgba(0,0,0,.15)">PROF. VANCE</div>
</div>

<!-- Minimized pill -->
<div id="avatar-mini" style="display:none;position:fixed;bottom:5rem;right:1rem;z-index:91;background:linear-gradient(135deg,#2563eb,#7c3aed);color:white;padding:.5rem .75rem;border-radius:.9rem;font-weight:900;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.25);font-size:.82rem" onclick="restorePax()">🎓 Vance (listening)</div>

<div style="position:fixed;top:0;left:0;right:0;height:4px;background:#1e293b;z-index:100">
  <div id="progress-bar" class="progress-bar" style="height:100%;background:linear-gradient(90deg,#2563eb,#7c3aed);width:3.7%;transition:width .4s ease"></div>
</div>

<!-- floating slide edge nav arrows -->
<button id="side-arrow-prev" onclick="prevSlide()" title="Previous slide" style="position:fixed;left:0;top:50%;transform:translateY(-50%);z-index:79;width:52px;height:80px;background:rgba(10,15,30,.65);border:none;color:white;font-size:1.6rem;cursor:pointer;border-radius:0 .75rem .75rem 0;backdrop-filter:blur(8px);transition:background .2s" onmouseover="this.style.background='rgba(37,99,235,.7)'" onmouseout="this.style.background='rgba(10,15,30,.65)'">&#8249;</button>
<button id="side-arrow-next" onclick="nextSlide()" title="Next slide" style="position:fixed;right:0;top:50%;transform:translateY(-50%);z-index:79;width:52px;height:80px;background:rgba(37,99,235,.7);border:none;color:white;font-size:1.6rem;cursor:pointer;border-radius:.75rem 0 0 .75rem;backdrop-filter:blur(8px);transition:background .2s" onmouseover="this.style.background='rgba(37,99,235,.92)'" onmouseout="this.style.background='rgba(37,99,235,.7)'">&#8250;</button>

<nav style="position:fixed;bottom:0;left:0;right:0;background:rgba(10,15,30,.97);backdrop-filter:blur(16px);border-top:1px solid rgba(255,255,255,.07);padding:.6rem 1rem;display:flex;align-items:center;gap:.5rem;z-index:80;flex-wrap:wrap;row-gap:.35rem">
  <!-- Left: slide counter + XP -->
  <div style="display:flex;align-items:center;gap:.75rem;flex-shrink:0">
    <div id="nav-slide-counter" style="color:#475569;font-size:.78rem;font-weight:800;min-width:46px">1 / 27</div>
    <div style="color:#64748b;font-size:.72rem;font-weight:700;white-space:nowrap">Lvl <span id="nav-level">1</span> · <span id="nav-xp">0</span> XP</div>
    <div style="color:#10b981;font-size:.72rem;font-weight:800;white-space:nowrap">💠 <span id="nav-lc">0 LC</span></div>
  </div>

  <!-- Spacer -->
  <div style="flex:1"></div>

  <!-- Right controls -->
  <div style="display:flex;gap:.4rem;align-items:center;flex-wrap:wrap;justify-content:flex-end">
    <button onclick="toggleAmbience()" id="ambience-btn" title="Toggle background ambience" style="background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.25);color:#bfdbfe;padding:.5rem .78rem;border-radius:.8rem;font-size:.85rem;font-weight:800;cursor:pointer" onmouseover="this.style.background='rgba(59,130,246,.2)'" onmouseout="this.style.background='rgba(59,130,246,.12)'">🎵 Ambience (tap to play)</button>
    <button onclick="openChat()" title="Prof. Vance & chat" style="background:rgba(96,165,250,.18);border:1px solid rgba(96,165,250,.3);color:#bfdbfe;padding:.5rem .78rem;border-radius:.8rem;font-size:.85rem;font-weight:800;cursor:pointer;display:flex;align-items:center;gap:.4rem" onmouseover="this.style.background='rgba(96,165,250,.26)'" onmouseout="this.style.background='rgba(96,165,250,.18)'">🎓 <span style="font-size:.8rem">Vance & Chat</span></button>
    <button onclick="openVideoModal()" title="Example videos" style="background:rgba(251,191,36,.16);border:1px solid rgba(251,191,36,.35);color:#facc15;padding:.5rem .78rem;border-radius:.8rem;font-size:.85rem;font-weight:800;cursor:pointer" onmouseover="this.style.background='rgba(251,191,36,.24)'" onmouseout="this.style.background='rgba(251,191,36,.16)'">🎬 Videos</button>
    <button onclick="openLabRoom()" title="Laboratory Room" style="background:rgba(16,185,129,.14);border:1px solid rgba(16,185,129,.3);color:#a7f3d0;padding:.5rem .78rem;border-radius:.8rem;font-size:.85rem;font-weight:800;cursor:pointer;display:flex;align-items:center;gap:.4rem;white-space:nowrap" onmouseover="this.style.background='rgba(16,185,129,.22)'" onmouseout="this.style.background='rgba(16,185,129,.14)'">🧪 Lab Room</button>
    <button onclick="openAdminPrompt()" title="Admin Dashboard" style="background:rgba(124,58,237,.18);border:1px solid rgba(124,58,237,.35);color:#c4b5fd;padding:.5rem .7rem;border-radius:.8rem;font-size:.85rem;font-weight:800;cursor:pointer" onmouseover="this.style.background='rgba(124,58,237,.3)'" onmouseout="this.style.background='rgba(124,58,237,.18)'">⚙️</button>
    <button onclick="prevSlide()" title="Previous slide" style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.18);color:white;width:48px;height:48px;border-radius:.875rem;font-size:1.5rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0" onmouseover="this.style.background='rgba(255,255,255,.22)'" onmouseout="this.style.background='rgba(255,255,255,.1)'">&#8249;</button>
    <button onclick="showHomeGateway()" title="Home / Hub" style="background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);color:#94a3b8;width:48px;height:48px;border-radius:.875rem;font-size:1.25rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0" onmouseover="this.style.background='rgba(255,255,255,.15)'" onmouseout="this.style.background='rgba(255,255,255,.07)'">🏠</button>
    <button onclick="nextSlide()" title="Next slide" style="background:#2563eb;color:white;width:48px;height:48px;border-radius:.875rem;font-size:1.5rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 4px 14px rgba(37,99,235,.5)" onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#2563eb'">&#8250;</button>
    <!-- My Account button -->
    <button onclick="openAccountModal()" title="My Account" style="display:flex;align-items:center;gap:.45rem;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);cursor:pointer;padding:.3rem .6rem .3rem .35rem;border-radius:.875rem;flex-shrink:0" onmouseover="this.style.background='rgba(255,255,255,.14)'" onmouseout="this.style.background='rgba(255,255,255,.07)'">
      <div style="width:30px;height:30px;background:linear-gradient(135deg,#2563eb,#7c3aed);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;color:white;font-size:.8rem;flex-shrink:0" id="nav-avatar-initials"></div>
      <span style="color:white;font-weight:800;font-size:.82rem;white-space:nowrap"><span id="nav-name">My Account</span></span>
    </button>
    <button onclick="doSignOut()" title="Sign out" style="background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.25);color:#fca5a5;padding:.5rem .72rem;border-radius:.8rem;font-size:.85rem;font-weight:800;cursor:pointer" onmouseover="this.style.background='rgba(239,68,68,.25)'" onmouseout="this.style.background='rgba(239,68,68,.12)'">Sign Out</button>
  </div>
</nav>

<!-- XP Toast notification -->
<div id="xp-toast" style="display:none;position:fixed;bottom:6.5rem;left:50%;transform:translateX(-50%);z-index:300;background:linear-gradient(135deg,#1d4ed8,#7c3aed);color:white;font-weight:900;font-size:.95rem;padding:.5rem 1.3rem;border-radius:2rem;box-shadow:0 6px 20px rgba(37,99,235,.45);pointer-events:none;white-space:nowrap">+XP</div>

<!-- Keyboard shortcuts overlay -->
<div id="shortcuts-overlay" onclick="closeShortcuts()" style="display:none;position:fixed;inset:0;z-index:5000;background:rgba(0,0,20,.72);backdrop-filter:blur(6px);align-items:center;justify-content:center;padding:1.5rem">
  <div onclick="event.stopPropagation()" style="background:#0f172a;border:1px solid rgba(255,255,255,.12);border-radius:1.5rem;padding:2rem;max-width:420px;width:100%;box-shadow:0 24px 80px rgba(0,0,0,.6);color:#f1f5f9">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.4rem">
      <h3 style="font-size:1rem;font-weight:900;letter-spacing:.05em;text-transform:uppercase;color:#f8fafc">⌨ Keyboard Shortcuts</h3>
      <button onclick="closeShortcuts()" style="background:rgba(255,255,255,.08);border:none;color:#94a3b8;border-radius:.5rem;width:28px;height:28px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center">&times;</button>
    </div>
    <div style="display:grid;gap:.6rem;font-size:.83rem">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:rgba(255,255,255,.05);border-radius:.65rem"><span style="color:#94a3b8">Next slide</span><kbd style="background:#1e293b;color:#e2e8f0;padding:.2rem .55rem;border-radius:.35rem;font-family:monospace;font-size:.78rem;border:1px solid rgba(255,255,255,.1)">→ / ↓</kbd></div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:rgba(255,255,255,.05);border-radius:.65rem"><span style="color:#94a3b8">Previous slide</span><kbd style="background:#1e293b;color:#e2e8f0;padding:.2rem .55rem;border-radius:.35rem;font-family:monospace;font-size:.78rem;border:1px solid rgba(255,255,255,.1)">← / ↑</kbd></div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:rgba(255,255,255,.05);border-radius:.65rem"><span style="color:#94a3b8">Toggle ambient sound</span><kbd style="background:#1e293b;color:#e2e8f0;padding:.2rem .55rem;border-radius:.35rem;font-family:monospace;font-size:.78rem;border:1px solid rgba(255,255,255,.1)">M</kbd></div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:rgba(255,255,255,.05);border-radius:.65rem"><span style="color:#94a3b8">Open admin dashboard</span><kbd style="background:#1e293b;color:#e2e8f0;padding:.2rem .55rem;border-radius:.35rem;font-family:monospace;font-size:.78rem;border:1px solid rgba(255,255,255,.1)">A</kbd></div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:rgba(255,255,255,.05);border-radius:.65rem"><span style="color:#94a3b8">Dismiss Vance / close panel</span><kbd style="background:#1e293b;color:#e2e8f0;padding:.2rem .55rem;border-radius:.35rem;font-family:monospace;font-size:.78rem;border:1px solid rgba(255,255,255,.1)">Esc</kbd></div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:rgba(255,255,255,.05);border-radius:.65rem"><span style="color:#94a3b8">This help screen</span><kbd style="background:#1e293b;color:#e2e8f0;padding:.2rem .55rem;border-radius:.35rem;font-family:monospace;font-size:.78rem;border:1px solid rgba(255,255,255,.1)">?</kbd></div>
    </div>
    <p style="margin-top:1.2rem;font-size:.72rem;color:#475569;text-align:center">Click anywhere outside or press Esc to close</p>
  </div>
</div>

<!-- Completion options modal -->
<div id="completion-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:120;align-items:center;justify-content:center;padding:1rem">
  <div style="background:white;border-radius:1rem;max-width:520px;width:100%;padding:1.5rem;box-shadow:0 16px 48px rgba(0,0,0,.35)">
    <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:1rem">
      <div style="font-size:1.8rem">🎉</div>
      <div>
        <h3 style="margin:0;font-size:1.2rem;font-weight:900;color:#0f172a">You're certified!</h3>
        <p style="margin:.2rem 0 0;color:#475569;font-weight:600;font-size:.92rem">Pick how you want to continue.</p>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:.65rem">
      <button onclick="chooseCompletionPath('review')" style="border:1px solid #e2e8f0;background:#f8fafc;border-radius:.85rem;padding:.85rem 1rem;text-align:left;cursor:pointer;font-weight:800;color:#0f172a">🔁 Review full training (restart)</button>
      <button onclick="chooseCompletionPath('lab')" style="border:1px solid #d1fae5;background:#ecfdf3;border-radius:.85rem;padding:.85rem 1rem;text-align:left;cursor:pointer;font-weight:800;color:#065f46">🧪 Jump into Lab & role-play only</button>
      <button onclick="chooseCompletionPath('continue')" style="border:1px solid #e0e7ff;background:#eef2ff;border-radius:.85rem;padding:.85rem 1rem;text-align:left;cursor:pointer;font-weight:800;color:#312e81">🚀 Keep exploring slides</button>
    </div>
  </div>
</div>

<!-- Chat panel -->
<div id="chat-panel" style="display:none;position:fixed;bottom:5.2rem;right:1rem;z-index:96;width:340px;max-height:420px;background:white;border:1px solid #e2e8f0;border-radius:1rem;box-shadow:0 16px 48px rgba(0,0,0,.2);flex-direction:column;overflow:hidden">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid #e2e8f0;background:#f8fafc">
    <div>
      <div style="font-weight:900;color:#0f172a;font-size:1.05rem">Ask Prof. Vance</div>
      <div style="font-size:.8rem;color:#475569;font-weight:700">Marcus scenario · clinical de-escalation coach</div>
    </div>
    <button onclick="closeChat()" style="width:28px;height:28px;border-radius:50%;border:1px solid #e2e8f0;background:#f1f5f9;font-weight:900;color:#475569;cursor:pointer">✕</button>
  </div>
  <div style="padding:.65rem 1rem;border-bottom:1px solid #e2e8f0;display:flex;gap:.4rem;align-items:center">
    <div style="font-size:.8rem;color:#475569;font-weight:700">Secure backend chat enabled for staff.</div>
  </div>
  <div id="chat-messages" style="flex:1;overflow-y:auto;padding:1rem;background:#fff"></div>
  <div style="padding:.6rem 1rem;border-top:1px solid #e2e8f0;background:#f8fafc;display:flex;gap:.5rem;flex-direction:column">
    <textarea id="chat-input" rows="2" placeholder="Type how you'd respond to Marcus, or ask Professor Vance a clinical question..." style="width:100%;border:1px solid #e2e8f0;border-radius:.75rem;padding:.7rem;font-size:.95rem;font-weight:700;resize:vertical;background:white" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChatMessage();}"></textarea>
    <div style="display:flex;gap:.5rem;align-items:center;justify-content:space-between">
      <span style="font-size:.8rem;color:#64748b;font-weight:700">If I'm unsure, I'll suggest asking a supervisor/leadership.</span>
      <button id="chat-send-btn" onclick="sendChatMessage()" style="border:none;background:#2563eb;color:white;font-weight:900;padding:.6rem 1rem;border-radius:.85rem;font-size:.9rem;cursor:pointer">Send</button>
    </div>
  </div>
</div>

<!-- Video modal -->
<div id="video-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:95;align-items:center;justify-content:center;padding:1rem">
  <div class="card" style="width:100%;max-width:960px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;border-bottom:1px solid #e2e8f0">
      <div>
        <h3 style="margin:0;font-size:1.1rem;font-weight:900;color:#0f172a">🎬 Training Example Videos</h3>
        <p style="margin:0;color:#475569;font-weight:700;font-size:.9rem">Current links from YouTube/Facebook; swap with internal clips anytime.</p>
      </div>
      <button onclick="closeVideoModal()" style="width:36px;height:36px;border-radius:50%;background:#f1f5f9;border:none;font-weight:900;color:#475569;cursor:pointer">✕</button>
    </div>
    <div style="padding:1rem;overflow-y:auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem">
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:1rem;padding:.85rem;display:flex;flex-direction:column;gap:.6rem">
        <div style="font-weight:900;color:#0f172a;font-size:1.02rem">De-escalation Coaching (YouTube)</div>
        <div style="position:relative;padding-top:56.25%;border-radius:.75rem;overflow:hidden;border:1px solid #e2e8f0;background:#000">
          <iframe src="https://www.youtube.com/embed/yqdV8wCRET0" title="De-escalation coaching" style="position:absolute;inset:0;width:100%;height:100%;border:0" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen></iframe>
        </div>
        <p style="font-size:.9rem;color:#475569;font-weight:600;line-height:1.55">Short clip illustrating calming tone and slow pacing during initial contact.</p>
      </div>
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:1rem;padding:.85rem;display:flex;flex-direction:column;gap:.6rem">
        <div style="font-weight:900;color:#0f172a;font-size:1.02rem">Staff Safety Scenario (YouTube)</div>
        <div style="position:relative;padding-top:56.25%;border-radius:.75rem;overflow:hidden;border:1px solid #e2e8f0;background:#000">
          <iframe src="https://www.youtube.com/embed/x7T5Eukokgs" title="Staff safety scenario" style="position:absolute;inset:0;width:100%;height:100%;border:0" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen></iframe>
        </div>
        <p style="font-size:.9rem;color:#475569;font-weight:600;line-height:1.55">Body positioning and teamwork during an escalating interaction.</p>
      </div>
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:1rem;padding:.85rem;display:flex;flex-direction:column;gap:.6rem">
        <div style="font-weight:900;color:#0f172a;font-size:1.02rem">Trauma-Informed Example (YouTube)</div>
        <div style="position:relative;padding-top:56.25%;border-radius:.75rem;overflow:hidden;border:1px solid #e2e8f0;background:#000">
          <iframe src="https://www.youtube.com/embed/Jit68JYo0Us" title="Trauma-informed example" style="position:absolute;inset:0;width:100%;height:100%;border:0" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen></iframe>
        </div>
        <p style="font-size:.9rem;color:#475569;font-weight:600;line-height:1.55">Example scripting that stays consent-focused and avoids re-traumatization.</p>
      </div>
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:1rem;padding:.85rem;display:flex;flex-direction:column;gap:.6rem">
        <div style="font-weight:900;color:#0f172a;font-size:1.02rem">Rapid Tips (YouTube Short)</div>
        <div style="position:relative;padding-top:56.25%;border-radius:.75rem;overflow:hidden;border:1px solid #e2e8f0;background:#000">
          <iframe src="https://www.youtube.com/embed/LXCxqJw5rDg" title="Rapid de-escalation tips" style="position:absolute;inset:0;width:100%;height:100%;border:0" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen></iframe>
        </div>
        <p style="font-size:.9rem;color:#475569;font-weight:600;line-height:1.55">Quick-hit reminders for tone, posture, and choice-offering.</p>
      </div>
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:1rem;padding:.85rem;display:flex;flex-direction:column;gap:.6rem">
        <div style="font-weight:900;color:#0f172a;font-size:1.02rem">Facebook Clip</div>
        <p style="font-size:.9rem;color:#475569;font-weight:600;line-height:1.55">Opens externally due to Facebook permissions.</p>
        <a href="https://www.facebook.com/share/r/1DN8AiFLVR/" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;justify-content:center;gap:.45rem;background:#2563eb;color:white;font-weight:900;padding:.65rem .9rem;border-radius:.75rem;text-decoration:none">Open in Facebook ↗</a>
      </div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════════════════════════
     SLIDE 1 — WELCOME
═══════════════════════════════════════════════════════════════════ -->
<div class="slide active" style="background:linear-gradient(135deg,#0f172a 0%,#1e3a5f 60%,#0f172a 100%)">
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:3rem 2rem;text-align:center;padding-bottom:6rem">
    <div style="margin-bottom:1.2rem;max-width:320px;width:70vw;filter:drop-shadow(0 6px 14px rgba(0,0,0,.25))">
      <img src="logo.png" alt="Destiny Springs Healthcare" style="width:100%;object-fit:contain;display:block">
    </div>
    <div class="badge" style="background:rgba(37,99,235,.2);color:#93c5fd;border:1px solid rgba(37,99,235,.3);margin-bottom:2rem;font-size:.7rem">
      🏥 Inpatient Psychiatric Acute Care · Est. 2026
    </div>
    <h1 style="font-size:clamp(2.5rem,8vw,5.5rem);color:white;line-height:.95;margin-bottom:1.5rem;font-family:Montserrat,sans-serif;font-weight:900">
      De-escalation<br><span style="background:linear-gradient(90deg,#60a5fa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent">Mastery Lab™</span>
    </h1>
    <p style="color:#94a3b8;font-size:1.1rem;margin-bottom:.5rem;font-weight:300">Destiny Springs Healthcare</p>
    <p style="color:#475569;font-size:.8rem;margin-bottom:3rem">© 2026 De-escalation Mastery Lab™. All Rights Reserved. Proprietary Training Content.</p>
    <div id="welcome-card" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:1.5rem;padding:2rem;max-width:520px;width:100%;margin-bottom:2.5rem;backdrop-filter:blur(12px)">
      <p id="welcome-greeting" style="color:#94a3b8;font-size:.85rem;margin-bottom:.5rem">Welcome,</p>
      <p id="welcome-name" style="color:white;font-size:1.75rem;font-weight:900;font-family:Montserrat,sans-serif;margin-bottom:1rem">&nbsp;</p>
      <p style="color:#cbd5e1;font-size:.9rem;line-height:1.7">You're about to complete <strong style="color:white">evidence-based training modules</strong> covering de-escalation, crisis intervention, psychiatric diagnosis recognition, and real-time scenario practice. Let's build your clinical confidence.</p>
    </div>
    <div style="display:flex;gap:1rem;flex-wrap:wrap;justify-content:center">
      <div style="display:flex;align-items:center;gap:.5rem;color:white;font-size:.8rem;font-weight:700"><span style="width:10px;height:10px;background:#ef4444;border-radius:50%;display:inline-block"></span>Safety First</div>
      <div style="display:flex;align-items:center;gap:.5rem;color:white;font-size:.8rem;font-weight:700"><span style="width:10px;height:10px;background:#22c55e;border-radius:50%;display:inline-block"></span>Patient Dignity</div>
      <div style="display:flex;align-items:center;gap:.5rem;color:white;font-size:.8rem;font-weight:700"><span style="width:10px;height:10px;background:#3b82f6;border-radius:50%;display:inline-block"></span>Evidence-Based</div>
      <div style="display:flex;align-items:center;gap:.5rem;color:white;font-size:.8rem;font-weight:700"><span style="width:10px;height:10px;background:#a78bfa;border-radius:50%;display:inline-block"></span>Trauma-Informed</div>
    </div>
  </div>
</div>

<!-- SLIDE 2 — BODY LANGUAGE -->
<div class="slide" style="background:#f8fafc;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#dbeafe;color:#1d4ed8;margin-bottom:1rem">Module 1 · Non-Verbal Communication</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif;line-height:1.1">Your Body Speaks First</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">55% of communication is body language. 38% is tone. Only 7% is the actual words.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr;gap:1.25rem">
    <div class="card red-box p-6">
      <h3 style="font-size:1.1rem;font-weight:900;color:#dc2626;margin-bottom:1rem;text-transform:uppercase">✕ Threatening Posture</h3>
      <ul style="space-y:8px;font-size:.9rem;color:#7f1d1d;font-weight:600;line-height:2">
        <li>✕ Direct chest-to-chest confrontation</li>
        <li>✕ Arms crossed, hands on hips</li>
        <li>✕ Intense, unblinking eye contact</li>
        <li>✕ Leaning in aggressively</li>
        <li>✕ Clenched fists / visible tension</li>
        <li>✕ Blocking the doorway</li>
        <li>✕ Hands behind back (secretive)</li>
      </ul>
    </div>
    <div class="card green-box p-6">
      <h3 style="font-size:1.1rem;font-weight:900;color:#15803d;margin-bottom:1rem;text-transform:uppercase">✓ De-escalating Posture</h3>
      <ul style="font-size:.9rem;color:#14532d;font-weight:600;line-height:2">
        <li>✓ 45° angle — never square-on</li>
        <li>✓ Open palms visible at sides</li>
        <li>✓ Soft, warm, natural eye contact</li>
        <li>✓ Slight backward lean (non-threatening)</li>
        <li>✓ Relaxed, dropped shoulders</li>
        <li>✓ Clear pathway to exit available</li>
        <li>✓ Slow, deliberate movements</li>
      </ul>
    </div>
    <div class="card blue-box p-6" style="grid-column:1/-1">
      <h3 style="font-weight:900;color:#1d4ed8;margin-bottom:.75rem">🧠 The Science Behind It</h3>
      <p style="font-size:.875rem;color:#1e3a8a;line-height:1.7;font-weight:500">When a person is in crisis, their prefrontal cortex (logic) goes offline and the <strong>amygdala (threat-detection)</strong> takes over. Your body language is processed as threat/safe data in milliseconds — before you say a single word. A non-threatening physical presence is your most powerful tool.</p>
    </div>
  </div>
</div>

<!-- SLIDE 3 — PROXEMICS / PERSONAL SPACE -->
<div class="slide" style="background:white;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#cffafe;color:#0e7490;margin-bottom:1rem">Module 1 · Proxemics</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">The Power of Distance</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">Invading personal space activates the fight-or-flight response instantly.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:repeat(4,1fr);gap:1rem">
    <div class="card p-5" style="border-top:5px solid #ef4444;text-align:center">
      <div style="font-size:1.75rem;font-weight:900;color:#ef4444">0–18"</div>
      <div style="font-size:.75rem;font-weight:900;color:#7f1d1d;text-transform:uppercase;margin:.5rem 0">Intimate Zone</div>
      <p style="font-size:.78rem;color:#991b1b;line-height:1.6">⚠️ Never enter without invitation. Reserved for medical necessity only — always explain first: <em>"I need to check your arm."</em></p>
    </div>
    <div class="card p-5" style="border-top:5px solid #f97316;text-align:center">
      <div style="font-size:1.75rem;font-weight:900;color:#f97316">1.5–4 ft</div>
      <div style="font-size:.75rem;font-weight:900;color:#7c2d12;text-transform:uppercase;margin:.5rem 0">Personal Zone</div>
      <p style="font-size:.78rem;color:#9a3412;line-height:1.6">⚠️ High anxiety during crisis. Use for assessments with trusted rapport only.</p>
    </div>
    <div class="card p-5" style="border-top:5px solid #22c55e;text-align:center;outline:3px solid #22c55e;outline-offset:2px">
      <div style="font-size:1.75rem;font-weight:900;color:#16a34a">4–10 ft</div>
      <div style="font-size:.75rem;font-weight:900;color:#14532d;text-transform:uppercase;margin:.5rem 0">✅ Social Zone</div>
      <p style="font-size:.78rem;color:#166534;line-height:1.6"><strong>IDEAL for de-escalation.</strong> Professional, safe, non-threatening. Start here always.</p>
    </div>
    <div class="card p-5" style="border-top:5px solid #94a3b8;text-align:center">
      <div style="font-size:1.75rem;font-weight:900;color:#64748b">10+ ft</div>
      <div style="font-size:.75rem;font-weight:900;color:#475569;text-transform:uppercase;margin:.5rem 0">Public Zone</div>
      <p style="font-size:.78rem;color:#64748b;line-height:1.6">Too distant — feels dismissive. Use for group settings or initial approach only.</p>
    </div>
  </div>
  <div style="padding:0 2rem" class="card amber-box p-5">
    <strong style="color:#92400e">⚡ Clinical Tip:</strong> <span style="font-size:.875rem;color:#78350f">Always position yourself at a 45° angle so the patient has a clear exit path. Trapped people escalate. A patient who feels they can leave — often won't.</span>
  </div>
</div>

<!-- SLIDE 4 — VOICE & TONE -->
<div class="slide" style="background:#f8fafc;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#ede9fe;color:#6d28d9;margin-bottom:1rem">Module 1 · Paralinguistics</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">Your Voice Is a Clinical Tool</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">38% of emotional communication comes from tone alone. Not what you say — how you say it.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr;gap:1.25rem">
    <div class="card green-box p-6">
      <h3 style="font-weight:900;color:#15803d;margin-bottom:1rem;text-transform:uppercase;font-size:.95rem">✓ Calming Vocal Qualities</h3>
      <div style="display:flex;flex-direction:column;gap:.75rem">
        <div style="display:flex;align-items:center;gap:.75rem"><div style="width:40px;height:40px;background:#dcfce7;border-radius:.75rem;display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0">🔉</div><div><p style="font-weight:800;font-size:.85rem;color:#166534">Low Pitch</p><p style="font-size:.75rem;color:#15803d">Lower frequencies signal calm and safety to the limbic system</p></div></div>
        <div style="display:flex;align-items:center;gap:.75rem"><div style="width:40px;height:40px;background:#dcfce7;border-radius:.75rem;display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0">🐢</div><div><p style="font-weight:800;font-size:.85rem;color:#166534">Slower Pacing</p><p style="font-size:.75rem;color:#15803d">Rushed speech signals anxiety; slow = safe</p></div></div>
        <div style="display:flex;align-items:center;gap:.75rem"><div style="width:40px;height:40px;background:#dcfce7;border-radius:.75rem;display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0">📢</div><div><p style="font-weight:800;font-size:.85rem;color:#166534">Quieter Volume</p><p style="font-size:.75rem;color:#15803d">Speak softer than them — they'll match you</p></div></div>
        <div style="display:flex;align-items:center;gap:.75rem"><div style="width:40px;height:40px;background:#dcfce7;border-radius:.75rem;display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0">😐</div><div><p style="font-weight:800;font-size:.85rem;color:#166534">Neutral Affect</p><p style="font-size:.75rem;color:#15803d">No excitement, no judgment — steady and warm</p></div></div>
      </div>
    </div>
    <div class="card red-box p-6">
      <h3 style="font-weight:900;color:#dc2626;margin-bottom:1rem;text-transform:uppercase;font-size:.95rem">✕ Escalating Vocal Patterns</h3>
      <div style="display:flex;flex-direction:column;gap:.75rem">
        <div style="display:flex;align-items:center;gap:.75rem"><div style="width:40px;height:40px;background:#fee2e2;border-radius:.75rem;display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0">📣</div><div><p style="font-weight:800;font-size:.85rem;color:#991b1b">High Pitch / Loud</p><p style="font-size:.75rem;color:#b91c1c">Triggers alarm — sounds like threat or panic</p></div></div>
        <div style="display:flex;align-items:center;gap:.75rem"><div style="width:40px;height:40px;background:#fee2e2;border-radius:.75rem;display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0">⚡</div><div><p style="font-weight:800;font-size:.85rem;color:#991b1b">Rapid Speech</p><p style="font-size:.75rem;color:#b91c1c">Feels urgent/anxious; escalates their nervous system</p></div></div>
        <div style="display:flex;align-items:center;gap:.75rem"><div style="width:40px;height:40px;background:#fee2e2;border-radius:.75rem;display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0">😬</div><div><p style="font-weight:800;font-size:.85rem;color:#991b1b">Overly Cheerful</p><p style="font-size:.75rem;color:#b91c1c">Dismissive — invalidates their real pain</p></div></div>
        <div style="display:flex;align-items:center;gap:.75rem"><div style="width:40px;height:40px;background:#fee2e2;border-radius:.75rem;display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0">😤</div><div><p style="font-weight:800;font-size:.85rem;color:#991b1b">Heavy Emotion</p><p style="font-size:.75rem;color:#b91c1c">Emotions are contagious — frustration breeds frustration</p></div></div>
      </div>
    </div>
    <div class="card p-5 blue-box" style="grid-column:1/-1">
      <strong style="color:#1d4ed8">🗣️ Practice:</strong> <span style="font-size:.875rem;color:#1e3a8a">Try saying "Help me understand what you need" three ways: (1) normal tone, (2) louder/faster, (3) slow and low. Notice how each version feels completely different emotionally.</span>
    </div>
  </div>
</div>

<!-- SLIDE 5 — VALIDATION & EMPATHY -->
<div class="slide" style="background:white;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#dcfce7;color:#166534;margin-bottom:1rem">Module 2 · Core Techniques</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">Validation & Empathy</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">The two most powerful de-escalation tools. They cost nothing and work every time.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr;gap:1.25rem">
    <div class="card p-6">
      <div style="font-size:2rem;margin-bottom:.75rem">🎯</div>
      <h3 style="font-size:1.1rem;font-weight:900;color:#0f172a;margin-bottom:.75rem">Validation</h3>
      <p style="font-size:.85rem;color:#475569;font-style:italic;margin-bottom:1rem;padding:.75rem;background:#f8fafc;border-radius:.75rem">"Your feelings are real and make sense, even if I don't fully understand the situation."</p>
      <div style="margin-bottom:1rem"><p style="font-size:.8rem;font-weight:800;color:#374151;margin-bottom:.5rem">WHY IT WORKS:</p><p style="font-size:.8rem;color:#6b7280;line-height:1.6">Validation signals to the amygdala that the threat is acknowledged — not dismissed. This begins the neurological shift from fight-or-flight back to reasoning mode.</p></div>
      <p style="font-size:.8rem;font-weight:800;color:#374151;margin-bottom:.5rem">EXAMPLE PHRASES:</p>
      <ul style="font-size:.8rem;color:#4b5563;line-height:2">
        <li>• "Your frustration makes total sense."</li>
        <li>• "Anyone in your situation would feel this way."</li>
        <li>• "I hear you — that sounds really hard."</li>
        <li>• "You don't have to explain why you feel this way."</li>
      </ul>
    </div>
    <div class="card p-6">
      <div style="font-size:2rem;margin-bottom:.75rem">❤️</div>
      <h3 style="font-size:1.1rem;font-weight:900;color:#0f172a;margin-bottom:.75rem">Empathy (vs. Sympathy)</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:1rem">
        <div style="background:#fef2f2;padding:.75rem;border-radius:.75rem"><p style="font-size:.7rem;font-weight:900;color:#dc2626;text-transform:uppercase;margin-bottom:.4rem">Sympathy ✕</p><p style="font-size:.75rem;color:#7f1d1d">"At least you have family who loves you..."<br><em>(minimizes)</em></p></div>
        <div style="background:#f0fdf4;padding:.75rem;border-radius:.75rem"><p style="font-size:.7rem;font-weight:900;color:#16a34a;text-transform:uppercase;margin-bottom:.4rem">Empathy ✓</p><p style="font-size:.75rem;color:#166534">"It sounds like you're carrying a lot right now. I'm here."<br><em>(connects)</em></p></div>
      </div>
      <p style="font-size:.8rem;font-weight:800;color:#374151;margin-bottom:.5rem">HOW TO SHOW IT:</p>
      <ul style="font-size:.8rem;color:#4b5563;line-height:2">
        <li>• Soft, warm eye contact (not staring)</li>
        <li>• Slow nodding (shows active listening)</li>
        <li>• Use their name: <em>"David, I hear you."</em></li>
        <li>• Comfortable silence — don't rush to fill it</li>
        <li>• "Tell me more..." invites without pressure</li>
      </ul>
    </div>
  </div>
</div>

<!-- SLIDE 6 — ACTIVE LISTENING -->
<div class="slide" style="background:#f8fafc;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#fef3c7;color:#92400e;margin-bottom:1rem">Module 2 · Core Techniques</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">Active Listening</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">Most people listen to reply. Your job is to listen to understand.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem">
    <div class="card p-5" style="border-top:4px solid #f59e0b">
      <div style="font-size:1.75rem;margin-bottom:.75rem">👂</div>
      <h3 style="font-weight:900;font-size:.9rem;color:#0f172a;margin-bottom:.75rem;text-transform:uppercase">Reflect</h3>
      <p style="font-size:.8rem;color:#475569;line-height:1.6">Mirror back what you heard in your own words — not parrot-style.</p>
      <div style="background:#fffbeb;padding:.75rem;border-radius:.75rem;margin-top:.75rem"><p style="font-size:.75rem;color:#92400e;font-style:italic">"So what I'm hearing is — you feel like nobody is taking you seriously. Is that right?"</p></div>
    </div>
    <div class="card p-5" style="border-top:4px solid #3b82f6">
      <div style="font-size:1.75rem;margin-bottom:.75rem">❓</div>
      <h3 style="font-weight:900;font-size:.9rem;color:#0f172a;margin-bottom:.75rem;text-transform:uppercase">Open Questions</h3>
      <p style="font-size:.8rem;color:#475569;line-height:1.6">Questions that can't be answered with yes/no open dialogue.</p>
      <div style="background:#eff6ff;padding:.75rem;border-radius:.75rem;margin-top:.75rem">
        <p style="font-size:.75rem;color:#1d4ed8">✓ "What would help you feel safer right now?"</p>
        <p style="font-size:.75rem;color:#1d4ed8;margin-top:.4rem">✓ "Help me understand what happened."</p>
        <p style="font-size:.75rem;color:#dc2626;margin-top:.4rem">✕ "Did you take your meds?"</p>
      </div>
    </div>
    <div class="card p-5" style="border-top:4px solid #8b5cf6">
      <div style="font-size:1.75rem;margin-bottom:.75rem">🤫</div>
      <h3 style="font-weight:900;font-size:.9rem;color:#0f172a;margin-bottom:.75rem;text-transform:uppercase">Strategic Silence</h3>
      <p style="font-size:.8rem;color:#475569;line-height:1.6">5 seconds of silence feels like 30 to a distressed person. Resist filling it.</p>
      <div style="background:#faf5ff;padding:.75rem;border-radius:.75rem;margin-top:.75rem"><p style="font-size:.75rem;color:#6d28d9;font-style:italic">After asking a question, count silently to 10 before speaking again. They will fill the silence — and that's where truth lives.</p></div>
    </div>
    <div class="card p-5 amber-box" style="grid-column:1/-1">
      <h3 style="font-weight:900;font-size:.9rem;color:#92400e;margin-bottom:.75rem">🚫 WORDS TO NEVER SAY DURING CRISIS</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:.5rem;font-size:.8rem">
        <div style="background:white;padding:.5rem .75rem;border-radius:.5rem;color:#dc2626;font-weight:700">"Calm down!" — invalidating</div>
        <div style="background:white;padding:.5rem .75rem;border-radius:.5rem;color:#dc2626;font-weight:700">"I know how you feel" — dismissive</div>
        <div style="background:white;padding:.5rem .75rem;border-radius:.5rem;color:#dc2626;font-weight:700">"You need to..." — commanding</div>
        <div style="background:white;padding:.5rem .75rem;border-radius:.5rem;color:#dc2626;font-weight:700">"That makes no sense" — invalidating</div>
        <div style="background:white;padding:.5rem .75rem;border-radius:.5rem;color:#dc2626;font-weight:700">"Nothing is wrong" — gaslighting</div>
        <div style="background:white;padding:.5rem .75rem;border-radius:.5rem;color:#dc2626;font-weight:700">"Stop overreacting" — shaming</div>
      </div>
    </div>
  </div>
</div>

<!-- SLIDE 7 — 5-4-3-2-1 GROUNDING -->
<div class="slide" style="background:linear-gradient(135deg,#1e3a8a,#1e40af);padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1.5rem;text-align:center">
    <span class="badge" style="background:rgba(255,255,255,.15);color:#bfdbfe;margin-bottom:1rem">Module 2 · Grounding Techniques</span>
    <h2 style="font-size:2rem;font-weight:900;color:white;font-family:Montserrat,sans-serif">5-4-3-2-1 Grounding</h2>
    <p style="color:#bfdbfe;font-weight:600;margin-top:.4rem;font-size:.9rem">When a patient is trapped in their mind — bring them back to their body. Takes 2 minutes.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:repeat(5,1fr);gap:.875rem">
    <div style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:1.25rem;padding:1.5rem;text-align:center;cursor:pointer;transition:all .2s" onmouseover="this.style.background='rgba(255,255,255,.22)'" onmouseout="this.style.background='rgba(255,255,255,.12)'">
      <div style="font-size:3rem;font-weight:900;color:white;line-height:1">5</div>
      <div style="font-size:.8rem;font-weight:900;color:#93c5fd;text-transform:uppercase;letter-spacing:.1em;margin:.5rem 0">👁️ SEE</div>
      <p style="font-size:.75rem;color:#bfdbfe;line-height:1.5">Name 5 things you can see right now</p>
    </div>
    <div style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:1.25rem;padding:1.5rem;text-align:center;cursor:pointer;transition:all .2s" onmouseover="this.style.background='rgba(255,255,255,.22)'" onmouseout="this.style.background='rgba(255,255,255,.12)'">
      <div style="font-size:3rem;font-weight:900;color:white;line-height:1">4</div>
      <div style="font-size:.8rem;font-weight:900;color:#93c5fd;text-transform:uppercase;letter-spacing:.1em;margin:.5rem 0">✋ TOUCH</div>
      <p style="font-size:.75rem;color:#bfdbfe;line-height:1.5">Feel 4 different textures around you</p>
    </div>
    <div style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:1.25rem;padding:1.5rem;text-align:center;cursor:pointer;transition:all .2s" onmouseover="this.style.background='rgba(255,255,255,.22)'" onmouseout="this.style.background='rgba(255,255,255,.12)'">
      <div style="font-size:3rem;font-weight:900;color:white;line-height:1">3</div>
      <div style="font-size:.8rem;font-weight:900;color:#93c5fd;text-transform:uppercase;letter-spacing:.1em;margin:.5rem 0">👂 HEAR</div>
      <p style="font-size:.75rem;color:#bfdbfe;line-height:1.5">Identify 3 distinct sounds near and far</p>
    </div>
    <div style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:1.25rem;padding:1.5rem;text-align:center;cursor:pointer;transition:all .2s" onmouseover="this.style.background='rgba(255,255,255,.22)'" onmouseout="this.style.background='rgba(255,255,255,.12)'">
      <div style="font-size:3rem;font-weight:900;color:white;line-height:1">2</div>
      <div style="font-size:.8rem;font-weight:900;color:#93c5fd;text-transform:uppercase;letter-spacing:.1em;margin:.5rem 0">👃 SMELL</div>
      <p style="font-size:.75rem;color:#bfdbfe;line-height:1.5">Notice 2 scents: coffee, soap, air</p>
    </div>
    <div style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:1.25rem;padding:1.5rem;text-align:center;cursor:pointer;transition:all .2s" onmouseover="this.style.background='rgba(255,255,255,.22)'" onmouseout="this.style.background='rgba(255,255,255,.12)'">
      <div style="font-size:3rem;font-weight:900;color:white;line-height:1">1</div>
      <div style="font-size:.8rem;font-weight:900;color:#93c5fd;text-transform:uppercase;letter-spacing:.1em;margin:.5rem 0">👅 TASTE</div>
      <p style="font-size:.75rem;color:#bfdbfe;line-height:1.5">One taste — water, food, mint, etc.</p>
    </div>
  </div>
  <div style="padding:0 2rem 2rem">
    <div style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:1.25rem;padding:1.5rem;display:flex;align-items:center;gap:1rem">
      <div style="font-size:2rem;flex-shrink:0">💡</div>
      <p style="font-size:.85rem;color:#bfdbfe;line-height:1.7;font-weight:500"><strong style="color:white">How to guide a patient through this:</strong> Speak slowly, pause between each step. "Can you look around and tell me one thing you see? Just one." — Each answer is a micro-victory that builds momentum away from crisis.</p>
    </div>
  </div>
</div>

<!-- SLIDE 8 — BOX BREATHING -->
<div class="slide" style="background:#f8fafc;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#dbeafe;color:#1d4ed8;margin-bottom:1rem">Module 2 · Breathing Techniques</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">Box Breathing (4-4-4-4)</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">Used by Navy SEALs, ER nurses, and crisis counselors worldwide. Activates the parasympathetic nervous system in 60 seconds.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:flex;gap:2rem;align-items:center;flex-wrap:wrap">
    <div style="flex:1;min-width:280px">
      <div id="box-breath-anim" style="width:220px;height:220px;border:6px solid #2563eb;border-radius:2rem;margin:0 auto 1.5rem;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;transition:all .3s" onclick="startBoxBreathing()">
        <div style="text-align:center">
          <div id="box-phase" style="font-size:1.25rem;font-weight:900;color:#1d4ed8;font-family:Montserrat,sans-serif">TAP TO START</div>
          <div id="box-count" style="font-size:3rem;font-weight:900;color:#0f172a">▶</div>
        </div>
        <div id="box-indicator" style="position:absolute;width:16px;height:16px;background:#2563eb;border-radius:50%;top:0;left:50%;transform:translateX(-50%) translateY(-50%);box-shadow:0 0 12px rgba(37,99,235,.6);transition:all 1s linear"></div>
      </div>
      <p style="text-align:center;font-size:.8rem;color:#64748b;font-weight:600">Click the box to begin a guided round</p>
    </div>
    <div style="flex:2;min-width:280px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem">
        <div class="card p-4" style="border-left:4px solid #3b82f6"><p style="font-size:.7rem;font-weight:900;color:#1d4ed8;text-transform:uppercase;margin-bottom:.4rem">Step 1 — Inhale</p><p style="font-size:1.5rem;font-weight:900;color:#0f172a">4 Counts</p><p style="font-size:.8rem;color:#64748b;margin-top:.4rem">Slow, fill from belly to chest</p></div>
        <div class="card p-4" style="border-left:4px solid #8b5cf6"><p style="font-size:.7rem;font-weight:900;color:#6d28d9;text-transform:uppercase;margin-bottom:.4rem">Step 2 — Hold</p><p style="font-size:1.5rem;font-weight:900;color:#0f172a">4 Counts</p><p style="font-size:.8rem;color:#64748b;margin-top:.4rem">Hold at the top — stay still</p></div>
        <div class="card p-4" style="border-left:4px solid #06b6d4"><p style="font-size:.7rem;font-weight:900;color:#0e7490;text-transform:uppercase;margin-bottom:.4rem">Step 3 — Exhale</p><p style="font-size:1.5rem;font-weight:900;color:#0f172a">4 Counts</p><p style="font-size:.8rem;color:#64748b;margin-top:.4rem">Slow exhale — release tension</p></div>
        <div class="card p-4" style="border-left:4px solid #22c55e"><p style="font-size:.7rem;font-weight:900;color:#166534;text-transform:uppercase;margin-bottom:.4rem">Step 4 — Hold</p><p style="font-size:1.5rem;font-weight:900;color:#0f172a">4 Counts</p><p style="font-size:.8rem;color:#64748b;margin-top:.4rem">Empty pause before next cycle</p></div>
      </div>
      <div class="card amber-box p-4"><strong style="color:#92400e">Staff Note:</strong> <span style="font-size:.825rem;color:#78350f">Model this yourself first — "I'm going to take a moment to breathe. Want to try with me?" Breathing together creates co-regulation and builds trust.</span></div>
    </div>
  </div>
</div>

<!-- SLIDE 9 — SENSORY TOOLS -->
<div class="slide" style="background:white;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#cffafe;color:#0e7490;margin-bottom:1rem">Module 2 · Sensory Regulation</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">Sensory Regulation Tools</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">Sensory input can reset the nervous system faster than any verbal intervention.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:repeat(3,1fr);gap:1.25rem">
    <div class="card p-6" style="border-top:5px solid #06b6d4;text-align:center">
      <div style="font-size:3rem;margin-bottom:.75rem" class="anim-bounce" style="display:inline-block">🧊</div>
      <h3 style="font-weight:900;color:#0e7490;margin-bottom:.5rem;font-size:1rem">Cold Compress / Ice Water</h3>
      <p style="font-size:.7rem;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.75rem">Vagus Nerve Activation</p>
      <p style="font-size:.8rem;color:#475569;line-height:1.6">Cold on face/wrists triggers the dive reflex — instantly slows heart rate and activates parasympathetic response. Fastest biological de-escalator available.</p>
    </div>
    <div class="card p-6" style="border-top:5px solid #f97316;text-align:center">
      <div style="font-size:3rem;margin-bottom:.75rem">🍋</div>
      <h3 style="font-weight:900;color:#c2410c;margin-bottom:.5rem;font-size:1rem">Sour / Strong Flavor</h3>
      <p style="font-size:.7rem;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.75rem">Sensory Interrupt</p>
      <p style="font-size:.8rem;color:#475569;line-height:1.6">A sudden intense taste/smell breaks the rumination loop. Lemon candy, sour gummy, strong peppermint — pulls attention forcibly to the present moment.</p>
    </div>
    <div class="card p-6" style="border-top:5px solid #8b5cf6;text-align:center">
      <div style="font-size:3rem;margin-bottom:.75rem">🫂</div>
      <h3 style="font-weight:900;color:#6d28d9;margin-bottom:.5rem;font-size:1rem">Deep Pressure / Weight</h3>
      <p style="font-size:.7rem;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.75rem">Proprioceptive Input</p>
      <p style="font-size:.8rem;color:#475569;line-height:1.6">Weighted blankets, firm hand squeeze (with consent), or pressing feet firmly to floor — activates proprioceptors and signals bodily safety to the CNS.</p>
    </div>
    <div class="card p-6" style="border-top:5px solid #22c55e;text-align:center">
      <div style="font-size:3rem;margin-bottom:.75rem">🎵</div>
      <h3 style="font-weight:900;color:#15803d;margin-bottom:.5rem;font-size:1rem">Sound / Music</h3>
      <p style="font-size:.7rem;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.75rem">Auditory Regulation</p>
      <p style="font-size:.8rem;color:#475569;line-height:1.6">Low-frequency calm music or white noise can reduce cortisol. Avoid silence in high-tension rooms — offer a quiet familiar sound if available.</p>
    </div>
    <div class="card p-6" style="border-top:5px solid #eab308;text-align:center">
      <div style="font-size:3rem;margin-bottom:.75rem">🖐️</div>
      <h3 style="font-weight:900;color:#92400e;margin-bottom:.5rem;font-size:1rem">Fidget / Textured Object</h3>
      <p style="font-size:.7rem;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.75rem">Tactile Focus Tool</p>
      <p style="font-size:.8rem;color:#475569;line-height:1.6">Silly putty, rubber band, stress ball — gives the nervous system a safe outlet for excess energy. Particularly effective with ADHD and Autism presentations.</p>
    </div>
    <div class="card p-6" style="border-top:5px solid #ec4899;text-align:center">
      <div style="font-size:3rem;margin-bottom:.75rem">🌬️</div>
      <h3 style="font-weight:900;color:#9d174d;margin-bottom:.5rem;font-size:1rem">Breath Focus</h3>
      <p style="font-size:.7rem;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.75rem">Mindful Anchor</p>
      <p style="font-size:.8rem;color:#475569;line-height:1.6">Slow exhale longer than inhale (4 in, 6 out) reliably activates the vagal brake. Combine with a visual focus point for maximum effect.</p>
    </div>
  </div>
</div>

<!-- SLIDE 10 — CPI ESCALATION MODEL -->
<div class="slide" style="background:#0f172a;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:rgba(239,68,68,.2);color:#fca5a5;border:1px solid rgba(239,68,68,.3);margin-bottom:1rem">Module 3 · Crisis Stages</span>
    <h2 style="font-size:2rem;font-weight:900;color:white;font-family:Montserrat,sans-serif">Crisis Escalation Stages</h2>
    <p style="color:#94a3b8;font-weight:600;margin-top:.4rem;font-size:.9rem">Behavior signals tell you exactly where someone is. Match your intervention to their stage.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:flex;flex-direction:column;gap:.875rem">
    <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:1rem;align-items:center;background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.25);border-radius:1.25rem;padding:1.25rem">
      <div style="text-align:center"><div style="font-size:1.5rem;font-weight:900;color:#4ade80">1</div><div style="font-size:.65rem;font-weight:900;color:#86efac;text-transform:uppercase">Baseline</div></div>
      <div><p style="font-size:.85rem;font-weight:800;color:#86efac;margin-bottom:.4rem">Normal Behavior</p><p style="font-size:.8rem;color:#4ade80;line-height:1.5">Calm, cooperative, engaged. Normal verbal interaction. No warning signs present.</p></div>
      <div style="background:rgba(0,0,0,.3);border-radius:.75rem;padding:.875rem"><p style="font-size:.75rem;font-weight:800;color:#86efac;margin-bottom:.35rem">YOUR ROLE:</p><p style="font-size:.78rem;color:#4ade80">Build rapport, establish trust, maintain positive therapeutic relationship. Prevention is here.</p></div>
    </div>
    <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:1rem;align-items:center;background:rgba(234,179,8,.12);border:1px solid rgba(234,179,8,.25);border-radius:1.25rem;padding:1.25rem">
      <div style="text-align:center"><div style="font-size:1.5rem;font-weight:900;color:#facc15">2</div><div style="font-size:.65rem;font-weight:900;color:#fde047;text-transform:uppercase">Trigger</div></div>
      <div><p style="font-size:.85rem;font-weight:800;color:#fde047;margin-bottom:.4rem">Early Signs of Distress</p><p style="font-size:.8rem;color:#fbbf24;line-height:1.5">Pacing, raised voice, restlessness, withdrawal, increasing demands, short answers.</p></div>
      <div style="background:rgba(0,0,0,.3);border-radius:.75rem;padding:.875rem"><p style="font-size:.75rem;font-weight:800;color:#fde047;margin-bottom:.35rem">YOUR ROLE:</p><p style="font-size:.78rem;color:#fbbf24">Acknowledge, offer space, use empathy. Remove the trigger if possible. "I can see something's wrong — I'm here."</p></div>
    </div>
    <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:1rem;align-items:center;background:rgba(249,115,22,.12);border:1px solid rgba(249,115,22,.25);border-radius:1.25rem;padding:1.25rem">
      <div style="text-align:center"><div style="font-size:1.5rem;font-weight:900;color:#fb923c">3</div><div style="font-size:.65rem;font-weight:900;color:#fdba74;text-transform:uppercase">Agitation</div></div>
      <div><p style="font-size:.85rem;font-weight:800;color:#fdba74;margin-bottom:.4rem">Active Distress</p><p style="font-size:.8rem;color:#fb923c;line-height:1.5">Yelling, crying, swearing, threatening gestures, property destruction, refusing direction.</p></div>
      <div style="background:rgba(0,0,0,.3);border-radius:.75rem;padding:.875rem"><p style="font-size:.75rem;font-weight:800;color:#fdba74;margin-bottom:.35rem">YOUR ROLE:</p><p style="font-size:.78rem;color:#fb923c">Limit commands. Validate heavily. Offer choices. Reduce audience. Call for support — don't handle alone if escalating.</p></div>
    </div>
    <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:1rem;align-items:center;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.25);border-radius:1.25rem;padding:1.25rem">
      <div style="text-align:center"><div style="font-size:1.5rem;font-weight:900;color:#f87171">4</div><div style="font-size:.65rem;font-weight:900;color:#fca5a5;text-transform:uppercase">Acceleration</div></div>
      <div><p style="font-size:.85rem;font-weight:800;color:#fca5a5;margin-bottom:.4rem">Loss of Control</p><p style="font-size:.8rem;color:#f87171;line-height:1.5">Physical aggression possible. Throwing objects, charging, self-harm. Rational communication is not possible.</p></div>
      <div style="background:rgba(0,0,0,.3);border-radius:.75rem;padding:.875rem"><p style="font-size:.75rem;font-weight:800;color:#fca5a5;margin-bottom:.35rem">YOUR ROLE:</p><p style="font-size:.78rem;color:#f87171">Safety first. Do NOT debate. Back away, give space, call code if needed. Verbal de-escalation is secondary to physical safety here.</p></div>
    </div>
    <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:1rem;align-items:center;background:rgba(139,92,246,.12);border:1px solid rgba(139,92,246,.25);border-radius:1.25rem;padding:1.25rem">
      <div style="text-align:center"><div style="font-size:1.5rem;font-weight:900;color:#a78bfa">5</div><div style="font-size:.65rem;font-weight:900;color:#c4b5fd;text-transform:uppercase">Recovery</div></div>
      <div><p style="font-size:.85rem;font-weight:800;color:#c4b5fd;margin-bottom:.4rem">Post-Crisis State</p><p style="font-size:.8rem;color:#a78bfa;line-height:1.5">Emotional exhaustion, shame, remorse, vulnerability. This is a critical therapeutic window.</p></div>
      <div style="background:rgba(0,0,0,.3);border-radius:.75rem;padding:.875rem"><p style="font-size:.75rem;font-weight:800;color:#c4b5fd;margin-bottom:.35rem">YOUR ROLE:</p><p style="font-size:.78rem;color:#a78bfa">Non-judgmental presence. No debriefing immediately. "I'm glad you're okay. We don't have to talk now." Reconnect when calm.</p></div>
    </div>
  </div>
</div>

<!-- SLIDE 11 — AUTISM SPECTRUM DISORDER -->
<div class="slide" style="background:#f8fafc;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#dbeafe;color:#1d4ed8;margin-bottom:1rem">Module 4 · Diagnosis-Specific Care</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">🧩 Autism Spectrum Disorder</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">Neurodivergence, not defiance. Different sensory wiring — not behavioral choice.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.25rem">
    <div class="card p-5 red-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#dc2626;text-transform:uppercase;margin-bottom:.875rem">⚠️ Crisis Triggers</h3>
      <ul style="font-size:.82rem;color:#7f1d1d;line-height:2;font-weight:600">
        <li>🔊 Sudden loud noises</li>
        <li>💡 Fluorescent/bright lights</li>
        <li>🔄 Unexpected routine change</li>
        <li>👥 Crowds / too many people</li>
        <li>👁️ Forced eye contact</li>
        <li>🤝 Unexpected physical touch</li>
        <li>❓ Abstract or figurative language</li>
        <li>⏰ Transitions without warning</li>
      </ul>
    </div>
    <div class="card p-5 green-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#16a34a;text-transform:uppercase;margin-bottom:.875rem">✓ What Works</h3>
      <ul style="font-size:.82rem;color:#14532d;line-height:2;font-weight:600">
        <li>📖 Literal, concrete language</li>
        <li>🔇 Reduce sensory input first</li>
        <li>🔁 Respect stimming behavior</li>
        <li>👁️ No forced eye contact</li>
        <li>⏱️ Give processing time (10-15 sec)</li>
        <li>📋 Written instructions if possible</li>
        <li>🎯 One clear direction at a time</li>
        <li>🏠 Offer a quiet, calm space</li>
      </ul>
    </div>
    <div class="card p-5 blue-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#1d4ed8;text-transform:uppercase;margin-bottom:.875rem">🗣️ Language Examples</h3>
      <div style="display:flex;flex-direction:column;gap:.75rem">
        <div style="background:white;padding:.75rem;border-radius:.75rem;border-left:3px solid #ef4444"><p style="font-size:.72rem;font-weight:900;color:#dc2626;margin-bottom:.25rem">AVOID</p><p style="font-size:.78rem;color:#7f1d1d;font-style:italic">"Take a chill pill"<br>"Give me some space"<br>"Stop acting out"</p></div>
        <div style="background:white;padding:.75rem;border-radius:.75rem;border-left:3px solid #22c55e"><p style="font-size:.72rem;font-weight:900;color:#16a34a;margin-bottom:.25rem">USE INSTEAD</p><p style="font-size:.78rem;color:#166534;font-style:italic">"Please sit in the blue chair now"<br>"I will be back in 5 minutes"<br>"That behavior is not allowed here"</p></div>
      </div>
    </div>
    <div class="card p-5 amber-box" style="grid-column:1/-1">
      <strong style="color:#92400e">🧠 Remember:</strong> <span style="font-size:.875rem;color:#78350f">Stimming (rocking, flapping, humming, spinning) is <strong>self-regulation</strong> — it is NOT misbehavior. Stopping a stim removes their coping mechanism and WILL escalate the situation. Unless it's dangerous to self/others, let it continue.</span>
    </div>
  </div>
</div>

<!-- SLIDE 12 — ADHD -->
<div class="slide" style="background:white;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#fef3c7;color:#92400e;margin-bottom:1rem">Module 4 · Diagnosis-Specific Care</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">⚡ ADHD</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">Executive dysfunction is neurological, not laziness. The brain genuinely cannot regulate attention and impulse without support.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.25rem">
    <div class="card p-5" style="border-top:4px solid #f59e0b">
      <h3 style="font-weight:900;font-size:.9rem;color:#92400e;text-transform:uppercase;margin-bottom:.875rem">📋 Clinical Indicators</h3>
      <ul style="font-size:.82rem;color:#78350f;line-height:2;font-weight:600">
        <li>🎯 Hyperfocus on wrong task</li>
        <li>⚡ Cannot redirect easily</li>
        <li>🏃 Constant movement/pacing</li>
        <li>💭 Racing thoughts, can't follow long instructions</li>
        <li>😤 Shame spiral when unable to comply</li>
        <li>⏰ Time blindness</li>
        <li>💥 Impulsive emotional outbursts</li>
        <li>😴 Alternates between shutdown and hyperactivity</li>
      </ul>
    </div>
    <div class="card p-5 green-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#166534;text-transform:uppercase;margin-bottom:.875rem">✓ What Works</h3>
      <ul style="font-size:.82rem;color:#14532d;line-height:2;font-weight:600">
        <li>🏃 Offer movement: "Want to walk?"</li>
        <li>📌 ONE instruction at a time</li>
        <li>⚡ Immediate feedback: "Yes! That's it"</li>
        <li>🎯 Match their energy, then slow down</li>
        <li>❤️ Never shame: "You got this"</li>
        <li>⏱️ Use timers as visual anchors</li>
        <li>🎮 Gamify: "Let's see if you can..."</li>
        <li>🔄 Offer choices to increase buy-in</li>
      </ul>
    </div>
    <div class="card p-5 blue-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#1d4ed8;text-transform:uppercase;margin-bottom:.875rem">🗣️ Language Examples</h3>
      <div style="display:flex;flex-direction:column;gap:.75rem">
        <div style="background:white;padding:.75rem;border-radius:.75rem;border-left:3px solid #ef4444"><p style="font-size:.72rem;font-weight:900;color:#dc2626;margin-bottom:.25rem">AVOID</p><p style="font-size:.78rem;color:#7f1d1d;font-style:italic">"How hard is it to just sit still?"<br>"Why can't you listen?"<br>"You're being disruptive"</p></div>
        <div style="background:white;padding:.75rem;border-radius:.75rem;border-left:3px solid #22c55e"><p style="font-size:.72rem;font-weight:900;color:#16a34a;margin-bottom:.25rem">USE INSTEAD</p><p style="font-size:.78rem;color:#166534;font-style:italic">"Let's take a quick walk to reset"<br>"One thing: sit in that chair"<br>"I noticed you're having a hard time — want to move rooms?"</p></div>
      </div>
    </div>
    <div class="card p-5 purple-box" style="grid-column:1/-1">
      <strong style="color:#5b21b6">🧠 Key Insight:</strong> <span style="font-size:.875rem;color:#4c1d95">ADHD brains have a dopamine deficit. Reward pathways are weak. This is why they seek stimulation and have difficulty with boring/repetitive tasks. Your warm, specific praise ("You handled that really well") is genuinely neurologically reinforcing — not just nice to say.</span>
    </div>
  </div>
</div>

<!-- SLIDE 13 — SCHIZOPHRENIA -->
<div class="slide" style="background:#f8fafc;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#ede9fe;color:#5b21b6;margin-bottom:1rem">Module 4 · Diagnosis-Specific Care</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">🌀 Schizophrenia Spectrum</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">Their experience is 100% real to them. Never debate the content of psychosis — engage the person, not the delusion.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.25rem">
    <div class="card p-5 red-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#dc2626;text-transform:uppercase;margin-bottom:.875rem">⚠️ Active Psychosis Signs</h3>
      <ul style="font-size:.82rem;color:#7f1d1d;line-height:2;font-weight:600">
        <li>👂 Responding to internal voices (AH)</li>
        <li>👁️ Visual hallucinations</li>
        <li>🕵️ Paranoid delusions (being watched/harmed)</li>
        <li>🔗 Ideas of reference (TV "talking to them")</li>
        <li>💭 Disorganized, tangential speech</li>
        <li>😐 Flat affect / emotional blunting</li>
        <li>🚶 Catatonia or agitated pacing</li>
      </ul>
    </div>
    <div class="card p-5 green-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#166534;text-transform:uppercase;margin-bottom:.875rem">✓ What Works</h3>
      <ul style="font-size:.82rem;color:#14532d;line-height:2;font-weight:600">
        <li>✓ Stay calm — your calm is contagious</li>
        <li>✓ Don't argue with delusion content</li>
        <li>✓ Acknowledge the emotion: "Sounds scary"</li>
        <li>✓ Speak simply — one idea per sentence</li>
        <li>✓ Announce every action before doing it</li>
        <li>✓ Reduce environmental stimulation</li>
        <li>✓ Maintain clear, predictable routine</li>
        <li>✓ Focus on feeling safe, not on reality</li>
      </ul>
    </div>
    <div class="card p-5 blue-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#1d4ed8;text-transform:uppercase;margin-bottom:.875rem">🗣️ Language Examples</h3>
      <div style="display:flex;flex-direction:column;gap:.75rem">
        <div style="background:white;padding:.75rem;border-radius:.75rem;border-left:3px solid #ef4444"><p style="font-size:.72rem;font-weight:900;color:#dc2626;margin-bottom:.25rem">NEVER SAY</p><p style="font-size:.78rem;color:#7f1d1d;font-style:italic">"That's not real"<br>"The voices aren't there"<br>"You're imagining it"</p></div>
        <div style="background:white;padding:.75rem;border-radius:.75rem;border-left:3px solid #22c55e"><p style="font-size:.72rem;font-weight:900;color:#16a34a;margin-bottom:.25rem">SAY INSTEAD</p><p style="font-size:.78rem;color:#166534;font-style:italic">"That sounds really frightening"<br>"I don't hear what you hear, but I believe you feel scared"<br>"I'm right here. You are safe."</p></div>
      </div>
    </div>
    <div class="card p-5 amber-box" style="grid-column:1/-1">
      <strong style="color:#92400e">⚡ Critical Principle:</strong> <span style="font-size:.875rem;color:#78350f">Never physically startle a patient in active psychosis — announce EVERYTHING: "I'm going to sit down now." "I'm going to hand you this cup." Unexpected movements from staff can be interpreted as threats within the delusional framework and will escalate immediately.</span>
    </div>
  </div>
</div>

</div><!-- end #app section 1 — JS and remaining slides added next -->
<script>
// ═══════════════════════════════════════════════════════════
//  SLIDES 14-27 injected dynamically to avoid file limits
// ═══════════════════════════════════════════════════════════
document.addEventListener('DOMContentLoaded', function() {
  const app = document.getElementById('app');
  app.insertAdjacentHTML('beforeend', getSlides14to27());
  window._slidesReady = true;
  // If Firebase auth already fired and initApp was queued, run it now
  if(window._initAppQueued) { window._initAppQueued = false; initApp(); }
});

function getSlides14to27() { return `

<!-- SLIDE 14 — BIPOLAR DISORDER -->
<div class="slide" style="background:white;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#fce7f3;color:#9d174d;margin-bottom:1rem">Module 4 · Diagnosis-Specific Care</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">📊 Bipolar Disorder</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">A mood cycling disorder — not a personality flaw. The intervention differs completely between mania and depression presentations.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr;gap:1.25rem">
    <div class="card p-5" style="border-top:4px solid #f59e0b">
      <h3 style="font-weight:900;font-size:.95rem;color:#92400e;text-transform:uppercase;margin-bottom:.875rem">☀️ Manic Episode</h3>
      <div style="margin-bottom:.875rem"><p style="font-size:.75rem;font-weight:800;color:#94a3b8;text-transform:uppercase;margin-bottom:.4rem">Signs</p><ul style="font-size:.82rem;color:#78350f;line-height:1.8;font-weight:600"><li>• Rapid/pressured speech, cannot interrupt</li><li>• Decreased need for sleep (not tired)</li><li>• Grandiosity ("I am the only one who can fix this")</li><li>• Impulsive, risky behavior</li><li>• Irritability if challenged</li></ul></div>
      <div style="background:#fffbeb;padding:.875rem;border-radius:.875rem"><p style="font-size:.75rem;font-weight:800;color:#92400e;margin-bottom:.4rem">YOUR APPROACH:</p><p style="font-size:.8rem;color:#78350f;line-height:1.5">Match their energy initially then gradually slow. Brief, simple directives. Don't argue with grandiose ideas. Redirect: "That sounds exciting — let's find a quiet space to talk about it."</p></div>
    </div>
    <div class="card p-5" style="border-top:4px solid #6366f1">
      <h3 style="font-weight:900;font-size:.95rem;color:#3730a3;text-transform:uppercase;margin-bottom:.875rem">🌑 Depressive Episode</h3>
      <div style="margin-bottom:.875rem"><p style="font-size:.75rem;font-weight:800;color:#94a3b8;text-transform:uppercase;margin-bottom:.4rem">Signs</p><ul style="font-size:.82rem;color:#3730a3;line-height:1.8;font-weight:600"><li>• Withdrawal, flat affect, hopelessness</li><li>• Very slow speech and movement</li><li>• Possible suicidal ideation</li><li>• Excessive sleep or insomnia</li><li>• Self-neglect (not eating, hygiene)</li></ul></div>
      <div style="background:#eef2ff;padding:.875rem;border-radius:.875rem"><p style="font-size:.75rem;font-weight:800;color:#3730a3;margin-bottom:.4rem">YOUR APPROACH:</p><p style="font-size:.8rem;color:#4338ca;line-height:1.5">Slow, warm, low-key presence. Don't try to "cheer them up." Sit with them quietly. Ask directly about suicidal thoughts — asking does NOT increase risk. "Are you having any thoughts of hurting yourself?"</p></div>
    </div>
    <div class="card p-4 amber-box" style="grid-column:1/-1">
      <strong style="color:#92400e">⚡ Mixed States:</strong> <span style="font-size:.875rem;color:#78350f">The most dangerous phase — simultaneous depressive hopelessness AND manic energy/impulsivity. Highest suicide risk occurs here. Involve clinical team immediately and complete a suicide risk assessment.</span>
    </div>
  </div>
</div>

<!-- SLIDE 15 — PTSD -->
<div class="slide" style="background:#f8fafc;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#ecfdf5;color:#065f46;margin-bottom:1rem">Module 4 · Diagnosis-Specific Care</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">🛡️ Post-Traumatic Stress Disorder</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">Trauma lives in the body, not just the mind. A trigger transports the patient to the past — they are not "overreacting."</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.25rem">
    <div class="card p-5 red-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#dc2626;text-transform:uppercase;margin-bottom:.875rem">⚠️ Trauma Triggers</h3>
      <ul style="font-size:.82rem;color:#7f1d1d;line-height:2;font-weight:600">
        <li>👥 Being touched without warning</li>
        <li>🔒 Feeling restrained/confined</li>
        <li>👨‍⚕️ Uniforms/authority figures</li>
        <li>🔊 Raised voices/arguments</li>
        <li>🌙 Night / darkness / sleeping</li>
        <li>📅 Anniversaries of trauma</li>
        <li>👃 Smells/sensory reminders</li>
      </ul>
    </div>
    <div class="card p-5 green-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#166534;text-transform:uppercase;margin-bottom:.875rem">✓ Trauma-Informed Response</h3>
      <ul style="font-size:.82rem;color:#14532d;line-height:2;font-weight:600">
        <li>✓ Always explain before you touch</li>
        <li>✓ Offer choice and control ALWAYS</li>
        <li>✓ "You are safe right now. This is [place]."</li>
        <li>✓ Grounding before processing</li>
        <li>✓ Ask: "What would help you feel safer?"</li>
        <li>✓ Never restrain if avoidable — triggers re-traumatization</li>
        <li>✓ Identify and avoid known triggers</li>
      </ul>
    </div>
    <div class="card p-5 blue-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#1d4ed8;text-transform:uppercase;margin-bottom:.875rem">🧠 Flashback Protocol</h3>
      <p style="font-size:.8rem;color:#1e3a8a;line-height:1.6;font-weight:600;margin-bottom:1rem">During a flashback, they are neurologically in the past. Bring them back:</p>
      <div style="background:white;padding:1rem;border-radius:.875rem;font-size:.8rem;color:#1e3a8a;font-weight:700;line-height:2">
        <div>1. "Look at me. You are with [your name]."</div>
        <div>2. "You are in [location]. Today is [date]."</div>
        <div>3. "The [past event] is over. You survived."</div>
        <div>4. Name 3 things they can see right now.</div>
        <div>5. Grounding breath: 4 in, 6 out.</div>
      </div>
    </div>
    <div class="card p-4 purple-box" style="grid-column:1/-1">
      <strong style="color:#5b21b6">⚕️ Staff Wellness Note:</strong> <span style="font-size:.875rem;color:#4c1d95">Vicarious trauma is real. After a particularly intense trauma-related interaction, take 5 minutes to decompress. Talk to a colleague or supervisor. You cannot pour from an empty cup — your wellbeing directly affects patient outcomes.</span>
    </div>
  </div>
</div>

<!-- SLIDE 16 — BORDERLINE PERSONALITY DISORDER -->
<div class="slide" style="background:white;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#fce7f3;color:#831843;margin-bottom:1rem">Module 4 · Diagnosis-Specific Care</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">💔 Borderline Personality Disorder</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">Intense emotion dysregulation + fear of abandonment. The most misunderstood diagnosis in psychiatry. Requires consistent, boundaried compassion.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr;gap:1.25rem">
    <div class="card p-5">
      <h3 style="font-weight:900;font-size:.95rem;color:#0f172a;text-transform:uppercase;margin-bottom:.875rem">📋 Typical Crisis Patterns</h3>
      <ul style="font-size:.82rem;color:#374151;line-height:2;font-weight:600">
        <li>🌊 Rapid emotion escalation (0→100 instantly)</li>
        <li>✂️ Self-harm as emotional regulation</li>
        <li>😱 Splitting: staff are "all good" or "all evil"</li>
        <li>😭 Intense fear of abandonment/"being left"</li>
        <li>🎭 Identity disturbance / emptiness</li>
        <li>🔥 Intense anger at perceived rejection</li>
        <li>💊 Impulsive behaviors / threats</li>
      </ul>
    </div>
    <div class="card p-5 green-box">
      <h3 style="font-weight:900;font-size:.95rem;color:#166534;text-transform:uppercase;margin-bottom:.875rem">✓ DBT-Informed Approach</h3>
      <ul style="font-size:.82rem;color:#14532d;line-height:2;font-weight:600">
        <li>✓ Validate the emotion, not the behavior</li>
        <li>✓ Maintain consistent, reliable presence</li>
        <li>✓ Clear, fair, predictable limits</li>
        <li>✓ Avoid punitive or rejecting language</li>
        <li>✓ TIPP skills: Temp, Intense exercise, Paced breathing, Progressive relaxation</li>
        <li>✓ Never threaten abandonment: "I'll come back"</li>
        <li>✓ Same staff member = consistency = safety</li>
      </ul>
    </div>
    <div class="card p-5 red-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#dc2626;text-transform:uppercase;margin-bottom:.875rem">✕ Common Staff Mistakes</h3>
      <ul style="font-size:.82rem;color:#7f1d1d;line-height:2;font-weight:600">
        <li>✕ Labeling behavior as "attention-seeking"</li>
        <li>✕ Getting "hooked" into debates</li>
        <li>✕ Inconsistent rules between staff shifts</li>
        <li>✕ Taking splitting personally ("she hates me")</li>
        <li>✕ Ignoring self-harm threats ("they always say that")</li>
      </ul>
    </div>
    <div class="card p-5 blue-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#1d4ed8;text-transform:uppercase;margin-bottom:.875rem">🗣️ Key Script</h3>
      <div style="background:white;padding:1rem;border-radius:.875rem;font-size:.82rem;color:#1e3a8a;line-height:1.8;font-style:italic;font-weight:600">
        "I hear you and I'm not going anywhere. What you're feeling is real. I can't do [X] right now, but I will [Y]. I'm here."
      </div>
      <p style="font-size:.75rem;color:#3b82f6;margin-top:.75rem;font-weight:700">Validates + Sets limit + Commits to presence = the BPD de-escalation formula</p>
    </div>
  </div>
</div>

<!-- SLIDE 17 — TRAUMA-INFORMED CARE -->
<div class="slide" style="background:#0f172a;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:rgba(167,139,250,.2);color:#c4b5fd;border:1px solid rgba(167,139,250,.3);margin-bottom:1rem">Module 5 · Trauma-Informed Practice</span>
    <h2 style="font-size:2rem;font-weight:900;color:white;font-family:Montserrat,sans-serif">The 4 R's of Trauma-Informed Care</h2>
    <p style="color:#94a3b8;font-weight:600;margin-top:.4rem;font-size:.9rem">Not a checklist — a lens through which every interaction must pass. Developed by SAMHSA.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr;gap:1.25rem">
    <div style="background:rgba(167,139,250,.1);border:1px solid rgba(167,139,250,.25);border-radius:1.25rem;padding:1.5rem">
      <div style="font-size:2rem;margin-bottom:.75rem">🔍</div>
      <h3 style="font-weight:900;color:#c4b5fd;margin-bottom:.75rem;font-size:1rem;text-transform:uppercase">Realize</h3>
      <p style="font-size:.85rem;color:#a78bfa;line-height:1.7">Understand the widespread impact of trauma. Recognize that <strong style="color:white">the majority of psychiatric patients have trauma histories</strong>. This shapes how they perceive everything — including you.</p>
    </div>
    <div style="background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.25);border-radius:1.25rem;padding:1.5rem">
      <div style="font-size:2rem;margin-bottom:.75rem">👁️</div>
      <h3 style="font-weight:900;color:#93c5fd;margin-bottom:.75rem;font-size:1rem;text-transform:uppercase">Recognize</h3>
      <p style="font-size:.85rem;color:#60a5fa;line-height:1.7">Identify signs of trauma in patients, families, and colleagues. Ask yourself: <strong style="color:white">"What happened to this person?"</strong> — not "What's wrong with this person?"</p>
    </div>
    <div style="background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.25);border-radius:1.25rem;padding:1.5rem">
      <div style="font-size:2rem;margin-bottom:.75rem">🤝</div>
      <h3 style="font-weight:900;color:#6ee7b7;margin-bottom:.75rem;font-size:1rem;text-transform:uppercase">Respond</h3>
      <p style="font-size:.85rem;color:#34d399;line-height:1.7">Integrate trauma knowledge into every policy, procedure, and interaction. <strong style="color:white">Safety, trustworthiness, choice, collaboration, empowerment</strong> — the 5 principles in every exchange.</p>
    </div>
    <div style="background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.25);border-radius:1.25rem;padding:1.5rem">
      <div style="font-size:2rem;margin-bottom:.75rem">🛑</div>
      <h3 style="font-weight:900;color:#fde68a;margin-bottom:.75rem;font-size:1rem;text-transform:uppercase">Resist Re-traumatization</h3>
      <p style="font-size:.85rem;color:#fbbf24;line-height:1.7">Actively prevent practices that replicate trauma dynamics: <strong style="color:white">forced restraint, isolation, removal of control, power-over dynamics, public shaming</strong>. Every avoidable restraint is a failure.</p>
    </div>
  </div>
  <div style="padding:0 2rem">
    <div style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:1.25rem;padding:1.25rem;display:flex;gap:1rem;align-items:center">
      <div style="font-size:2rem;flex-shrink:0">💬</div>
      <p style="font-size:.875rem;color:#cbd5e1;line-height:1.7"><strong style="color:white">The shift:</strong> Trauma-informed care isn't just being "nicer." It fundamentally changes the power dynamic from clinician-as-authority to clinician-as-partner. Patients who feel empowered rarely escalate to crisis.</p>
    </div>
  </div>
</div>

<!-- SLIDE 18 — SUICIDE RISK ASSESSMENT -->
<div class="slide" style="background:#fff5f5;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#fee2e2;color:#991b1b;margin-bottom:1rem">Module 5 · Safety Assessment</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">☠️ Suicide Risk: The Columbia Protocol</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">Asking about suicide does NOT increase risk. Silence does. Every staff member must be able to ask clearly and document accurately.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr;gap:1.25rem">
    <div class="card p-6">
      <h3 style="font-weight:900;font-size:.95rem;color:#0f172a;text-transform:uppercase;margin-bottom:1rem">📋 C-SSRS Key Questions</h3>
      <div style="display:flex;flex-direction:column;gap:.875rem">
        <div style="background:#fef2f2;padding:.875rem;border-radius:.875rem;border-left:4px solid #ef4444">
          <p style="font-size:.72rem;font-weight:900;color:#dc2626;text-transform:uppercase;margin-bottom:.35rem">Ideation</p>
          <p style="font-size:.82rem;color:#7f1d1d;font-style:italic;font-weight:600">"Are you having any thoughts of killing yourself or wishing you were dead?"</p>
        </div>
        <div style="background:#fef2f2;padding:.875rem;border-radius:.875rem;border-left:4px solid #f97316">
          <p style="font-size:.72rem;font-weight:900;color:#c2410c;text-transform:uppercase;margin-bottom:.35rem">Plan</p>
          <p style="font-size:.82rem;color:#9a3412;font-style:italic;font-weight:600">"Have you thought about how you would do it?"</p>
        </div>
        <div style="background:#fef2f2;padding:.875rem;border-radius:.875rem;border-left:4px solid #dc2626">
          <p style="font-size:.72rem;font-weight:900;color:#991b1b;text-transform:uppercase;margin-bottom:.35rem">Means / Intent / Timeline</p>
          <p style="font-size:.82rem;color:#7f1d1d;font-style:italic;font-weight:600">"Do you have access to [method]? Do you intend to act on this? Is there a time you're thinking about?"</p>
        </div>
      </div>
    </div>
    <div class="card p-6">
      <h3 style="font-weight:900;font-size:.95rem;color:#0f172a;text-transform:uppercase;margin-bottom:1rem">🚦 Risk Level Response</h3>
      <div style="display:flex;flex-direction:column;gap:.75rem">
        <div style="background:#f0fdf4;padding:.875rem;border-radius:.875rem;border-left:4px solid #22c55e"><p style="font-size:.72rem;font-weight:900;color:#166534;text-transform:uppercase;margin-bottom:.25rem">Low — Passive ideation only</p><p style="font-size:.8rem;color:#15803d">Document, inform nurse/MD, increase check-ins, safety planning discussion</p></div>
        <div style="background:#fffbeb;padding:.875rem;border-radius:.875rem;border-left:4px solid #f59e0b"><p style="font-size:.72rem;font-weight:900;color:#92400e;text-transform:uppercase;margin-bottom:.25rem">Moderate — Plan but no means/intent</p><p style="font-size:.8rem;color:#78350f">Immediate psychiatric evaluation, environment safety check, 1:1 monitoring</p></div>
        <div style="background:#fef2f2;padding:.875rem;border-radius:.875rem;border-left:4px solid #ef4444"><p style="font-size:.72rem;font-weight:900;color:#991b1b;text-transform:uppercase;margin-bottom:.25rem">High — Plan + Means + Intent</p><p style="font-size:.8rem;color:#7f1d1d"><strong>CODE. Stay with patient. Do not leave alone. Call charge RN immediately.</strong> Remove any accessible means from environment.</p></div>
      </div>
    </div>
    <div class="card p-4 amber-box" style="grid-column:1/-1">
      <strong style="color:#92400e">⚠️ NEVER SAY:</strong> <span style="font-size:.875rem;color:#78350f">"If you were really suicidal you'd have done it by now" · "You're just looking for attention" · "I need to get another patient." — These are documented contributors to completed suicides. Every expression of suicidality is a moment of trust. Honor it.</span>
    </div>
  </div>
</div>

<!-- SLIDE 19 — CULTURAL COMPETENCY -->
<div class="slide" style="background:#f8fafc;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#ecfdf5;color:#065f46;margin-bottom:1rem">Module 5 · Cultural Competency</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">🌍 Cultural Competency in Crisis</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">Culture shapes how distress is expressed, what help looks like, and who is trusted. One size never fits all.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.25rem">
    <div class="card p-5 blue-box">
      <div style="font-size:2rem;margin-bottom:.75rem">🗣️</div>
      <h3 style="font-weight:900;font-size:.9rem;color:#1d4ed8;text-transform:uppercase;margin-bottom:.75rem">Language Access</h3>
      <ul style="font-size:.82rem;color:#1e3a8a;line-height:1.8;font-weight:600">
        <li>• Always use certified interpreter (not family)</li>
        <li>• Speak to patient, not interpreter</li>
        <li>• Back-translate critical information</li>
        <li>• Written materials in patient's language</li>
        <li>• "Do you prefer I speak through an interpreter?"</li>
      </ul>
    </div>
    <div class="card p-5 green-box">
      <div style="font-size:2rem;margin-bottom:.75rem">🤲</div>
      <h3 style="font-weight:900;font-size:.9rem;color:#166534;text-transform:uppercase;margin-bottom:.75rem">Cultural Expressions</h3>
      <ul style="font-size:.82rem;color:#14532d;line-height:1.8;font-weight:600">
        <li>• Eye contact norms vary by culture</li>
        <li>• Physical touch has different meaning</li>
        <li>• Some cultures somatize (physical symptoms for emotional distress)</li>
        <li>• Mental illness stigma is higher in some communities</li>
        <li>• Spiritual/religious frameworks must be respected</li>
      </ul>
    </div>
    <div class="card p-5 amber-box">
      <div style="font-size:2rem;margin-bottom:.75rem">⚖️</div>
      <h3 style="font-weight:900;font-size:.9rem;color:#92400e;text-transform:uppercase;margin-bottom:.75rem">Implicit Bias</h3>
      <ul style="font-size:.82rem;color:#78350f;line-height:1.8;font-weight:600">
        <li>• Check your assumptions before entering a room</li>
        <li>• Black patients are statistically undertreated for pain</li>
        <li>• Immigrant patients fear disclosure</li>
        <li>• LGBTQ+ patients have higher trauma rates</li>
        <li>• Ask: "What do you call what's happening to you?"</li>
      </ul>
    </div>
    <div class="card p-5 purple-box" style="grid-column:1/-1">
      <strong style="color:#5b21b6">💡 The LEARN Model:</strong>
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:.75rem;margin-top:1rem;font-size:.8rem">
        <div style="background:white;padding:.75rem;border-radius:.75rem;text-align:center"><strong style="color:#6d28d9;display:block;font-size:1.25rem">L</strong><span style="color:#4c1d95">Listen with empathy</span></div>
        <div style="background:white;padding:.75rem;border-radius:.75rem;text-align:center"><strong style="color:#6d28d9;display:block;font-size:1.25rem">E</strong><span style="color:#4c1d95">Explain your perception</span></div>
        <div style="background:white;padding:.75rem;border-radius:.75rem;text-align:center"><strong style="color:#6d28d9;display:block;font-size:1.25rem">A</strong><span style="color:#4c1d95">Acknowledge differences</span></div>
        <div style="background:white;padding:.75rem;border-radius:.75rem;text-align:center"><strong style="color:#6d28d9;display:block;font-size:1.25rem">R</strong><span style="color:#4c1d95">Recommend together</span></div>
        <div style="background:white;padding:.75rem;border-radius:.75rem;text-align:center"><strong style="color:#6d28d9;display:block;font-size:1.25rem">N</strong><span style="color:#4c1d95">Negotiate a plan</span></div>
      </div>
    </div>
  </div>
</div>

<!-- SLIDE 20 — DOCUMENTATION -->
<div class="slide" style="background:white;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#f0f9ff;color:#075985;margin-bottom:1rem">Module 6 · Clinical Documentation</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">📝 Documentation & Reporting</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">If it's not documented, it didn't happen. Precision protects patients AND staff.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr;gap:1.25rem">
    <div class="card p-6">
      <h3 style="font-weight:900;font-size:.95rem;color:#0f172a;text-transform:uppercase;margin-bottom:1rem">✓ What to Document in a Crisis</h3>
      <ul style="font-size:.85rem;color:#374151;line-height:2.2;font-weight:600">
        <li>📅 Exact time the behavior began</li>
        <li>👁️ Specific observable behaviors (not interpretations)</li>
        <li>🗣️ Exact quotes when possible</li>
        <li>🤝 What interventions were used and when</li>
        <li>👤 Who was present / notified</li>
        <li>📊 Patient's response to each intervention</li>
        <li>🏁 How the situation resolved</li>
        <li>⏰ Time of resolution and patient's current status</li>
      </ul>
    </div>
    <div class="card p-6">
      <h3 style="font-weight:900;font-size:.95rem;color:#0f172a;text-transform:uppercase;margin-bottom:1rem">📖 Objective vs. Subjective</h3>
      <div style="display:flex;flex-direction:column;gap:.875rem">
        <div><p style="font-size:.75rem;font-weight:900;color:#dc2626;text-transform:uppercase;margin-bottom:.4rem">✕ Subjective (AVOID)</p><div style="background:#fef2f2;padding:.75rem;border-radius:.75rem;font-size:.82rem;color:#7f1d1d;font-style:italic;font-weight:600">"Patient was aggressive and uncooperative, seemed manic, appeared dangerous"</div></div>
        <div><p style="font-size:.75rem;font-weight:900;color:#16a34a;text-transform:uppercase;margin-bottom:.4rem">✓ Objective (USE)</p><div style="background:#f0fdf4;padding:.75rem;border-radius:.75rem;font-size:.82rem;color:#166534;font-style:italic;font-weight:600">"At 14:32, patient raised voice and struck wall three times with open palm. Stated 'I'm going to hurt someone' twice. Staff member Jones initiated verbal de-escalation. Patient sat down at 14:38."</div></div>
      </div>
    </div>
    <div class="card p-4 amber-box" style="grid-column:1/-1">
      <strong style="color:#92400e">⚠️ Legal Reminder:</strong> <span style="font-size:.875rem;color:#78350f">Your documentation is a legal document. Use only DSM-5 or facility-approved terminology. Never document what you think happened — only what you directly observed. Timely completion (within shift) is required by JCAHO standards.</span>
    </div>
  </div>
</div>

<!-- SLIDE 21 — SUBSTANCE USE / DUAL DIAGNOSIS -->
<div class="slide" style="background:#f8fafc;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#fef3c7;color:#78350f;margin-bottom:1rem">Module 4 · Dual Diagnosis</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">💊 Substance Use & Dual Diagnosis</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">60% of psychiatric inpatients have a co-occurring substance use disorder. They are inseparable — treat both or treat neither.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.25rem">
    <div class="card p-5 red-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#dc2626;text-transform:uppercase;margin-bottom:.875rem">🚨 High-Risk Acute Signs</h3>
      <ul style="font-size:.82rem;color:#7f1d1d;line-height:2;font-weight:600">
        <li>Stimulants: paranoia, aggression, racing</li>
        <li>Depressants: slurred, slow, unresponsive</li>
        <li>Opioids: pinpoint pupils, respiratory depression</li>
        <li>Hallucinogens: reality detachment, panic</li>
        <li>Alcohol withdrawal: seizure risk, delirium</li>
        <li>Cannabis: acute psychosis (high THC)</li>
      </ul>
    </div>
    <div class="card p-5 green-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#166534;text-transform:uppercase;margin-bottom:.875rem">✓ Safe Approach</h3>
      <ul style="font-size:.82rem;color:#14532d;line-height:2;font-weight:600">
        <li>✓ Non-judgmental stance always</li>
        <li>✓ Safety first — medical emergency possible</li>
        <li>✓ Don't challenge denial during intoxication</li>
        <li>✓ Motivational Interviewing when sober</li>
        <li>✓ Harm reduction over abstinence-only</li>
        <li>✓ Connect substance use to psychiatric triggers</li>
        <li>✓ Notify medical team immediately for overdose signs</li>
      </ul>
    </div>
    <div class="card p-5 blue-box">
      <h3 style="font-weight:900;font-size:.9rem;color:#1d4ed8;text-transform:uppercase;margin-bottom:.875rem">🧠 Motivational Interviewing</h3>
      <p style="font-size:.8rem;color:#1e3a8a;line-height:1.6;font-weight:600;margin-bottom:.75rem">Use open-ended questions that activate their own motivation:</p>
      <ul style="font-size:.8rem;color:#1e3a8a;line-height:1.8;font-style:italic">
        <li>"What would your life look like without it?"</li>
        <li>"What's one thing you'd like to be different?"</li>
        <li>"What worries you most about how things are going?"</li>
      </ul>
      <p style="font-size:.78rem;color:#3b82f6;margin-top:.75rem;font-weight:700">Remember: Ambivalence is normal. Roll with resistance, don't confront it.</p>
    </div>
  </div>
</div>

<!-- SLIDE 22 — CRISIS SCENARIO LAB -->
<div class="slide" style="background:#0f172a;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:rgba(251,191,36,.2);color:#fde68a;border:1px solid rgba(251,191,36,.3);margin-bottom:1rem">Module 7 · Interactive Practice</span>
    <h2 style="font-size:2rem;font-weight:900;color:white;font-family:Montserrat,sans-serif">🎮 Crisis Scenario Lab</h2>
    <p style="color:#94a3b8;font-weight:600;margin-top:.4rem;font-size:.9rem">Real crisis situations. Choose your diagnosis and practice your response. Earn XP for thoughtful interventions.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr;gap:1.25rem">
    <div class="card p-6" style="display:flex;flex-direction:column;gap:1rem">
      <div>
        <label style="font-size:.75rem;font-weight:900;color:#64748b;text-transform:uppercase;letter-spacing:.08em;display:block;margin-bottom:.5rem">Select Diagnosis</label>
        <select id="scenario-dx" style="width:100%;padding:.75rem 1rem;background:#f8fafc;border:2px solid #e2e8f0;border-radius:.875rem;font-family:inherit;font-weight:700;font-size:.9rem;outline:none">
          <option value="autism">🧩 Autism Spectrum Disorder</option>
          <option value="adhd">⚡ ADHD</option>
          <option value="schizophrenia">🌀 Schizophrenia</option>
          <option value="bipolar">📊 Bipolar Disorder</option>
          <option value="ptsd">🛡️ PTSD</option>
          <option value="bpd">💔 Borderline PD</option>
        </select>
      </div>
      <div id="scenario-box" style="background:#f8fafc;border:2px solid #e2e8f0;border-radius:1rem;padding:1.25rem;min-height:140px;font-size:.875rem;color:#374151;line-height:1.7;font-style:italic;font-weight:500">Click Generate to receive a crisis scenario...</div>
      <textarea id="scenario-response" style="width:100%;padding:.875rem;background:#f8fafc;border:2px solid #e2e8f0;border-radius:.875rem;font-family:inherit;font-size:.85rem;font-weight:600;resize:none;outline:none;height:100px" placeholder="Describe your de-escalation approach..."></textarea>
      <div style="display:flex;gap:.75rem">
        <button onclick="generateScenario()" class="btn btn-amber" style="flex:1">✨ Generate Scenario</button>
        <button onclick="submitScenario()" class="btn btn-primary" style="flex:1" id="submit-btn" disabled>Submit Response ›</button>
      </div>
    </div>
    <div class="card p-6" style="display:flex;flex-direction:column;gap:1rem">
      <div id="scenario-feedback" style="flex:1;background:#f8fafc;border:2px solid #e2e8f0;border-radius:1rem;padding:1.25rem;font-size:.875rem;color:#374151;line-height:1.7;min-height:200px">
        <p style="color:#94a3b8;font-style:italic">Feedback from AI mentor will appear here after you submit your response...</p>
      </div>
      <div id="scenario-score" style="display:none;background:linear-gradient(135deg,#1e3a8a,#2563eb);border-radius:1rem;padding:1.25rem;text-align:center">
        <p style="color:#bfdbfe;font-size:.75rem;font-weight:900;text-transform:uppercase;letter-spacing:.1em;margin-bottom:.5rem">Score</p>
        <p id="score-letter" style="font-size:3rem;font-weight:900;color:white;font-family:Montserrat,sans-serif;line-height:1">A</p>
        <p id="score-xp" style="color:#93c5fd;font-weight:800;font-size:.9rem">+250 XP earned</p>
      </div>
      <div style="background:#fffbeb;border-radius:1rem;padding:1rem;border-left:4px solid #f59e0b">
        <p style="font-size:.75rem;font-weight:900;color:#92400e;text-transform:uppercase;margin-bottom:.4rem">💰 XP Scoring</p>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;font-size:.8rem;color:#78350f;font-weight:700">
          <span>A (Excellent): +250 XP</span><span>B (Good): +175 XP</span>
          <span>C (Fair): +100 XP</span><span>D (Needs work): +50 XP</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SLIDE 23 — ROLEPLAY SCRIPT BUILDER -->
<div class="slide" style="background:#f8fafc;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#dcfce7;color:#166534;margin-bottom:1rem">Module 7 · Team Training Tools</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">📜 Role-Play Script Builder</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">Build realistic training scripts for team huddles, onboarding, and clinical supervision sessions.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 2fr;gap:1.25rem">
    <div style="display:flex;flex-direction:column;gap:.875rem">
      <div>
        <label style="font-size:.75rem;font-weight:900;color:#64748b;text-transform:uppercase;letter-spacing:.08em;display:block;margin-bottom:.5rem">Scenario Topic</label>
        <input id="slide-script-topic" class="input-field" placeholder="e.g., Medication refusal">
      </div>
      <div>
        <label style="font-size:.75rem;font-weight:900;color:#64748b;text-transform:uppercase;letter-spacing:.08em;display:block;margin-bottom:.5rem">Diagnosis Context</label>
        <select id="script-dx" class="input-field">
          <option value="general">General / Any</option>
          <option value="autism">Autism</option>
          <option value="schizophrenia">Schizophrenia</option>
          <option value="bpd">Borderline PD</option>
          <option value="ptsd">PTSD</option>
          <option value="bipolar">Bipolar (Manic)</option>
        </select>
      </div>
      <div>
        <label style="font-size:.75rem;font-weight:900;color:#64748b;text-transform:uppercase;letter-spacing:.08em;display:block;margin-bottom:.5rem">Difficulty</label>
        <select id="script-level" class="input-field">
          <option value="basic">Basic — New Staff</option>
          <option value="intermediate">Intermediate</option>
          <option value="advanced">Advanced — Experienced</option>
        </select>
      </div>
      <button onclick="buildScript()" class="btn btn-success">🎭 Build Script</button>
      <button onclick="printScript()" class="btn" style="background:#f1f5f9;color:#475569">🖨️ Print Script</button>
    </div>
    <div id="slide-script-output" style="background:#0f172a;border-radius:1.5rem;padding:1.5rem;font-family:'Courier New',monospace;font-size:.82rem;line-height:1.8;color:#4ade80;min-height:400px;white-space:pre-wrap;overflow-y:auto">
<span style="color:#64748b;font-style:normal">// Select options and click Build Script to generate a training scenario...</span>
    </div>
  </div>
</div>

<!-- SLIDE 24 — DOWNLOADABLE REFERENCE CARDS -->
<div class="slide" style="background:linear-gradient(135deg,#1e3a8a,#2563eb);padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem;text-align:center">
    <span class="badge" style="background:rgba(255,255,255,.15);color:#bfdbfe;margin-bottom:1rem">Module 8 · Field Resources</span>
    <h2 style="font-size:2rem;font-weight:900;color:white;font-family:Montserrat,sans-serif">🃏 Quick Reference Cards</h2>
    <p style="color:#93c5fd;font-weight:600;margin-top:.4rem;font-size:.9rem">Keep these in your pocket. Evidence-based techniques on the fly. Click any card to download as PDF.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:repeat(3,1fr);gap:1.25rem">
    <div class="card p-5" style="cursor:pointer;transition:all .2s;text-align:center" onclick="downloadCard('deescalation')" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 20px 40px rgba(0,0,0,.2)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
      <div style="font-size:2.5rem;margin-bottom:.75rem">🎯</div>
      <h3 style="font-weight:900;font-size:.95rem;color:#1e3a8a;margin-bottom:.5rem">Top 10 De-escalation Phrases</h3>
      <p style="font-size:.78rem;color:#64748b;margin-bottom:1rem">The exact words to use in any crisis situation</p>
      <span class="badge" style="background:#dbeafe;color:#1d4ed8">📥 Download PDF</span>
    </div>
    <div class="card p-5" style="cursor:pointer;transition:all .2s;text-align:center" onclick="downloadCard('diagnoses')" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform=''">
      <div style="font-size:2.5rem;margin-bottom:.75rem">🧠</div>
      <h3 style="font-weight:900;font-size:.95rem;color:#1e3a8a;margin-bottom:.5rem">Diagnosis Quick Guide</h3>
      <p style="font-size:.78rem;color:#64748b;margin-bottom:1rem">Key triggers + approaches for all 6 diagnoses</p>
      <span class="badge" style="background:#dcfce7;color:#166534">📥 Download PDF</span>
    </div>
    <div class="card p-5" style="cursor:pointer;transition:all .2s;text-align:center" onclick="downloadCard('grounding')" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform=''">
      <div style="font-size:2.5rem;margin-bottom:.75rem">⚓</div>
      <h3 style="font-weight:900;font-size:.95rem;color:#1e3a8a;margin-bottom:.5rem">Grounding Techniques</h3>
      <p style="font-size:.78rem;color:#64748b;margin-bottom:1rem">5-4-3-2-1, Box Breathing, TIPP reference</p>
      <span class="badge" style="background:#fef3c7;color:#92400e">📥 Download PDF</span>
    </div>
    <div class="card p-5" style="cursor:pointer;transition:all .2s;text-align:center" onclick="downloadCard('suicide')" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform=''">
      <div style="font-size:2.5rem;margin-bottom:.75rem">☠️</div>
      <h3 style="font-weight:900;font-size:.95rem;color:#1e3a8a;margin-bottom:.5rem">Suicide Risk Protocol</h3>
      <p style="font-size:.78rem;color:#64748b;margin-bottom:1rem">C-SSRS questions + response levels</p>
      <span class="badge" style="background:#fee2e2;color:#991b1b">📥 Download PDF</span>
    </div>
    <div class="card p-5" style="cursor:pointer;transition:all .2s;text-align:center" onclick="downloadCard('escalation')" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform=''">
      <div style="font-size:2.5rem;margin-bottom:.75rem">📈</div>
      <h3 style="font-weight:900;font-size:.95rem;color:#1e3a8a;margin-bottom:.5rem">Escalation Stage Chart</h3>
      <p style="font-size:.78rem;color:#64748b;margin-bottom:1rem">5-stage model with staff roles at each level</p>
      <span class="badge" style="background:#ede9fe;color:#5b21b6">📥 Download PDF</span>
    </div>
    <div class="card p-5" style="cursor:pointer;transition:all .2s;text-align:center" onclick="downloadCard('trauma')" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform=''">
      <div style="font-size:2.5rem;margin-bottom:.75rem">🛡️</div>
      <h3 style="font-weight:900;font-size:.95rem;color:#1e3a8a;margin-bottom:.5rem">Trauma-Informed Principles</h3>
      <p style="font-size:.78rem;color:#64748b;margin-bottom:1rem">4 R's + 5 principles quick reference</p>
      <span class="badge" style="background:#d1fae5;color:#065f46">📥 Download PDF</span>
    </div>
  </div>
</div>

<!-- SLIDE 25 — RESOURCES & RECOMMENDED READING -->
<div class="slide" style="background:#f8fafc;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:#fef3c7;color:#92400e;margin-bottom:1rem">Module 8 · Continued Learning</span>
    <h2 style="font-size:2rem;font-weight:900;color:#0f172a;font-family:Montserrat,sans-serif">📚 Resources & Recommended Reading</h2>
    <p style="color:#64748b;font-weight:600;margin-top:.4rem;font-size:.9rem">Deepen your expertise. These are the definitive resources in psychiatric crisis care.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr;gap:1.25rem">
    <div class="card p-6">
      <h3 style="font-weight:900;font-size:.95rem;color:#0f172a;text-transform:uppercase;margin-bottom:1rem">📖 Essential Books</h3>
      <div style="display:flex;flex-direction:column;gap:.875rem">
        <div style="display:flex;gap:.875rem;align-items:start"><div style="width:44px;height:56px;background:linear-gradient(135deg,#2563eb,#1d4ed8);border-radius:.5rem;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:white;font-size:.6rem;font-weight:900;text-align:center;padding:.2rem">📘</div><div><p style="font-weight:800;font-size:.85rem;color:#0f172a">The Body Keeps the Score</p><p style="font-size:.75rem;color:#64748b">Bessel van der Kolk — Essential trauma neuroscience</p></div></div>
        <div style="display:flex;gap:.875rem;align-items:start"><div style="width:44px;height:56px;background:linear-gradient(135deg,#059669,#047857);border-radius:.5rem;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:white;font-size:.6rem;font-weight:900;text-align:center;padding:.2rem">📗</div><div><p style="font-weight:800;font-size:.85rem;color:#0f172a">DBT Skills Training Manual</p><p style="font-size:.75rem;color:#64748b">Marsha Linehan — The BPD treatment bible</p></div></div>
        <div style="display:flex;gap:.875rem;align-items:start"><div style="width:44px;height:56px;background:linear-gradient(135deg,#7c3aed,#6d28d9);border-radius:.5rem;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:white;font-size:.6rem;font-weight:900;text-align:center;padding:.2rem">📙</div><div><p style="font-weight:800;font-size:.85rem;color:#0f172a">An Unquiet Mind</p><p style="font-size:.75rem;color:#64748b">Kay Redfield Jamison — Bipolar from the inside</p></div></div>
        <div style="display:flex;gap:.875rem;align-items:start"><div style="width:44px;height:56px;background:linear-gradient(135deg,#dc2626,#b91c1c);border-radius:.5rem;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:white;font-size:.6rem;font-weight:900;text-align:center;padding:.2rem">📕</div><div><p style="font-weight:800;font-size:.85rem;color:#0f172a">Walking on Eggshells</p><p style="font-size:.75rem;color:#64748b">Paul Mason — Understanding BPD relationships</p></div></div>
      </div>
    </div>
    <div class="card p-6">
      <h3 style="font-weight:900;font-size:.95rem;color:#0f172a;text-transform:uppercase;margin-bottom:1rem">🌐 Online Resources</h3>
      <div style="display:flex;flex-direction:column;gap:.75rem">
        <div style="background:#eff6ff;padding:.875rem;border-radius:.875rem"><p style="font-weight:800;font-size:.85rem;color:#1e40af">SAMHSA TIP 59 — Trauma-Informed Care</p><p style="font-size:.75rem;color:#3b82f6">samhsa.gov — Free, comprehensive clinical guide</p></div>
        <div style="background:#f0fdf4;padding:.875rem;border-radius:.875rem"><p style="font-weight:800;font-size:.85rem;color:#166534">CPI (Crisis Prevention Institute)</p><p style="font-size:.75rem;color:#22c55e">crisisprevention.com — Training & certification</p></div>
        <div style="background:#faf5ff;padding:.875rem;border-radius:.875rem"><p style="font-weight:800;font-size:.85rem;color:#5b21b6">NAMI — National Alliance on Mental Illness</p><p style="font-size:.75rem;color:#7c3aed">nami.org — Family education & peer support</p></div>
        <div style="background:#fff7ed;padding:.875rem;border-radius:.875rem"><p style="font-weight:800;font-size:.85rem;color:#9a3412">988 Suicide & Crisis Lifeline</p><p style="font-size:.75rem;color:#f97316">Call or text 988 — Clinical guidance available</p></div>
        <div style="background:#f0f9ff;padding:.875rem;border-radius:.875rem"><p style="font-weight:800;font-size:.85rem;color:#075985">Zero Suicide Institute</p><p style="font-size:.75rem;color:#0284c7">zerosuicide.com — Staff training certification</p></div>
      </div>
    </div>
  </div>
</div>

<!-- SLIDE 26 — STAFF WELLNESS -->
<div class="slide" style="background:linear-gradient(135deg,#0f172a,#1e1b4b);padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem;text-align:center">
    <span class="badge" style="background:rgba(167,139,250,.2);color:#c4b5fd;margin-bottom:1rem">Module 9 · Staff Wellbeing</span>
    <h2 style="font-size:2rem;font-weight:900;color:white;font-family:Montserrat,sans-serif">🌿 Your Wellness Matters</h2>
    <p style="color:#a5b4fc;font-weight:600;margin-top:.4rem;font-size:.9rem">Compassion fatigue is real. Recognizing it in yourself is the first step to sustainable care.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.25rem">
    <div style="background:rgba(167,139,250,.1);border:1px solid rgba(167,139,250,.2);border-radius:1.25rem;padding:1.5rem">
      <div style="font-size:2rem;margin-bottom:.75rem">😔</div>
      <h3 style="font-weight:900;color:#c4b5fd;font-size:.95rem;margin-bottom:.75rem;text-transform:uppercase">Signs of Compassion Fatigue</h3>
      <ul style="font-size:.82rem;color:#a78bfa;line-height:2;font-weight:600">
        <li>• Dreading going to work</li>
        <li>• Emotional numbness toward patients</li>
        <li>• Intrusive thoughts / nightmares</li>
        <li>• Cynicism: "They did it to themselves"</li>
        <li>• Physical exhaustion despite rest</li>
        <li>• Increased errors or distractibility</li>
      </ul>
    </div>
    <div style="background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.2);border-radius:1.25rem;padding:1.5rem">
      <div style="font-size:2rem;margin-bottom:.75rem">🌱</div>
      <h3 style="font-weight:900;color:#6ee7b7;font-size:.95rem;margin-bottom:.75rem;text-transform:uppercase">Recovery Strategies</h3>
      <ul style="font-size:.82rem;color:#34d399;line-height:2;font-weight:600">
        <li>• Debrief after difficult incidents</li>
        <li>• Physical movement before/after shifts</li>
        <li>• Name your emotions — don't suppress</li>
        <li>• Peer support check-ins</li>
        <li>• EAP / counseling — use it freely</li>
        <li>• Boundary clarity: work ends at logout</li>
      </ul>
    </div>
    <div style="background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.2);border-radius:1.25rem;padding:1.5rem">
      <div style="font-size:2rem;margin-bottom:.75rem">🛑</div>
      <h3 style="font-weight:900;color:#fde68a;font-size:.95rem;margin-bottom:.75rem;text-transform:uppercase">When to Escalate</h3>
      <ul style="font-size:.82rem;color:#fbbf24;line-height:2;font-weight:600">
        <li>• Unable to separate work from personal</li>
        <li>• Suicidal thoughts of your own</li>
        <li>• Substance use to cope</li>
        <li>• Extended absence from activities you loved</li>
        <li>• Feeling hopeless about your own future</li>
        <li>→ Talk to supervisor or HR today</li>
      </ul>
    </div>
    <div style="background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);border-radius:1.25rem;padding:1.5rem;grid-column:1/-1;display:flex;align-items:center;gap:1rem">
      <div style="font-size:2.5rem;flex-shrink:0">💬</div>
      <div>
        <p style="font-weight:800;color:white;margin-bottom:.5rem">Internal Resources at Destiny Springs Healthcare</p>
        <p style="font-size:.875rem;color:#94a3b8;line-height:1.7">Employee Assistance Program (EAP) · Peer Support Team · Clinical Supervisor Debriefs · Anonymous wellness check-ins available anytime. <strong style="color:#c4b5fd">You cannot give what you don't have. Taking care of yourself IS patient care.</strong></p>
      </div>
    </div>
  </div>
</div>

<!-- SLIDE 27 — INTERACTIVE DEMOS + MATCHING -->
<div class="slide" style="background:#0b172a;padding-bottom:5rem">
  <div style="padding:2.5rem 2rem 1rem">
    <span class="badge" style="background:rgba(59,130,246,.16);color:#bfdbfe;border:1px solid rgba(59,130,246,.3);margin-bottom:1rem">Module 9 · Practice & Play</span>
    <h2 style="font-size:2rem;font-weight:900;color:white;font-family:Montserrat,sans-serif">🎬 Watch & Try: Do vs Don’t</h2>
    <p style="color:#cbd5e1;font-weight:600;margin-top:.4rem;font-size:.9rem">View example clips, then test yourself by matching the best (and worst) moves.</p>
  </div>
  <div style="padding:0 2rem 2rem;display:grid;grid-template-columns:1.25fr 1fr;gap:1.25rem;align-items:start;flex-wrap:wrap">
    <div class="card p-5" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:1.25rem">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem">
        <div style="display:flex;flex-direction:column;gap:.6rem">
          <div style="font-weight:900;color:#cbd5e1;font-size:.95rem">De-escalation Example</div>
          <div style="position:relative;padding-top:56.25%;border-radius:.85rem;overflow:hidden;border:1px solid rgba(255,255,255,.12);background:#000">
            <iframe src="https://www.youtube.com/embed/x7T5Eukokgs" title="Staff safety scenario" style="position:absolute;inset:0;width:100%;height:100%;border:0" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen></iframe>
          </div>
          <p style="color:#94a3b8;font-weight:700;font-size:.85rem;line-height:1.6">Watch how staff position themselves, speak slowly, and keep space open.</p>
        </div>
        <div style="display:flex;flex-direction:column;gap:.6rem">
          <div style="font-weight:900;color:#cbd5e1;font-size:.95rem">Trauma-Informed Example</div>
          <div style="position:relative;padding-top:56.25%;border-radius:.85rem;overflow:hidden;border:1px solid rgba(255,255,255,.12);background:#000">
            <iframe src="https://www.youtube.com/embed/Jit68JYo0Us" title="Trauma-informed example" style="position:absolute;inset:0;width:100%;height:100%;border:0" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen></iframe>
          </div>
          <p style="color:#94a3b8;font-weight:700;font-size:.85rem;line-height:1.6">Notice the scripting: consent before touch, choices, and validation.</p>
        </div>
      </div>
    </div>
    <div class="card p-5" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:1.25rem">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.8rem">
        <div>
          <p style="margin:0;font-size:.78rem;color:#93c5fd;font-weight:800;letter-spacing:.08em;text-transform:uppercase">Mini-game</p>
          <h3 style="margin:.15rem 0 0;font-size:1.1rem;font-weight:900;color:white">Match the Do vs Don’t</h3>
        </div>
        <button onclick="resetMatchGame()" style="border:none;background:#0ea5e9;color:white;font-weight:900;padding:.55rem .85rem;border-radius:.75rem;cursor:pointer">Reset</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:.75rem">
        <div data-answer="do" class="match-card" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:.9rem;padding:.85rem">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.5rem">
            <p style="margin:0;color:#e2e8f0;font-weight:800;font-size:.95rem">Offer two safe choices to reduce power struggles.</p>
            <span class="match-status" style="background:rgba(255,255,255,.08);color:#cbd5e1;font-weight:800;padding:.25rem .6rem;border-radius:.6rem;font-size:.78rem">—</span>
          </div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            <button onclick="markMatch(this,'do')" class="btn btn-success" style="padding:.45rem .8rem;font-size:.82rem">Do</button>
            <button onclick="markMatch(this,'dont')" class="btn" style="padding:.45rem .8rem;font-size:.82rem;background:rgba(248,250,252,.1);color:#e2e8f0;border:1px solid rgba(226,232,240,.25)">Don't</button>
          </div>
          <div class="match-feedback" style="margin-top:.4rem;font-size:.82rem;color:#94a3b8;font-weight:700"></div>
        </div>
        <div data-answer="dont" class="match-card" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:.9rem;padding:.85rem">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.5rem">
            <p style="margin:0;color:#e2e8f0;font-weight:800;font-size:.95rem">Say “Calm down!” as a command when emotions spike.</p>
            <span class="match-status" style="background:rgba(255,255,255,.08);color:#cbd5e1;font-weight:800;padding:.25rem .6rem;border-radius:.6rem;font-size:.78rem">—</span>
          </div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            <button onclick="markMatch(this,'do')" class="btn btn-success" style="padding:.45rem .8rem;font-size:.82rem">Do</button>
            <button onclick="markMatch(this,'dont')" class="btn" style="padding:.45rem .8rem;font-size:.82rem;background:rgba(248,250,252,.1);color:#e2e8f0;border:1px solid rgba(226,232,240,.25)">Don't</button>
          </div>
          <div class="match-feedback" style="margin-top:.4rem;font-size:.82rem;color:#94a3b8;font-weight:700"></div>
        </div>
        <div data-answer="do" class="match-card" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:.9rem;padding:.85rem">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.5rem">
            <p style="margin:0;color:#e2e8f0;font-weight:800;font-size:.95rem">Name what you hear and validate (“It makes sense you’re upset”).</p>
            <span class="match-status" style="background:rgba(255,255,255,.08);color:#cbd5e1;font-weight:800;padding:.25rem .6rem;border-radius:.6rem;font-size:.78rem">—</span>
          </div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            <button onclick="markMatch(this,'do')" class="btn btn-success" style="padding:.45rem .8rem;font-size:.82rem">Do</button>
            <button onclick="markMatch(this,'dont')" class="btn" style="padding:.45rem .8rem;font-size:.82rem;background:rgba(248,250,252,.1);color:#e2e8f0;border:1px solid rgba(226,232,240,.25)">Don't</button>
          </div>
          <div class="match-feedback" style="margin-top:.4rem;font-size:.82rem;color:#94a3b8;font-weight:700"></div>
        </div>
        <div data-answer="dont" class="match-card" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:.9rem;padding:.85rem">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.5rem">
            <p style="margin:0;color:#e2e8f0;font-weight:800;font-size:.95rem">Argue with a delusion to prove it’s not real.</p>
            <span class="match-status" style="background:rgba(255,255,255,.08);color:#cbd5e1;font-weight:800;padding:.25rem .6rem;border-radius:.6rem;font-size:.78rem">—</span>
          </div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            <button onclick="markMatch(this,'do')" class="btn btn-success" style="padding:.45rem .8rem;font-size:.82rem">Do</button>
            <button onclick="markMatch(this,'dont')" class="btn" style="padding:.45rem .8rem;font-size:.82rem;background:rgba(248,250,252,.1);color:#e2e8f0;border:1px solid rgba(226,232,240,.25)">Don't</button>
          </div>
          <div class="match-feedback" style="margin-top:.4rem;font-size:.82rem;color:#94a3b8;font-weight:700"></div>
        </div>
        <div data-answer="do" class="match-card" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:.9rem;padding:.85rem">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.5rem">
            <p style="margin:0;color:#e2e8f0;font-weight:800;font-size:.95rem">Offer to dim lights / reduce noise during sensory overload.</p>
            <span class="match-status" style="background:rgba(255,255,255,.08);color:#cbd5e1;font-weight:800;padding:.25rem .6rem;border-radius:.6rem;font-size:.78rem">—</span>
          </div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            <button onclick="markMatch(this,'do')" class="btn btn-success" style="padding:.45rem .8rem;font-size:.82rem">Do</button>
            <button onclick="markMatch(this,'dont')" class="btn" style="padding:.45rem .8rem;font-size:.82rem;background:rgba(248,250,252,.1);color:#e2e8f0;border:1px solid rgba(226,232,240,.25)">Don't</button>
          </div>
          <div class="match-feedback" style="margin-top:.4rem;font-size:.82rem;color:#94a3b8;font-weight:700"></div>
        </div>
        <div data-answer="dont" class="match-card" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:.9rem;padding:.85rem">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.5rem">
            <p style="margin:0;color:#e2e8f0;font-weight:800;font-size:.95rem">Crowd the doorway or block exits during escalation.</p>
            <span class="match-status" style="background:rgba(255,255,255,.08);color:#cbd5e1;font-weight:800;padding:.25rem .6rem;border-radius:.6rem;font-size:.78rem">—</span>
          </div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            <button onclick="markMatch(this,'do')" class="btn btn-success" style="padding:.45rem .8rem;font-size:.82rem">Do</button>
            <button onclick="markMatch(this,'dont')" class="btn" style="padding:.45rem .8rem;font-size:.82rem;background:rgba(248,250,252,.1);color:#e2e8f0;border:1px solid rgba(226,232,240,.25)">Don't</button>
          </div>
          <div class="match-feedback" style="margin-top:.4rem;font-size:.82rem;color:#94a3b8;font-weight:700"></div>
        </div>
      </div>
    </div>

    <!-- Interactive micro-drills -->
    <div style="grid-column:1/-1;display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem">
      <div class="card p-5" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:1.2rem">
        <p style="margin:0 0 .35rem;font-size:.8rem;color:#93c5fd;font-weight:800;letter-spacing:.08em;text-transform:uppercase">Vitals HUD</p>
        <h3 style="margin:0 0 .65rem;font-size:1.1rem;font-weight:900;color:white">Tap when the micro-aggression appears</h3>
        <div style="background:rgba(15,23,42,.6);border:1px solid rgba(255,255,255,.08);border-radius:1rem;padding:1rem;display:flex;flex-direction:column;gap:.65rem">
          <div style="position:relative;padding-top:56%;border-radius:.75rem;overflow:hidden;background:#0b1224;border:1px solid rgba(255,255,255,.12)">
            <img src="microexpressions.png" alt="Microexpression reference" loading="lazy" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.96)">
            <div style="position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.0),rgba(0,0,0,.35));"></div>
            <div id="micro-cue" style="position:absolute;bottom:24%;left:50%;width:44px;height:44px;border-radius:999px;border:2px solid #fcd34d;background:rgba(251,191,36,.2);box-shadow:0 0 0 8px rgba(251,191,36,.08);display:none;transform:translate(-50%,50%);transition:opacity .2s ease;opacity:0;pointer-events:none"></div>
            <div style="position:absolute;left:1rem;bottom:1rem;color:#e2e8f0;font-weight:800;font-size:.85rem;letter-spacing:.02em">Microexpression drill</div>
          </div>
          <div style="display:flex;align-items:center;gap:.6rem">
            <div style="flex:1;height:12px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden">
              <div id="vitals-meter" style="height:12px;width:0%;background:linear-gradient(90deg,#22c55e,#f97316,#ef4444);border-radius:999px;transition:width .12s ease"></div>
            </div>
            <span style="color:#cbd5e1;font-weight:800;font-size:.82rem">Agitation</span>
          </div>
          <div id="vitals-status" style="color:#cbd5e1;font-weight:700;font-size:.9rem">Press start, then tap “Intervene” when you see the jaw clench.</div>
          <div style="display:flex;gap:.6rem;flex-wrap:wrap">
            <button onclick="startVitalsDrill()" class="btn btn-primary" style="flex:1;min-width:160px">Start drill</button>
            <button onclick="tapIntervene()" class="btn btn-success" style="flex:1;min-width:160px">Intervene now</button>
          </div>
        </div>
      </div>

      <div class="card p-5" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:1.2rem">
        <p style="margin:0 0 .35rem;font-size:.8rem;color:#93c5fd;font-weight:800;letter-spacing:.08em;text-transform:uppercase">Verbal Brancher</p>
        <h3 style="margin:0 0 .65rem;font-size:1.1rem;font-weight:900;color:white">Pick a line and see the reaction</h3>
        <div style="display:flex;flex-direction:column;gap:.65rem">
          <button class="btn" style="justify-content:flex-start;gap:.5rem;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);color:#e2e8f0;font-weight:800" onclick="pickBranch('validate')">"I can see this is a lot. Want a quieter space or some water?"</button>
          <button class="btn" style="justify-content:flex-start;gap:.5rem;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);color:#e2e8f0;font-weight:800" onclick="pickBranch('command')">"Calm down and sit or I will have to call security."</button>
          <button class="btn" style="justify-content:flex-start;gap:.5rem;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);color:#e2e8f0;font-weight:800" onclick="pickBranch('debate')">"You are overreacting. Nothing that bad happened."</button>
          <div id="branch-reaction" style="margin-top:.5rem;background:rgba(15,23,42,.6);border:1px solid rgba(255,255,255,.08);border-radius:.9rem;padding:1rem;color:#cbd5e1;font-weight:700;min-height:100px">
            Choose a line to see the patient’s response.
          </div>
          <div id="branch-video" style="background:rgba(0,0,0,.5);border:1px dashed rgba(255,255,255,.15);border-radius:.9rem;padding:.9rem;display:flex;align-items:center;justify-content:center;min-height:140px;position:relative;overflow:hidden">
            <div id="branch-video-label" style="color:#e2e8f0;font-weight:800;font-size:.9rem;text-align:center;line-height:1.4">Choose a response above to see the outcome video.</div>
          </div>
          <button class="btn" style="background:#e2e8f0;color:#0f172a;font-weight:900" onclick="resetBranch()">Reset</button>
        </div>
      </div>

      <div class="card p-5" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:1.2rem">
        <p style="margin:0 0 .35rem;font-size:.8rem;color:#93c5fd;font-weight:800;letter-spacing:.08em;text-transform:uppercase">360° Scan</p>
        <h3 style="margin:0 0 .65rem;font-size:1.1rem;font-weight:900;color:white">Find 5 hazards before time runs out</h3>
        <div style="background:rgba(15,23,42,.6);border:1px solid rgba(255,255,255,.08);border-radius:1rem;padding:1rem;display:flex;flex-direction:column;gap:.75rem">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:.75rem;flex-wrap:wrap">
            <div style="color:#cbd5e1;font-weight:800;font-size:.9rem">Time: <span id="hazard-timer">30s</span></div>
            <div style="color:#a7f3d0;font-weight:800;font-size:.9rem">Hazards found: <span id="hazard-found">0</span>/5</div>
            <button class="btn btn-primary" onclick="startHazardScan()">Start scan</button>
          </div>
          <div id="hazard-wrap" style="position:relative;width:100%;padding-top:62%;border-radius:1rem;overflow:hidden;border:1px solid rgba(255,255,255,.12);background:#0b1224">
            <img src="hazards.png" alt="Patient room environment" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.85)">
            <button class="hazard-dot" data-hid="hx" style="position:absolute;top:22%;left:38%;width:38px;height:38px;border-radius:50%;border:2px solid #fcd34d;background:rgba(251,191,36,.22);color:#fcd34d;font-weight:900;cursor:pointer;display:none" onclick="tapHazard('hx')">!</button>
            <button class="hazard-dot" data-hid="hy" style="position:absolute;top:48%;left:62%;width:38px;height:38px;border-radius:50%;border:2px solid #fcd34d;background:rgba(251,191,36,.22);color:#fcd34d;font-weight:900;cursor:pointer;display:none" onclick="tapHazard('hy')">!</button>
            <button class="hazard-dot" data-hid="hz" style="position:absolute;top:68%;left:24%;width:38px;height:38px;border-radius:50%;border:2px solid #fcd34d;background:rgba(251,191,36,.22);color:#fcd34d;font-weight:900;cursor:pointer;display:none" onclick="tapHazard('hz')">!</button>
            <button class="hazard-dot" data-hid="ha" style="position:absolute;top:30%;left:78%;width:38px;height:38px;border-radius:50%;border:2px solid #fcd34d;background:rgba(251,191,36,.22);color:#fcd34d;font-weight:900;cursor:pointer;display:none" onclick="tapHazard('ha')">!</button>
            <button class="hazard-dot" data-hid="hb" style="position:absolute;top:78%;left:55%;width:38px;height:38px;border-radius:50%;border:2px solid #fcd34d;background:rgba(251,191,36,.22);color:#fcd34d;font-weight:900;cursor:pointer;display:none" onclick="tapHazard('hb')">!</button>
          </div>
          <div id="hazard-status" style="color:#cbd5e1;font-weight:700;font-size:.88rem">Press start to reveal hazards.</div>
          <img id="hazard-fail-img" src="failure.png" alt="De-escalation failure" style="width:100%;border-radius:.75rem;display:none;opacity:.92;margin-top:.1rem">
          <img id="hazard-success-img" src="success.png" alt="De-escalation success" style="width:100%;border-radius:.75rem;display:none;opacity:.92;margin-top:.1rem">
        </div>
      </div>
    </div>
    <!-- Lab debrief — shown after all 3 drills attempted -->
    <div id="lab-debrief" style="grid-column:1/-1;display:none;background:linear-gradient(135deg,rgba(16,185,129,.12),rgba(99,102,241,.12));border:1px solid rgba(16,185,129,.3);border-radius:1.25rem;padding:1.5rem 1.25rem;text-align:center">
      <div style="font-size:2.5rem;margin-bottom:.4rem">🏆</div>
      <h3 style="margin:0 0 .35rem;font-size:1.1rem;font-weight:900;color:white">Lab Session Complete</h3>
      <p style="margin:0 0 1rem;color:#a7f3d0;font-weight:700;font-size:.88rem">You've worked through all three practice drills. Review your stats and keep refining.</p>
      <div id="lab-debrief-stats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-bottom:1rem"></div>
      <button class="btn btn-primary" onclick="startVitalsDrill();resetBranch();startHazardScan();document.getElementById('lab-debrief').style.display='none';drillStats={vitalsAttempts:0,vitalsPass:0,brancherPicks:{},hazardAttempts:0,hazardWins:0};">Run drills again</button>
    </div>
  </div>
</div>

<!-- SLIDE 28 — FINAL KNOWLEDGE CHECK -->
<div class="slide" style="background:linear-gradient(135deg,#0f172a 0%,#1e1b4b 50%,#0f172a 100%);padding-bottom:5rem">
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:3rem 2rem;text-align:center">
    <div style="font-size:5rem;margin-bottom:1rem;animation:bounce 1s ease infinite">🎓</div>
    <h2 style="font-size:clamp(1.75rem,5vw,3rem);font-weight:900;color:white;font-family:Montserrat,sans-serif;margin-bottom:.75rem">Final Knowledge Check</h2>
    <p style="color:#a5b4fc;font-size:1rem;margin-bottom:2.5rem">Score 90% or higher to unlock your certificate on the next slide.</p>
    <div id="final-quiz-card" style="background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:1rem;padding:1.25rem;max-width:960px;width:100%;margin-bottom:1.5rem">
      <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:.75rem"><div style="font-size:1.5rem">📝</div><div><div style="font-weight:900;color:white;font-size:1rem">10-question knowledge check</div><div style="color:#cbd5e1;font-size:.85rem;font-weight:600">Pass to continue.</div></div></div>
      <div id="final-quiz-questions" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:.85rem"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-top:1rem;flex-wrap:wrap">
        <div id="final-quiz-result" style="color:#cbd5e1;font-weight:700;font-size:.9rem">Answer all questions, then submit.</div>
        <button onclick="submitFinalQuiz()" style="background:#38bdf8;border:none;color:#0f172a;font-weight:900;padding:.65rem 1rem;border-radius:.75rem;cursor:pointer">Submit quiz</button>
      </div>
    </div>
    <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:1.5rem;padding:2rem;max-width:640px;width:100%;margin-bottom:1.5rem;backdrop-filter:blur(12px)">
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.2rem">
        <div style="text-align:center"><div id="final-xp" style="font-size:2rem;font-weight:900;color:#60a5fa">0</div><p style="font-size:.7rem;color:#94a3b8;font-weight:700;margin-top:.25rem">Total XP</p></div>
        <div style="text-align:center"><div id="final-level" style="font-size:2rem;font-weight:900;color:#a78bfa">1</div><p style="font-size:.7rem;color:#94a3b8;font-weight:700;margin-top:.25rem">Level</p></div>
        <div style="text-align:center"><div id="final-scenarios" style="font-size:2rem;font-weight:900;color:#34d399">0</div><p style="font-size:.7rem;color:#94a3b8;font-weight:700;margin-top:.25rem">Scenarios</p></div>
        <div style="text-align:center"><div id="final-score" style="font-size:2rem;font-weight:900;color:#fb923c">—</div><p style="font-size:.7rem;color:#94a3b8;font-weight:700;margin-top:.25rem">Avg Score</p></div>
      </div>
      <p style="color:#cbd5e1;font-weight:700;font-size:.9rem;margin:0">Pass to unlock the certificate slide.</p>
    </div>
    <p style="color:#475569;font-size:.75rem;line-height:1.8">© 2026 De-escalation Mastery Lab™. Proprietary training content.<br>Unauthorized reproduction, distribution, or commercial use is prohibited.</p>
  </div>
</div>

<!-- SLIDE 29 — CERTIFICATE DOWNLOAD (UNLOCKED AFTER QUIZ) -->
<div class="slide" style="background:linear-gradient(135deg,#0b1224,#0f172a);padding-bottom:5rem">
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:3rem 2rem;text-align:center">
    <div style="font-size:4.5rem;margin-bottom:1rem">📜</div>
    <h2 style="font-size:clamp(1.85rem,5vw,3rem);font-weight:900;color:white;font-family:Montserrat,sans-serif;margin-bottom:.5rem">Certificate of Completion</h2>
    <p style="color:#a5b4fc;font-size:1rem;margin-bottom:2rem">Available after you score 90% or higher on the quiz.</p>
    <div style="background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:1.5rem;padding:2rem;max-width:640px;width:100%;backdrop-filter:blur(12px);box-shadow:0 14px 40px rgba(0,0,0,.25)">
      <p id="cert-locked-msg" style="color:#cbd5e1;font-weight:700;font-size:.95rem;margin-bottom:1rem">Pass the quiz to unlock your certificate.</p>
      <button id="cert-btn" onclick="downloadCertificate()" disabled style="width:100%;background:linear-gradient(135deg,#2563eb,#7c3aed);color:white;font-weight:900;font-size:1rem;padding:1rem;border-radius:1rem;border:none;cursor:pointer;font-family:Montserrat,sans-serif;letter-spacing:.02em;box-shadow:0 8px 24px rgba(37,99,235,.4);opacity:.8;margin-bottom:1rem">
        📥 Download Certificate
      </button>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;text-align:left;color:#cbd5e1;font-weight:700;font-size:.9rem">
        <div style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:.9rem;padding:.9rem">
          <div style="color:#60a5fa;font-size:.78rem;font-weight:900;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.2rem">XP</div>
          <div id="cert-xp" style="font-size:1.4rem;font-weight:900;color:white">0</div>
        </div>
        <div style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:.9rem;padding:.9rem">
          <div style="color:#a78bfa;font-size:.78rem;font-weight:900;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.2rem">Level</div>
          <div id="cert-level" style="font-size:1.4rem;font-weight:900;color:white">1</div>
        </div>
        <div style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:.9rem;padding:.9rem">
          <div style="color:#34d399;font-size:.78rem;font-weight:900;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.2rem">Scenarios</div>
          <div id="cert-scenarios" style="font-size:1.4rem;font-weight:900;color:white">0</div>
        </div>
        <div style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:.9rem;padding:.9rem">
          <div style="color:#fbbf24;font-size:.78rem;font-weight:900;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.2rem">Quiz</div>
          <div id="cert-score" style="font-size:1.4rem;font-weight:900;color:white">—</div>
        </div>
      </div>
    </div>
  </div>
</div>

`; }
</script>

<!-- ═══════════════════════════════════════════════════════════
     MAIN APPLICATION JAVASCRIPT
═══════════════════════════════════════════════════════════ -->
<script>
// ─── State ────────────────────────────────────────────────
const LOGO_SVG = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 900 300' role='img' aria-label='Destiny Springs Healthcare' width='100%' height='100%'>
  <defs>
    <linearGradient id='ds-grad' x1='0%' y1='0%' x2='100%' y2='100%'>
      <stop offset='0%' stop-color='#1FA0E0'/>
      <stop offset='100%' stop-color='#0066B3'/>
    </linearGradient>
  </defs>
  <g transform='translate(40 30) scale(0.9)'>
    <path fill='url(#ds-grad)' d='M200 240c-77 0-140-63-140-140S123 0 200 0s140 63 140 140-63 140-140 140Zm0-16c67 0 122-55 122-124S267  -24 200 -24 78 31 78 100s55 124 122 124Z' opacity='0.35'/>
    <path fill='url(#ds-grad)' d='M205 248c-74 0-134-60-134-134 0-24 6-47 18-67 4-7 14-9 20-4 49 44 93 50 129 27 8-5 18 3 15 12-14 46-51 105-151 112 22 17 50 27 80 27 56 0 105-33 126-80-8 67-65 119-133 119Z'/>
    <path fill='url(#ds-grad)' d='M121 213c39-6 70-34 95-107 4-13 19-17 28-7 9 10 12 26 6 41-27 75-78 97-129 73Z'/>
    <text x='280' y='130' fill='#0f5fab' font-family='Georgia,serif' font-size='86' font-weight='400'>Destiny Springs</text>
    <text x='280' y='185' fill='#0f9edd' font-family='Helvetica Neue,Arial,sans-serif' font-size='46' font-weight='700' letter-spacing='6'>HEALTHCARE</text>
  </g>
</svg>`;
function renderInlineLogos() {
  const t = window.TENANT;
  document.querySelectorAll('.logo-inline').forEach(el => {
    if(t?.logoUrl) {
      el.innerHTML = `<img src="${t.logoUrl}" alt="${t.orgName || ''}" style="width:100%;height:auto;object-fit:contain;display:block;max-height:80px">`;
    } else {
      el.innerHTML = LOGO_SVG;
    }
  });
}
function applyTenantContent() {
  const T = window.TENANT;
  if(!T) return;
  const el = id => document.getElementById(id);
  document.title = `${T.orgName} \u2014 ${T.brandName}`;
  if(el('auth-tagline'))    el('auth-tagline').textContent   = `Master psychiatric de-escalation techniques through immersive training built for ${T.orgName} staff.`;
  if(el('auth-org-logo'))  { el('auth-org-logo').src = T.logoUrl; el('auth-org-logo').alt = T.orgName; }
  if(el('auth-privacy'))   el('auth-privacy').textContent   = `Your information is stored securely and used only for ${T.orgName} training purposes.`;
  if(el('auth-copyright')) el('auth-copyright').textContent = `\u00A9 ${T.copyrightYear} ${T.brandName}`;
  if(el('hub-heading'))    el('hub-heading').textContent    = `Welcome back to the ${T.orgName} ${T.brandName}`;
  if(el('hub-org-pill'))   el('hub-org-pill').textContent   = T.orgName;
  if(el('admin-role-badge')) el('admin-role-badge').textContent = `${T.orgName} \u2014 Training Management`;
  if(el('lab-patient-name')) el('lab-patient-name').innerHTML = `${T.patientName} <span style="font-size:.75rem;font-weight:600;color:#94a3b8">\u2014 ${T.patientDx}</span>`;
  document.querySelectorAll('.tenant-lab-bg').forEach(img => { img.src = T.labImageUrl; });
}
document.addEventListener('DOMContentLoaded', () => { renderInlineLogos(); applyTenantContent(); });
const CHAT_ENDPOINT = '/api/pax-chat';
let currentSlide = 0;
let totalSlides  = 0;
let xp           = 0;
let level        = 1;
let scenariosDone= 0;
let scoreTotal   = 0;
let avatarActive = false;
let breathInterval= null;
let completedTraining = false;
let finalQuizPassed = false;
let finalQuizScore = 0;
let finalQuizResponses = {};
let sessionMode = 'training'; // training | review | lab | prompt
let scenarioActive= false;
let adminCodeHash = null; // stored hash from settings
let lastSpokenSlide = -1; // ensure Pax speaks once per slide
const _spokenSlides = new Set(); // track every slide Vance has already spoken about (prevents repeats on back-nav)
let labCredits = 0;
let currentLabScenarioId = null;
let currentLabDx = null;
let labSettings = { labBaseLC:50, labScoreBonus:{A:50,B:30,C:15,D:5}, redemptionTiers:[300,600,1000,1800], weeklyBonusLC:200 };
let paxMuted = false;
let paxMinimized = false;
let draggingPax = false;
let dragOffset = {x:0,y:0};
let paxDragged = false;
let chatMessages = [];
let chatApiKey = '';
let chatLoading = false;
let ambienceAudio = null;
let ambienceEnabled = false;
let ambiencePrimed = false;
let vitalsInterval = null;
let vitalsTargetTs = null;
let vitalsActive = false;
let hazardTimer = null;
let hazardTimeLeft = 30;
let hazardsFound = 0;
let drillStats = { vitalsAttempts:0, vitalsPass:0, brancherPicks:{}, hazardAttempts:0, hazardWins:0 };
let marcusState = 'Neutral'; // Neutral, Frustrated, Rage
let drillStreak = 0;
let drillFlipped = false;
let drillCurrentCard = null;
let drillCurrentScenario = null;
let drillXPEarned = false;

// ─── Skill Cards (15 clinical flash-cards for Daily Drill) ───
const SKILL_CARDS = [
  { category:'Reaction Gap', title:'Maintain 6–10 Feet', front:'A patient is escalating. What is the first physical thing you should do?', back:'Create and maintain a 6–10 foot Reaction Gap. This gives you time to assess, gives the patient space to feel less cornered, and protects you if the situation escalates. Do NOT close distance when tension rises — that is the most common BHT error in crisis situations.', prompt:'Think about the last time a patient escalated near you. Were you within the reaction gap?' },
  { category:'Validation First', title:'Validate Before You Assert', front:'A patient screams "Nobody listens to me in this place!" — What is your FIRST move?', back:'Validate before you assert authority or offer solutions. Say: "You\'re right that it can feel that way here, and I hear you." Validation does NOT mean agreement — it means acknowledgment. Jumping to problem-solving before validating is the #1 mistake that escalates patients.', prompt:'Practice: write a 1-sentence validation for a patient refusing medication.' },
  { category:'Choice Architecture', title:'Forced Choice = Less Resistance', front:'You need a patient to return to their room. They\'re refusing. What technique reduces resistance most?', back:'Offer a Forced Choice — two options you can live with: "Would you like to walk back now, or in two minutes?" This preserves the patient\'s sense of control, the core driver of de-escalation. Never issue ultimatums. Ultimatums remove options and trigger fight-or-flight.', prompt:'What forced choice could you offer to a patient refusing vitals?' },
  { category:'Tone & Pacing', title:'Lower Your Voice When They Raise Theirs', front:'A patient begins yelling. What should you do with your own voice?', back:'Deliberately lower your volume and slow your pace — this is vocal pacing. Your calm, low tone signals safety to the nervous system. Matching a patient\'s intensity amplifies theirs. Pause between sentences — silence is a clinical tool, not a failure.', prompt:'How does your own nervous system respond when a patient is screaming? What do you do first?' },
  { category:'Trauma-Informed', title:'Trauma Responses Look Like Defiance', front:'A patient refuses all instructions, turns away, and won\'t make eye contact. Is this defiance?', back:'Probably not. Dissociation, hypervigilance, and shutdown are trauma responses mistaken for non-compliance. Ask: "What happened to this person?" not "What is wrong with them." Adjust: less commands, more soft presence. Sit at their level if safe. Avoid sudden movement.', prompt:'Name one thing you could say to signal safety to a trauma survivor without asking a direct question.' },
  { category:'PTSD — Flashback', title:'Orienting a Patient in Flashback', front:'A veteran patient crouches near the wall, scanning the room, saying "They\'re coming." What is happening?', back:'This is a flashback — the trauma is experienced as present reality. Do NOT touch them. Lower yourself to their level if safe. Say slowly: "You\'re in the hospital. My name is [name]. You\'re safe right now." Repeat grounding cues: time, name, place. Flashbacks are not psychosis.', prompt:'What is the clinical difference between a flashback and psychotic ideation? Why does it matter?' },
  { category:'Bipolar Mania', title:'Do Not Match Manic Energy', front:'A patient in a manic episode speaks rapidly for 10 minutes without pause. Biggest mistake to avoid?', back:'Do NOT try to out-talk or debate a manic patient. Reduce environmental stimulation first (TV, noise, other patients). Use short sentences. Offer structure: a glass of water, a brief walk, a quiet space. Goal: lower arousal load — not correct their thinking while they\'re floridly manic.', prompt:'What one environmental change in your unit right now would most reduce stimulation?' },
  { category:'Schizophrenia — Paranoia', title:'Therapeutic Neutrality with Delusions', front:'A paranoid patient accuses you of poisoning their food. You know it\'s a delusion. How do you respond?', back:'Do NOT argue — you will lose and it will escalate. Do NOT confirm it either. Use therapeutic neutrality: "I hear that you\'re worried about your food, and I want you to feel safe here." The goal is reducing fear, not winning the debate. Never mock or dismiss a delusion.', prompt:'Why does arguing with a delusion almost always make things worse?' },
  { category:'Environmental Safety', title:'Hazard Scan on Entry', front:'Before entering a room with an escalating patient, what should you do in the first 3 seconds?', back:'Rapid hazard scan: locate exits, identify objects within reach (chairs, cords, IV poles), note other patients, assess your escape path. Never enter a crisis room fixated only on the patient\'s face — peripheral awareness is your safety. This takes 2–3 seconds and must become automatic.', prompt:'Walk through your unit mentally. List 3 objects that could become a hazard in an escalation.' },
  { category:'Wait-5 Rule', title:'Silence Is a Clinical Tool', front:'You asked a patient if they\'re okay. They stare at the wall. What do you do next?', back:'Do nothing for 5 full seconds — this is the Wait-5 Rule. Most staff fill the silence immediately, which robs the patient of processing time. Count slowly to five. When you do speak, re-approach softly: "Take your time." Silence paired with calm presence is often more therapeutic than words.', prompt:'Practice: count silently to 5 right now. That\'s the Wait-5 Rule in action.' },
  { category:'De-escalation Ladder', title:'The 5-Step Ladder', front:'What are the five steps of the de-escalation ladder?', back:'1. Create Space (Reaction Gap). 2. Establish safety with tone and posture. 3. Validate feelings. 4. Identify the need beneath the behavior. 5. Offer a choice or structure. Every intervention should climb this ladder before any restrictive response. Skip a step and you may trigger the behavior you\'re trying to prevent.', prompt:'Think of a recent patient interaction. Which step of the ladder was skipped?' },
  { category:'Body Language', title:'Open Posture = Signal of Safety', front:'How should you position your body when approaching a distressed patient?', back:'Turn slightly sideways (reduces perceived threat), keep hands visible and open, avoid crossed arms, maintain a relaxed stance. Never point — it reads as accusatory. Eye contact should be soft, not direct staring. Subtle mirroring of the patient\'s posture builds unconscious rapport.', prompt:'What does your default body stance look like when you\'re stressed? Does it signal safety or threat?' },
  { category:'Limit Setting', title:'Setting Limits Without Ultimatums', front:'A patient is shouting and throwing a pillow. You need to set a behavioral limit. How?', back:'Use DESC: Describe (what you see), Express (the impact), Specify (what needs to change), Consequences (natural, not punitive). Example: "I see you\'re throwing things. I need to keep everyone safe. If we can\'t stay safe here, we\'ll need to move to a quieter space." Always offer the path to de-escalation.', prompt:'Write a 1-sentence DESC limit for a patient banging their head on the door.' },
  { category:'Self-Regulation', title:'Your Nervous System Is Contagious', front:'You\'re stressed from a prior incident and must immediately deal with a new escalation. Step one?', back:'Regulate yourself first. One slow breath: 4 counts in, 4 hold, 4 out. Your nervous system state transmits to patients through tone, micro-expressions, and movement speed. A dysregulated BHT entering a crisis room often makes it worse. You are a clinical tool — calibrate it first.', prompt:'What is your personal regulation strategy before entering a high-tension situation?' },
  { category:'Teamwork', title:'One Voice Rule in Crisis', front:'During a patient escalation, what should every staff member know and follow?', back:'One Voice Rule: a single staff member leads verbal de-escalation. Others position themselves silently, block exits if needed, and hold. Multiple staff speaking creates confusion and escalates the patient. Know the unit\'s backup signal, the leader, and the hand-off protocol before a crisis — not during it.', prompt:'Does your unit have a clear One Voice policy in crisis? If not, what would you propose?' }
];

// ─── Lab Patients ────────────────────────────────────────
const LAB_PATIENTS = [
  {
    id:'marcus',  name:'Marcus',  age:38, gender:'M',
    dx:'Combat PTSD',
    dxKey:'ptsd',
    bio:'Veteran · acute flashback episode · evaluation pending',
    avatar:'prof.png',
    initials:'MR', color:'#2563eb',
    persona:`You are Marcus, 38, a military veteran admitted to a psychiatric unit with combat PTSD. You do NOT know you are in a training simulation. Respond in first person, in character, exactly as Marcus would in this moment.`
  },
  {
    id:'delilah', name:'Delilah', age:25, gender:'F',
    dx:'Bipolar I — Acute Mania',
    dxKey:'bipolar',
    bio:'First hospitalization · manic episode day 3 · flight of ideas',
    avatar:null,
    initials:'DL', color:'#7c3aed',
    persona:`You are Delilah, 25, admitted for a first psychiatric hospitalization in the middle of a severe manic episode — day 3, little to no sleep. You are racing with ideas, feel invincible and misunderstood, and do NOT know you are in a training simulation. Respond in first person with rapid, pressured speech. You are not hostile by default but feel deeply that no one understands your brilliance right now.`
  },
  {
    id:'raymond', name:'Raymond', age:52, gender:'M',
    dx:'Schizophrenia (Paranoid Type)',
    dxKey:'schizophrenia',
    bio:'Paranoid ideation · refusing medications · hearing voices',
    avatar:null,
    initials:'RM', color:'#dc2626',
    persona:`You are Raymond, 52, a patient admitted with paranoid schizophrenia who believes the staff are part of a coordinated effort to silence him. You have been refusing your antipsychotic for 2 days. You hear a voice warning you not to trust anyone in the room. You do NOT know you are in a training simulation. Respond in first person — guarded, suspicious, low-trust. Statements from staff may feel like coded threats.`
  }
];
let activePatient = LAB_PATIENTS[0];

async function hashText(text) {
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(text));
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
}

// ─── Auth UI ─────────────────────────────────────────────
function showAuthTab(tab) {
  document.getElementById('login-form').style.display  = tab==='login'  ? 'block' : 'none';
  document.getElementById('signup-form').style.display = tab==='signup' ? 'block' : 'none';
  const loginBtn  = document.getElementById('tab-login');
  const signupBtn = document.getElementById('tab-signup');
  const title = document.getElementById('auth-panel-title');
  const sub   = document.getElementById('auth-panel-sub');
  if(loginBtn) {
    loginBtn.style.background = tab==='login' ? 'white' : 'transparent';
    loginBtn.style.color      = tab==='login' ? '#0f172a' : '#64748b';
    loginBtn.style.boxShadow  = tab==='login' ? '0 1px 4px rgba(0,0,0,.1)' : 'none';
  }
  if(signupBtn) {
    signupBtn.style.background = tab==='signup' ? 'white' : 'transparent';
    signupBtn.style.color      = tab==='signup' ? '#0f172a' : '#64748b';
    signupBtn.style.boxShadow  = tab==='signup' ? '0 1px 4px rgba(0,0,0,.1)' : 'none';
  }
  if(title) title.textContent = tab==='login' ? 'Welcome back' : 'Join the team';
  if(sub)   sub.textContent   = tab==='login' ? 'Sign in to continue your training.' : 'Create your staff training account.';
}

async function doSignIn() {
  const email = document.getElementById('li-email').value.trim();
  const pass  = document.getElementById('li-pass').value;
  const err   = document.getElementById('auth-error');
  err.style.display='none';
  if (!email||!pass){err.textContent='Please enter email and password.';err.style.display='block';return;}
  try { await window._signIn(email,pass); }
  catch(e){ err.textContent = e.message.replace('Firebase: ',''); err.style.display='block'; }
}

async function doSignUp() {
  const fname = document.getElementById('su-fname').value.trim();
  const lname = document.getElementById('su-lname').value.trim();
  const email = document.getElementById('su-email').value.trim();
  const phone = document.getElementById('su-phone').value.trim();
  const title = document.getElementById('su-title').value.trim();
  const dept  = document.getElementById('su-dept').value.trim();
  const empid = document.getElementById('su-empid').value.trim();
  const pass  = document.getElementById('su-pass').value;
  const conf  = document.getElementById('su-conf').value;
  const err   = document.getElementById('auth-error');
  const btn   = document.getElementById('signup-btn');
  err.style.display='none';
  if (!fname||!lname){err.textContent='Please enter your first and last name.';err.style.display='block';return;}
  if (!email){err.textContent='Please enter your work email.';err.style.display='block';return;}
  if (!phone){err.textContent='Please enter your mobile phone number.';err.style.display='block';return;}
  if (!title||!dept){err.textContent='Please enter your job title and department.';err.style.display='block';return;}
  if (!pass){err.textContent='Please create a password.';err.style.display='block';return;}
  if (pass!==conf){err.textContent='Passwords do not match.';err.style.display='block';return;}
  if (pass.length<6){err.textContent='Password must be at least 6 characters.';err.style.display='block';return;}
  if(btn){btn.disabled=true;btn.textContent='Creating account...';btn.style.opacity='0.7';}
  try {
    await window._signUp(fname, lname, email, pass, phone, title, dept, empid);
    if(btn){btn.disabled=false;btn.textContent='Account created! Redirecting...';btn.style.opacity='1';}
  } catch(e){
    const msg = e.message.replace('Firebase: ','');
    err.textContent = msg.includes('email-already-in-use') ? 'That email is already registered. Try signing in.' :
                      msg.includes('invalid-email') ? 'Please enter a valid email address.' : msg;
    err.style.display='block';
    if(btn){btn.disabled=false;btn.textContent='Create Account →';btn.style.opacity='1';}
  }
}

async function doGoogleSignIn() {
  const err = document.getElementById('auth-error');
  err.style.display='none';
  try {
    await signInWithPopup(auth, googleProvider);
  } catch(e){
    err.textContent = e.message.replace('Firebase: ','');
    err.style.display='block';
  }
}

async function doAnonSignIn() {
  const err = document.getElementById('auth-error');
  err.style.display='none';
  try {
    await signInAnonymously(auth);
  } catch(e){
    err.textContent = e.message.replace('Firebase: ','');
    err.style.display='block';
  }
}

// ─── App Init ────────────────────────────────────────────
function initApp() {
  // Slides 14-27 are injected on DOMContentLoaded — if not ready yet, queue and return
  if(!window._slidesReady) { window._initAppQueued = true; return; }
  const slides = document.querySelectorAll('.slide');
  totalSlides  = slides.length;
  labCredits   = window._userData?.labCredits || 0;
  xp    = window._userData?.xp    || 0;
  level = window._userData?.level || 1;
  scenariosDone = window._userData?.scenariosDone || 0;
  scoreTotal    = window._userData?.scoreTotal   || 0;
  completedTraining = !!window._userData?.completedTraining;
  finalQuizPassed   = !!window._userData?.finalQuizPassed;
  sessionMode       = window._userData?.sessionMode || 'training';
  currentSlide      = Math.max(0, Number(window._userData?.currentSlide || 0));
  const completed   = !!window._userData?.completedTraining || !!window._userData?.finalQuizPassed;
  const hasProgress = currentSlide > 0;
  const seenBefore  = !!window._userData?.hasOnboarded;
  const isNewUser   = !completed && !hasProgress && !seenBefore;

  if(isNewUser) {
    // Brand-new account: skip title card, go straight to first content slide
    sessionMode = 'training';
    currentSlide = 1;
    showSlide(1);
    hideHomeGateway();
  } else {
    // Returning user: always land on the hub (welcome-back page)
    showSlide(currentSlide);
    showHomeGateway();
  }

  window._saveUserData({ sessionMode, currentSlide, hasOnboarded:true }).catch(()=>{});
  updateNavUI();
  updateFinalStats();
  initPaxDrag();
  renderFinalQuiz();
  renderInlineLogos();
  // Use stored firstName first, then displayName, then email prefix
  const ud = window._userData || {};
  const firstName = ud.firstName ||
    (window._currentUser?.displayName||'').split(' ')[0] ||
    (window._currentUser?.email||'').split('@')[0] ||
    'there';
  const greetEl = document.getElementById('welcome-greeting');
  if(greetEl) greetEl.textContent = completed ? 'Welcome back,' : 'Welcome,';
  const welEl = document.getElementById('welcome-name');
  if(welEl) welEl.textContent = firstName;

  // Handle PWA home-screen shortcut deep links
  if (window._pwaShortcut) {
    const sc = window._pwaShortcut;
    delete window._pwaShortcut;
    setTimeout(() => {
      if (sc === 'training') startTrainingFromHub && startTrainingFromHub();
      if (sc === 'lab')      enterLabFromHub      && enterLabFromHub();
    }, 600);
  }
}

// ─── Slide Navigation ────────────────────────────────────
function showSlide(n) {
  const slides = document.querySelectorAll('.slide');
  const certIndex = slides.length ? slides.length-1 : 0;
  let target = Math.max(0, Math.min(n, slides.length-1));
  // Always refresh welcome card name when slide 0 is shown
  if(target === 0) {
    const _fn = currentFirstName();
    const greetEl = document.getElementById('welcome-greeting');
    const welEl   = document.getElementById('welcome-name');
    if(greetEl) greetEl.textContent = (window._userData?.completedTraining || window._userData?.currentSlide > 0) ? 'Welcome back,' : 'Welcome,';
    if(welEl)   welEl.textContent   = _fn;
  }

  // Gate certificate slide until quiz is passed
  if(target === certIndex && !finalQuizPassed) {
    alert('Score 90%+ on the quiz to unlock the certificate slide.');
    target = Math.max(0, certIndex-1);
  }

  slides.forEach((s,i)=>{
    s.style.display = i===target ? 'block' : 'none';
    s.classList.toggle('active', i===target);
    if(i===target) s.scrollTop = 0;
  });
  currentSlide = target;
  if(target===certIndex){
    completedTraining = !!finalQuizPassed;
    window._saveUserData({ completedTraining:completedTraining }).catch(()=>{});
    const certBtn = document.getElementById('cert-btn');
    if(certBtn && !finalQuizPassed) certBtn.disabled = true;
  }
  // Progress bar
  const pct = totalSlides>1 ? (target/(totalSlides-1))*100 : 0;
  const pb = document.getElementById('progress-bar');
  if(pb) pb.style.width = pct+'%';
  // Counter
  const sc = document.getElementById('nav-slide-counter');
  if(sc) sc.textContent = `${target+1} / ${totalSlides}`;
  // Award XP on first visit
  const key = 'visited_'+target;
  if(!window._userData || !window._userData[key]){
    awardXP(10, false);
    if(window._userData) window._userData[key]=true;
  }
  saveProgress();
  // Update final stats on last slide
  if(target>=totalSlides-2) updateFinalStats();

  // First-visit only: XP milestone + Vance speaks (never repeats on back-nav)
  if(!_spokenSlides.has(target)) {
    _spokenSlides.add(target);
    lastSpokenSlide = target;
    // Section milestone: +50 XP every 5 slides
    if(target > 0 && target % 5 === 0) {
      const mKey = 'milestone_' + target;
      if(!window._userData?.[mKey]) {
        awardXP(50);
        showXPToast(50, '5-Slide Section Complete');
        if(window._userData) window._userData[mKey] = true;
        window._saveUserData({ [mKey]: true }).catch(()=>{});
      }
    }
    // Vance speaks about this slide
    const _ud = window._userData || {};
    const _u  = window._currentUser;
    const _fn = _ud.firstName || (_u?.displayName||'').split(' ')[0] || 'there';
    if(target === 0) {
      scheduleVance(()=>showAvatarAndSpeak('_direct_', _fn, `Welcome, ${_fn}! Are you ready to begin? I’m here to help and guide you through every module on this journey.`), 400);
    } else {
      const tipFn = slideTips[target] || slideTips[slideTips.length-1];
      scheduleVance(()=>showAvatarAndSpeak('_direct_', _fn, tipFn(_fn)), 400);
    }
  }
  // Reset idle nudge timer on every slide navigation
  resetSlideIdleTimer();
}

// -- Idle nudge timer: Vance speaks if trainee lingers 45s without navigating --
let slideIdleTimer = null;
function resetSlideIdleTimer() {
  clearTimeout(slideIdleTimer);
  slideIdleTimer = setTimeout(() => {
    const hub = document.getElementById('home-gateway');
    if(hub && hub.style.display === 'flex') return;
    if(paxMuted) return;
    if(currentSlide === 0) return;  // never nudge on the welcome/title slide
    const labModal = document.getElementById('lab-modal');
    if(labModal && labModal.style.display === 'flex') return;  // never nudge while lab is open
    const nudges = [
      'Don\'t miss the detail on the right - that could be a safety breach.',
      'This concept maps directly to how we approach Marcus. Think about the timing.',
      'This is certification exam material. Lock it in before moving on.',
      'Think of Marcus right now - how would this principle change your next move?'
    ];
    const n = nudges[Math.floor(Math.random() * nudges.length)];
    showAvatarAndSpeak('_direct_', currentFirstName(), n);
  }, 45000);
}

function nextSlide() {
  if(currentSlide < totalSlides-1) showSlide(currentSlide+1);
}
function prevSlide() {
  if(currentSlide > 0) showSlide(currentSlide-1);
}

// Keyboard navigation
document.addEventListener('keydown',e=>{
  if(document.getElementById('app').style.display==='none') return;
  if(e.key==='?' || (e.key==='/'&&!e.ctrlKey&&!e.metaKey)) { e.preventDefault(); showShortcuts(); return; }
  if(e.key==='Escape') { closeShortcuts(); }
  if(document.activeElement.tagName==='INPUT'||document.activeElement.tagName==='TEXTAREA') return;
  if(['ArrowRight','ArrowDown'].includes(e.key)) nextSlide();
  if(['ArrowLeft','ArrowUp'].includes(e.key)) prevSlide();
  if(e.key==='a'||e.key==='A') openAdminPrompt();
  if(e.key==='m'||e.key==='M') toggleAmbience();
});
function showShortcuts() {
  const o = document.getElementById('shortcuts-overlay');
  if(o) { o.style.display = 'flex'; }
}
function closeShortcuts() {
  const o = document.getElementById('shortcuts-overlay');
  if(o) o.style.display = 'none';
}

// ─── Nav UI ──────────────────────────────────────────────
function updateNavUI() {
  const user = window._currentUser;
  if(!user) return;
  const ud = window._userData || {};
  const firstName = ud.firstName || (user.displayName||'').split(' ')[0] || user.email.split('@')[0];
  const lastName  = ud.lastName  || (user.displayName||'').split(' ').slice(1).join(' ') || '';
  const initials  = ((firstName[0]||'')+(lastName[0]||'')).toUpperCase() || user.email[0].toUpperCase();
  const navName  = document.getElementById('nav-name');
  const navInit  = document.getElementById('nav-avatar-initials');
  const navLevel = document.getElementById('nav-level');
  const navXP    = document.getElementById('nav-xp');
  const navLC    = document.getElementById('nav-lc');
  if(navName)  navName.textContent  = firstName;
  if(navInit)  navInit.textContent  = initials;
  if(navLevel) navLevel.textContent = `Level ${level}`;
  if(navXP)    navXP.textContent    = `${xp.toLocaleString()} XP`;
  if(navLC)    navLC.textContent    = `${labCredits.toLocaleString()} LC`;
}

function currentFirstName() {
  const ud = window._userData || {};
  const user = window._currentUser;
  return ud.firstName || (user?.displayName||'').split(' ')[0] || (user?.email||'').split('@')[0] || 'there';
}

function showHomeGateway() {
  // First-time users get the tutorial automatically
  if(window._userData && !window._userData.hasOnboarded) {
    openTutorial();
    return;
  }
  const hub = document.getElementById('home-gateway');
  if(hub) hub.style.display = 'flex';
  refreshDueDateBanner(); // show/hide training deadline notification
  refreshDrillStreak();  // update streak badge on daily drill button
  const pa = document.getElementById('side-arrow-prev');
  const na = document.getElementById('side-arrow-next');
  if(pa) pa.style.display = 'none';
  if(na) na.style.display = 'none';
  // Show Professor Vance on the hub with a welcome greeting
  const fname = currentFirstName();
  const isReturning = !!(window._userData?.currentSlide > 0 || window._userData?.completedTraining);
  const hubMsg = isReturning
    ? `Welcome back, ${fname}! Pick where you want to go today — I’ll be right here with you.`
    : `Welcome, ${fname}! I’m Professor Vance. When you’re ready, choose a path and we’ll get started.`;
  if(window._vanceAudio) { window._vanceAudio.pause(); window._vanceAudio.currentTime = 0; }
  // Update hub heading with user's first name
  const hubHeading = document.getElementById('hub-heading');
  if(hubHeading) hubHeading.textContent = isReturning ? 'Welcome back, ' + fname + '! \uD83D\uDC4B' : 'Welcome, ' + fname + '! Ready to get started?';
  scheduleVance(()=>showAvatarAndSpeak('_direct_', fname, hubMsg), 300);
}

function hideHomeGateway() {
  const hub = document.getElementById('home-gateway');
  if(hub) hub.style.display = 'none';
  // Restore slide navigation arrows
  const pa = document.getElementById('side-arrow-prev');
  const na = document.getElementById('side-arrow-next');
  if(pa) pa.style.display = '';
  if(na) na.style.display = '';
}

function startTrainingFromHub() {
  hideHomeGateway();
  const modal = document.getElementById('completion-modal');
  if(modal) modal.style.display = 'none';
  sessionMode = 'training';
  completedTraining = false;
  finalQuizPassed = false;
  finalQuizScore = 0;
  finalQuizResponses = {};
  currentSlide = 0;
  _spokenSlides.clear(); // fresh session — let Vance speak each slide again
  showSlide(0);
  renderFinalQuiz();
  window._saveUserData({ sessionMode, currentSlide:0, completedTraining:false, finalQuizPassed:false, finalQuizScore:0 }).catch(()=>{});
}

function resumeTrainingFromHub() {
  hideHomeGateway();
  sessionMode = 'training';
  // Go to saved slide; use at least slide 1 so we never land back on the title card
  const savedSlide = Number(window._userData?.currentSlide || currentSlide || 0);
  const resumeSlide = Math.max(1, savedSlide);
  currentSlide = resumeSlide;
  showSlide(currentSlide);
  renderFinalQuiz();
  window._saveUserData({ sessionMode, currentSlide }).catch(()=>{});
  const fname = currentFirstName();
  // Vance will auto-speak via showSlide if it's a new slide; no redundant greeting needed
}

function enterLabFromHub() {
  hideHomeGateway();
  sessionMode = 'lab';
  currentSlide = 0;
  showSlide(0);
  const fname = currentFirstName();
  scheduleVance(()=>showAvatarAndSpeak('_direct_', fname, 'Jumping into the Lab. Ask me if you want tips while you practice.'), 500);
  window._saveUserData({ sessionMode, currentSlide:0 }).catch(()=>{});
  setTimeout(()=>openLabRoom(), 350);
}

function showCompletionOptions() {
  const modal = document.getElementById('completion-modal');
  if(modal) modal.style.display='flex';
}

function chooseCompletionPath(mode) {
  const modal = document.getElementById('completion-modal');
  if(modal) modal.style.display='none';
  completedTraining = true;
  if(mode === 'review') {
    sessionMode = 'review';
    currentSlide = 0;
    showSlide(0);
    window._saveUserData({ sessionMode, currentSlide:0, completedTraining:true }).catch(()=>{});
  } else if(mode === 'lab') {
    sessionMode = 'lab';
    currentSlide = 0;
    showSlide(0);
    window._saveUserData({ sessionMode, currentSlide:0, completedTraining:true }).catch(()=>{});
    setTimeout(()=>openLabRoom(), 300);
  } else {
    sessionMode = 'training';
    window._saveUserData({ sessionMode, completedTraining:true }).catch(()=>{});
  }
}

// ─── XP & Level ──────────────────────────────────────────
function awardXP(amount, save=true) {
  const prevXP = xp;
  xp += amount;
  const thresholds = [0,500,1200,2200,3500,5500,8000,11000,15000,20000];
  const prevLevel = level;
  for(let i=thresholds.length-1;i>=0;i--){
    if(xp>=thresholds[i]){ level=i+1; break; }
  }
  updateNavUI();
  // Animate the XP counter rolling up (runs after updateNavUI sets the final value)
  if(amount > 0 && window._animCounter) {
    const navXpEl = document.getElementById('nav-xp');
    if(navXpEl) {
      // Small rAF delay so updateNavUI's synchronous textContent set is painted first,
      // then we immediately overwrite with the animation start value
      requestAnimationFrame(() => window._animCounter(navXpEl, prevXP, xp, 900));
    }
  }
  // Level-up flash
  if(level > prevLevel) {
    const navLvl = document.getElementById('nav-level');
    if(navLvl) { navLvl.style.transition='color .2s'; navLvl.style.color='#fbbf24'; setTimeout(()=>{ navLvl.style.color=''; }, 1400); }
  }
  window._checkAchievements && window._checkAchievements({xp, level}).catch(()=>{});
  if(save) saveProgress();
}

function awardLabCredits(amount, save=true) {
  labCredits += amount;
  updateNavUI();
  if(save) saveProgress();
}

function getTier(lc, tiers) {
  const arr = Array.isArray(tiers) ? tiers.slice().sort((a,b)=>a-b) : [];
  let tier = null;
  arr.forEach((t,i)=>{ if(lc >= t) tier = i+1; });
  return tier;
}

function ensureAmbienceAudio() {
  if(ambienceAudio) return ambienceAudio;
  ambienceAudio = new Audio('https://cdn.pixabay.com/download/audio/2022/10/09/audio_0c1486c1ef.mp3?filename=calm-nature-ambient-124008.mp3');
  ambienceAudio.loop = true;
  ambienceAudio.volume = 0.22;
  return ambienceAudio;
}

function primeAmbienceOnce() {
  if(ambiencePrimed) return;
  const audio = ensureAmbienceAudio();
  const originalVolume = audio.volume;
  audio.volume = 0;
  audio.play().then(()=>{
    audio.pause();
    audio.currentTime = 0;
    audio.volume = originalVolume;
    ambiencePrimed = true;
    document.removeEventListener('pointerdown', primeAmbienceOnce);
    document.removeEventListener('keydown', primeAmbienceOnce);
  }).catch(()=>{
    audio.volume = originalVolume;
  });
}
document.addEventListener('pointerdown', primeAmbienceOnce, { passive:true });
document.addEventListener('keydown', primeAmbienceOnce, { passive:true });

async function toggleAmbience(auto=false) {
  const btn = document.getElementById('ambience-btn');
  const audio = ensureAmbienceAudio();
  try {
    if(audio.paused) {
      await audio.play();
      ambienceEnabled = true;
    } else {
      audio.pause();
      ambienceEnabled = false;
    }
  } catch(e) {
    if(!auto) alert('Could not start audio (browser blocked autoplay). Try clicking again.');
    ambienceEnabled = false;
  }
  if(btn) btn.textContent = ambienceEnabled ? '🎵 Ambience On' : '🎵 Ambience (tap to play)';
  ambiencePrimed = ambiencePrimed || !audio.paused;
}

// ─── Final Quiz (Certificate Gate) ───────────────────────
const finalQuizQuestions = [
  {q:'What is the minimum recommended Reaction Gap when approaching a standing agitated patient?', a:['2-3 feet - within coaching range','6-10 feet - outside striking range','15+ feet - hallway distance'], correct:1},
  {q:'Marcus says he is sick of waiting. What is the BEST first response?', a:['Tell him the wait is normal and he needs to be patient','Validate: That wait sounds incredibly frustrating - I hear you.','Inform him of consequences for outbursts'], correct:1},
  {q:'Which object in a psychiatric room is a ligature risk?', a:['A plastic chair','A window blind cord','A foam mattress'], correct:1},
  {q:'Which micro-expression most reliably precedes a physical strike from an agitated patient?', a:['Tearful eyes and lip tremor','Flared nostrils, clenched jaw, and narrowed eyes','Downcast gaze and collapsed posture'], correct:1},
  {q:'Choice Architecture in de-escalation means:', a:['Physically blocking escape routes','Offering two safe options so the patient feels in control','Designing the unit layout to prevent elopement'], correct:1},
  {q:'Offering Marcus a choice between two safe options is a form of manipulation - True or False?', a:['True - it removes his autonomy','False - it IS Choice Architecture and restores his sense of control','Only true if the patient is involuntary'], correct:1},
  {q:'The CPI model pillars are:', a:['Care, Welfare, Safety, Security','Control, Warning, Safety, Supervision','Calm, Wait, Separate, Contain'], correct:0},
  {q:'If Marcus is in an active PTSD flashback, your FIRST action is:', a:['Increase lighting and speak louder to orient him','Call a code team immediately','Lower stimulation, announce every movement, use grounding language'], correct:2},
  {q:'Non-punitive limit setting sounds like:', a:['Do it again and you lose phone privileges.','I cannot allow that for safety. What I CAN offer is...','Calm down or I will have to restrain you.'], correct:1},
  {q:'After a crisis stabilizes, when is the best time to debrief Marcus?', a:['Immediately while emotions are high','After stabilization, with his consent, in a safe environment','Only when mandated by the incident report'], correct:1}
];

function renderFinalQuiz() {
  const box = document.getElementById('final-quiz-questions');
  if(!box) return;
  box.innerHTML = finalQuizQuestions.map((q,i)=>{
    const options = q.a.map((opt,idx)=>`
      <label style="display:block;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:.75rem;padding:.55rem .65rem;color:#e2e8f0;font-weight:600;cursor:pointer;margin-bottom:.4rem">
        <input type="radio" name="fq-${i}" value="${idx}" style="margin-right:.5rem">${opt}
      </label>`).join('');
    return `<div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:.9rem;padding:.75rem"><div style="color:#cbd5e1;font-weight:800;margin-bottom:.4rem;font-size:.9rem">Q${i+1}. ${q.q}</div>${options}</div>`;
  }).join('');
  const certBtn = document.getElementById('cert-btn');
  if(certBtn) certBtn.disabled = !finalQuizPassed;
  const lockMsg = document.getElementById('cert-locked-msg');
  if(lockMsg) lockMsg.textContent = finalQuizPassed ? 'Certificate unlocked — go to the next slide to download.' : 'Pass the quiz to unlock your certificate.';
  const res = document.getElementById('final-quiz-result');
  if(res && finalQuizPassed) res.textContent = `Passed ${finalQuizScore}/10 — certificate unlocked.`;
}

function submitFinalQuiz() {
  let answered = 0;
  let score = 0;
  finalQuizQuestions.forEach((q,i)=>{
    const sel = document.querySelector(`input[name="fq-${i}"]:checked`);
    if(sel){ answered++; if(Number(sel.value)===q.correct) score++; }
  });
  if(answered < finalQuizQuestions.length){
    alert('Please answer all 10 questions.');
    return;
  }
  finalQuizScore = score;
  const pass = score >= 9; // 90% threshold
  finalQuizPassed = pass;
  const certBtn = document.getElementById('cert-btn');
  if(certBtn) { certBtn.disabled = !pass; certBtn.style.opacity = pass ? '1' : '.8'; }
  const res = document.getElementById('final-quiz-result');
  if(res) res.textContent = pass ? `Great work — you passed ${score}/10. Certificate unlocked on the next slide.` : `Score ${score}/10. Need 9+ to unlock. Review and retry.`;
  const lockMsg = document.getElementById('cert-locked-msg');
  if(lockMsg) lockMsg.textContent = pass ? 'Certificate unlocked — proceed to the next slide to download.' : 'Pass the quiz to unlock your certificate.';
  completedTraining = pass;
  window._saveUserData({ finalQuizPassed: pass, finalQuizScore: score, completedTraining: pass }).catch(()=>{});
  if(pass) setTimeout(()=>showSlide(totalSlides-1), 350);
}

// ─── Matching Mini-Game ─────────────────────────────────
function markMatch(btn, choice) {
  const card = btn.closest('.match-card');
  if(!card) return;
  const correct = card.dataset.answer;
  const status = card.querySelector('.match-status');
  const fb = card.querySelector('.match-feedback');
  const isCorrect = choice === correct;
  if(status){
    status.textContent = choice === 'do' ? 'Do' : "Don't";
    status.style.background = isCorrect ? '#dcfce7' : '#fef2f2';
    status.style.color = isCorrect ? '#166534' : '#991b1b';
  }
  if(fb){
    fb.textContent = isCorrect ? 'Correct — this aligns with best practice.' : 'Try again — that move can escalate.';
    fb.style.color = isCorrect ? '#22c55e' : '#f87171';
  }
}

function resetMatchGame() {
  document.querySelectorAll('.match-card').forEach(card => {
    const status = card.querySelector('.match-status');
    const fb = card.querySelector('.match-feedback');
    if(status){
      status.textContent = '—';
      status.style.background = 'rgba(255,255,255,.08)';
      status.style.color = '#cbd5e1';
    }
    if(fb){
      fb.textContent = '';
      fb.style.color = '#94a3b8';
    }
    card.dataset.selected = '';
  });
}

// ─── Interactive Drills ─────────────────────────────────
function pickBranch(choice) {
  const reaction = document.getElementById('branch-reaction');
  const videoBox  = document.getElementById('branch-video');
  if(!reaction) return;
  const responses = {
    validate: 'Patient exhales, shoulders drop a bit. "Yeah… it is loud. Water would help."',
    command:  'Eyes narrow, tone sharpens: "Don\'t tell me what to do." Agitation spikes.',
    debate:   'Patient erupts — "You have no idea what I\'ve been through!" Situation rapidly escalates.'
  };
  reaction.textContent = responses[choice] || responses.validate;
  reaction.style.color = choice === 'validate' ? '#bbf7d0' : '#fecdd3';
  drillStats.brancherPicks[choice] = (drillStats.brancherPicks[choice] || 0) + 1;
  window._saveUserData && window._saveUserData({ drillStats }).catch(()=>{});
  checkLabComplete();
  if(!videoBox) return;
  if(choice === 'validate') {
    videoBox.style.padding = '.9rem';
    videoBox.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.75rem;min-height:120px;text-align:center">
      <img src="success.png" alt="De-escalation success" style="width:100%;border-radius:.75rem;opacity:.92;margin-bottom:.25rem">
      <div style="color:#bbf7d0;font-weight:800;font-size:.8rem;text-transform:uppercase;letter-spacing:.07em">✓ Good example — de-escalation</div>
      <a href="https://abc7chicago.com/post/franklin-park-police-cook-county-sheriffs-office-bodycam-video/11778196/" target="_blank" rel="noopener noreferrer" style="display:inline-flex;align-items:center;gap:.45rem;background:#0ea5e9;color:white;font-weight:900;font-size:.9rem;padding:.55rem 1.3rem;border-radius:.6rem;text-decoration:none">▶ Watch Video</a>
      <div style="color:#94a3b8;font-size:.75rem">Opens in new tab</div>
    </div>`;
  } else if(choice === 'command') {
    videoBox.style.padding = '0';
    videoBox.innerHTML = `<div style="position:relative;width:100%;padding-top:56.25%">
      <iframe style="position:absolute;inset:0;width:100%;height:100%;border:0;border-radius:.85rem" src="https://www.youtube.com/embed/cbQUrfYxNtg" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" title="What not to do — escalation example"></iframe>
      <img src="failure.png" alt="Escalation failure" style="position:absolute;top:0;right:0;width:42%;z-index:2;pointer-events:none;opacity:.92;filter:drop-shadow(0 2px 8px rgba(0,0,0,.7))">
    </div>`;
  } else {
    videoBox.style.padding = '0';
    videoBox.innerHTML = `<div style="position:relative;width:100%;padding-top:56.25%">
      <video style="position:absolute;inset:0;width:100%;height:100%;border-radius:.85rem;background:#000" controls>
        <source src="angrypt.mp4" type="video/mp4">
        Your browser does not support video playback.
      </video>
      <img src="failure.png" alt="Escalation failure" style="position:absolute;top:0;right:0;width:42%;z-index:2;pointer-events:none;opacity:.92;filter:drop-shadow(0 2px 8px rgba(0,0,0,.7))">
    </div>`;
  }
}

function resetBranch() {
  const reaction = document.getElementById('branch-reaction');
  const videoBox  = document.getElementById('branch-video');
  if(!reaction) return;
  reaction.textContent = 'Choose a line to see the patient’s response.';
  reaction.style.color = '#cbd5e1';
  if(videoBox) {
    videoBox.style.padding = '.9rem';
    videoBox.innerHTML = '<div id="branch-video-label" style="color:#e2e8f0;font-weight:800;font-size:.9rem;text-align:center;line-height:1.4">Choose a response above to see the outcome video.</div>';
  }
}

function checkLabComplete() {
  if(!drillStats.vitalsAttempts || !Object.keys(drillStats.brancherPicks).length || !drillStats.hazardAttempts) return;
  const debrief = document.getElementById('lab-debrief');
  if(!debrief || debrief.style.display !== 'none') return;
  const vRate = drillStats.vitalsAttempts ? Math.round((drillStats.vitalsPass / drillStats.vitalsAttempts)*100) : 0;
  const hRate = drillStats.hazardAttempts ? Math.round((drillStats.hazardWins / drillStats.hazardAttempts)*100) : 0;
  const topPick = Object.entries(drillStats.brancherPicks).sort((a,b)=>b[1]-a[1])[0];
  const pickLabel = {validate:'Validate',command:'Command',debate:'Debate'}[topPick[0]] || topPick[0];
  const statsEl = document.getElementById('lab-debrief-stats');
  if(statsEl) statsEl.innerHTML = `
    <div style="background:rgba(255,255,255,.06);border-radius:.9rem;padding:.85rem;text-align:center">
      <div style="font-size:1.5rem;font-weight:900;color:${vRate>=50?'#34d399':'#f87171'}">${vRate}%</div>
      <div style="font-size:.75rem;color:#94a3b8;font-weight:700;margin-top:.2rem">Vitals accuracy</div>
    </div>
    <div style="background:rgba(255,255,255,.06);border-radius:.9rem;padding:.85rem;text-align:center">
      <div style="font-size:1.5rem;font-weight:900;color:#a78bfa">${pickLabel}</div>
      <div style="font-size:.75rem;color:#94a3b8;font-weight:700;margin-top:.2rem">Most-used line</div>
    </div>
    <div style="background:rgba(255,255,255,.06);border-radius:.9rem;padding:.85rem;text-align:center">
      <div style="font-size:1.5rem;font-weight:900;color:${hRate>=50?'#34d399':'#f87171'}">${hRate}%</div>
      <div style="font-size:.75rem;color:#94a3b8;font-weight:700;margin-top:.2rem">Hazard clear rate</div>
    </div>`;
  debrief.style.display = 'block';
}

function startVitalsDrill() {
  stopVitalsDrill();
  vitalsActive = true;
  const meter = document.getElementById('vitals-meter');
  const status = document.getElementById('vitals-status');
   const cue = document.getElementById('micro-cue');
  if(meter) meter.style.width = '0%';
  const fimgV = document.getElementById('vitals-fail-img');
  const simgV = document.getElementById('vitals-success-img');
  if(fimgV) fimgV.style.display = 'none';
  if(simgV) simgV.style.display = 'none';
  if(status) {
    status.textContent = 'Watching micro-signals. Tap when you see the jaw clench.';
    status.removeAttribute('data-triggered');
  }
  if(cue) {
    cue.style.display = 'none';
    cue.style.opacity = '0';
  }
  const now = Date.now();
  const delay = 2400 + Math.random()*3200; // randomized trigger window
  vitalsTargetTs = now + delay;
  vitalsInterval = setInterval(()=>{
    if(!vitalsActive) { stopVitalsDrill(); return; }
    const elapsed = Date.now() - now;
    const pct = Math.min(100, (elapsed / (delay + 2000)) * 100);
    if(meter) meter.style.width = `${pct}%`;
    if(Date.now() >= vitalsTargetTs && status && !status.dataset.triggered) {
      status.dataset.triggered = '1';
      status.textContent = 'Jaw clenched — give a calm redirect now.';
      if(cue) {
        cue.style.display = 'block';
        requestAnimationFrame(()=> cue.style.opacity = '1');
      }
    }
    if(elapsed > delay + 2500) {
      if(status) status.textContent = 'Missed it — agitation rose. Reset and try again.';
      const mfimg = document.getElementById('vitals-fail-img');
      if(mfimg) mfimg.style.display = 'block';
      drillStats.vitalsAttempts += 1;
      window._saveUserData && window._saveUserData({ drillStats }).catch(()=>{});
      checkLabComplete();
      stopVitalsDrill();
    }
  }, 120);
}

function tapIntervene() {
  const status = document.getElementById('vitals-status');
  const meter = document.getElementById('vitals-meter');
  const cue = document.getElementById('micro-cue');
  if(!vitalsActive) {
    if(status) status.textContent = 'Start the drill first, then watch for the cue.';
    return;
  }
  const now = Date.now();
  const tapFimg = document.getElementById('vitals-fail-img');
  const tapSimg = document.getElementById('vitals-success-img');
  drillStats.vitalsAttempts += 1;
  if(now >= vitalsTargetTs) {
    if(status) status.textContent = 'Good catch — agitation contained.';
    if(meter) meter.style.width = '100%';
    if(tapFimg) tapFimg.style.display = 'none';
    if(tapSimg) tapSimg.style.display = 'block';
    drillStats.vitalsPass += 1;
  } else {
    if(status) status.textContent = 'Too early — wait for the jaw set before stepping in.';
    if(meter) meter.style.width = '45%';
    if(tapFimg) tapFimg.style.display = 'block';
    if(tapSimg) tapSimg.style.display = 'none';
  }
  window._saveUserData && window._saveUserData({ drillStats }).catch(()=>{});
  checkLabComplete();
  if(cue) {
    cue.style.opacity = '0';
    setTimeout(()=>{ cue.style.display = 'none'; }, 200);
  }
  stopVitalsDrill();
}

function stopVitalsDrill() {
  if(vitalsInterval) {
    clearInterval(vitalsInterval);
    vitalsInterval = null;
  }
  vitalsActive = false;
  vitalsTargetTs = null;
  const cue = document.getElementById('micro-cue');
  if(cue) {
    cue.style.opacity = '0';
    setTimeout(()=>{ cue.style.display = 'none'; }, 150);
  }
}

function startHazardScan() {
  endHazardScan('reset');
  hazardTimeLeft = 30;
  hazardsFound = 0;
  document.querySelectorAll('.hazard-dot').forEach(dot => {
    dot.style.display = 'block';
    dot.disabled = false;
  });
  const status = document.getElementById('hazard-status');
  if(status) status.textContent = 'Scan the room and tap hazards.';
  const hfimgS = document.getElementById('hazard-fail-img');
  const hsimgS = document.getElementById('hazard-success-img');
  if(hfimgS) hfimgS.style.display = 'none';
  if(hsimgS) hsimgS.style.display = 'none';
  updateHazardUI();
  hazardTimer = setInterval(()=>{
    hazardTimeLeft -= 1;
    if(hazardTimeLeft <= 0) {
      endHazardScan('time');
    } else {
      updateHazardUI();
    }
  }, 1000);
}

function tapHazard(hid) {
  if(!hazardTimer) {
    const status = document.getElementById('hazard-status');
    if(status) status.textContent = 'Press start to reveal hazards first.';
    return;
  }
  const dot = Array.from(document.querySelectorAll('.hazard-dot')).find(d=>d.dataset.hid===hid);
  if(dot && dot.style.display !== 'none') {
    dot.style.display = 'none';
    hazardsFound += 1;
    updateHazardUI();
    if(hazardsFound >= 5) endHazardScan('win');
  }
}

function endHazardScan(state='reset') {
  if(hazardTimer) {
    clearInterval(hazardTimer);
    hazardTimer = null;
  }
  const status = document.getElementById('hazard-status');
  const hfimg = document.getElementById('hazard-fail-img');
  const hsimg = document.getElementById('hazard-success-img');
  if(state === 'win') {
    if(status) status.textContent = 'Nice scan — all hazards cleared.';
    if(hfimg) hfimg.style.display = 'none';
    if(hsimg) hsimg.style.display = 'block';
    drillStats.hazardAttempts += 1;
    drillStats.hazardWins += 1;
    window._saveUserData && window._saveUserData({ drillStats }).catch(()=>{});
    checkLabComplete();
  } else if(state === 'time') {
    hazardTimeLeft = 0;
    if(status) status.textContent = 'Time up — review what you missed and restart.';
    if(hfimg) hfimg.style.display = 'block';
    if(hsimg) hsimg.style.display = 'none';
    drillStats.hazardAttempts += 1;
    window._saveUserData && window._saveUserData({ drillStats }).catch(()=>{});
    checkLabComplete();
  } else {
    if(status) status.textContent = 'Press start to reveal hazards.';
    if(hfimg) hfimg.style.display = 'none';
    if(hsimg) hsimg.style.display = 'none';
  }
  document.querySelectorAll('.hazard-dot').forEach(dot => dot.style.display = 'none');
  updateHazardUI();
}

function updateHazardUI() {
  const timer = document.getElementById('hazard-timer');
  const found = document.getElementById('hazard-found');
  if(timer) timer.textContent = `${hazardTimeLeft}s`;
  if(found) found.textContent = hazardsFound.toString();
}

// ─── Save / Load Progress ────────────────────────────────
function saveProgress() {
  const user = window._currentUser;
  if(!user) return;
  window._saveUserData({
    xp, level, currentSlide,
    scenariosDone, scoreTotal, labCredits, sessionMode,
    lastActive: Date.now(),
    displayName: user.displayName || '',
    email: user.email
  }).catch(()=>{}); // suppress permission errors — slide navigation always succeeds
}

// ─── Avatar & Voice ──────────────────────────────────────
// Per-slide tips (0-indexed slide number)
const slideTips = [
  n=>`This is where it all begins. Take a breath and read through — when you’re ready, hit the arrow and we’ll dive in.`,

  ()=>'De-escalation is a skill, not a personality trait. Every technique you learn here can be practiced until it becomes instinct.',
  ()=>'The CPI model has 4 key pillars: Care, Welfare, Safety, and Security. Keep all four in mind for every patient interaction.',
  ()=>'Remember: behavior is communication. Ask yourself — what is this patient trying to tell me with this behavior?',
  ()=>'Verbal de-escalation tip: Lower your voice when a patient raises theirs. They will often unconsciously mirror your calm tone.',
  ()=>'Body language accounts for over 55% of communication. Keep an open stance, avoid crossed arms, and stay at eye level.',
  ()=>'Active listening means reflecting back what you hear: "It sounds like you\'re feeling really frustrated right now. Am I hearing that right?"',
  ()=>'5-4-3-2-1 grounding: Ask them to name 5 things they can see, 4 they can touch, 3 they can hear, 2 they can smell, 1 they can taste.',
  ()=>'Box breathing works for staff too! Use it yourself before entering a high-tension room to regulate your own stress response.',
  ()=>'Trauma-informed care means asking "What happened to you?" instead of "What\'s wrong with you?" — it changes everything.',
  ()=>'CPI Stage 3 (Acceleration): Reduce verbal interaction. The patient is past reasoning. Focus on lowering stimulation, not winning the conversation.',
  ()=>'With autism: remove the sensory trigger FIRST. No touching, no crowding, no loud voice. Silence and space are your tools.',
  ()=>'ADHD de-escalation: short sentences win. "I hear you. Let\'s step outside." Three to five words at a time max during a crisis.',
  ()=>'Schizophrenia: never argue with a delusion. Validate the emotion behind it — "That sounds really frightening. I want you to feel safe."',
  ()=>'Bipolar mania: match their energy level first, then slowly bring your tone down. Sudden calm can feel threatening to a manic patient.',
  ()=>'PTSD: always announce before you touch. "I\'m going to put my hand on your shoulder — is that okay?" Every time. No exceptions.',
  ()=>'BPD: the most powerful words are "I\'m not leaving." Abandonment is the core fear. Your consistent presence is the intervention.',
  ()=>'Seclusion and restraint are last resort options — not behavior management tools. Document every alternative you tried first.',
  ()=>'Non-punitive limit setting: "I can\'t let you do X because I care about your safety. What I CAN do is Y. Your choice."',
  ()=>'Cultural humility means staying curious about a patient\'s cultural context rather than assuming you know what their behavior means.',
  ()=>'Suicide risk: the C-SSRS is your structured tool — but your relationship with the patient determines whether they tell you the truth.',
  ()=>'Scenario practice builds muscle memory. The goal is not to score an A — it\'s to build automatic clinical responses for real situations.',
  ()=>'The role-play script builder helps your team practice together. Run it with a colleague this week — even 10 minutes builds skill.',
  ()=>'Box breathing for staff: try 4 counts before any difficult conversation. Your regulated nervous system helps regulate your patient\'s.',
  ()=>'Quick reference cards are yours to keep. Print the de-escalation phrases card and post it somewhere you\'ll see it every shift.',
  ()=>'Test yourself in the Do vs Don\'t matching game — repetition builds automatic habits.',
  ()=>'You\'ve made it to the final module. This training counts — and your patients benefit every time you practice these skills.',
  ()=>'Great work completing the training! Download your certificate and share it with your supervisor. These skills save lives.',
  ()=>'Certificate unlocked — download it and send to your supervisor to log credit.'
];

function renderChatMessages() {
  const box = document.getElementById('chat-messages');
  if(!box) return;
  box.innerHTML = chatMessages.map(m=>`<div style="margin-bottom:.65rem;">${m.role==='user'?'<div style="font-size:.78rem;color:#475569;font-weight:800;margin-bottom:.2rem">You</div>':'<div style="font-size:.78rem;color:#1d4ed8;font-weight:900;margin-bottom:.2rem">Prof. Vance</div>'}<div style="background:${m.role==='user'?'#e2e8f0':'#eff6ff'};border:1px solid ${m.role==='user'?'#cbd5e1':'#bfdbfe'};border-radius:.75rem;padding:.65rem .8rem;font-size:.92rem;color:#0f172a;line-height:1.55">${m.content}</div></div>`).join('');
  box.scrollTop = box.scrollHeight;
}

function openChat() {
  const panel = document.getElementById('chat-panel');
  if(panel) {
    panel.style.display='flex';
    panel.style.opacity='1';
  }
  const avatar = document.getElementById('avatar-container');
  const mini = document.getElementById('avatar-mini');
  paxMinimized = false;
  if(avatar) avatar.style.display = 'flex';
  if(mini) mini.style.display = 'none';
  if(typeof restorePax === 'function') restorePax();
  if(!chatMessages.length) {
    const mode = sessionMode || 'training';
    const intro = mode === 'lab'
      ? "Welcome to the unit. I'm Professor Vance. Marcus is waiting — tension is rising. Before you step in, take a breath. Your goal isn't to control him, it's to help him regain control of himself. Tell me how you plan to approach him."
      : "Welcome to the unit. I'm Professor Vance. Today we're working with Marcus — he's been waiting a long time for his evaluation and the tension is rising. Your goal isn't to control him, it's to help him regain control of himself. When you're ready, tell me how you plan to approach him.";
    chatMessages.push({role:'assistant', content:intro});
  }
  renderChatMessages();
  const input = document.getElementById('chat-input');
  if(input) setTimeout(()=>input.focus(), 50);
}

function openChatFromPax(evt) {
  if(evt) evt.stopPropagation();
  openChat();
}

function closeChat() {
  const panel = document.getElementById('chat-panel');
  if(panel) panel.style.display='none';
}

async function sendChatMessage() {
  if(chatLoading) return;
  const input = document.getElementById('chat-input');
  const q = (input?.value||'').trim();
  if(!q) return;
  chatMessages.push({role:'user', content:q});
  renderChatMessages();
  if(input) input.value='';
  // Show typing indicator
  const box = document.getElementById('chat-messages');
  if(box) {
    const typing = document.createElement('div');
    typing.id = 'vance-typing';
    typing.style.cssText = 'margin-bottom:.65rem';
    typing.innerHTML = '<div style="font-size:.78rem;color:#1d4ed8;font-weight:900;margin-bottom:.2rem">Prof. Vance</div><div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:.75rem;padding:.65rem .8rem;font-size:1.1rem;color:#475569;letter-spacing:.15em">&#8226;&#8226;&#8226;</div>';
    box.appendChild(typing);
    box.scrollTop = box.scrollHeight;
  }
  chatLoading = true;
  const sendBtn = document.getElementById('chat-send-btn');
  if(sendBtn) { sendBtn.disabled=true; sendBtn.textContent='Sending...'; }
  const _pName = (typeof activePatient !== 'undefined' ? activePatient.name : null) || window.TENANT?.patientName || 'Marcus';
  const _pDx   = (typeof activePatient !== 'undefined' ? activePatient.dx   : null) || 'Combat PTSD';
  const mode = sessionMode || 'training';
  const sys = mode === 'lab'
    ? `You are Professor Vance, an expert Clinical Mentor for Behavioral Health Technicians (BHTs) in a high-acuity psychiatric crisis unit. You are coaching a trainee through a simulation involving a patient named ${_pName} (${_pDx}). You have access to the user's progress through the training. When the user is on a slide, narrate key points and provide Pro-Tips. When the user types a response, evaluate it based on de-escalation criteria and award XP verbally for strong clinical points. Tone: calm, authoritative, deeply empathetic — unshakable in a crisis. Maximum THREE short conversational sentences per reply. Use 'we' to foster teamwork. Safety rules: Reaction Gap (6-10 feet), validate feelings before asserting authority, offer forced choices (Choice Architecture), scan for environmental hazards. If the trainee's response would escalate the patient: 'That's a common mistake, but in this environment it's a dangerous one. Let's look at what went wrong.' If they choose well: 'Excellent work. By validating their frustration, you've lowered the room's temperature.' Link feedback to concepts from the slides they just completed. Avoid PHI and definitive clinical orders.`
    : `You are Professor Vance, an expert Clinical Mentor for Behavioral Health Technicians at ${window.TENANT?.orgName||'Destiny Springs Healthcare'}, coaching through an interactive de-escalation training involving a patient named ${_pName}. You serve dual roles: (1) when asked about slides or content, narrate and give Pro-Tips linked to what was just covered; (2) when the user types a clinical response, evaluate it against de-escalation best practices and provide immediate coaching. Keep replies to maximum THREE short sentences. Use 'we' to build teamwork. Always connect feedback to the slides. If unsure or outside training scope, recommend the supervisor or clinical leadership. Avoid PHI.`;
  const _mStateNote = (typeof marcusState !== 'undefined' && marcusState !== 'Neutral') ? ` [ALERT: Patient ${_pName} current state is ${marcusState} — calibrate your coaching accordingly.]` : '';
  const body = { system: sys + _mStateNote, messages: chatMessages.slice(-8) };
  let reply = '';
  try {
    const res = await fetch(CHAT_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!res.ok) throw new Error('LLM request failed');
    const data = await res.json();
    reply = (data?.reply || data?.choices?.[0]?.message?.content || '').trim();
  } catch(e) {
    reply = "I might not have the answer here. Please check with your supervisor or leadership for the safest guidance.";
  }
  chatMessages.push({role:'assistant', content:reply});
  chatLoading = false;
  if(sendBtn) { sendBtn.disabled=false; sendBtn.textContent='Send'; }
  // Remove typing indicator
  const typingEl = document.getElementById('vance-typing');
  if(typingEl) typingEl.remove();
  renderChatMessages();
  // Award XP for engagement — +40 per substantive Vance reply
  if(reply && reply.length > 30) { awardXP(40); showXPToast(40, 'Chat Reflection'); }
  // Play Professor Vance voice for this reply
  speakWithVance(reply);
}

function updatePaxMiniLabel() {
  const mini = document.getElementById('avatar-mini');
  if(mini) mini.textContent = paxMuted ? '🎓 Vance (muted)' : '🎓 Vance (listening)';
}

function togglePaxMute(evt) {
  if(evt) evt.stopPropagation();
  paxMuted = !paxMuted;
  const btn = document.getElementById('pax-mute-btn');
  if(btn) btn.textContent = paxMuted ? '🔇' : '🔈';
  if(paxMuted && window._vanceAudio) { window._vanceAudio.pause(); window._vanceAudio.currentTime=0; }
  updatePaxMiniLabel();
}

function minimizePax(evt) {
  if(evt) evt.stopPropagation();
  paxMinimized = true;
  const cont = document.getElementById('avatar-container');
  const bubble = document.getElementById('avatar-speech');
  const mini = document.getElementById('avatar-mini');
  if(bubble) bubble.style.display = 'none';
  if(cont) cont.style.display = 'none';
  if(mini) { mini.style.display = 'block'; updatePaxMiniLabel(); }
  if(window._vanceAudio) { window._vanceAudio.pause(); window._vanceAudio.currentTime=0; }
}

function restorePax() {
  paxMinimized = false;
  avatarActive = true;
  const cont = document.getElementById('avatar-container');
  const bubble = document.getElementById('avatar-speech');
  const mini = document.getElementById('avatar-mini');
  if(cont) cont.style.display = 'flex';
  if(bubble) bubble.style.display = 'block';
  if(mini) mini.style.display = 'none';
}

function initPaxDrag() {
  const handle = document.getElementById('avatar-drag-handle');
  const cont = document.getElementById('avatar-container');
  if(!handle || !cont) return;
  handle.style.touchAction = 'none';
  let offsetX = 0, offsetY = 0;
  const move = e => {
    if(!draggingPax) return;
    e.preventDefault();
    paxDragged = true;
    const newLeft = Math.min(window.innerWidth - cont.offsetWidth - 10, Math.max(10, e.clientX - offsetX));
    const newTop  = Math.min(window.innerHeight - cont.offsetHeight - 10, Math.max(10, e.clientY - offsetY));
    cont.style.left = `${newLeft}px`;
    cont.style.top  = `${newTop}px`;
    cont.style.right = 'auto';
  };
  const up = () => {
    draggingPax = false;
    cont.style.cursor='grab';
    document.removeEventListener('pointermove', move);
    document.removeEventListener('pointerup', up);
    setTimeout(()=>{ paxDragged = false; }, 80);
  };
  handle.addEventListener('pointerdown', e => {
    if(e.target && e.target.closest('button')) return;
    e.preventDefault();
    e.stopPropagation();
    draggingPax = true;
    cont.style.cursor='grabbing';
    const rect = cont.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    document.addEventListener('pointermove', move);
    document.addEventListener('pointerup', up);
  });
  handle.addEventListener('click', e => {
    if(paxDragged) {
      e.preventDefault();
      e.stopPropagation();
    }
  }, true);
}

function showGuide() {
  const ud = window._userData || {};
  const fn = window._currentUser;
  const firstName = ud.firstName || (fn?.displayName||'').split(' ')[0] || 'there';
  const tipFn = slideTips[currentSlide] || slideTips[slideTips.length-1];
  showAvatarAndSpeak('_direct_', firstName, tipFn(firstName));
}

function toggleAvatar() {
  const cont = document.getElementById('avatar-container');
  avatarActive = !avatarActive;
  paxMinimized = !avatarActive ? paxMinimized : paxMinimized;
  if(cont) cont.style.display = avatarActive ? 'flex' : 'none';
  if(!avatarActive && window._vanceAudio) { window._vanceAudio.pause(); window._vanceAudio.currentTime=0; }
  if(!avatarActive) document.getElementById('avatar-mini').style.display='none';
}

// ─── ElevenLabs TTS for Professor Vance ──────────────────
const _vanceAudioCache = new Map(); // session cache: text → blob URL (avoids repeat API calls)
let _vanceGen = 0;       // incremented each time a new speak is requested — stale fetches are discarded
let _vanceTimer = null;  // single pending speak timer — cleared before each new one is scheduled

// Cancel any scheduled or in-flight Vance speech and stop current audio
function cancelVance() {
  clearTimeout(_vanceTimer);
  _vanceTimer = null;
  _vanceGen++;  // invalidate any in-flight fetch
  if(window._vanceAudio) { window._vanceAudio.pause(); window._vanceAudio.currentTime = 0; window._vanceAudio = null; }
  const portrait = document.getElementById('vance-portrait');
  if(portrait) portrait.classList.remove('speaking');
}

// Schedule a single Vance speech, cancelling any previously queued one
function scheduleVance(fn, delay) {
  clearTimeout(_vanceTimer);
  _vanceTimer = setTimeout(fn, delay);
}

async function speakWithVance(text) {
  if(paxMuted || !text) return;
  // Stop any current playback
  if(window._vanceAudio) { window._vanceAudio.pause(); window._vanceAudio.currentTime = 0; window._vanceAudio = null; }
  // Capture current generation — if it changes before fetch resolves, discard the audio
  const myGen = ++_vanceGen;

  const portrait = document.getElementById('vance-portrait');
  const cacheKey = text.trim().slice(0, 120); // use first 120 chars as key

  const playAudio = (url) => {
    if(_vanceGen !== myGen) return; // a newer speak was requested — discard this audio
    if(window._vanceAudio) { window._vanceAudio.pause(); window._vanceAudio.currentTime = 0; }
    const audio = new Audio(url);
    window._vanceAudio = audio;
    if(portrait) portrait.classList.add('speaking');
    audio.play().catch(()=>{});
    audio.onended = () => {
      window._vanceAudio = null;
      if(portrait) portrait.classList.remove('speaking');
    };
    audio.onerror = () => {
      window._vanceAudio = null;
      if(portrait) portrait.classList.remove('speaking');
    };
  };

  // Return cached audio if available for this text
  if(_vanceAudioCache.has(cacheKey)) {
    playAudio(_vanceAudioCache.get(cacheKey));
    return;
  }

  // Call /api/tts — fallback silently on failure (no disruption to training)
  try {
    const res = await fetch('/api/tts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    });
    if(_vanceGen !== myGen) return; // superseded while waiting for network
    if(!res.ok) return;
    const blob = await res.blob();
    if(_vanceGen !== myGen) return; // superseded while parsing blob
    const url  = URL.createObjectURL(blob);
    _vanceAudioCache.set(cacheKey, url);
    playAudio(url);
  } catch(e) {
    // TTS failure is non-fatal — training continues without audio
  }
}

// ─── Tutorial ────────────────────────────────────────────
const TUTORIAL_STEPS = [
  {
    icon: '🎓',
    title: 'Welcome to the Lab',
    subtitle: 'De-escalation Training Simulation',
    body: `I'm Professor Vance, your Clinical Mentor. Today we're working with ${window.TENANT?.patientName||'Marcus'} — a patient who's been waiting a long time for his evaluation and the tension is rising. Before we step into the unit, let's cover your three core tools.`,
    tip: `Welcome to the Lab, Trainee. Your goal isn't to control ${window.TENANT?.patientName||'Marcus'} — it's to help him regain control of himself. Accuracy is better than speed, but in a crisis you'll need both. Let's begin.`
  },
  {
    icon: '🔍',
    title: 'Step 1 — Environmental Hazard Scan',
    subtitle: `Secure the room before you engage ${window.TENANT?.patientName||'Marcus'}`,
    body: `Before approaching ${window.TENANT?.patientName||'Marcus'}, tap every object in the room that could be used as a weapon or projectile — water pitchers, loose cords, heavy books. Always secure the environment first; then engage the patient.`,

    tip: "A safe room makes for a safe conversation. Don't let a heavy book or a loose cord turn a talk into a crisis."
  },
  {
    icon: '👁',
    title: 'Step 2 — Micro-Expression Training',
    subtitle: "Read what Marcus won't say out loud",
    body: "You'll have 2 seconds to identify Marcus's hidden emotion: Anger, Fear, Sadness, or Neutral. His face gives away what his words won't. Build this skill until it's automatic — it could be the first warning you get.",
    tip: "The eyes tell the truth before the voice does. Flared nostrils and narrowed eyes mean it's time to back up and give Marcus more space."
  },
  {
    icon: '💬',
    title: 'Step 3 — Live Interaction',
    subtitle: 'Practice verbal de-escalation with Marcus',
    body: "When Marcus speaks, type your response in the chat. I'll analyze your words and coach you in real-time. There's no pre-set script — this is live practice. Every response you type earns XP based on your clinical judgment.",
    tip: "Think before you type. Avoid 'Why' questions — they sound like accusations. Instead, validate what Marcus is feeling."
  }
];
let tutCurrentStep = 0;

function openTutorial() {
  const overlay = document.getElementById('tutorial-overlay');
  if(!overlay) return;
  tutCurrentStep = 0;
  overlay.style.display = 'flex';
  renderTutStep();
}

function renderTutStep() {
  const step = TUTORIAL_STEPS[tutCurrentStep];
  if(!step) return;
  const el = (id) => document.getElementById(id);
  el('tut-icon').textContent    = step.icon;
  el('tut-title').textContent   = step.title;
  el('tut-subtitle').textContent = step.subtitle;
  el('tut-body').textContent    = step.body;
  el('tut-tip').textContent     = step.tip;
  // Dots
  TUTORIAL_STEPS.forEach((_,i) => {
    const d = el(`tut-dot-${i}`);
    if(d) d.style.background = i === tutCurrentStep ? '#2563eb' : '#cbd5e1';
  });
  // Back button
  const back = el('tut-back-btn');
  if(back) back.style.display = tutCurrentStep > 0 ? 'inline-block' : 'none';
  // Next/finish button
  const next = el('tut-next-btn');
  if(next) {
    const isLast = tutCurrentStep === TUTORIAL_STEPS.length - 1;
    next.textContent = isLast ? '🚀 Begin Training' : 'Next →';
    next.onclick = isLast ? closeTutorial : () => tutStep(1);
  }
  // TTS narration of Professor tip
  speakWithVance(step.tip);
}

function tutStep(dir) {
  tutCurrentStep = Math.max(0, Math.min(TUTORIAL_STEPS.length - 1, tutCurrentStep + dir));
  renderTutStep();
}

function closeTutorial() {
  const overlay = document.getElementById('tutorial-overlay');
  if(overlay) overlay.style.display = 'none';
  if(window._currentUser) _saveUserData({ hasOnboarded: true });
  if(window._vanceAudio) { window._vanceAudio.pause(); window._vanceAudio.currentTime = 0; }
  // After tutorial, show the hub so they can choose where to go
  const hub = document.getElementById('home-gateway');
  if(hub) hub.style.display = 'flex';
}

// ─── XP Toast ────────────────────────────────────────────
function showXPToast(amount, label='') {
  const toast = document.getElementById('xp-toast');
  if(!toast) return;
  toast.textContent = `+${amount.toLocaleString()} XP${label ? ' · ' + label : ''}`;
  toast.style.display = 'block';
  toast.style.opacity = '1';
  toast.style.transition = '';
  toast.classList.remove('xp-toast-pop');
  void toast.offsetWidth; // reflow to restart animation
  toast.classList.add('xp-toast-pop');
  clearTimeout(window._xpToastTimer);
  window._xpToastTimer = setTimeout(() => {
    toast.style.transition = 'opacity .65s ease';
    toast.style.opacity = '0';
    setTimeout(() => { toast.style.display = 'none'; toast.style.transition = ''; toast.classList.remove('xp-toast-pop'); }, 700);
  }, 1900);
}

function showAvatarAndSpeak(context, name, directText) {
  // Cancel any pending scheduled speech and stop current audio before starting a new one
  cancelVance();
  // Don't interrupt with auto slide-tips while the hub is open — but DO allow direct messages (welcome back etc.)
  const hub = document.getElementById('home-gateway');
  if(hub && hub.style.display === 'flex' && context !== '_direct_') return;

  const cont   = document.getElementById('avatar-container');
  const bubble = document.getElementById('avatar-speech');
  const mouth  = document.getElementById('avatar-mouth');
  if(!cont || !bubble) return;

  let text;
  if(directText) {
    text = directText;
  } else if(context === 'welcome') {
    text = slideTips[0](name);
  } else {
    text = slideTips[currentSlide] ? slideTips[currentSlide](name) : slideTips[slideTips.length-1](name);
  }

  cont.style.display = 'flex';
  avatarActive = true;
  paxMinimized = false;
  const mini = document.getElementById('avatar-mini');
  if(mini) mini.style.display='none';
  const muteBtn = document.getElementById('pax-mute-btn');
  if(muteBtn) muteBtn.textContent = paxMuted ? '🔇' : '🔈';
  bubble.style.transition = 'none';
  bubble.style.display  = 'block';
  bubble.style.opacity  = '0';
  bubble.style.transform = 'translateY(10px)';
  const speechText = document.getElementById('avatar-speech-text');
  if(speechText) speechText.textContent = text;
  else bubble.textContent = text;
  bubble.onclick = openChatFromPax;
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      bubble.style.transition = 'opacity .35s ease, transform .35s ease';
      bubble.style.opacity    = '1';
      bubble.style.transform  = 'translateY(0)';
    });
  });

  // ElevenLabs TTS — natural Professor Vance voice
  speakWithVance(text);
}

// ─── My Account ──────────────────────────────────────────
function openAccountModal() {
  const ud = window._userData || {};
  const user = window._currentUser;
  const fname = ud.firstName || (ud.name||'').split(' ')[0] || '';
  const lname = ud.lastName  || (ud.name||'').split(' ').slice(1).join(' ') || '';
  const initials = ((fname[0]||'')+(lname[0]||'')).toUpperCase() || (user?.email||'?')[0].toUpperCase();
  document.getElementById('acct-avatar-circle').textContent = initials;
  document.getElementById('acct-header-name').textContent = fname + (lname ? ' ' + lname : '');
  const tier = getTier(labCredits, labSettings.redemptionTiers||[]);
  document.getElementById('acct-header-sub').textContent = (ud.jobTitle||'') + (ud.department ? ' · ' + ud.department : '');
  document.getElementById('acct-fname').textContent   = fname || '—';
  document.getElementById('acct-lname').textContent   = lname || '—';
  document.getElementById('acct-email').textContent   = ud.email || user?.email || '—';
  document.getElementById('acct-phone').textContent   = ud.phone || '—';
  document.getElementById('acct-title').textContent   = ud.jobTitle || '—';
  document.getElementById('acct-dept').textContent    = ud.department || '—';
  document.getElementById('acct-empid').textContent   = ud.employeeId || '—';
  document.getElementById('acct-year').textContent    = ud.trainingYear || new Date().getFullYear();
  const lcStat = document.getElementById('acct-lc-stat');
  if(lcStat) lcStat.textContent = (labCredits||0).toLocaleString();
  const tierEl = document.getElementById('acct-tier-stat');
  if(tierEl) tierEl.textContent = tier ? `Tier ${tier}` : '—';
  document.getElementById('acct-xp-stat').textContent       = (ud.xp||xp||0).toLocaleString();
  document.getElementById('acct-level-stat').textContent    = ud.level||level||1;
  document.getElementById('acct-scenarios-stat').textContent= ud.scenariosDone||scenariosDone||0;
  document.getElementById('acct-view').style.display = 'block';
  document.getElementById('acct-edit').style.display = 'none';
  document.getElementById('acct-pw').style.display   = 'none';
  document.getElementById('account-modal').style.display = 'flex';
}
function closeAccountModal() { document.getElementById('account-modal').style.display='none'; }
function openAccountEdit() {
  const ud = window._userData || {};
  const fname = ud.firstName || (ud.name||'').split(' ')[0] || '';
  const lname = ud.lastName  || (ud.name||'').split(' ').slice(1).join(' ') || '';
  document.getElementById('edit-fname').value = fname;
  document.getElementById('edit-lname').value = lname;
  document.getElementById('edit-phone').value = ud.phone || '';
  document.getElementById('edit-title').value = ud.jobTitle || '';
  document.getElementById('edit-dept').value  = ud.department || '';
  document.getElementById('edit-empid').value = ud.employeeId || '';
  document.getElementById('acct-edit-error').style.display = 'none';
  document.getElementById('acct-view').style.display = 'none';
  document.getElementById('acct-edit').style.display = 'block';
}
function cancelAccountEdit() {
  document.getElementById('acct-edit').style.display = 'none';
  document.getElementById('acct-view').style.display = 'block';
}
async function saveAccountEdit() {
  const fname = document.getElementById('edit-fname').value.trim();
  const lname = document.getElementById('edit-lname').value.trim();
  const phone = document.getElementById('edit-phone').value.trim();
  const title = document.getElementById('edit-title').value.trim();
  const dept  = document.getElementById('edit-dept').value.trim();
  const empid = document.getElementById('edit-empid').value.trim();
  const errEl = document.getElementById('acct-edit-error');
  errEl.style.display='none';
  if(!fname||!lname){errEl.textContent='First and last name are required.';errEl.style.display='block';return;}
  if(!phone){errEl.textContent='Phone number is required.';errEl.style.display='block';return;}
  if(!title||!dept){errEl.textContent='Job title and department are required.';errEl.style.display='block';return;}
  const displayName = fname + ' ' + lname;
  const updates = { firstName:fname, lastName:lname, name:displayName, phone, jobTitle:title, department:dept, employeeId:empid };
  try {
    await window._saveUserData(updates);
    await window._updateProfile(window._currentUser, { displayName });
    // Refresh nav
    updateNavUI();
    // Refresh welcome name on slide 1
    const welEl = document.getElementById('welcome-name');
    if(welEl) welEl.textContent = fname;
    // Close edit, reopen view
    cancelAccountEdit();
    openAccountModal();
  } catch(e) {
    errEl.textContent = 'Error saving: ' + e.message;
    errEl.style.display='block';
  }
}
function openChangePassword() {
  document.getElementById('pw-current').value='';
  document.getElementById('pw-new').value='';
  document.getElementById('pw-conf').value='';
  document.getElementById('acct-pw-error').style.display='none';
  document.getElementById('acct-pw-success').style.display='none';
  document.getElementById('acct-view').style.display='none';
  document.getElementById('acct-pw').style.display='block';
}
function cancelChangePassword() {
  document.getElementById('acct-pw').style.display='none';
  document.getElementById('acct-view').style.display='block';
}
async function doChangePassword() {
  const cur  = document.getElementById('pw-current').value;
  const nw   = document.getElementById('pw-new').value;
  const conf = document.getElementById('pw-conf').value;
  const errEl = document.getElementById('acct-pw-error');
  const okEl  = document.getElementById('acct-pw-success');
  errEl.style.display='none'; okEl.style.display='none';
  if(!cur){errEl.textContent='Enter your current password.';errEl.style.display='block';return;}
  if(nw.length<6){errEl.textContent='New password must be at least 6 characters.';errEl.style.display='block';return;}
  if(nw!==conf){errEl.textContent='New passwords do not match.';errEl.style.display='block';return;}
  try {
    await window._reauthAndChangePassword(cur, nw);
    okEl.style.display='block';
    setTimeout(()=>cancelChangePassword(),2500);
  } catch(e) {
    const msg = e.message.replace('Firebase: ','');
    errEl.textContent = msg.includes('wrong-password')||msg.includes('invalid-credential') ? 'Current password is incorrect.' : msg;
    errEl.style.display='block';
  }
}

// ─── Admin ───────────────────────────────────────────────
let currentAdminRole = null;

async function openAdminPrompt() {
  const modal    = document.getElementById('admin-pin-modal');
  const checking = document.getElementById('admin-access-checking');
  const denied   = document.getElementById('admin-access-denied');
  const setup    = document.getElementById('admin-first-setup');
  const codeBox  = document.getElementById('admin-code-entry');
  const codeErr  = document.getElementById('admin-code-error');
  const codeInp  = document.getElementById('admin-access-code');
  const msg      = document.getElementById('admin-access-msg');
  // Reset state
  checking.style.display='block'; denied.style.display='none'; setup.style.display='none'; codeBox.style.display='none';
  codeErr.style.display='none'; if(codeInp) codeInp.value='';
  msg.textContent = 'Checking your access level…';
  modal.style.display='flex';
  try {
    const uid = window._currentUser?.uid;
    if(!uid) { denied.style.display='block'; checking.style.display='none'; return; }
    // Load settings and admins
    const [allAdmins, settings] = await Promise.all([window._loadAllAdmins(), window._getSettings()]);
    adminCodeHash = settings?.adminCodeHash || null;
    if(!allAdmins || !Object.keys(allAdmins).length) {
      // First-time setup — allow current user to claim owner and set code
      msg.textContent = 'No admin accounts found.';
      checking.style.display='none'; setup.style.display='block'; return;
    }
    const role = await window._getAdminRole(uid);
    currentAdminRole = role;
    if(role) {
      if(adminCodeHash) {
        msg.textContent = 'Enter access code to continue.';
        checking.style.display='none'; codeBox.style.display='block';
        if(codeInp) setTimeout(()=>codeInp.focus(),50);
      } else {
        modal.style.display='none';
        openAdminDashboard();
      }
    } else {
      msg.textContent = 'Access check complete.';
      checking.style.display='none'; denied.style.display='block';
    }
  } catch(e) {
    msg.textContent = 'Error checking access.';
    checking.style.display='none'; denied.style.display='block';
  }
}

async function claimOwnerAccount() {
  const uid = window._currentUser?.uid;
  if(!uid) return;
  const code = document.getElementById('owner-code-new')?.value.trim();
  const conf = document.getElementById('owner-code-conf')?.value.trim();
  const err  = document.getElementById('owner-code-error');
  if(err) err.style.display='none';
  if(!code || !conf) { if(err){err.textContent='Enter and confirm an access code.'; err.style.display='block';} return; }
  if(code!==conf){ if(err){err.textContent='Codes do not match.'; err.style.display='block';} return; }
  try {
    const hash = await hashText(code);
    await window._setAdminRole(uid, 'owner');
    await window._saveSettings({ adminCodeHash: hash });
    adminCodeHash = hash;
    currentAdminRole = 'owner';
    document.getElementById('admin-pin-modal').style.display='none';
    openAdminDashboard();
  } catch(e) { if(err){err.textContent='Error: '+e.message; err.style.display='block';} else { alert('Error claiming owner account: ' + e.message); } }
}

function openAdminDashboard() {
  const badge = document.getElementById('admin-role-badge');
  if(badge) badge.textContent = `Destiny Springs Healthcare — Signed in as ${currentAdminRole==='owner' ? '🔑 Owner' : '🛡️ Admin'}`;
  // Show/hide owner-only tabs based on role
  const auditBtn = document.getElementById('audit-tab-btn');
  if(auditBtn) auditBtn.style.display = currentAdminRole==='owner' ? '' : 'none';
  const stBtn = document.getElementById('settings-tab-btn');
  if(stBtn) stBtn.style.display = currentAdminRole==='owner' ? 'block' : 'none';
  document.getElementById('admin-modal').style.display='flex';
  loadLeaderboard();
}

async function verifyAdminCode() {
  const inp = document.getElementById('admin-access-code');
  const err = document.getElementById('admin-code-error');
  if(err) err.style.display='none';
  if(!inp) return;
  const val = inp.value.trim();
  if(!val){ if(err){err.textContent='Enter the access code.'; err.style.display='block';} return; }
  if(!adminCodeHash) {
    document.getElementById('admin-pin-modal').style.display='none';
    openAdminDashboard();
    return;
  }
  const hash = await hashText(val);
  if(hash === adminCodeHash) {
    document.getElementById('admin-pin-modal').style.display='none';
    openAdminDashboard();
  } else {
    if(err){err.textContent='Incorrect code. Try again.'; err.style.display='block';}
  }
}

function closePinModal() { document.getElementById('admin-pin-modal').style.display='none'; }
function closeAdmin()    { document.getElementById('admin-modal').style.display='none'; currentAdminRole=null; }

function adminTab(name, el) {
  document.querySelectorAll('.admin-tab-btn').forEach(t=>{
    t.className='admin-tab-btn py-3 px-4 text-xs font-black uppercase tracking-widest border-b-2 border-transparent text-slate-400 whitespace-nowrap';
  });
  if(el){ el.className='admin-tab-btn py-3 px-4 text-xs font-black uppercase tracking-widest border-b-2 border-blue-600 text-blue-600 whitespace-nowrap'; }
  ['leaderboard','users','analytics','reports','completion','settings','audit'].forEach(t=>{
    const d=document.getElementById('at-'+t);
    if(d) d.style.display=(t===name)?'block':'none';
  });
  if(name==='leaderboard') loadLeaderboard();
  if(name==='users')       loadUsers();
  if(name==='analytics')   loadAnalytics();
  if(name==='reports')     loadReports();
  if(name==='completion')  loadCompletion();
  if(name==='settings')    loadSettings();
  if(name==='audit')       loadAudit();
}

async function loadLeaderboard() {
  const el = document.getElementById('at-leaderboard');
  if(!el) return;
  el.innerHTML = `<div style="display:flex;flex-direction:column;gap:.75rem;padding:.5rem">${[1,2,3,4,5].map(()=>`
    <div style="display:flex;align-items:center;gap:.75rem">
      <div class="skel" style="width:32px;height:32px;border-radius:50%;flex-shrink:0"></div>
      <div style="flex:1;display:flex;flex-direction:column;gap:.4rem">
        <div class="skel" style="width:55%;height:.85rem"></div>
        <div class="skel" style="width:35%;height:.72rem"></div>
      </div>
      <div class="skel" style="width:60px;height:1.2rem"></div>
    </div>`).join('')}</div>`;
  try {
    const users = await window._loadAllUsers();
    if(!users||!Object.keys(users).length){
      el.innerHTML='<p style="color:#94a3b8;font-size:.875rem;padding:1rem">No users yet.</p>'; return;
    }
    const sorted = Object.entries(users).map(([uid,d])=>({uid,...d}))
      .sort((a,b)=>(b.xp||0)-(a.xp||0));
    const medals=['🥇','🥈','🥉'];
    const T = window.TENANT;
    const totalSl = (T?.moduleCount||27);
    el.innerHTML = `<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:.85rem">
      <thead><tr style="background:#f8fafc;border-bottom:2px solid #e2e8f0">
        <th style="padding:.875rem;text-align:left;font-weight:900;color:#0f172a">#</th>
        <th style="padding:.875rem;text-align:left;font-weight:900;color:#0f172a">Name</th>
        <th style="padding:.875rem;text-align:left;font-weight:900;color:#0f172a">Dept</th>
        <th style="padding:.875rem;text-align:center;font-weight:900;color:#0f172a">Level</th>
        <th style="padding:.875rem;text-align:center;font-weight:900;color:#0f172a">XP</th>
        <th style="padding:.875rem;text-align:center;font-weight:900;color:#0f172a">Progress</th>
        <th style="padding:.875rem;text-align:center;font-weight:900;color:#0f172a">Status</th>
      </tr></thead><tbody>
      ${sorted.map((u,i)=>{
        const nm = [u.firstName,u.lastName].filter(Boolean).join(' ') || u.name || u.email || 'Unknown';
        const done = (u.currentSlide||0) >= totalSl - 1;
        const pct  = Math.min(100, Math.round(((u.currentSlide||0)/(totalSl-1))*100));
        return `<tr style="border-bottom:1px solid #f1f5f9;${i<3?'background:#fffbeb':''}">
          <td style="padding:.875rem;font-weight:900;color:#0f172a">${medals[i]||i+1}</td>
          <td style="padding:.875rem;font-weight:700;color:#0f172a">${nm}</td>
          <td style="padding:.875rem;color:#64748b;font-size:.8rem">${u.department||'—'}</td>
          <td style="padding:.875rem;text-align:center"><span class="badge" style="background:#dbeafe;color:#1d4ed8">Lvl ${u.level||1}</span></td>
          <td style="padding:.875rem;text-align:center;font-weight:800;color:#2563eb">${(u.xp||0).toLocaleString()}</td>
          <td style="padding:.875rem;text-align:center"><div style="background:#e2e8f0;border-radius:999px;height:8px;width:80px;margin:auto"><div style="background:#2563eb;height:8px;border-radius:999px;width:${pct}%"></div></div></td>
          <td style="padding:.875rem;text-align:center"><span style="background:${done?'#dcfce7':'#fef9c3'};color:${done?'#15803d':'#92400e'};padding:.2rem .6rem;border-radius:999px;font-size:.72rem;font-weight:800">${done?'✅ Done':'⏳ '+pct+'%'}</span></td>
        </tr>`;
      }).join('')}
      </tbody></table></div>`;
  } catch(e){
    el.innerHTML=`<p style="color:#ef4444;font-size:.875rem;padding:1rem">Error loading users: ${e.message}</p>`;
  }
}

async function loadUsers() {
  const el = document.getElementById('at-users');
  if(!el) return;
  el.innerHTML = `<div style="display:flex;flex-direction:column;gap:.65rem;padding:.5rem">${[1,2,3,4,5,6].map(()=>`
    <div style="display:flex;align-items:center;gap:.75rem;padding:.5rem;border-radius:.75rem;border:1px solid #f1f5f9">
      <div class="skel" style="width:40px;height:40px;border-radius:50%;flex-shrink:0"></div>
      <div style="flex:1;display:flex;flex-direction:column;gap:.4rem">
        <div class="skel" style="width:45%;height:.85rem"></div>
        <div class="skel" style="width:65%;height:.72rem"></div>
      </div>
      <div style="display:flex;gap:.5rem">
        <div class="skel" style="width:50px;height:1.4rem"></div>
        <div class="skel" style="width:65px;height:1.4rem"></div>
      </div>
    </div>`).join('')}</div>`;
  try {
    const users = await window._loadAllUsers();
    if(!users||!Object.keys(users).length){
      el.innerHTML='<p style="color:#94a3b8;font-size:.875rem;padding:1rem">No registered users yet.</p>'; return;
    }
    window._adminUsersCache = users;
    _renderUsersGrid(users);
  } catch(e){
    el.innerHTML=`<p style="color:#ef4444;font-size:.875rem;padding:1rem">Error: ${e.message}</p>`;
  }
}

function _renderUsersGrid(users) {
  const el = document.getElementById('at-users');
  if(!el) return;
  const T = window.TENANT;
  const totalSl = (T?.moduleCount||27);
  const entries = Object.entries(users);
  el.innerHTML = `
    <div style="display:flex;gap:.75rem;align-items:center;margin-bottom:1rem;flex-wrap:wrap">
      <input id="user-search-box" type="text" placeholder="🔍 Search name, email or department…"
        oninput="filterAdminUsers(this.value)"
        style="flex:1;min-width:200px;padding:.55rem .9rem;border:1px solid #e2e8f0;border-radius:.65rem;font-size:.85rem;font-weight:600;color:#0f172a;outline:none">
      <button onclick="openBulkDueDateModal()" style="background:linear-gradient(135deg,#2563eb,#7c3aed);color:white;border:none;padding:.5rem 1rem;border-radius:.65rem;font-size:.8rem;font-weight:800;cursor:pointer;white-space:nowrap">📅 Bulk Deadline</button>
      <span id="user-count-badge" style="font-size:.8rem;color:#94a3b8;font-weight:700">${entries.length} user${entries.length!==1?'s':''}</span>
    </div>
    <div id="user-cards-wrap">
      ${entries.map(([uid,u])=>{
        const name = [u.firstName,u.lastName].filter(Boolean).join(' ') || u.name || 'Unknown';
        const initials = name.split(' ').map(w=>w[0]||'').join('').toUpperCase().slice(0,2)||'?';
        const done = (u.currentSlide||0) >= totalSl-1;
        const lastSeen = u.lastLogin ? new Date(u.lastLogin).toLocaleDateString() : 'Never';
        const searchKey = (name+' '+(u.email||'')+' '+(u.department||'')).toLowerCase();
        // Due-date badge
        let dueBadge = '';
        if (u.dueDate && !done) {
          const dLeft = Math.ceil((u.dueDate - Date.now()) / 864e5);
          const isOD  = dLeft < 0;
          const isSoon = dLeft >= 0 && dLeft <= 3;
          const dueBg  = isOD ? '#fef2f2' : isSoon ? '#fff7ed' : '#eff6ff';
          const dueClr = isOD ? '#dc2626' : isSoon ? '#d97706' : '#2563eb';
          const dueLabel = isOD ? `⚠️ Overdue ${Math.abs(dLeft)}d` : dLeft === 0 ? '🚨 Due today' : `📅 ${dLeft}d left`;
          dueBadge = `<span style="background:${dueBg};color:${dueClr};padding:.2rem .6rem;border-radius:999px;font-size:.72rem;font-weight:800">${dueLabel}</span>`;
        }
        return `<div data-uid="${uid}" data-search="${searchKey}"
          style="background:#f8fafc;border-radius:1rem;padding:.875rem 1rem;display:flex;align-items:center;justify-content:space-between;border:1px solid #e2e8f0;margin-bottom:.65rem;gap:1rem;flex-wrap:wrap">
          <div style="display:flex;align-items:center;gap:.875rem;flex:1;min-width:0">
            <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#2563eb,#7c3aed);color:white;font-weight:900;font-size:.9rem;display:flex;align-items:center;justify-content:center;flex-shrink:0">${initials}</div>
            <div style="min-width:0">
              <p style="font-weight:800;font-size:.875rem;color:#0f172a;margin:0">${name}</p>
              <p style="font-size:.72rem;color:#64748b;margin:.1rem 0 0">${u.email||''}${u.department?' · '+u.department:''}</p>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:.75rem;flex-wrap:wrap">
            <span style="font-size:.78rem;font-weight:700;color:#2563eb">Lvl ${u.level||1} · ${(u.xp||0).toLocaleString()} XP</span>
            <span style="background:${done?'#dcfce7':'#fef9c3'};color:${done?'#15803d':'#92400e'};padding:.2rem .6rem;border-radius:999px;font-size:.72rem;font-weight:800">${done?'✅ Done':'⏳ Slide '+(u.currentSlide||0)}</span>
            ${dueBadge}
            <span style="font-size:.72rem;color:#94a3b8;font-weight:600">Last: ${lastSeen}</span>
            <button onclick="openSetDueDateModal('${uid}','${name.replace(/'/g,"\\'")}',${u.dueDate||'null'})" style="background:#eff6ff;color:#2563eb;border:1px solid #bfdbfe;border-radius:.5rem;padding:.3rem .7rem;font-size:.72rem;font-weight:700;cursor:pointer">📅 Deadline</button>
            <button onclick="confirmDeleteUser('${uid}','${name.replace(/'/g,"\\'")}' )" style="background:#fef2f2;color:#dc2626;border:1px solid #fecaca;border-radius:.5rem;padding:.3rem .7rem;font-size:.72rem;font-weight:700;cursor:pointer">Remove</button>
          </div>
        </div>`;
      }).join('')}
    </div>`;
}

function filterAdminUsers(q) {
  const term = (q||'').toLowerCase().trim();
  const cards = document.querySelectorAll('#user-cards-wrap>[data-uid]');
  let visible = 0;
  cards.forEach(c => {
    const match = !term || c.dataset.search.includes(term);
    c.style.display = match ? '' : 'none';
    if(match) visible++;
  });
  const badge = document.getElementById('user-count-badge');
  if(badge) badge.textContent = `${visible} user${visible!==1?'s':''}`;
}

async function confirmDeleteUser(uid,name) {
  if(!confirm(`Remove user "${name}" from the system? This cannot be undone.`)) return;
  try{
    await window._deleteUser(uid);
    loadUsers();
    loadLeaderboard();
  }catch(e){alert('Error removing user: '+e.message);}
}

async function loadAnalytics() {
  const el = document.getElementById('at-analytics');
  if(!el) return;
  el.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:1rem;margin-bottom:1.5rem">${[1,2,3,4].map(()=>`<div style="padding:1.25rem;border-radius:1rem;background:#f8fafc"><div class="skel" style="width:55%;height:2rem;margin:0 auto .5rem"></div><div class="skel" style="width:70%;height:.72rem;margin:0 auto"></div></div>`).join('')}</div><div style="display:flex;flex-direction:column;gap:.65rem">${[1,2,3].map(()=>`<div class="skel" style="height:2.5rem;border-radius:.75rem"></div>`).join('')}</div>`;
  try {
    const users = await window._loadAllUsers() || {};
    const list = Object.values(users);
    const T = window.TENANT;
    const totalSl = (T?.moduleCount||27);
    const total       = list.length;
    const notStarted  = list.filter(u=>!(u.currentSlide>0) && !(u.xp>0)).length;
    const inProgress  = list.filter(u=>(u.currentSlide||0)>0 && (u.currentSlide||0)<totalSl-1).length;
    const compl       = list.filter(u=>(u.currentSlide||0)>=totalSl-1).length;
    const stalled     = list.filter(u=> {
      const daysAgo = u.lastLogin ? (Date.now()-u.lastLogin)/864e5 : 999;
      return daysAgo > 7 && (u.currentSlide||0) > 0 && (u.currentSlide||0) < totalSl-1;
    }).length;
    const avgXP  = total ? Math.round(list.reduce((s,u)=>s+(u.xp||0),0)/total) : 0;
    const avgLvl = total ? (list.reduce((s,u)=>s+(u.level||1),0)/total).toFixed(1) : 0;
    const complPct = total ? Math.round((compl/total)*100) : 0;
    el.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:1rem;margin-bottom:1.5rem">
        <div style="background:#eff6ff;padding:1.25rem;border-radius:1rem;text-align:center">
          <div style="font-size:2rem;font-weight:900;color:#1d4ed8">${total}</div>
          <p style="font-size:.72rem;color:#3b82f6;font-weight:800;text-transform:uppercase;margin-top:.25rem">Total Users</p>
        </div>
        <div style="background:#f0fdf4;padding:1.25rem;border-radius:1rem;text-align:center">
          <div style="font-size:2rem;font-weight:900;color:#15803d">${compl}</div>
          <p style="font-size:.72rem;color:#16a34a;font-weight:800;text-transform:uppercase;margin-top:.25rem">Completed</p>
        </div>
        <div style="background:#fef9c3;padding:1.25rem;border-radius:1rem;text-align:center">
          <div style="font-size:2rem;font-weight:900;color:#92400e">${inProgress}</div>
          <p style="font-size:.72rem;color:#d97706;font-weight:800;text-transform:uppercase;margin-top:.25rem">In Progress</p>
        </div>
        <div style="background:#fef2f2;padding:1.25rem;border-radius:1rem;text-align:center">
          <div style="font-size:2rem;font-weight:900;color:#dc2626">${notStarted}</div>
          <p style="font-size:.72rem;color:#ef4444;font-weight:800;text-transform:uppercase;margin-top:.25rem">Not Started</p>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem">
        <div style="background:#faf5ff;padding:1.25rem;border-radius:1rem;text-align:center">
          <div style="font-size:2rem;font-weight:900;color:#6d28d9">${avgXP.toLocaleString()}</div>
          <p style="font-size:.72rem;color:#7c3aed;font-weight:800;text-transform:uppercase;margin-top:.25rem">Avg XP</p>
        </div>
        <div style="background:#fffbeb;padding:1.25rem;border-radius:1rem;text-align:center">
          <div style="font-size:2rem;font-weight:900;color:#92400e">${avgLvl}</div>
          <p style="font-size:.72rem;color:#d97706;font-weight:800;text-transform:uppercase;margin-top:.25rem">Avg Level</p>
        </div>
      </div>
      <div style="background:#f8fafc;border-radius:1rem;padding:1.25rem;border:1px solid #e2e8f0;margin-bottom:1.25rem">
        <p style="font-size:.8rem;font-weight:900;color:#0f172a;margin-bottom:.875rem;text-transform:uppercase">Overall Completion Rate</p>
        <div style="background:#e2e8f0;border-radius:999px;height:14px;overflow:hidden">
          <div style="background:linear-gradient(90deg,#2563eb,#7c3aed);height:14px;border-radius:999px;width:${complPct}%;transition:width .6s ease"></div>
        </div>
        <p style="font-size:.75rem;color:#64748b;margin-top:.5rem;font-weight:700">${complPct}% of ${total} users completed all ${totalSl} slides</p>
      </div>
      ${stalled > 0
        ? `<div style="background:#fff7ed;border:1px solid #fed7aa;border-radius:1rem;padding:1.25rem">
            <p style="font-weight:900;font-size:.85rem;color:#c2410c;margin-bottom:.4rem">⚠️ Needs Attention — ${stalled} staff member${stalled!==1?'s':''} stalled 7+ days</p>
            <p style="font-size:.8rem;color:#9a3412;margin:0">These users started training but haven't logged in for over a week. Visit the Users tab to identify them (highlighted in red "Last Login").</p>
          </div>`
        : `<div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:1rem;padding:1.25rem">
            <p style="font-weight:900;font-size:.85rem;color:#15803d;margin:0">✅ No stalled users — all active staff are progressing on schedule.</p>
          </div>`
      }`;
  } catch(e){
    el.innerHTML=`<p style="color:#ef4444;font-size:.875rem">Error: ${e.message}</p>`;
  }
}

// ─── Reports ──────────────────────────────────────────────
async function loadReports() {
  const el = document.getElementById('at-reports');
  if(!el) return;
  el.innerHTML=`<p style="color:#94a3b8;font-size:.875rem;padding:1rem">Loading reports…</p>`;
  try {
    const users = await window._loadAllUsers() || {};
    const list = Object.entries(users).map(([uid,d])=>({uid,...d}));
    if(!list.length){ el.innerHTML='<p style="color:#94a3b8;font-size:.875rem;padding:1rem">No user data yet.</p>'; return; }

    // Group by department
    const T = window.TENANT;
    const totalSl = (T?.moduleCount||27);
    const depts = {};
    list.forEach(u => {
      const d = u.department || 'Unassigned';
      if(!depts[d]) depts[d] = { total:0, completed:0, totalXP:0 };
      depts[d].total++;
      if((u.currentSlide||0)>=totalSl-1) depts[d].completed++;
      depts[d].totalXP += (u.xp||0);
    });

    let deptRows = Object.entries(depts).sort((a,b)=>b[1].total-a[1].total).map(([name,d])=>{
      const pct = Math.round((d.completed/d.total)*100);
      return `<tr style="border-bottom:1px solid #f1f5f9">
        <td style="padding:.75rem 1rem;font-weight:700;color:#0f172a">${name}</td>
        <td style="padding:.75rem 1rem;text-align:center;color:#475569">${d.total}</td>
        <td style="padding:.75rem 1rem;text-align:center;color:#15803d;font-weight:800">${d.completed}</td>
        <td style="padding:.75rem 1rem;text-align:center">
          <div style="display:flex;align-items:center;gap:.5rem">
            <div style="flex:1;background:#e2e8f0;border-radius:999px;height:8px">
              <div style="background:${pct>=80?'#16a34a':pct>=50?'#2563eb':'#dc2626'};width:${pct}%;height:8px;border-radius:999px"></div>
            </div>
            <span style="font-size:.75rem;font-weight:800;color:#475569;min-width:2.5rem">${pct}%</span>
          </div>
        </td>
        <td style="padding:.75rem 1rem;text-align:center;color:#7c3aed;font-weight:700">${Math.round(d.totalXP/d.total).toLocaleString()}</td>
      </tr>`;
    }).join('');

    // Per-user table
    const userRows = list.sort((a,b)=>(b.xp||0)-(a.xp||0)).map(u=>{
      const name = [u.firstName,u.lastName].filter(Boolean).join(' ') || u.name || u.email || 'Unknown';
      const done = (u.currentSlide||0)>=totalSl-1;
      const completedDate = u.completedAt
        ? new Date(u.completedAt).toLocaleDateString()
        : (done && u.lastLogin ? new Date(u.lastLogin).toLocaleDateString()+' *' : '—');
      const quizScore = u.finalQuizScore != null ? `${u.finalQuizScore}/10` : '—';
      const daysAgo = u.lastLogin ? Math.round((Date.now()-u.lastLogin)/864e5) : null;
      const loginStr = daysAgo === 0 ? 'Today' : daysAgo === 1 ? 'Yesterday' : daysAgo != null ? `${daysAgo}d ago` : '—';
      const loginColor = daysAgo != null && daysAgo > 7 && !done ? '#dc2626' : '#475569';
      return `<tr style="border-bottom:1px solid #f1f5f9">
        <td style="padding:.6rem 1rem;font-weight:700;color:#0f172a">${name}</td>
        <td style="padding:.6rem 1rem;color:#64748b;font-size:.8rem">${u.department||'—'}</td>
        <td style="padding:.6rem 1rem;color:#64748b;font-size:.8rem">${u.jobTitle||'—'}</td>
        <td style="padding:.6rem 1rem;text-align:center"><span style="background:${done?'#dcfce7':'#fef9c3'};color:${done?'#15803d':'#92400e'};padding:.2rem .65rem;border-radius:999px;font-size:.72rem;font-weight:800">${done?'✅ Complete':'⏳ Slide '+(u.currentSlide||0)+'/'+totalSl}</span></td>
        <td style="padding:.6rem 1rem;text-align:center;font-weight:700;color:#7c3aed">${(u.xp||0).toLocaleString()}</td>
        <td style="padding:.6rem 1rem;text-align:center;font-weight:700;color:${u.finalQuizScore>=9?'#15803d':u.finalQuizScore>0?'#92400e':'#94a3b8'}">${quizScore}</td>
        <td style="padding:.6rem 1rem;text-align:center;color:#475569;font-size:.8rem">${completedDate}</td>
        <td style="padding:.6rem 1rem;text-align:center;font-size:.8rem;font-weight:700">${u.dueDate&&!done?`<span style="color:${Math.ceil((u.dueDate-Date.now())/864e5)<0?'#dc2626':Math.ceil((u.dueDate-Date.now())/864e5)<=3?'#d97706':'#2563eb'};">${Math.ceil((u.dueDate-Date.now())/864e5)<0?'⚠️ Overdue':'📅 '+new Date(u.dueDate).toLocaleDateString()}</span>`:done?'—':'Not set'}</td>
        <td style="padding:.6rem 1rem;text-align:center;color:${loginColor};font-size:.8rem;font-weight:${daysAgo>7&&!done?'800':'400'}">${loginStr}</td>
      </tr>`;
    }).join('');

    el.innerHTML = `
      <div style="display:flex;justify-content:flex-end;gap:.75rem;margin-bottom:1.25rem;flex-wrap:wrap">
        <button onclick="openBulkDueDateModal()" class="btn" style="background:linear-gradient(135deg,#2563eb,#7c3aed);color:white;border:none;font-size:.8rem;padding:.5rem 1rem">📅 Bulk Deadline</button>
        <button onclick="exportCSV()" class="btn btn-primary" style="font-size:.8rem;padding:.5rem 1.25rem">⬇️ Export CSV</button>
      </div>
      <h3 style="font-weight:900;font-size:.85rem;color:#0f172a;text-transform:uppercase;letter-spacing:.07em;margin-bottom:.75rem">Completion by Department</h3>
      <div style="overflow-x:auto;border:1px solid #e2e8f0;border-radius:1rem;margin-bottom:2rem">
        <table style="width:100%;border-collapse:collapse;font-size:.85rem">
          <thead><tr style="background:#f8fafc;">
            <th style="padding:.75rem 1rem;text-align:left;font-weight:900;color:#0f172a">Department</th>
            <th style="padding:.75rem 1rem;text-align:center;font-weight:900;color:#0f172a">Users</th>
            <th style="padding:.75rem 1rem;text-align:center;font-weight:900;color:#0f172a">Completed</th>
            <th style="padding:.75rem 1rem;text-align:left;font-weight:900;color:#0f172a">Rate</th>
            <th style="padding:.75rem 1rem;text-align:center;font-weight:900;color:#0f172a">Avg XP</th>
          </tr></thead>
          <tbody>${deptRows}</tbody>
        </table>
      </div>
      <h3 style="font-weight:900;font-size:.85rem;color:#0f172a;text-transform:uppercase;letter-spacing:.07em;margin-bottom:.75rem">All Users</h3>
      <div style="overflow-x:auto;border:1px solid #e2e8f0;border-radius:1rem">
        <table style="width:100%;border-collapse:collapse;font-size:.83rem">
          <thead><tr style="background:#f8fafc;">
            <th style="padding:.6rem 1rem;text-align:left;font-weight:900;color:#0f172a">Name</th>
            <th style="padding:.6rem 1rem;text-align:left;font-weight:900;color:#0f172a">Dept</th>
            <th style="padding:.6rem 1rem;text-align:left;font-weight:900;color:#0f172a">Title</th>
            <th style="padding:.6rem 1rem;text-align:center;font-weight:900;color:#0f172a">Status</th>
            <th style="padding:.6rem 1rem;text-align:center;font-weight:900;color:#0f172a">XP</th>
            <th style="padding:.6rem 1rem;text-align:center;font-weight:900;color:#0f172a">Quiz</th>
            <th style="padding:.6rem 1rem;text-align:center;font-weight:900;color:#0f172a">Completed</th>
            <th style="padding:.6rem 1rem;text-align:center;font-weight:900;color:#0f172a">Due Date</th>
            <th style="padding:.6rem 1rem;text-align:center;font-weight:900;color:#0f172a">Last Login</th>
          </tr></thead>
          <tbody>${userRows}</tbody>
        </table>
      </div>`;
  } catch(e){
    el.innerHTML=`<p style="color:#ef4444;font-size:.875rem">Error: ${e.message}</p>`;
  }
}

async function exportCSV() {
  const users = await window._loadAllUsers() || {};
  const rows = [['First Name','Last Name','Email','Department','Job Title','Employee ID','XP','Level','Slide','Completed','Completed Date','Quiz Score','Lab Credits','Tier','Last Login','Training Year']];
  const totalSl = (window.TENANT?.moduleCount||27);
  Object.values(users).forEach(u => {
    const tier = getTier(u.labCredits||0, (window._settingsCache?.redemptionTiers)||labSettings.redemptionTiers||[]);
    const done = (u.currentSlide||0)>=totalSl-1;
    rows.push([
      u.firstName||'', u.lastName||'', u.email||'',
      u.department||'', u.jobTitle||'', u.employeeId||'',
      u.xp||0, u.level||1, u.currentSlide||0,
      done ? 'Yes':'No',
      u.completedAt ? new Date(u.completedAt).toLocaleDateString() : (done && u.lastLogin ? new Date(u.lastLogin).toLocaleDateString()+' (est)' : ''),
      u.finalQuizScore != null ? u.finalQuizScore : '',
      u.labCredits||0,
      tier ? `Tier ${tier}` : '',
      u.lastLogin ? new Date(u.lastLogin).toLocaleDateString() : '',
      u.trainingYear||''
    ]);
  });
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = `${(window.TENANT?.orgId||'training').toUpperCase()}_Report_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

// ─── Due-date / Assignment system ─────────────────────────

function refreshDueDateBanner() {
  const banner = document.getElementById('due-date-banner');
  if (!banner) return;
  const ud = window._userData;
  if (!ud?.dueDate) { banner.style.display = 'none'; return; }
  const T = window.TENANT;
  const totalSl = (T?.moduleCount || 27);
  const done = (ud.currentSlide || 0) >= totalSl - 1;
  if (done) { banner.style.display = 'none'; return; }
  const now = Date.now();
  const due = ud.dueDate;
  const daysLeft = Math.ceil((due - now) / 864e5);
  const overdue  = daysLeft < 0;
  const soon     = daysLeft >= 0 && daysLeft <= 3;
  const bg    = overdue ? 'linear-gradient(135deg,#dc2626,#b91c1c)' : soon ? 'linear-gradient(135deg,#d97706,#b45309)' : 'linear-gradient(135deg,#2563eb,#1d4ed8)';
  const emoji = overdue ? '🚨' : soon ? '⏰' : '📅';
  const label = overdue
    ? `Your training was due ${Math.abs(daysLeft)} day${Math.abs(daysLeft)!==1?'s':''} ago. Please complete it today.`
    : daysLeft === 0
    ? 'Your training deadline is TODAY. Please complete it before your shift ends.'
    : `Training deadline: ${new Date(due).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})} — ${daysLeft} day${daysLeft!==1?'s':''} remaining`;
  banner.style.display = 'block';
  banner.innerHTML = `
    <div style="background:${bg};color:white;border-radius:1rem;padding:.875rem 1.25rem;display:flex;align-items:center;gap:.875rem;margin-bottom:.25rem">
      <span style="font-size:1.5rem;flex-shrink:0">${emoji}</span>
      <p style="font-weight:800;font-size:.9rem;margin:0;flex:1">${label}</p>
      <button onclick="hideHomeGateway();resumeTrainingFromHub&&resumeTrainingFromHub()"
        style="background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.35);color:white;padding:.4rem 1rem;border-radius:.6rem;font-weight:900;font-size:.8rem;cursor:pointer;flex-shrink:0;white-space:nowrap">
        Resume Now →
      </button>
    </div>`;
}

function openSetDueDateModal(uid, name, currentDue) {
  const existing = currentDue ? new Date(currentDue).toISOString().slice(0,10) : '';
  const existing_enc = name.replace(/'/g,"\\'");
  const modal = document.createElement('div');
  modal.id = 'due-date-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:300;display:flex;align-items:center;justify-content:center;padding:1.5rem';
  modal.innerHTML = `
    <div style="background:white;border-radius:1.25rem;padding:2rem;max-width:440px;width:100%;box-shadow:0 25px 60px rgba(0,0,0,.35)">
      <h3 style="font-weight:900;font-size:1.1rem;color:#0f172a;margin:0 0 .35rem">📅 Set Training Deadline</h3>
      <p style="font-size:.85rem;color:#64748b;margin:0 0 1.5rem">Assign a due date for <strong>${name}</strong>. They'll see a countdown banner on their Hub.</p>
      <label style="font-size:.825rem;font-weight:700;color:#0f172a;display:block;margin-bottom:.4rem">Deadline Date</label>
      <input id="due-date-input" type="date" value="${existing}"
        style="width:100%;padding:.65rem .875rem;border:1.5px solid #e2e8f0;border-radius:.65rem;font-size:1rem;font-weight:700;color:#0f172a;margin-bottom:1.25rem;outline:none">
      <div style="display:flex;gap:.75rem;justify-content:flex-end">
        ${existing ? `<button onclick="clearDueDate('${uid}')" style="background:#fef2f2;color:#dc2626;border:1px solid #fecaca;padding:.55rem 1rem;border-radius:.65rem;font-weight:800;font-size:.85rem;cursor:pointer;margin-right:auto">Remove Deadline</button>` : ''}
        <button onclick="document.getElementById('due-date-modal')?.remove()" style="background:#f1f5f9;color:#64748b;border:none;padding:.6rem 1.25rem;border-radius:.65rem;font-weight:700;font-size:.875rem;cursor:pointer">Cancel</button>
        <button onclick="saveDueDate('${uid}')" style="background:linear-gradient(135deg,#2563eb,#7c3aed);color:white;border:none;padding:.6rem 1.5rem;border-radius:.65rem;font-weight:900;font-size:.875rem;cursor:pointer">Save</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if(e.target===modal) modal.remove(); });
  setTimeout(()=>document.getElementById('due-date-input')?.focus(), 50);
}

async function saveDueDate(uid) {
  const input = document.getElementById('due-date-input');
  if (!input?.value) { alert('Please pick a date.'); return; }
  const dueDate = new Date(input.value + 'T23:59:59').getTime();
  try {
    await window._updateUserData(uid, { dueDate });
    document.getElementById('due-date-modal')?.remove();
    const cached = window._adminUsersCache;
    if (cached && cached[uid]) cached[uid].dueDate = dueDate;
    _renderUsersGrid(window._adminUsersCache || {});
  } catch(e) { alert('Error saving: ' + e.message); }
}

async function clearDueDate(uid) {
  try {
    await window._updateUserData(uid, { dueDate: null });
    document.getElementById('due-date-modal')?.remove();
    const cached = window._adminUsersCache;
    if (cached && cached[uid]) delete cached[uid].dueDate;
    _renderUsersGrid(window._adminUsersCache || {});
  } catch(e) { alert('Error: ' + e.message); }
}

function openBulkDueDateModal() {
  const cached = window._adminUsersCache || {};
  const depts = [...new Set(Object.values(cached).map(u=>u.department||'Unassigned'))].sort();
  const modal = document.createElement('div');
  modal.id = 'bulk-due-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:300;display:flex;align-items:center;justify-content:center;padding:1.5rem';
  modal.innerHTML = `
    <div style="background:white;border-radius:1.25rem;padding:2rem;max-width:480px;width:100%;box-shadow:0 25px 60px rgba(0,0,0,.35)">
      <h3 style="font-weight:900;font-size:1.1rem;color:#0f172a;margin:0 0 .35rem">📅 Bulk Assign Training Deadline</h3>
      <p style="font-size:.85rem;color:#64748b;margin:0 0 1.5rem">Assign a deadline to an entire department or all staff. Overwrites any existing deadlines.</p>
      <label style="font-size:.825rem;font-weight:700;color:#0f172a;display:block;margin-bottom:.4rem">Apply To</label>
      <select id="bulk-dept-select"
        style="width:100%;padding:.65rem .875rem;border:1.5px solid #e2e8f0;border-radius:.65rem;font-size:.9rem;font-weight:700;color:#0f172a;margin-bottom:1rem;background:white">
        <option value="__all__">All Users (entire facility)</option>
        ${depts.map(d=>`<option value="${d}">${d}</option>`).join('')}
      </select>
      <label style="font-size:.825rem;font-weight:700;color:#0f172a;display:block;margin-bottom:.4rem">Deadline Date</label>
      <input id="bulk-date-input" type="date"
        style="width:100%;padding:.65rem .875rem;border:1.5px solid #e2e8f0;border-radius:.65rem;font-size:1rem;font-weight:700;color:#0f172a;margin-bottom:1.25rem">
      <div style="display:flex;gap:.75rem;justify-content:flex-end">
        <button onclick="document.getElementById('bulk-due-modal')?.remove()" style="background:#f1f5f9;color:#64748b;border:none;padding:.6rem 1.25rem;border-radius:.65rem;font-weight:700;font-size:.875rem;cursor:pointer">Cancel</button>
        <button onclick="applyBulkDueDate()" style="background:linear-gradient(135deg,#2563eb,#7c3aed);color:white;border:none;padding:.6rem 1.5rem;border-radius:.65rem;font-weight:900;font-size:.875rem;cursor:pointer">Assign Deadline</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if(e.target===modal) modal.remove(); });
}

async function applyBulkDueDate() {
  const dept  = document.getElementById('bulk-dept-select')?.value;
  const dateV = document.getElementById('bulk-date-input')?.value;
  if (!dateV) { alert('Please pick a date.'); return; }
  const dueDate = new Date(dateV + 'T23:59:59').getTime();
  const cached = window._adminUsersCache || {};
  const targets = Object.entries(cached).filter(([,u]) =>
    dept === '__all__' || (u.department||'Unassigned') === dept
  );
  if (!targets.length) { alert('No users found.'); return; }
  if (!confirm(`Set deadline of ${new Date(dueDate).toLocaleDateString()} for ${targets.length} user${targets.length!==1?'s':''}?`)) return;
  try {
    await Promise.all(targets.map(([uid]) => window._updateUserData(uid, { dueDate })));
    targets.forEach(([uid]) => { if(cached[uid]) cached[uid].dueDate = dueDate; });
    document.getElementById('bulk-due-modal')?.remove();
    _renderUsersGrid(cached);
  } catch(e) { alert('Error: ' + e.message); }
}

// ─── Completion roster ────────────────────────────────────
async function loadCompletion() {
  const el = document.getElementById('at-completion');
  if(!el) return;
  el.innerHTML='<p style="color:#94a3b8;font-size:.875rem;padding:1rem">Loading...</p>';
  try {
    const users = await window._loadAllUsers() || {};
    const T = window.TENANT;
    const totalSl = (T?.moduleCount||27);
    const list = Object.entries(users).map(([uid,d])=>({uid,...d}));
    const done    = list.filter(u=>(u.currentSlide||0)>=totalSl-1)
                        .sort((a,b)=>(b.completedAt||b.lastLogin||0)-(a.completedAt||a.lastLogin||0));
    const pending = list.filter(u=>(u.currentSlide||0)<totalSl-1)
                        .sort((a,b)=>(b.currentSlide||0)-(a.currentSlide||0));

    const row = (u, isDone) => {
      const name = [u.firstName,u.lastName].filter(Boolean).join(' ') || u.name || 'Unknown';
      const initials = name.split(' ').map(w=>w[0]||'').join('').toUpperCase().slice(0,2)||'?';
      const pct = Math.min(100, Math.round(((u.currentSlide||0)/(totalSl-1))*100));
      const completedStr = u.completedAt
        ? new Date(u.completedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})
        : (isDone ? 'Date not recorded' : '');
      const score = u.finalQuizScore != null ? u.finalQuizScore : null;
      return `<div style="display:flex;align-items:center;gap:.875rem;padding:.75rem 1rem;border-bottom:1px solid #f1f5f9">
        <div style="width:36px;height:36px;border-radius:50%;background:${isDone?'linear-gradient(135deg,#16a34a,#22c55e)':'linear-gradient(135deg,#2563eb,#7c3aed)'};color:white;font-weight:900;font-size:.8rem;display:flex;align-items:center;justify-content:center;flex-shrink:0">${initials}</div>
        <div style="flex:1;min-width:0">
          <p style="font-weight:800;font-size:.85rem;color:#0f172a;margin:0">${name}</p>
          <p style="font-size:.72rem;color:#64748b;margin:.1rem 0 0">${u.department||u.jobTitle||u.email||''}</p>
        </div>
        ${isDone
          ? `<div style="text-align:right;flex-shrink:0">
              ${score!==null?`<div style="font-size:.75rem;font-weight:800;color:${score>=9?'#15803d':'#92400e'}">Quiz: ${score}/10</div>`:''}
              <div style="font-size:.72rem;color:#64748b">${completedStr}</div>
             </div>
             <span style="background:#dcfce7;color:#15803d;padding:.25rem .65rem;border-radius:999px;font-size:.72rem;font-weight:800;flex-shrink:0">✅ Done</span>`
          : `<div style="width:90px;flex-shrink:0">
               <div style="background:#e2e8f0;border-radius:999px;height:6px;margin-bottom:.2rem">
                 <div style="background:#2563eb;width:${pct}%;height:6px;border-radius:999px"></div>
               </div>
               <p style="font-size:.7rem;color:#94a3b8;font-weight:700;text-align:right">${pct}% · Slide ${u.currentSlide||0}</p>
             </div>`
        }
      </div>`;
    };

    el.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.25rem">
        <div style="border:1px solid #e2e8f0;border-radius:1rem;overflow:hidden">
          <div style="background:#f0fdf4;padding:.875rem 1rem;border-bottom:1px solid #e2e8f0">
            <span style="font-weight:900;font-size:.85rem;color:#15803d">✅ Completed — ${done.length}</span>
          </div>
          <div style="max-height:440px;overflow-y:auto">
            ${done.length ? done.map(u=>row(u,true)).join('') : '<p style="padding:1rem;color:#94a3b8;font-size:.85rem">No completions yet.</p>'}
          </div>
        </div>
        <div style="border:1px solid #e2e8f0;border-radius:1rem;overflow:hidden">
          <div style="background:#fef9c3;padding:.875rem 1rem;border-bottom:1px solid #e2e8f0">
            <span style="font-weight:900;font-size:.85rem;color:#92400e">⏳ In Progress / Not Started — ${pending.length}</span>
          </div>
          <div style="max-height:440px;overflow-y:auto">
            ${pending.length ? pending.map(u=>row(u,false)).join('') : '<p style="padding:1rem;color:#94a3b8;font-size:.85rem;color:#15803d">🎉 All staff have completed training!</p>'}
          </div>
        </div>
      </div>`;
  } catch(e) {
    el.innerHTML=`<p style="color:#ef4444;font-size:.875rem">Error: ${e.message}</p>`;
  }
}

// ─── Settings ─────────────────────────────────────────────
async function loadSettings() {
  if(currentAdminRole!=='owner') return;
  const el = document.getElementById('at-settings');
  if(!el) return;
  el.innerHTML=`<p style="color:#94a3b8;font-size:.875rem;padding:1rem">Loading settings…</p>`;
  try {
    const [allUsers, allAdmins, settings] = await Promise.all([
      window._loadAllUsers(), window._loadAllAdmins(), window._getSettings()
    ]);
    adminCodeHash = settings?.adminCodeHash || null;
    window._settingsCache = settings || {};
    labSettings = {
      labBaseLC: settings?.labBaseLC ?? 50,
      labScoreBonus: settings?.labScoreBonus || {A:50,B:30,C:15,D:5},
      redemptionTiers: settings?.redemptionTiers || [300,600,1000,1800],
      weeklyBonusLC: settings?.weeklyBonusLC ?? 200
    };
    const userList = Object.entries(allUsers||{});
    const adminUIDs = Object.keys(allAdmins||{});
    const currentYear = settings.trainingYear || new Date().getFullYear();

    const userOptions = userList.map(([uid,u])=>`<option value="${uid}">${u.firstName||''} ${u.lastName||''} (${u.email||uid})</option>`).join('');

    const adminRows = adminUIDs.map(uid=>{
      const role = allAdmins[uid]?.role;
      const u = allUsers[uid]||{};
      if(uid===window._currentUser?.uid) return `<tr style="border-bottom:1px solid #f1f5f9;background:#eff6ff">
        <td style="padding:.75rem 1rem;font-weight:800;color:#1d4ed8">${u.firstName||''} ${u.lastName||''} <span style="font-size:.72rem">(You)</span></td>
        <td style="padding:.75rem 1rem"><span style="background:#dbeafe;color:#1d4ed8;padding:.2rem .75rem;border-radius:999px;font-size:.75rem;font-weight:800">🔑 ${role}</span></td>
        <td style="padding:.75rem 1rem;color:#94a3b8;font-size:.8rem">Cannot modify own account</td>
      </tr>`;
      return `<tr style="border-bottom:1px solid #f1f5f9">
        <td style="padding:.75rem 1rem;font-weight:700;color:#0f172a">${u.firstName||''} ${u.lastName||''}</td>
        <td style="padding:.75rem 1rem"><span style="background:${role==='owner'?'#fef3c7':'#f0fdf4'};color:${role==='owner'?'#92400e':'#15803d'};padding:.2rem .75rem;border-radius:999px;font-size:.75rem;font-weight:800">${role==='owner'?'🔑':'🛡️'} ${role}</span></td>
        <td style="padding:.75rem 1rem">
          <button onclick="revokeAdmin('${uid}','${u.firstName||''} ${u.lastName||''}')" style="background:#fef2f2;color:#dc2626;border:1px solid #fecaca;border-radius:.5rem;padding:.3rem .875rem;font-size:.78rem;font-weight:800;cursor:pointer">Revoke</button>
        </td>
      </tr>`;
    }).join('');

    el.innerHTML = `
      <!-- Training Year -->
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:1.25rem;padding:1.5rem;margin-bottom:1.5rem">
        <h3 style="font-weight:900;font-size:.875rem;color:#0f172a;text-transform:uppercase;letter-spacing:.07em;margin-bottom:1rem">📅 Training Year</h3>
        <div style="display:flex;align-items:center;gap:.75rem">
          <input id="setting-year" type="number" value="${currentYear}" min="2020" max="2099" class="input-field" style="max-width:9rem;font-weight:800;font-size:1.1rem;text-align:center">
          <button onclick="saveTrainingYear()" class="btn btn-primary" style="font-size:.82rem;padding:.55rem 1.25rem">Save Year</button>
        </div>
        <p style="font-size:.75rem;color:#64748b;margin-top:.75rem">Changing the year marks all users' current training as outdated at year-end rollover.</p>
      </div>

      <!-- Grant Admin -->
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:1.25rem;padding:1.5rem;margin-bottom:1.5rem">
        <h3 style="font-weight:900;font-size:.875rem;color:#0f172a;text-transform:uppercase;letter-spacing:.07em;margin-bottom:1rem">🛡️ Grant Admin Access</h3>
        <div style="display:flex;gap:.75rem;flex-wrap:wrap">
          <select id="grant-admin-uid" class="input-field" style="flex:1;min-width:200px;font-size:.85rem">${userOptions}</select>
          <button onclick="grantAdminRole('admin')" class="btn" style="background:#f0fdf4;color:#15803d;border:1px solid #bbf7d0;font-size:.82rem;padding:.55rem 1.25rem;font-weight:800">Grant Admin</button>
          <button onclick="grantAdminRole('owner')" class="btn" style="background:#fef3c7;color:#92400e;border:1px solid #fcd34d;font-size:.82rem;padding:.55rem 1.25rem;font-weight:800">Grant Owner</button>
        </div>
      </div>

      <!-- Access Code -->
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:1.25rem;padding:1.5rem;margin-bottom:1.5rem">
        <h3 style="font-weight:900;font-size:.875rem;color:#0f172a;text-transform:uppercase;letter-spacing:.07em;margin-bottom:1rem">🔒 Admin/Owner Access Code</h3>
        <div style="display:grid;gap:.65rem;grid-template-columns:1fr 1fr">
          <input id="setting-code-new" type="password" class="input-field" placeholder="New access code" autocomplete="off" style="font-weight:800;text-align:center">
          <input id="setting-code-conf" type="password" class="input-field" placeholder="Confirm code" autocomplete="off" style="font-weight:800;text-align:center">
        </div>
        <button onclick="saveAdminAccessCode()" class="btn btn-primary" style="margin-top:.75rem;font-size:.82rem;padding:.55rem 1.2rem;font-weight:800">Save Access Code</button>
        <p style="font-size:.75rem;color:#64748b;margin-top:.5rem">Owners can rotate the code anytime. The hash is stored in Firebase settings; no code is embedded in the page.</p>
      </div>

      <!-- Lab Settings -->
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:1.25rem;padding:1.5rem;margin-bottom:1.5rem">
        <h3 style="font-weight:900;font-size:.875rem;color:#0f172a;text-transform:uppercase;letter-spacing:.07em;margin-bottom:1rem">🧪 Lab Credits & Tiers</h3>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;align-items:end">
          <div>
            <label style="font-size:.8rem;font-weight:800;color:#475569">Base credits per scenario</label>
            <input id="setting-lab-base" type="number" class="input-field" value="${labSettings.labBaseLC}" min="0" style="font-weight:800;text-align:center">
          </div>
          <div>
            <label style="font-size:.8rem;font-weight:800;color:#475569">Weekly bonus (top 5)</label>
            <input id="setting-weekly-bonus" type="number" class="input-field" value="${labSettings.weeklyBonusLC}" min="0" style="font-weight:800;text-align:center">
          </div>
        </div>
        <div style="margin-top:1rem">
          <label style="font-size:.8rem;font-weight:800;color:#475569">Redemption tiers (comma-separated)</label>
          <input id="setting-tiers" class="input-field" value="${(labSettings.redemptionTiers||[]).join(', ')}" style="font-weight:800">
        </div>
        <div style="margin-top:1rem;display:grid;grid-template-columns:repeat(4,1fr);gap:.6rem">
          <div style="font-size:.78rem;font-weight:800;color:#15803d;background:#ecfdf3;border:1px solid #bbf7d0;border-radius:.75rem;padding:.5rem">A Bonus: <input id="setting-bonus-a" type="number" value="${(labSettings.labScoreBonus||{}).A||50}" style="width:80px;text-align:center;font-weight:800"></div>
          <div style="font-size:.78rem;font-weight:800;color:#2563eb;background:#eff6ff;border:1px solid #bfdbfe;border-radius:.75rem;padding:.5rem">B Bonus: <input id="setting-bonus-b" type="number" value="${(labSettings.labScoreBonus||{}).B||30}" style="width:80px;text-align:center;font-weight:800"></div>
          <div style="font-size:.78rem;font-weight:800;color:#f59e0b;background:#fff7ed;border:1px solid #fed7aa;border-radius:.75rem;padding:.5rem">C Bonus: <input id="setting-bonus-c" type="number" value="${(labSettings.labScoreBonus||{}).C||15}" style="width:80px;text-align:center;font-weight:800"></div>
          <div style="font-size:.78rem;font-weight:800;color:#dc2626;background:#fef2f2;border:1px solid #fecaca;border-radius:.75rem;padding:.5rem">D Bonus: <input id="setting-bonus-d" type="number" value="${(labSettings.labScoreBonus||{}).D||5}" style="width:80px;text-align:center;font-weight:800"></div>
        </div>
        <button onclick="saveLabSettings()" class="btn btn-primary" style="margin-top:1rem;font-size:.82rem;padding:.55rem 1.2rem;font-weight:800">Save Lab Settings</button>
      </div>

      <!-- HR Integrations -->
      <div style="background:linear-gradient(135deg,#f0f9ff,#eff6ff);border:2px solid #bfdbfe;border-radius:1.25rem;padding:1.5rem;margin-bottom:1.5rem">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:.5rem">
          <h3 style="font-weight:900;font-size:.875rem;color:#1e3a8a;text-transform:uppercase;letter-spacing:.07em;margin:0">🔗 HR System Integrations</h3>
          <div style="display:flex;flex-wrap:wrap;gap:.4rem">
            ${['ADP','Paycom','Paycor','Workday','BambooHR','UKG','Cornerstone','SAP SF'].map(p=>`<span style="background:white;border:1px solid #bfdbfe;border-radius:999px;padding:.15rem .55rem;font-size:.65rem;font-weight:800;color:#1d4ed8">${p}</span>`).join('')}
          </div>
        </div>
        <p style="font-size:.78rem;color:#3b82f6;margin:0 0 1.25rem;font-weight:700">Connect via outbound webhooks → Zapier/Make → any HR platform, xAPI for LMS/LRS, or let HR systems pull completion data via REST API.</p>

        <!-- Outbound Webhook -->
        <div style="background:white;border:1px solid #e2e8f0;border-radius:1rem;padding:1.1rem;margin-bottom:1rem">
          <h4 style="font-weight:900;font-size:.82rem;color:#0f172a;margin:0 0 .35rem">📡 Outbound Webhook <span style="font-weight:600;font-size:.72rem;color:#64748b">— fires to Zapier, Make.com, or your HR endpoint on training events</span></h4>
          <div style="display:grid;gap:.6rem;margin-bottom:.75rem">
            <input id="setting-webhook-url" class="input-field" style="font-size:.82rem" placeholder="https://hooks.zapier.com/hooks/catch/…  or  https://your-hr-api.com/training-webhook" value="${settings?.webhookUrl||''}">
            <input id="setting-webhook-secret" class="input-field" type="password" style="font-size:.82rem" placeholder="Signing secret (optional — HMAC-SHA256 sent as X-DSH-Signature header)" value="${settings?.webhookSecret||''}">
          </div>
          <div style="margin-bottom:.75rem">
            <div style="font-size:.72rem;font-weight:800;color:#475569;margin-bottom:.4rem">Fire on events:</div>
            <div style="display:flex;flex-wrap:wrap;gap:.5rem">
              ${['training_completed','cert_downloaded','lab_completed','user_created'].map(ev=>{
                const on = (settings?.webhookEvents||['training_completed','cert_downloaded','lab_completed']).includes(ev);
                return `<label style="display:flex;align-items:center;gap:.3rem;font-size:.78rem;font-weight:700;color:#374151;cursor:pointer"><input type="checkbox" id="wh-ev-${ev}" ${on?'checked':''} style="accent-color:#2563eb"> ${ev}</label>`;
              }).join('')}
            </div>
          </div>
          <div style="display:flex;gap:.6rem;flex-wrap:wrap">
            <button onclick="saveIntegrationSettings()" class="btn btn-primary" style="font-size:.78rem;padding:.45rem 1rem">Save Webhook</button>
            <button onclick="testWebhook()" style="border:1px solid #bfdbfe;background:#eff6ff;color:#1d4ed8;border-radius:.65rem;padding:.45rem 1rem;font-size:.78rem;font-weight:800;cursor:pointer">🧪 Send Test Ping</button>
          </div>
        </div>

        <!-- xAPI / Tin Can -->
        <div style="background:white;border:1px solid #e2e8f0;border-radius:1rem;padding:1.1rem;margin-bottom:1rem">
          <h4 style="font-weight:900;font-size:.82rem;color:#0f172a;margin:0 0 .35rem">📊 xAPI / Tin Can LRS <span style="font-weight:600;font-size:.72rem;color:#64748b">— Cornerstone, Workday Learning, SAP SuccessFactors, UKG, SCORM Cloud</span></h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom:.75rem">
            <input id="setting-xapi-endpoint" class="input-field" style="font-size:.82rem;grid-column:1/-1" placeholder="LRS endpoint  e.g. https://lrs.yourcompany.com/xapi/" value="${settings?.xapiEndpoint||''}">
            <input id="setting-xapi-user" class="input-field" style="font-size:.82rem" placeholder="LRS username / client key" value="${settings?.xapiUsername||''}">
            <input id="setting-xapi-pass" class="input-field" type="password" style="font-size:.82rem" placeholder="LRS password / client secret" value="${settings?.xapiPassword||''}">
            <input id="setting-xapi-activity" class="input-field" style="font-size:.82rem;grid-column:1/-1" placeholder="Activity ID  e.g. https://yourorg.com/training/de-escalation" value="${settings?.xapiActivityId||''}">
          </div>
          <div style="display:flex;gap:.6rem;flex-wrap:wrap">
            <button onclick="saveIntegrationSettings()" class="btn btn-primary" style="font-size:.78rem;padding:.45rem 1rem">Save xAPI</button>
            <button onclick="testXAPI()" style="border:1px solid #bfdbfe;background:#eff6ff;color:#1d4ed8;border-radius:.65rem;padding:.45rem 1rem;font-size:.78rem;font-weight:800;cursor:pointer">🧪 Send Test Statement</button>
          </div>
        </div>

        <!-- REST Pull API -->
        <div style="background:white;border:1px solid #e2e8f0;border-radius:1rem;padding:1.1rem;margin-bottom:1rem">
          <h4 style="font-weight:900;font-size:.82rem;color:#0f172a;margin:0 0 .35rem">🔌 REST Completion API <span style="font-weight:600;font-size:.72rem;color:#64748b">— ADP, Paycom, Paycor, or any system that can make HTTP GET requests</span></h4>
          <p style="font-size:.75rem;color:#64748b;margin:0 0 .65rem">HR systems can poll this endpoint to get completion status for any employee by email.</p>
          <div style="background:#0f172a;border-radius:.75rem;padding:.75rem 1rem;font-family:monospace;font-size:.72rem;color:#4ade80;margin-bottom:.75rem;word-break:break-all">GET /api/hr/completion?orgId=<span style="color:#f9a8d4">${(typeof TENANT_ID!=='undefined'?TENANT_ID:settings?.orgId||'YOUR_ORG_ID')}</span>&amp;email=employee@company.com&amp;apiKey=<span style="color:#fbbf24">${settings?.apiKey ? settings.apiKey.slice(0,8)+'…' : 'YOUR_API_KEY'}</span></div>
          <div style="display:flex;align-items:center;gap:.6rem;flex-wrap:wrap">
            <div style="font-size:.78rem;font-weight:800;color:#0f172a">API Key: </div>
            <code style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:.45rem;padding:.25rem .65rem;font-size:.75rem;color:#0f172a;font-weight:700;letter-spacing:.05em">${settings?.apiKey || '— not generated —'}</code>
            <button onclick="generateApiKey()" style="border:1px solid #bfdbfe;background:#eff6ff;color:#1d4ed8;border-radius:.65rem;padding:.4rem .9rem;font-size:.75rem;font-weight:800;cursor:pointer">🔄 Regenerate</button>
          </div>
          <p style="font-size:.72rem;color:#94a3b8;margin:.65rem 0 0">⚙️ One-time Vercel setup required: add <code style="background:#f1f5f9;padding:.1rem .3rem;border-radius:.25rem">FIREBASE_DB_SECRET</code> and <code style="background:#f1f5f9;padding:.1rem .3rem;border-radius:.25rem">FIREBASE_DB_URL</code> as environment variables in your Vercel project settings.</p>
        </div>

        <!-- CSV Roster Import -->
        <div style="background:white;border:1px solid #e2e8f0;border-radius:1rem;padding:1.1rem">
          <h4 style="font-weight:900;font-size:.82rem;color:#0f172a;margin:0 0 .35rem">📁 CSV Roster Import <span style="font-weight:600;font-size:.72rem;color:#64748b">— bulk-provision accounts from an ADP/Paycom employee export</span></h4>
          <p style="font-size:.75rem;color:#64748b;margin:0 0 .65rem">Required columns: <strong>firstName, lastName, email</strong>. Optional: <em>department, employeeId, dueDate (YYYY-MM-DD)</em>. Accounts will be staged for self-activation via the sign-up flow.</p>
          <div style="display:flex;gap:.6rem;align-items:center;flex-wrap:wrap">
            <label style="display:inline-flex;align-items:center;gap:.5rem;background:#eff6ff;border:1px solid #bfdbfe;border-radius:.65rem;padding:.5rem 1rem;font-size:.8rem;font-weight:800;color:#1d4ed8;cursor:pointer">📂 Choose CSV <input type="file" id="roster-csv-input" accept=".csv,.txt" style="display:none" onchange="importRosterCSV(this)"></label>
            <span style="font-size:.75rem;color:#94a3b8" id="roster-file-name">No file selected</span>
          </div>
          <div id="roster-import-log" style="margin-top:.65rem"></div>
        </div>
      </div>

      <!-- Admin List -->
      <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:1.25rem;padding:1.5rem;margin-bottom:1.5rem">
        <h3 style="font-weight:900;font-size:.875rem;color:#0f172a;text-transform:uppercase;letter-spacing:.07em;margin-bottom:1rem">👤 Current Admins</h3>
        ${adminUIDs.length ? `<div style="overflow-x:auto;border-radius:.875rem;overflow:hidden;border:1px solid #e2e8f0">
          <table style="width:100%;border-collapse:collapse;font-size:.85rem">
            <thead><tr style="background:#f1f5f9">
              <th style="padding:.75rem 1rem;text-align:left;font-weight:900;color:#0f172a">User</th>
              <th style="padding:.75rem 1rem;text-align:left;font-weight:900;color:#0f172a">Role</th>
              <th style="padding:.75rem 1rem;text-align:left;font-weight:900;color:#0f172a">Actions</th>
            </tr></thead>
            <tbody>${adminRows}</tbody>
          </table></div>` : '<p style="color:#94a3b8;font-size:.85rem">No admins assigned yet.</p>'}
      </div>

      <!-- Danger Zone -->
      <div style="background:#fff5f5;border:1px solid #fecaca;border-radius:1.25rem;padding:1.5rem">
        <h3 style="font-weight:900;font-size:.875rem;color:#dc2626;text-transform:uppercase;letter-spacing:.07em;margin-bottom:.5rem">⚠️ Danger Zone</h3>
        <p style="font-size:.8rem;color:#ef4444;margin-bottom:1rem">These actions are irreversible. Proceed with caution.</p>
        <button onclick="confirmResetTraining()" style="background:#fef2f2;color:#dc2626;border:1px solid #fecaca;border-radius:.75rem;padding:.55rem 1.25rem;font-size:.82rem;font-weight:800;cursor:pointer">🔄 Reset All Training Progress for New Year</button>
      </div>`;
  } catch(e) {
    el.innerHTML=`<p style="color:#ef4444;font-size:.875rem">Error: ${e.message}</p>`;
  }
}

async function saveTrainingYear() {
  const val = document.getElementById('setting-year')?.value;
  if(!val) return;
  await window._saveSettings({ trainingYear: parseInt(val) });
  alert(`Training year set to ${val}. New user sessions will reflect this year.`);
}

async function saveAdminAccessCode() {
  if(currentAdminRole!=='owner') { alert('Only owners can change the access code.'); return; }
  const a = document.getElementById('setting-code-new')?.value.trim();
  const b = document.getElementById('setting-code-conf')?.value.trim();
  if(!a||!b){ alert('Enter and confirm the access code.'); return; }
  if(a!==b){ alert('Codes do not match.'); return; }
  const hash = await hashText(a);
  await window._saveSettings({ adminCodeHash: hash });
  adminCodeHash = hash;
  alert('Access code updated. Share the new code with admins/owners securely.');
}

async function saveLabSettings() {
  if(currentAdminRole!=='owner') { alert('Only owners can change lab settings.'); return; }
  const base = parseInt(document.getElementById('setting-lab-base')?.value||'50',10);
  const weekly = parseInt(document.getElementById('setting-weekly-bonus')?.value||'200',10);
  const tiersStr = document.getElementById('setting-tiers')?.value||'';
  const bonusA = parseInt(document.getElementById('setting-bonus-a')?.value||'50',10);
  const bonusB = parseInt(document.getElementById('setting-bonus-b')?.value||'30',10);
  const bonusC = parseInt(document.getElementById('setting-bonus-c')?.value||'15',10);
  const bonusD = parseInt(document.getElementById('setting-bonus-d')?.value||'5',10);
  const tiers = tiersStr.split(',').map(t=>parseInt(t.trim(),10)).filter(n=>!isNaN(n)).sort((a,b)=>a-b);
  const payload = {
    labBaseLC: base,
    weeklyBonusLC: weekly,
    redemptionTiers: tiers,
    labScoreBonus: {A:bonusA,B:bonusB,C:bonusC,D:bonusD}
  };
  await window._saveSettings(payload);
  labSettings = Object.assign({}, labSettings, payload);
  alert('Lab settings saved.');
}

async function grantAdminRole(role) {
  const uid = document.getElementById('grant-admin-uid')?.value;
  if(!uid) return;
  if(!confirm(role==='owner'?'Grant OWNER access to this user?':'Grant ADMIN access to this user?')) return;
  await window._setAdminRole(uid, role);
  loadSettings();
}

async function revokeAdmin(uid, name) {
  if(!confirm(`Revoke admin access for ${name}?`)) return;
  await window._setAdminRole(uid, null);
  loadSettings();
}

function confirmResetTraining() {
  if(!confirm("⚠️ This will reset all users' slide progress to 0 for the new training year. This CANNOT be undone. Are you absolutely sure?")) return;
  if(!confirm('Final confirmation: Reset all training progress?')) return;
  resetAllTraining();
}

async function resetAllTraining() {
  await window._resetAllProgress();
  alert('All training progress has been reset for the new year.');
  loadSettings();
}

// ─── Integration Settings ────────────────────────────────
async function saveIntegrationSettings() {
  if(currentAdminRole!=='owner') { alert('Only owners can change integration settings.'); return; }
  const webhookUrl    = document.getElementById('setting-webhook-url')?.value.trim() || '';
  const webhookSecret = document.getElementById('setting-webhook-secret')?.value.trim() || '';
  const xapiEndpoint  = document.getElementById('setting-xapi-endpoint')?.value.trim() || '';
  const xapiUsername  = document.getElementById('setting-xapi-user')?.value.trim() || '';
  const xapiPassword  = document.getElementById('setting-xapi-pass')?.value.trim() || '';
  const xapiActivityId= document.getElementById('setting-xapi-activity')?.value.trim() || '';
  const webhookEvents = ['training_completed','cert_downloaded','lab_completed','user_created']
    .filter(ev => document.getElementById(`wh-ev-${ev}`)?.checked);
  const payload = { webhookUrl, webhookSecret, xapiEndpoint, xapiUsername, xapiPassword, xapiActivityId, webhookEvents };
  await window._saveSettings(payload);
  Object.assign(window._settingsCache||{}, payload);
  alert('Integration settings saved.');
}

async function generateApiKey() {
  if(currentAdminRole!=='owner') { alert('Only owners can regenerate the API key.'); return; }
  if(!confirm('Regenerate the REST API key? Any systems currently using the old key will need to be updated.')) return;
  const arr = new Uint8Array(24);
  crypto.getRandomValues(arr);
  const key = Array.from(arr).map(b=>b.toString(16).padStart(2,'0')).join('');
  await window._saveSettings({ apiKey: key });
  if(window._settingsCache) window._settingsCache.apiKey = key;
  alert(`New API key: ${key}\n\nCopy this now — it is shown once in plain text and then stored in Firebase.`);
  loadSettings();
}

async function testWebhook() {
  const url = document.getElementById('setting-webhook-url')?.value.trim();
  if(!url) { alert('Enter a webhook URL first.'); return; }
  const user = window._currentUser;
  const payload = {
    event:'test_ping',
    timestamp: new Date().toISOString(),
    orgId: window.TENANT?.orgId||'test',
    orgName: window.TENANT?.orgName||'DSH Training',
    message:'This is a test ping from DSH Training Platform.',
    user: { email: user?.email||'admin@test.com', name: user?.displayName||'Admin' }
  };
  try {
    const secret = document.getElementById('setting-webhook-secret')?.value.trim()||'';
    const body = JSON.stringify(payload);
    const res = await fetch('/api/webhook-proxy', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ url, event:'test_ping', secret, body })
    });
    const data = await res.json();
    alert(data.ok ? `✅ Webhook delivered! HTTP ${data.status}` : `⚠️ Webhook sent but destination returned an error: ${data.error||data.status}`);
  } catch(e) { alert(`❌ Failed to send webhook: ${e.message}`); }
}

async function testXAPI() {
  const endpoint = document.getElementById('setting-xapi-endpoint')?.value.trim();
  if(!endpoint) { alert('Enter an LRS endpoint URL first.'); return; }
  const tmpSettings = {
    xapiEndpoint: endpoint,
    xapiUsername: document.getElementById('setting-xapi-user')?.value.trim()||'',
    xapiPassword: document.getElementById('setting-xapi-pass')?.value.trim()||'',
    xapiActivityId: document.getElementById('setting-xapi-activity')?.value.trim()||''
  };
  const orig = window._settingsCache;
  window._settingsCache = Object.assign({}, orig||{}, tmpSettings);
  await window._emitXAPI('attempted', { completion: false });
  window._settingsCache = orig;
  alert('✅ xAPI statement sent. Check your LRS dashboard to confirm receipt.');
}

async function importRosterCSV(input) {
  const file = input?.files?.[0];
  if(!file) return;
  document.getElementById('roster-file-name').textContent = file.name;
  const text = await file.text();
  const lines = text.trim().split(/\r?\n/);
  if(lines.length < 2) { alert('CSV must have a header row and at least one data row.'); return; }

  // Parse header
  const headers = lines[0].split(',').map(h=>h.trim().toLowerCase().replace(/[^a-z]/g,''));
  const get = (row, ...keys) => { for(const k of keys) { const i = headers.indexOf(k); if(i>=0) return (row[i]||'').trim(); } return ''; };

  const log = document.getElementById('roster-import-log');
  log.innerHTML = '<p style="font-size:.78rem;color:#64748b">Processing…</p>';

  let created=0, skipped=0, errors=0;
  const results = [];
  const existingUsers = await window._loadAllUsers().catch(()=>({}));

  for(let i=1;i<lines.length;i++) {
    const row = lines[i].split(',').map(c=>c.trim().replace(/^"|"$/g,''));
    const email     = get(row,'email').toLowerCase();
    const firstName = get(row,'firstname','first_name','first');
    const lastName  = get(row,'lastname','last_name','last');
    if(!email||!firstName||!lastName) { skipped++; results.push(`<span style="color:#f59e0b">⚠️ Row ${i+1}: missing required fields (email, firstName, lastName)</span>`); continue; }

    // Check if already exists
    const exists = Object.values(existingUsers||{}).some(u=>(u.email||'').toLowerCase()===email);
    if(exists) { skipped++; results.push(`<span style="color:#94a3b8">— ${email}: already has an account</span>`); continue; }

    // Stage invite record in Firebase
    try {
      const dept    = get(row,'department','dept','division');
      const empId   = get(row,'employeeid','employee_id','employeenumber','id','empid');
      const dueStr  = get(row,'duedate','due_date','due','deadline');
      const dueTs   = dueStr ? new Date(dueStr).getTime() : null;
      await update(_ref('invites/' + btoa(email).replace(/=/g,'')), {
        email, firstName, lastName,
        ...(dept  ? { department: dept } : {}),
        ...(empId ? { employeeId: empId } : {}),
        ...(dueTs && !isNaN(dueTs) ? { dueDate: dueTs } : {}),
        createdAt: Date.now(), source:'csv_import'
      });
      created++;
      results.push(`<span style="color:#16a34a">✅ ${firstName} ${lastName} (${email}) — staged</span>`);
    } catch(e) { errors++; results.push(`<span style="color:#dc2626">❌ ${email}: ${e.message}</span>`); }
  }

  log.innerHTML = `
    <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:.75rem;padding:.85rem;margin-top:.5rem">
      <div style="font-size:.8rem;font-weight:900;color:#0f172a;margin-bottom:.4rem">Import complete: <span style="color:#16a34a">${created} staged</span> · <span style="color:#f59e0b">${skipped} skipped</span>${errors?` · <span style="color:#dc2626">${errors} errors</span>`:''}</div>
      <div style="font-size:.75rem;color:#475569;margin-bottom:.5rem">Staged users will see their pre-filled profile when they sign up with the matching email.</div>
      <div style="max-height:160px;overflow-y:auto;font-size:.72rem;line-height:1.7;font-family:monospace">${results.join('<br>')}</div>
    </div>`;
  input.value = '';
}
// ─── Audit Log ──────────────────────────────────────────
async function loadAudit() {
  if(currentAdminRole !== 'owner') return;
  const el = document.getElementById('at-audit');
  if(!el) return;
  el.innerHTML = `<div class="flex items-center justify-between mb-4">
    <h3 style="font-size:1.1rem;font-weight:900;color:#0f172a">🔍 Audit Log</h3>
    <button onclick="exportAuditCSV()" style="background:#0f172a;color:#fff;font-size:.75rem;font-weight:700;padding:.45rem .9rem;border-radius:.5rem;border:none;cursor:pointer">⬇ Export CSV</button>
  </div>
  <div id="audit-table-wrap"><div style="color:#64748b;font-size:.85rem;padding:2rem;text-align:center">Loading audit events…</div></div>`;
  try {
    const snap = await get(_ref('audit'));
    const raw = snap.val() || {};
    const rows = Object.entries(raw)
      .map(([k,v]) => ({...v, _key: k}))
      .sort((a,b) => b.ts - a.ts)
      .slice(0, 300);
    window._auditRows = rows;
    const COLOR = {
      login:           'background:#dbeafe;color:#1d4ed8',
      logout:          'background:#f1f5f9;color:#475569',
      cert_downloaded: 'background:#fef9c3;color:#92400e',
      lab_completed:   'background:#dcfce7;color:#166534',
      drill_completed: 'background:#fef3c7;color:#92400e',
      admin_access:    'background:#f3e8ff;color:#6b21a8',
    };
    if(!rows.length) {
      document.getElementById('audit-table-wrap').innerHTML =
        '<div style="color:#64748b;font-size:.85rem;padding:2rem;text-align:center">No audit events recorded yet.</div>';
      return;
    }
    const tbl = `<div style="overflow-x:auto">
      <table style="width:100%;border-collapse:collapse;font-size:.77rem">
        <thead><tr style="background:#f8fafc;border-bottom:2px solid #e2e8f0">
          <th style="text-align:left;padding:.55rem .75rem;font-weight:800;color:#475569">Time</th>
          <th style="text-align:left;padding:.55rem .75rem;font-weight:800;color:#475569">User</th>
          <th style="text-align:left;padding:.55rem .75rem;font-weight:800;color:#475569">Action</th>
          <th style="text-align:left;padding:.55rem .75rem;font-weight:800;color:#475569">Details</th>
        </tr></thead>
        <tbody>${rows.map(r=>{
          const dt = new Date(r.ts).toLocaleString();
          const badge = COLOR[r.action] || 'background:#e2e8f0;color:#334155';
          const det = Object.entries(r)
            .filter(([k])=>!['ts','iso','uid','email','displayName','action','ua','_key'].includes(k))
            .map(([k,v])=>`${k}: ${v}`).join(' · ');
          return `<tr style="border-bottom:1px solid #f1f5f9;transition:background .15s" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background=''">
            <td style="padding:.5rem .75rem;color:#64748b;white-space:nowrap">${dt}</td>
            <td style="padding:.5rem .75rem"><div style="font-weight:700;color:#0f172a">${r.displayName||''}</div><div style="color:#64748b">${r.email||''}</div></td>
            <td style="padding:.5rem .75rem"><span style="${badge};padding:.2rem .55rem;border-radius:.4rem;font-weight:800;font-size:.72rem">${r.action}</span></td>
            <td style="padding:.5rem .75rem;color:#475569">${det}</td>
          </tr>`;
        }).join('')}</tbody>
      </table></div>`;
    document.getElementById('audit-table-wrap').innerHTML = tbl;
  } catch(e) {
    document.getElementById('audit-table-wrap').innerHTML =
      `<div style="color:#dc2626;font-size:.85rem;padding:2rem;text-align:center">Error loading audit log: ${e.message}</div>`;
  }
}
function exportAuditCSV() {
  const rows = window._auditRows || [];
  if(!rows.length) { alert('No audit data to export.'); return; }
  const headers = ['timestamp','email','displayName','action','uid','details'];
  const lines = rows.map(r => {
    const det = Object.entries(r)
      .filter(([k])=>!['ts','iso','uid','email','displayName','action','ua','_key'].includes(k))
      .map(([k,v])=>`${k}=${v}`).join('; ');
    return [
      new Date(r.ts).toISOString(),
      r.email||'',
      r.displayName||'',
      r.action||'',
      r.uid||'',
      det
    ].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
  });
  const csv = [headers.join(','), ...lines].join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
  a.download = `audit_log_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

// ─── Daily Drill ─────────────────────────────────────────
function refreshDrillStreak() {
  const streak = window._userData?.drillStreak || 0;
  drillStreak = streak;
  const badge = document.getElementById('hub-streak-badge');
  if (!badge) return;
  if (streak > 0) {
    badge.style.display = 'block';
    badge.textContent = '🔥 ' + streak;
  } else {
    badge.style.display = 'none';
  }
}

function openDrillModal() {
  const modal = document.getElementById('drill-modal');
  if (!modal) return;
  modal.style.display = 'flex';

  const ud = window._userData || {};
  const today = new Date().toISOString().slice(0, 10);
  const alreadyDone = ud.lastDrillDate === today;

  const sd = document.getElementById('drill-streak-display');
  if (sd) {
    const s = ud.drillStreak || 0;
    sd.textContent = s > 0 ? `🔥 ${s}-day streak` : '🔥 Start your streak!';
  }

  if (alreadyDone) {
    document.getElementById('drill-done-today').style.display = 'block';
    document.getElementById('drill-steps-wrap').style.display = 'none';
    const dds = document.getElementById('drill-done-streak');
    if (dds) dds.textContent = `🔥 ${ud.drillStreak || 1}-day streak`;
  } else {
    document.getElementById('drill-done-today').style.display = 'none';
    document.getElementById('drill-steps-wrap').style.display = 'block';
    document.getElementById('drill-step-1').style.display = 'block';
    document.getElementById('drill-step-2').style.display = 'none';
    document.getElementById('drill-score-panel').style.display = 'none';
    const sb = document.getElementById('drill-submit-btn');
    if (sb) { sb.disabled = false; sb.textContent = 'Submit Response'; sb.style.display = ''; }
    const fb = document.getElementById('drill-finish-btn');
    if (fb) fb.style.display = 'none';
    document.getElementById('drill-response').value = '';
    drillFlipped = false;
    drillXPEarned = false;
    loadDrillCard();
  }
}

function closeDrillModal() {
  const modal = document.getElementById('drill-modal');
  if (modal) modal.style.display = 'none';
}

function loadDrillCard() {
  const card = SKILL_CARDS[Math.floor(Math.random() * SKILL_CARDS.length)];
  drillCurrentCard = card;
  drillFlipped = false;
  const inner = document.getElementById('drill-flip-inner');
  if (inner) inner.style.transform = 'rotateY(0deg)';
  document.getElementById('drill-card-category').textContent = card.category;
  document.getElementById('drill-card-title').textContent    = card.title;
  document.getElementById('drill-card-front').textContent    = card.front;
  document.getElementById('drill-card-back').textContent     = card.back;
  document.getElementById('drill-card-prompt').textContent   = card.prompt;
}

function flipDrillCard() {
  drillFlipped = !drillFlipped;
  const inner = document.getElementById('drill-flip-inner');
  if (inner) inner.style.transform = drillFlipped ? 'rotateY(180deg)' : 'rotateY(0deg)';
}

function advanceDrillToStep2() {
  document.getElementById('drill-step-1').style.display = 'none';
  document.getElementById('drill-step-2').style.display = 'block';
  loadDrillScenario();
}

function loadDrillScenario() {
  const dxKeys = Object.keys(scenarios || {});
  if (!dxKeys.length) { document.getElementById('drill-scenario-box').textContent = 'Loading scenarios…'; return; }
  const dx = dxKeys[Math.floor(Math.random() * dxKeys.length)];
  const pool = scenarios[dx] || [];
  const scen = pool[Math.floor(Math.random() * pool.length)] || 'A patient is becoming increasingly agitated in the common room and is not responding to verbal prompts.';
  drillCurrentScenario = scen;
  document.getElementById('drill-scenario-box').textContent = scen;
}

function rerollDrillScenario() {
  loadDrillScenario();
  document.getElementById('drill-score-panel').style.display = 'none';
  document.getElementById('drill-response').value = '';
  const sb = document.getElementById('drill-submit-btn');
  if (sb) { sb.disabled = false; sb.textContent = 'Submit Response'; sb.style.display = ''; }
  const fb = document.getElementById('drill-finish-btn');
  if (fb) fb.style.display = 'none';
}

async function submitDrill() {
  const resp = (document.getElementById('drill-response')?.value || '').trim();
  if (resp.length < 20) { alert('Please write a more detailed response (at least 20 characters).'); return; }

  const btn = document.getElementById('drill-submit-btn');
  if (btn) { btn.disabled = true; btn.textContent = 'Scoring…'; }

  const words = resp.toLowerCase();
  const keyTerms = ['safe','calm','choice','validate','empathize','listen','space','support','trigger','reduce','grounding','breathe','acknowledge','help','understand','trauma','feelings','option'];
  const matched = keyTerms.filter(t => words.includes(t)).length;
  let grade, feedbackText;
  if (matched >= 5 || resp.length > 200)     { grade = 'A'; feedbackText = 'Outstanding. You demonstrated validation, space creation, and patient-centered language. That\'s textbook de-escalation.'; }
  else if (matched >= 3 || resp.length > 100) { grade = 'B'; feedbackText = 'Solid response. You used key de-escalation language. Push further into explicit validation and structuring a choice for the patient.'; }
  else if (matched >= 2 || resp.length > 50)  { grade = 'C'; feedbackText = 'Developing. Your response was safe but lacked depth. Try explicitly naming the patient\'s emotion and offering a forced choice.'; }
  else                                         { grade = 'D'; feedbackText = 'Needs work. Response was too brief or directive. Remember: validate before you redirect. Review today\'s skill card and try again.'; }

  const ud = window._userData || {};
  const today = new Date().toISOString().slice(0, 10);
  let finalXP = 0;
  let streakBonus = 0;
  let newStreak = ud.drillStreak || 0;

  if (!drillXPEarned) {
    drillXPEarned = true;
    const baseXP = grade === 'A' ? 300 : grade === 'B' ? 200 : grade === 'C' ? 120 : 60;
    const lastDate = ud.lastDrillDate || '';
    const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
    if (lastDate === yesterday) {
      newStreak = (ud.drillStreak || 0) + 1;
    } else if (lastDate !== today) {
      newStreak = 1; // gap in streak — reset
    }

    // Streak XP multipliers: 3-day +25%, 7-day +50%, 14-day +75%, 30-day +100%
    const mult = newStreak >= 30 ? 2.0 : newStreak >= 14 ? 1.75 : newStreak >= 7 ? 1.5 : newStreak >= 3 ? 1.25 : 1.0;
    finalXP = Math.round(baseXP * mult);
    streakBonus = finalXP - baseXP;
    drillStreak = newStreak;

    await window._saveUserData({
      lastDrillDate: today,
      drillStreak: newStreak,
      totalDrillsCompleted: (ud.totalDrillsCompleted || 0) + 1
    }).catch(() => {});
    window._userData = Object.assign({}, ud, { lastDrillDate: today, drillStreak: newStreak });

    awardXP(finalXP);
    refreshDrillStreak();
    const sd = document.getElementById('drill-streak-display');
    if (sd) sd.textContent = `🔥 ${newStreak}-day streak`;
  }

  document.getElementById('drill-score-panel').style.display = 'block';
  document.getElementById('drill-grade').textContent = grade;
  document.getElementById('drill-feedback').textContent = feedbackText;

  const xpBadge = document.getElementById('drill-xp-badge');
  if (xpBadge) {
    xpBadge.textContent = finalXP > 0 ? `+${finalXP} XP earned` : 'Practice only (XP already earned today)';
    xpBadge.style.color = finalXP > 0 ? '#16a34a' : '#94a3b8';
  }

  const vsb = document.getElementById('drill-streak-bonus');
  if (vsb) {
    if (streakBonus > 0) { vsb.style.display = 'block'; vsb.textContent = `🔥 ${drillStreak}-day streak bonus: +${streakBonus} extra XP`; }
    else vsb.style.display = 'none';
  }

  if (btn) { btn.style.display = 'none'; }
  const fb = document.getElementById('drill-finish-btn');
  if (fb) fb.style.display = '';

  if (finalXP > 0) showXPToast(finalXP, `Daily Drill 🔥${drillStreak > 1 ? '×' + drillStreak : ''}`);

  window._fireWebhook && window._fireWebhook('drill_completed', {
    email: window._currentUser?.email,
    grade, xpEarned: finalXP, streak: drillStreak, timestamp: new Date().toISOString()
  }).catch(() => {});
  window._writeAudit('drill_completed', { grade, xpEarned: finalXP, streak: drillStreak }).catch(() => {});
  window._checkAchievements && window._checkAchievements({ drillStreak, totalDrillsCompleted: window._userData?.totalDrillsCompleted||0 }).catch(()=>{});
}

function startBoxBreathing() {
  if(breathInterval) clearInterval(breathInterval);
  const phases=[{text:'Inhale',dur:4},{text:'Hold',dur:4},{text:'Exhale',dur:4},{text:'Hold',dur:4}];
  let pi=0, countdown=phases[0].dur;
  const phaseEl = document.getElementById('box-phase');
  const countEl = document.getElementById('box-count');
  const anim    = document.getElementById('box-breath-anim');
  const colors  = ['#3b82f6','#8b5cf6','#06b6d4','#10b981'];
  function update(){
    if(phaseEl) phaseEl.textContent=phases[pi].text;
    if(countEl) countEl.textContent=countdown;
    if(anim){ anim.style.background=colors[pi]; anim.style.transform=pi===0?'scale(1.3)':pi===2?'scale(0.7)':'scale(1)'; }
    countdown--;
    if(countdown<0){ pi=(pi+1)%4; countdown=phases[pi].dur; }
  }
  update();
  breathInterval=setInterval(update,1000);
  awardXP(25);
}

// ─── Lab Room Helpers ───────────────────────────────────
function openLabRoom() {
  document.getElementById('lab-modal').style.display='flex';
  document.getElementById('lab-modal-credits').textContent = labCredits.toLocaleString();
  document.getElementById('lab-score-panel').style.display='none';
  document.getElementById('lab-feedback').textContent='';
  document.getElementById('lab-cooldown').style.display='none';
  document.getElementById('lab-response').value='';
  const mrw = document.getElementById('marcus-reply-wrap');
  if(mrw) mrw.style.display='none';
  // Sync patient UI (name/avatar/badge/selector)
  _setPatientAvatarEl('lab-patient-avatar-wrap', 'lab-patient-avatar-img', activePatient);
  _setPatientAvatarEl('reply-patient-avatar-wrap', 'reply-patient-avatar-img', activePatient);
  const nameEl = document.getElementById('lab-patient-name');
  if (nameEl) nameEl.innerHTML = `${activePatient.name} <span style="font-size:.75rem;font-weight:600;color:#94a3b8">\u2014 ${activePatient.dx}, ${activePatient.bio}</span>`;
  const rl = document.getElementById('reply-patient-label');
  if (rl) rl.textContent = `${activePatient.name} responds`;
  renderPatientSelector();
  updateMarcusStateBadge();
}
function closeLabRoom() {
  document.getElementById('lab-modal').style.display='none';
  cancelVance();
}

function openVideoModal() {
  const modal = document.getElementById('video-modal');
  if(modal) modal.style.display='flex';
}
function closeVideoModal() {
  const modal = document.getElementById('video-modal');
  if(modal) modal.style.display='none';
}

// ─── Lab Room Tabs ───────────────────────────────────────
function updateMarcusStateBadge() {
  const badge = document.getElementById('marcus-state-badge');
  if(!badge) return;
  const map = {
    Neutral:  { bg:'#dcfce7', color:'#166534', border:'#bbf7d0', dot:'&#x26AB;' },
    Frustrated:{ bg:'#fef9c3', color:'#854d0e', border:'#fde68a', dot:'&#x1F7E1;' },
    Rage:     { bg:'#fee2e2', color:'#991b1b', border:'#fca5a5', dot:'&#x1F534;' }
  };
  const s = map[marcusState] || map.Neutral;
  badge.style.background = s.bg;
  badge.style.color = s.color;
  badge.style.borderColor = s.border;
  badge.innerHTML = s.dot + ' ' + marcusState;
}

// ─── Patient selector helpers ─────────────────────────────
function _setPatientAvatarEl(wrapId, imgId, patient) {
  const wrap = document.getElementById(wrapId);
  const img  = document.getElementById(imgId);
  if (!wrap) return;
  // Remove old initials span if any
  const old = wrap.querySelector('.pat-initials');
  if (old) old.remove();
  if (patient.avatar) {
    wrap.style.background = 'transparent';
    if (img) { img.style.display = 'block'; img.src = patient.avatar; }
  } else {
    wrap.style.background = patient.color;
    if (img) img.style.display = 'none';
    const t = document.createElement('span');
    t.className = 'pat-initials';
    t.style.cssText = 'pointer-events:none;font-size:.68rem;font-weight:900;color:white';
    t.textContent = patient.initials;
    wrap.appendChild(t);
  }
  wrap.style.borderColor = patient.color;
}

function renderPatientSelector() {
  const sel = document.getElementById('patient-selector');
  if (!sel) return;
  sel.innerHTML = LAB_PATIENTS.map(p => {
    const isActive = p.id === activePatient.id;
    const avatarHtml = p.avatar
      ? `<img src="${p.avatar}" style="width:24px;height:24px;border-radius:50%;object-fit:cover;object-position:top;border:2px solid ${isActive?'white':p.color};flex-shrink:0" alt="">`
      : `<div style="width:24px;height:24px;border-radius:50%;background:${p.color};display:flex;align-items:center;justify-content:center;font-weight:900;font-size:.58rem;color:white;flex-shrink:0;border:2px solid ${isActive?'white':'transparent'}">${p.initials}</div>`;
    return `<button onclick="selectLabPatient('${p.id}')" style="display:flex;align-items:center;gap:.45rem;padding:.3rem .65rem .3rem .38rem;border-radius:2rem;border:2px solid ${isActive?p.color:'#e2e8f0'};background:${isActive?p.color+'22':'white'};cursor:pointer;font-size:.77rem;font-weight:${isActive?'900':'700'};color:${isActive?p.color:'#475569'};transition:all .15s;white-space:nowrap">${avatarHtml}<span>${p.name}</span><span style="font-size:.64rem;color:${isActive?p.color:'#94a3b8'};font-weight:600;display:none" class="pat-sel-dx">${p.dx}</span></button>`;
  }).join('');
}

function selectLabPatient(id) {
  const p = LAB_PATIENTS.find(x => x.id === id);
  if (!p) return;
  activePatient = p;
  marcusState = 'Neutral';

  // Status bar — name/bio
  const nameEl = document.getElementById('lab-patient-name');
  if (nameEl) nameEl.innerHTML = `${p.name} <span style="font-size:.75rem;font-weight:600;color:#94a3b8">\u2014 ${p.dx}, ${p.bio}</span>`;

  // Avatars
  _setPatientAvatarEl('lab-patient-avatar-wrap',  'lab-patient-avatar-img',  p);
  _setPatientAvatarEl('reply-patient-avatar-wrap', 'reply-patient-avatar-img', p);

  // Reply label
  const label = document.getElementById('reply-patient-label');
  if (label) label.textContent = `${p.name} responds`;

  // Auto-set dx dropdown
  const dxSel = document.getElementById('lab-dx');
  if (dxSel) dxSel.value = p.dxKey;

  // Reset scenario UI
  const scenBox = document.getElementById('lab-scenario-box');
  if (scenBox) scenBox.textContent = `Patient loaded: ${p.name} (${p.dx}). Click \u{1F3B2} New Scenario to begin.`;
  const respEl = document.getElementById('lab-response');
  if (respEl) respEl.value = '';
  const panel = document.getElementById('lab-score-panel');
  if (panel) panel.style.display = 'none';
  const mrw = document.getElementById('marcus-reply-wrap');
  if (mrw) mrw.style.display = 'none';

  renderPatientSelector();
  updateMarcusStateBadge();
}

function switchLabTab(tab) {
  cancelVance();  // stop any Vance speech from the previous tab
  ['scenarios','debrief','script','microexp'].forEach(t => {
    const pane = document.getElementById('lab-tab-'+t);
    const btn  = document.getElementById('lab-tab-btn-'+t);
    if(pane) pane.style.display = t === tab ? 'block' : 'none';
    if(btn) {
      btn.style.borderBottomColor = t === tab ? '#2563eb' : 'transparent';
      btn.style.color = t === tab ? '#2563eb' : '#64748b';
    }
  });
  if(tab === 'microexp') updateMarcusStateBadge();
}

async function runDebrief() {
  const btn = document.getElementById('debrief-btn');
  const input = document.getElementById('debrief-input');
  const output = document.getElementById('debrief-output');
  const text = (input?.value||'').trim();
  if(!text) { alert('Describe an incident first.'); return; }
  if(btn) { btn.disabled=true; btn.textContent='Analyzing…'; }
  if(output) output.innerHTML = '<span style="opacity:.6">Dr. Rivera is reviewing your incident…</span>';
  const sys = `You are Dr. Rivera, clinical supervisor at Destiny Springs Healthcare. Review this real incident and provide structured clinical feedback. Format your response using these four sections: WHAT WENT WELL | MISSED OPPORTUNITIES | NEXT TIME TRY | COMPETENCY LEVEL. Be supportive and growth-focused. This is about learning, not judgment. Keep response under 250 words.`;
  try {
    const res = await fetch(CHAT_ENDPOINT, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ system: sys, messages:[{role:'user',content:`Incident Debrief:\n${text}`}] })
    });
    const data = await res.json();
    const reply = (data?.reply || data?.choices?.[0]?.message?.content || 'Unable to retrieve feedback.').trim();
    if(output) output.textContent = reply;
    awardXP(100);
  } catch(e) {
    if(output) output.textContent = 'Connection error. Make sure you have internet access and try again.';
  } finally {
    if(btn) { btn.disabled=false; btn.textContent='Get Clinical Feedback ✨'; }
  }
}

async function buildLabScriptAI() {
  const btn = document.getElementById('script-btn');
  const topicEl = document.getElementById('script-topic');
  const output = document.getElementById('script-output');
  const topic = (topicEl?.value||'').trim() || 'Medication refusal';
  if(btn) { btn.disabled=true; btn.textContent='Building…'; }
  if(output) output.innerHTML = '<span style="opacity:.5">Generating script…</span>';
  const sys = `You are a clinical trainer writing roleplay scripts for psychiatric staff training. Write a 1–2 minute realistic roleplay script between a STAFF MEMBER and a PATIENT in a psychiatric unit. Include: Patient dialogue, Staff dialogue, and [Directions] for body language. Demonstrate de-escalation principles including validation and the Wait-5 Rule. Format clearly with speaker labels. Be realistic — something teams can do in a 5-minute huddle.`;
  try {
    const res = await fetch(CHAT_ENDPOINT, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ system: sys, messages:[{role:'user',content:`Create a training script for this scenario: ${topic}`}] })
    });
    const data = await res.json();
    const reply = (data?.reply || data?.choices?.[0]?.message?.content || 'Script generation failed.').trim();
    if(output) output.innerHTML = reply.replace(/\n/g,'<br>').replace(/\[([^\]]+)\]/g,'[<em>$1</em>]');
    awardXP(50);
  } catch(e) {
    if(output) output.textContent = 'Connection error. Make sure you have internet access and try again.';
  } finally {
    if(btn) { btn.disabled=false; btn.textContent='Build Script ✨'; }
  }
}

function generateLabScenario() {
  // Use active patient's dx key; sync the dropdown to match
  const dxSel = document.getElementById('lab-dx');
  if (dxSel) dxSel.value = activePatient.dxKey;
  const dx = activePatient.dxKey;
  let pool;
  if (dx === 'ptsd') {
    // Keep Marcus-specific pool for PTSD patient
    pool = scenarios.ptsd.filter(s => s.includes('Marcus'));
    if (!pool.length) pool = scenarios.ptsd;
  } else {
    pool = scenarios[dx] || scenarios.general || [];
  }
  const idx = Math.floor(Math.random()*pool.length);
  const scen= pool[idx] || 'No scenario available for this category yet.';
  currentLabDx = dx;
  currentLabScenarioId = `${dx}_${idx}`;
  document.getElementById('lab-scenario-box').textContent = scen;
  document.getElementById('lab-response').value = '';
  document.getElementById('lab-score-panel').style.display='none';
  document.getElementById('lab-feedback').textContent='';
  document.getElementById('lab-cooldown').style.display='none';
  document.getElementById('lab-submit-btn').disabled=false;
  const mrw = document.getElementById('marcus-reply-wrap');
  if(mrw) mrw.style.display='none';
}

function submitLabScenario() {
  const resp = document.getElementById('lab-response').value.trim();
  const diff = document.getElementById('lab-diff').value;
  const cooldown = document.getElementById('lab-cooldown');
  if(resp.length<20){ alert('Please write a more detailed response (at least 20 characters).'); return; }
  if(!currentLabScenarioId){ alert('Generate a scenario first.'); return; }
  // Score based on response length and key words
  const words = resp.toLowerCase();
  const keyTerms=['safe','calm','choice','validate','empathize','listen','space','support','trigger','reduce','grounding','breathe','acknowledge','help','understand'];
  const matched= keyTerms.filter(t=>words.includes(t)).length;
  let grade, xpGain;
  if(matched>=5||resp.length>200)      { grade='A'; xpGain=250; }
  else if(matched>=3||resp.length>120) { grade='B'; xpGain=175; }
  else if(matched>=2||resp.length>60)  { grade='C'; xpGain=100; }
  else                                 { grade='D'; xpGain=50;  }

  // Marcus state escalation/de-escalation
  if(grade==='A'||grade==='B') {
    if(marcusState==='Rage')       marcusState='Frustrated';
    else if(marcusState==='Frustrated') marcusState='Neutral';
  } else if(grade==='D') {
    if(marcusState==='Neutral')    marcusState='Frustrated';
    else if(marcusState==='Frustrated') marcusState='Rage';
  }
  updateMarcusStateBadge();

  // Lab credit calculation with once-per-day per scenario guard
  const today = new Date().toISOString().slice(0,10);
  const lastRun = (window._userData?.lastLabRun||{})[currentLabScenarioId];
  let lcEarned = 0;
  if(lastRun === today) {
    lcEarned = 0;
    if(cooldown){ cooldown.textContent = 'Credits already earned for this scenario today. Replays are practice-only.'; cooldown.style.display='block'; }
  } else {
    const base = labSettings.labBaseLC || 50;
    const bonusMap = labSettings.labScoreBonus || {A:50,B:30,C:15,D:5};
    const diffMult = diff==='advanced'?1.1 : diff==='intensive'?1.2 : 1;
    lcEarned = Math.round((base + (bonusMap[grade]||0)) * diffMult);
    // persist lastLabRun
    const updated = Object.assign({}, window._userData?.lastLabRun||{});
    updated[currentLabScenarioId] = today;
    window._saveUserData({ lastLabRun: updated, labCredits: labCredits + lcEarned }).catch(()=>{});
    window._userData.lastLabRun = updated;
    awardLabCredits(lcEarned, false);
  }

  // UI updates
  document.getElementById('lab-score-panel').style.display='block';
  document.getElementById('lab-score-letter').textContent = grade;
  document.getElementById('lab-lc-earned').textContent = lcEarned;
  document.getElementById('lab-feedback').textContent = feedback[grade];
  document.getElementById('lab-modal-credits').textContent = labCredits.toLocaleString();
  document.getElementById('lab-submit-btn').disabled=true;

  scenariosDone++;
  scoreTotal += ['A','B','C','D'].indexOf(grade)+1;
  awardXP(xpGain);
  updateFinalStats();

  // Fire lab webhook (non-blocking)
  window._fireWebhook('lab_completed', {
    email: window._currentUser?.email,
    displayName: window._currentUser?.displayName||window._currentUser?.email,
    scenarioId: currentLabScenarioId,
    diagnosis: currentLabDx,
    patient: (typeof activePatient !== 'undefined' ? activePatient.name : 'Marcus'),
    grade,
    lcEarned,
    timestamp: new Date().toISOString()
  }).catch(()=>{});
  window._writeAudit('lab_completed', {
    patient: (typeof activePatient !== 'undefined' ? activePatient.name : 'Marcus'),
    diagnosis: currentLabDx,
    grade,
    lcEarned
  }).catch(()=>{});
  // Track patient set for Full Spectrum badge
  const _patName = typeof activePatient !== 'undefined' ? activePatient.name : 'Marcus';
  const _patSet = [...new Set([...(window._userData?._labPatientSet||[]), _patName])];
  if(window._userData) window._userData._labPatientSet = _patSet;
  window._checkAchievements && window._checkAchievements({
    scenariosCompleted: (window._userData?.scenariosCompleted||0),
    _lastLabGrade: grade,
    _labPatientSet: _patSet
  }).catch(()=>{});
  window._emitXAPI('experienced', { completion:true, success: grade==='A'||grade==='B', score:{ raw:xpGain,min:0,max:250 } }).catch(()=>{});

  // Marcus in-character reply
  const scenarioText = document.getElementById('lab-scenario-box')?.textContent || '';
  generateMarcusReply(grade, scenarioText, resp);
}

async function generateMarcusReply(grade, scenario, staffResponse) {
  const wrap = document.getElementById('marcus-reply-wrap');
  const textEl = document.getElementById('marcus-reply-text');
  const dotEl  = document.getElementById('marcus-reply-state-dot');
  if(!wrap || !textEl) return;

  // Show bubble with loading state
  wrap.style.display = 'block';
  textEl.textContent = '...';
  const stateStyles = {
    Neutral:   { bg:'#dcfce7', color:'#166534', label:'Neutral' },
    Frustrated:{ bg:'#fef9c3', color:'#854d0e', label:'Frustrated' },
    Rage:      { bg:'#fee2e2', color:'#991b1b', label:'Rage' }
  };
  const ss = stateStyles[marcusState] || stateStyles.Neutral;
  if(dotEl){ dotEl.textContent = ss.label; dotEl.style.background = ss.bg; dotEl.style.color = ss.color; }

  const toneMap = {
    Neutral:   'You are slightly guarded but not hostile. You can be brief and flat — cautious, not warm.',
    Frustrated:'You are visibly irritated. Your words are short and clipped. You feel dismissed or talked at.',
    Rage:      'You are at a breaking point. Your reply is sharp, loud (implied), raw. One or two sentences maximum — you are barely holding it together.'
  };
  const gradeContext = { A: 'The staff member responded well — they gave you space, validated your feelings, and offered a choice. You are slightly less tense.', B: 'The staff response was okay. Not great, but not threatening. You are still unsure.', C: 'The staff response felt robotic or clinical. It did not land for you. You feel unheard.', D: 'The staff response made things worse — too directive, too close, or dismissive. You feel cornered.' };

  const sys = `${activePatient.persona} Current emotional state: ${marcusState}. ${toneMap[marcusState]} Keep your reply to 1-3 short sentences. No explanations, no narration — just ${activePatient.name} speaking. Do not use quotation marks.`;
  const userMsg = `Clinical scenario: ${scenario.slice(0,300)}

A staff member just responded to you by saying: "${staffResponse.slice(0,250)}"

${gradeContext[grade]}

How do you respond right now?`;
  // Also update the reply header label dynamically in case it wasn't set yet
  const rlDyn = document.getElementById('reply-patient-label');
  if (rlDyn) rlDyn.textContent = `${activePatient.name} responds`;

  try {
    const res = await fetch(CHAT_ENDPOINT, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ system: sys, messages:[{role:'user', content: userMsg}] })
    });
    const data = await res.json();
    const reply = (data?.reply || data?.choices?.[0]?.message?.content || '...').trim();
    window._typewrite(textEl, reply, 18);
  } catch(e) {
    window._typewrite(textEl, 'Fine. Whatever.', 22);
  }
}

// ─── Crisis Scenario Lab ──────────────────────────────────
const scenarios = {
  autism:[
    `James, 28, ASD Level 2, is eating in the dining room. The TV was turned on at high volume by another patient. He begins rocking rapidly, covers his ears, and makes a high-pitched sound. Staff approached him from behind and touched his shoulder. He spun around and shoved them away. He is now standing in the corner, rocking, eyes shut. He hasn't responded to verbal prompts for 4 minutes.`,
    `Maria, 19, non-verbal ASD, has been pacing the hallway for 30 minutes. Her AAC device fell earlier and hasn't been given back. She is now hitting the wall repeatedly with her palm and appears to be escalating.`
  ],
  adhd:[
    `Devon, 14, ADHD combined type, was told he must wait 30 minutes before his phone time. He immediately began yelling "This is stupid!" and threw a pillow across the room. He's now pacing rapidly and muttering to himself.`,
    `Lexi, 22, ADHD-I, has been sitting in group for 45 minutes. She is now standing up, pushing her chair back, and declaring she "can't do this anymore" — she's moving toward the door.`
  ],
  schizophrenia:[
    `Robert, 45, schizophrenia paranoid type, approaches you in the hallway and says the night staff have been poisoning his food. He's not eaten in 36 hours. He's escalating and says he needs to "get out before they hurt him." He's blocking the hallway exit.`,
    `Diane, 34, is responding to internal stimuli during a quiet hour. She's whispering rapidly and pointing at the wall. Another patient approaches to see what's happening — Diane suddenly shouts "Get away from me, I know what you are!"`
  ],
  bipolar:[
    `Tyler, 30, bipolar I, manic episode, has been awake for 48 hours. He's writing a 40-page business plan, insists he doesn't need medication today, and has been speaking so fast staff cannot interrupt. He's asked 6 times to use the phone.`,
    `Sarah, 26, bipolar I, depressive phase, has not left her room in 18 hours. Staff found her lying on the floor staring at the ceiling. She says "What's the point of anything" and won't respond to further prompts.`
  ],
  ptsd:[
    `A male nurse entered Ana's room without knocking while she was changing. Ana is a trauma survivor. She has now barricaded behind her bed, is hyperventilating, and keeps shouting "Don't come near me." She doesn't appear to recognize staff.`,
    `Marcus, 38, combat PTSD, was startled by a door slamming in the hallway. He is now in a crouched position near the wall, scanning the room, and appears to be in a flashback state saying "They're coming."`,
    `Marcus refused his morning medications and told staff "Those pills make me feel like I'm not myself." He is now pacing the hallway with fists clenched, and just told another patient to "stay out of my space." His voice is rising. Vitals were last taken 4 hours ago.`,
    `During group therapy, another patient described a combat story. Marcus abruptly stood up, knocked his chair backwards, and walked out of the room without a word. He is now sitting alone in the corner of the dayroom, hood up, knees pulled to his chest, with his back to the wall. He has not responded to two verbal check-ins from staff.`,
    `Marcus asked staff twice to lower the TV volume in the common room. It was not addressed. He is now standing at the nursing station, voice at a raised level, saying "Nobody listens in this place. I'm done with all of you." His affect is intense and his hands are visibly shaking.`,
    `It is 2:00 AM. Marcus was found by night staff sitting on the floor of the hallway outside his room, arms wrapped around himself, whispering. When asked if he is okay, he said "Just leave me alone. You wouldn't understand." He appears tearful and is not making eye contact.`
  ],
  bpd:[
    `Leah, 25, BPD, feels her discharge date was changed without her input. She approached the nursing desk crying and then began shouting that "nobody here cares about me." She said "I'll hurt myself if you discharge me." She's now in her room with the door locked.`,
    `Jaylen, 32, BPD, had a positive interaction with Staff A. When Staff B took over for the shift, Jaylen immediately said "You're the mean one — I hate when you work here." Staff B has set a limit. Jaylen is now escalating.`
  ]
};

const feedback = {
  A:`✅ EXCELLENT RESPONSE: You demonstrated strong clinical judgment. Key strengths:\n\n• Prioritized safety and de-escalation before any clinical objective\n• Used trauma-informed language and approach\n• Offered choice and control to the patient\n• Matched your energy level to the patient's need\n• Called for support appropriately\n\nThis is the standard every staff member at DSH should strive for. Outstanding work.`,
  B:`✅ GOOD RESPONSE: Solid clinical instincts. Most elements were present:\n\n• You correctly identified the escalation stage\n• Your language was mostly therapeutic\n• Consider: offering more specific choice options next time\n• Consider: reducing verbal prompts when patient is overwhelmed\n\nStrong performance — refine the finer points with experience.`,
  C:`⚠️ FAIR RESPONSE: You had some good elements but missed key interventions:\n\n• Check: Did you remove environmental triggers first?\n• Check: Did you avoid crowding or touching without consent?\n• Check: Was your tone truly calm, or just your words?\n• Check: Did you document specific behaviors or interpretations?\n\nPractice the specific techniques from the slides to strengthen this area.`,
  D:`🔴 NEEDS IMPROVEMENT: This response lacked critical de-escalation elements:\n\n• Confrontational or directive language increases escalation\n• Proximity and touch without consent re-traumatizes\n• Clinical goals must come AFTER safety and rapport\n• Re-review slides on the relevant diagnosis and escalation stages\n\nThis is a learning moment — these skills develop with practice and feedback.`
};

function generateScenario() {
  const dx = document.getElementById('scenario-dx').value;
  const pool= scenarios[dx]||scenarios.general||[];
  const scen= pool[Math.floor(Math.random()*pool.length)] || 'No scenario available for this category yet.';
  document.getElementById('scenario-box').textContent = scen;
  document.getElementById('scenario-response').value = '';
  document.getElementById('scenario-feedback').innerHTML = '<p style="color:#94a3b8;font-style:italic">Write your response and submit...</p>';
  document.getElementById('scenario-score').style.display='none';
  document.getElementById('submit-btn').disabled=false;
  scenarioActive=true;
}

function submitScenario() {
  const resp = document.getElementById('scenario-response').value.trim();
  if(resp.length<20){ alert('Please write a more detailed response (at least 20 characters).'); return; }
  // Score based on response length and key words
  const words = resp.toLowerCase();
  const keyTerms=['safe','calm','choice','validate','empathize','listen','space','support','trigger','reduce','grounding','breathe','acknowledge','help','understand'];
  const matched= keyTerms.filter(t=>words.includes(t)).length;
  let grade, xpGain;
  if(matched>=5||resp.length>200)      { grade='A'; xpGain=250; }
  else if(matched>=3||resp.length>120) { grade='B'; xpGain=175; }
  else if(matched>=2||resp.length>60)  { grade='C'; xpGain=100; }
  else                                 { grade='D'; xpGain=50;  }
  document.getElementById('scenario-feedback').innerHTML=`<pre style="white-space:pre-wrap;font-family:inherit;font-size:.85rem;color:#374151;line-height:1.7">${feedback[grade]}</pre>`;
  document.getElementById('scenario-score').style.display='block';
  document.getElementById('score-letter').textContent=grade;
  document.getElementById('score-xp').textContent=`+${xpGain} XP earned`;
  document.getElementById('submit-btn').disabled=true;
  scenariosDone++;
  scoreTotal += ['A','B','C','D'].indexOf(grade)+1; // 1=A,2=B,etc
  awardXP(xpGain);
  updateFinalStats();
}

// ─── Role-Play Script Builder ─────────────────────────────
function buildScript() {
  const topic = document.getElementById('slide-script-topic').value.trim() || 'Medication Refusal';
  const dx    = document.getElementById('script-dx').value;
  const level = document.getElementById('script-level').value;
  const dxMap = {general:'General',autism:'Autism Spectrum Disorder',schizophrenia:'Schizophrenia',bpd:'Borderline Personality Disorder',ptsd:'PTSD',bipolar:'Bipolar Disorder (Manic)'};
  const dxLabel = dxMap[dx]||dx;
  const script = `
╔══════════════════════════════════════════════════════════
  DSH TRAINING SCRIPT
  Topic: ${topic}
  Diagnosis Context: ${dxLabel}
  Level: ${level.charAt(0).toUpperCase()+level.slice(1)}
  © 2026 De-escalation Mastery Lab™ — Training Use Only
╚══════════════════════════════════════════════════════════

SCENARIO SETUP:
───────────────
Setting: Inpatient psychiatric acute care unit
Characters:
  • STAFF — [Training participant plays this role]
  • PATIENT — [Facilitator/co-trainer plays this role]
  • OBSERVER — [Notes interventions & technique use]

PATIENT BACKGROUND (For facilitator only):
─────────────────────────────────────────
Diagnosis: ${dxLabel}
Current State: Escalating (Stage 2-3 of CPI model)
Trigger: ${topic}

OPENING — STAFF ENTERS:
───────────────────────
STAFF: [Knock or announce presence — approach calmly from side]
  "Hey [Name]. I wanted to check in with you for a minute.
   Is it okay if I sit here?"
  [WAIT — allow patient to respond or not respond]

PATIENT: [Escalated response related to ${topic}]

STAFF: [Validation — do NOT problem-solve yet]
  "I hear you. That sounds really frustrating."
  [Pause — silence is therapeutic]

PATIENT: [Continues expressing distress]

STAFF: [Empathy + offer choice]
  "What would help you feel more comfortable right now?
   We could [Option A] or [Option B] — your choice."

PATIENT: [Either escalates, de-escalates, or tests limits]

STAFF: [Respond to patient's lead]
  IF escalating: "I can see this is really hard. I'm not
    going anywhere. Take your time."
  IF limit-testing: "I care about what happens to you.
    That's why I can't do [X]. What I can do is [Y]."
  IF de-escalating: "That's good. You're doing great.
    Let's take a slow breath together."

RESOLUTION:
───────────
STAFF: [Collaborative problem-solve ONLY after calm]
  "Now that things are a bit calmer — can we talk about
   [topic]? I want to understand your perspective."

POST-SCENARIO DEBRIEF QUESTIONS:
──────────────────────────────────
1. What did STAFF do well in the first 60 seconds?
2. When was empathy most clearly demonstrated?
3. What could have been done differently?
4. How did offering choice impact escalation level?
5. What diagnosis-specific techniques were used?

INSTRUCTOR NOTES:
─────────────────
Key techniques to watch for:
• Proxemics (approach angle, distance)
• Voice modulation (tone match → gradual slow)
• Validation before any directive
• Choice-offering language
• Non-punitive limit setting

════════════════════════════════════════════════════════════`;
  document.getElementById('slide-script-output').textContent = script;
  awardXP(50);
}

function printScript() {
  const content = document.getElementById('slide-script-output').textContent;
  const w = window.open('','_blank');
  w.document.write(`<html><head><title>DSH Training Script</title><style>body{font-family:'Courier New',monospace;font-size:11px;line-height:1.6;padding:2rem;white-space:pre-wrap}</style></head><body>${content}</body></html>`);
  w.document.close(); w.print();
}

// ─── Certificate ─────────────────────────────────────────
function downloadCertificate() {
  if(!finalQuizPassed) { alert('Please pass the 10-question knowledge check to unlock your certificate.'); return; }
  const user = window._currentUser;
  const name = user ? (user.displayName||user.email) : 'DSH Staff Member';
  const date = new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
  const html = `
  <div id="certificate" style="font-family:Georgia,serif;padding:3rem;text-align:center;background:white;max-width:1000px;margin:0 auto;border:14px double #1e3a8a;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.12)">
    <div style="margin-bottom:1.25rem;max-width:360px;width:100%;margin-left:auto;margin-right:auto">
      <div class="logo-inline" aria-label="Destiny Springs Healthcare logo" style="width:100%;display:block"></div>
    </div>
    <div style="font-size:.78rem;letter-spacing:.32em;color:#475569;text-transform:uppercase;margin-bottom:1rem">${(window.TENANT?.orgName||'Destiny Springs Healthcare')}</div>
    <div style="font-size:.68rem;letter-spacing:.28em;color:#64748b;text-transform:uppercase;margin-bottom:2rem">Certificate of Completion</div>
    <div style="width:120px;height:4px;background:linear-gradient(90deg,#1e3a8a,#7c3aed);margin:0 auto 2.2rem;border-radius:2px"></div>
    <div style="font-size:1rem;color:#334155;margin-bottom:.85rem">This certifies that</div>
    <div style="font-size:2.8rem;font-weight:700;color:#0f172a;font-family:Georgia,serif;margin-bottom:1rem;font-style:italic">${name}</div>
    <div style="font-size:1rem;color:#334155;margin-bottom:2.2rem">has successfully completed</div>
    <div style="font-size:1.6rem;font-weight:700;color:#0f172a;margin-bottom:.6rem">${(window.TENANT?.brandName||'De-escalation Mastery Lab™')}</div>
    <div style="font-size:.92rem;color:#475569;margin-bottom:.45rem">${(window.TENANT?.tagline||'27-Module Inpatient Psychiatric Crisis Intervention Training')}</div>
    <div style="font-size:.82rem;color:#94a3b8;margin-bottom:2rem">${(window.TENANT?.subtopics||'CPI Model · Diagnosis-Specific Care · Trauma-Informed Practice · Safety Protocols')}</div>
    <div style="width:120px;height:4px;background:linear-gradient(90deg,#7c3aed,#1e3a8a);margin:0 auto 2rem;border-radius:2px"></div>
    <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:1.5rem;gap:1.5rem">
      <div style="text-align:center;flex:1">
        <div style="border-top:2px solid #0f172a;width:220px;margin:0 auto .45rem"></div>
        <div style="font-size:.85rem;color:#475569;font-weight:700">Training Administrator</div>
        <div style="font-size:.72rem;color:#94a3b8">${(window.TENANT?.orgName||'Destiny Springs Healthcare')}</div>
      </div>
      <div style="text-align:center;flex:.6">
        <div style="font-size:3.2rem;margin-bottom:.25rem">🎓</div>
        <div style="font-size:.8rem;color:#475569;font-weight:700">XP: ${xp.toLocaleString()} · Level ${level}</div>
      </div>
      <div style="text-align:center;flex:1">
        <div style="border-top:2px solid #0f172a;width:220px;margin:0 auto .45rem"></div>
        <div style="font-size:.85rem;color:#475569;font-weight:700">Date of Completion</div>
        <div style="font-size:.72rem;color:#94a3b8">${date}</div>
      </div>
    </div>
    <div style="margin-top:2.2rem;font-size:.7rem;color:#94a3b8;border-top:1px solid #e2e8f0;padding-top:1rem">
      © ${(window.TENANT?.copyrightYear||'2026')} ${(window.TENANT?.brandName||'De-escalation Mastery Lab™')}. All Rights Reserved.
    </div>
  </div>`;
  const d = document.createElement('div');
  d.style.position='fixed';
  d.style.inset='0';
  d.style.padding='32px';
  d.style.background='#ffffff';
  d.style.zIndex='9999';
  d.style.overflow='auto';
  d.style.display='flex';
  d.style.justifyContent='center';
  d.style.alignItems='flex-start';
  d.innerHTML=html;
  document.body.appendChild(d);
  renderInlineLogos();
  const certEl = d.firstElementChild;
  const cleanup = ()=>{ try{ d.remove(); }catch(_e){} };
  const celebrate = () => {
    if(!window.confetti) return;
    const fire = (o) => window.confetti({ particleCount:90, spread:70, ...o });
    fire({ origin:{x:0.5,y:0.65} });
    setTimeout(()=>fire({ origin:{x:0.2,y:0.55}, angle:60,  particleCount:70 }), 220);
    setTimeout(()=>fire({ origin:{x:0.8,y:0.55}, angle:120, particleCount:70 }), 440);
    setTimeout(()=>fire({ origin:{x:0.5,y:0.3},  spread:110, particleCount:130 }), 700);
    setTimeout(()=>window.confetti({ particleCount:55, spread:100, startVelocity:12, origin:{x:0.5,y:0.9}, scalar:1.5 }), 1050);
    setTimeout(()=>fire({ origin:{x:0.35,y:0.5}, angle:80,  particleCount:60 }), 1400);
    setTimeout(()=>fire({ origin:{x:0.65,y:0.5}, angle:100, particleCount:60 }), 1600);
  };
  const finishFlow = ()=>{
    try {
      // Record completion timestamp once (do not overwrite if already stored)
      if(!window._userData?.completedAt) {
        window._saveUserData({ completedAt: Date.now() }).catch(()=>{});
      }
      // Fire HR integrations
      const _compUser = window._currentUser;
      const _compPayload = {
        email: _compUser?.email, displayName: _compUser?.displayName||_compUser?.email,
        completedAt: new Date().toISOString(), xp, level,
        department: window._userData?.department||null, employeeId: window._userData?.employeeId||null
      };
      window._fireWebhook('training_completed', _compPayload).catch(()=>{});
      window._fireWebhook('cert_downloaded', _compPayload).catch(()=>{});
      window._writeAudit('cert_downloaded', { xp, level, completedAt: new Date().toISOString() }).catch(()=>{});
      window._checkAchievements && window._checkAchievements({ completedAt: true }).catch(()=>{});
      window._emitXAPI('completed', { completion:true, success:true, duration:'PT0S', extensions:{ 'https://www.destinysprings.com/extensions/xp': xp, 'https://www.destinysprings.com/extensions/level': level } }).catch(()=>{});
      window._emitXAPI('passed', { completion:true, success:true, score:{ raw:xp, min:0 } }).catch(()=>{});
      currentSlide = 0;
      showSlide(0);
      window._saveUserData({ currentSlide:0 }).catch(()=>{});
      setTimeout(()=>{
        const signOut = window.confirm('Certificate saved! Do you want to sign out? Press OK to sign out, Cancel to continue training.');
        if(signOut) doSignOut();
      }, 300);
    } catch(_e){}
  };
  if(window.html2pdf && certEl){
    window.html2pdf().from(certEl).set({
      margin:0,
      filename:`${(window.TENANT?.orgId||'cert').toUpperCase()}-Certificate-${name.replace(/\s+/g,'-')}.pdf`,
      html2canvas:{scale:2,useCORS:true,backgroundColor:'#ffffff'},
      jsPDF:{unit:'in',format:'letter',orientation:'landscape'}
    }).save().then(()=>{ cleanup(); celebrate(); finishFlow(); }).catch(()=>cleanup());
  } else {
    alert('PDF library not loaded. Please try again in a moment.');
    cleanup();
  }
}

// ─── Quick Reference Cards ────────────────────────────────
const cardContent = {
  deescalation:{
    title:'Top 10 De-escalation Phrases',
    icon:'🎯',
    color:'#1e3a8a',
    items:[
      '1. "I hear you. That sounds really frustrating."',
      '2. "What would help you feel more comfortable right now?"',
      '3. "You have a choice here: [A] or [B]."',
      '4. "I\'m not going anywhere. Take your time."',
      '5. "I care about what happens to you."',
      '6. "Let\'s figure this out together."',
      '7. "You are safe right now. I am here."',
      '8. "I need you to know I take this seriously."',
      '9. "What do you need from me right now?"',
      '10. "I\'m listening. I won\'t rush you."'
    ]
  },
  diagnoses:{
    title:'Diagnosis Quick Guide',
    icon:'🧠',
    color:'#5b21b6',
    items:[
      'AUTISM: Reduce stimulation first. No unexpected touch.',
      'ADHD: Short sentences. Quick choices. Movement ok.',
      'SCHIZOPHRENIA: Calm, reality-anchoring. No arguing with delusions.',
      'BIPOLAR (MANIC): Brief directives. Don\'t match energy. Space.',
      'PTSD: Always explain before touch. Orient to present. Ground.',
      'BPD: Validate emotion. Consistent limits. Never threaten abandonment.'
    ]
  },
  grounding:{
    title:'Grounding Techniques',
    icon:'⚓',
    color:'#065f46',
    items:[
      '5-4-3-2-1: 5 see, 4 touch, 3 hear, 2 smell, 1 taste',
      'BOX BREATHING: 4 inhale · 4 hold · 4 exhale · 4 hold',
      'TIPP: Temperature · Intense exercise · Paced breathing · Relaxation',
      'SAFE PLACE: Guide to a calming mental image',
      'OBJECT FOCUS: "Hold this — describe how it feels"',
      'FEET ON FLOOR: "Feel your feet pressing on the ground"'
    ]
  },
  suicide:{
    title:'Suicide Risk C-SSRS Quick Reference',
    icon:'☠️',
    color:'#991b1b',
    items:[
      'IDEATION: "Any thoughts of killing yourself?"',
      'PLAN: "Have you thought about how you would do it?"',
      'MEANS: "Do you have access to [method]?"',
      'INTENT: "Do you intend to act on this?"',
      'TIMELINE: "When are you thinking about?"',
      'LOW: Document + increase monitoring',
      'MODERATE: Immediate psych eval + 1:1',
      'HIGH: STAY with patient. Call charge RN NOW.'
    ]
  },
  escalation:{
    title:'CPI Crisis Escalation Stages',
    icon:'📈',
    color:'#92400e',
    items:[
      '1. BASELINE: Typical behavior — proactive engagement',
      '2. TRIGGER: Stressor occurs — validate + redirect',
      '3. AGITATION: Visible agitation — reduce stimulation',
      '4. ACCELERATION: Escalating toward crisis — limit setting',
      '5. CRISIS: Loss of control — safety protocol actived',
      '6. DE-ESCALATION: Decreasing — continue calm presence',
      '7. RECOVERY/DEBRIEF: After event — process + plan'
    ]
  },
  trauma:{
    title:'Trauma-Informed Principles',
    icon:'🛡️',
    color:'#1d4ed8',
    items:[
      'REALIZE: Most psychiatric patients have trauma histories',
      'RECOGNIZE: "What happened to you?" not "What\'s wrong with you?"',
      'RESPOND: Safety · Trust · Choice · Collaboration · Empowerment',
      'RESIST RE-TRAUMATIZATION: Avoid power-over dynamics',
      'NEVER: Unexpected touch · Public shaming · Removing all control',
      'ALWAYS: Explain before you act · Offer options · Follow through'
    ]
  }
};

function downloadCard(type) {
  const card = cardContent[type];
  if(!card) return;
  const itemsHtml = card.items.map(i=>`<div style="padding:.4rem .6rem;border-bottom:1px solid #f1f5f9;font-size:11px;color:#374151;line-height:1.5">${i}</div>`).join('');
  const html = `
    <div style="font-family:Inter,sans-serif;padding:1.5rem;background:white;max-width:400px;border:3px solid ${card.color};border-radius:12px">
      <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:1rem;border-bottom:2px solid ${card.color};padding-bottom:.75rem">
        <div style="font-size:1.75rem">${card.icon}</div>
        <div>
          <div style="font-size:1rem;font-weight:900;color:${card.color};font-family:Georgia,serif">${card.title}</div>
          <div style="font-size:.65rem;color:#94a3b8;font-weight:700;letter-spacing:.1em;text-transform:uppercase">Destiny Springs Healthcare · De-escalation Mastery Lab™</div>
        </div>
      </div>
      ${itemsHtml}
      <div style="margin-top:.875rem;font-size:.65rem;color:#cbd5e1;text-align:center">© 2026 De-escalation Mastery Lab™ · Proprietary Training Content</div>
    </div>`;
  const d = document.createElement('div');
  d.style.position='fixed'; d.style.top='-9999px'; d.innerHTML=html;
  document.body.appendChild(d);
  if(window.html2pdf){
    window.html2pdf().from(d).set({
      margin:0.3, filename:`DSH-Card-${type}.pdf`,
      html2canvas:{scale:2},
      jsPDF:{unit:'in',format:[4.5,7],orientation:'portrait'}
    }).save().then(()=>d.remove());
  } else {
    const w=window.open('','_blank');
    w.document.write(`<html><head><style>@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');body{margin:0;padding:0}</style></head><body>${html}</body></html>`);
    w.document.close(); w.print(); d.remove();
  }
}

// ─── Final Stats Update ───────────────────────────────────
function updateFinalStats() {
  const fxp = document.getElementById('final-xp');
  const flv = document.getElementById('final-level');
  const fsc = document.getElementById('final-scenarios');
  const fsg = document.getElementById('final-score');
  const cxp = document.getElementById('cert-xp');
  const clv = document.getElementById('cert-level');
  const csc = document.getElementById('cert-scenarios');
  const cqs = document.getElementById('cert-score');
  if(fxp) fxp.textContent = xp.toLocaleString();
  if(flv) flv.textContent = level;
  if(fsc) fsc.textContent = scenariosDone;
  if(fsg) fsg.textContent = scenariosDone ? ['A','B','C','D'][Math.round(scoreTotal/scenariosDone)-1]||'—' : '—';
  if(cxp) cxp.textContent = xp.toLocaleString();
  if(clv) clv.textContent = level;
  if(csc) csc.textContent = scenariosDone;
  if(cqs) cqs.textContent = finalQuizPassed ? `${finalQuizScore}/10` : 'Locked';
}

// ─── Sign Out ─────────────────────────────────────────────
function doSignOut() {
  if(breathInterval) clearInterval(breathInterval);
  if(window.speechSynthesis) window.speechSynthesis.cancel();
  window._writeAudit('logout', {}).catch(()=>{});
  window._signOut();
}

// ─── Fallback: support both direct call and event dispatch ──
document.addEventListener('DSHUserLoaded', initApp);

// Pre-cache the 4 idle nudge phrases so the first fire is instant
function _preCacheIdleNudges() {
  if(paxMuted) return;
  const nudges = [
    "Don't miss the detail on the right - that could be a safety breach.",
    "This concept maps directly to how we approach Marcus. Think about the timing.",
    "This is certification exam material. Lock it in before moving on.",
    "Think of Marcus right now - how would this principle change your next move?"
  ];
  // Stagger requests 4 seconds apart to avoid hammering the TTS API at startup
  nudges.forEach((text, i) => {
    setTimeout(async () => {
      const key = text.trim().slice(0,120);
      if(_vanceAudioCache.has(key)) return;
      try {
        const res = await fetch('/api/tts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text}) });
        if(!res.ok) return;
        const blob = await res.blob();
        _vanceAudioCache.set(key, URL.createObjectURL(blob));
      } catch(_e) {}
    }, 8000 + i * 4000); // start 8s after load, stagger by 4s
  });
}
document.addEventListener('DSHUserLoaded', () => setTimeout(_preCacheIdleNudges, 500));
// --- Micro-Expression Drill -------------------------------------------------
const MICROEXP_ROUNDS = [
  { prompt: "Marcus crosses his arms, jaw tightens, eyes narrow. He just heard 'You have to calm down.'", emotion: "Anger", tip: "Jaw tightening + narrowed eyes = suppressed anger. Never command calm - offer choice instead." },
  { prompt: "Marcus goes still. Brows pull together and upward. Lips press together. A door just slammed.", emotion: "Fear", tip: "Inner brow raise + lip press = startle/fear. Lower voice, slow movements, give space." },
  { prompt: "Marcus's gaze drops to the floor. Lip corners pull down slightly. He says 'It doesn't matter.'", emotion: "Sadness", tip: "Downward gaze + lip corners down = despair. Validate feelings - do not problem-solve." },
  { prompt: "Marcus sits relaxed, face neutral, eyes mid-level. He responds to his name with 'Yeah.'", emotion: "Neutral", tip: "Relaxed facial muscles, neutral gaze = regulated state. Build rapport and offer choices now." },
  { prompt: "Marcus's nostrils flare briefly. Upper lip twitches. He turns slightly away while you speak.", emotion: "Anger", tip: "Nostril flare + upper lip pull = micro-contempt. Avoid confrontational language immediately." },
  { prompt: "Marcus glances rapidly toward the door twice. Breathing shallow. Hands grip chair arms.", emotion: "Fear", tip: "Eye movement to exits + shallow breathing = threat assessment. State room is safe; do not block exits." },
  { prompt: "Marcus stares at the table. Shoulders slump. Has not responded in 90 seconds.", emotion: "Sadness", tip: "Withdrawn stillness + slumped posture = shutdown. Silence can be therapeutic - wait before re-prompting." },
  { prompt: "Marcus makes brief eye contact, nods once, says 'I hear you.' Body language open.", emotion: "Neutral", tip: "Brief eye contact + open body = engagement signal. Transition to collaborative problem solving now." }
];
let _meIndex = 0, _meScore = 0, _meAnswered = false;
let _meTimerHandle = null, _meTimerBarHandle = null;

function startMicroExpDrill() {
  _meIndex = 0; _meScore = 0; _meAnswered = false;
  document.getElementById('microexp-score').textContent = '0';
  document.getElementById('microexp-total').textContent = '0';
  var res = document.getElementById('microexp-result-badge');
  if(res) res.style.display = 'none';
  var tip = document.getElementById('microexp-vance-tip');
  if(tip) tip.style.display = 'none';
  nextMicroExpRound();
}

function nextMicroExpRound() {
  // Hide the Next/See Results button at the start of every round
  var nextBtn = document.getElementById('microexp-next-btn');
  if(nextBtn) nextBtn.style.display = 'none';
  if(_meIndex >= MICROEXP_ROUNDS.length) {
    var prompt = document.getElementById('microexp-prompt');
    if(prompt) prompt.textContent = 'Drill complete! Score: ' + _meScore + '/' + MICROEXP_ROUNDS.length;
    var wrap = document.getElementById('microexp-timer-bar-wrap');
    if(wrap) wrap.style.display = 'none';
    awardXP(_meScore * 30);
    showXPToast(_meScore * 30, 'Micro-Exp Drill Complete');
    speakWithVance('Excellent drill work. You identified ' + _meScore + ' out of ' + MICROEXP_ROUNDS.length + ' expressions correctly. In a real crisis, that reaction time saves lives.');
    return;
  }
  _meAnswered = false;
  var round = MICROEXP_ROUNDS[_meIndex];
  var prompt = document.getElementById('microexp-prompt');
  if(prompt) prompt.textContent = round.prompt;
  var res = document.getElementById('microexp-result-badge');
  if(res) res.style.display = 'none';
  var tip = document.getElementById('microexp-vance-tip');
  if(tip) tip.style.display = 'none';
  var wrap = document.getElementById('microexp-timer-bar-wrap');
  var bar  = document.getElementById('microexp-timer-bar');
  if(wrap) wrap.style.display = 'block';
  if(bar)  { bar.style.transition = 'none'; bar.style.width = '100%'; bar.style.background = '#22c55e'; }
  clearTimeout(_meTimerHandle); clearInterval(_meTimerBarHandle);
  var START = Date.now(), DURATION = 8000;  // 8 seconds to study the expression
  _meTimerBarHandle = setInterval(function() {
    var pct = Math.max(0, 1 - (Date.now() - START) / DURATION);
    if(bar) { bar.style.transition='none'; bar.style.width=(pct*100)+'%'; bar.style.background=pct>0.5?'#22c55e':pct>0.25?'#f59e0b':'#ef4444'; }
    if(pct <= 0) clearInterval(_meTimerBarHandle);
  }, 50);
  _meTimerHandle = setTimeout(function() { if(!_meAnswered) answerMicroExp(null); }, DURATION);
}

function answerMicroExp(chosen) {
  if(_meAnswered) return;
  _meAnswered = true;
  clearTimeout(_meTimerHandle); clearInterval(_meTimerBarHandle);
  var round = MICROEXP_ROUNDS[_meIndex];
  var isRight = (chosen === round.emotion);
  if(isRight) _meScore++;
  document.getElementById('microexp-score').textContent = _meScore;
  document.getElementById('microexp-total').textContent = _meIndex + 1;
  var bar = document.getElementById('microexp-timer-bar');
  if(bar) bar.style.width = '0';
  var res = document.getElementById('microexp-result-badge');
  if(res) {
    res.style.display = 'inline-block';
    if(!chosen){ res.textContent='Too slow! Correct: '+round.emotion; res.style.background='#fee2e2'; res.style.color='#991b1b'; }
    else if(isRight){ res.textContent='Correct!'; res.style.background='#dcfce7'; res.style.color='#166534'; awardXP(30); }
    else{ res.textContent='Incorrect - was '+round.emotion; res.style.background='#fef9c3'; res.style.color='#854d0e'; }
  }
  var tipEl = document.getElementById('microexp-vance-tip');
  var tipTxt = document.getElementById('microexp-vance-text');
  if(tipEl && tipTxt) { tipTxt.textContent = round.tip; tipEl.style.display = 'block'; }
  speakWithVance(round.tip);
  _meIndex++;
  // Don't auto-advance — show a button so the user moves on when ready
  var nextBtn = document.getElementById('microexp-next-btn');
  if(nextBtn) {
    nextBtn.textContent = _meIndex < MICROEXP_ROUNDS.length ? 'Next Round →' : 'See Results →';
    nextBtn.style.display = 'inline-block';
  }
}
// ---------------------------------------------------------------------------
</script>
</body>
</html>
